<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%231a2744'/%3E%3Crect x='40' y='10' width='20' height='80' rx='4' fill='%23c9a84c'/%3E%3Crect x='14' y='30' width='72' height='20' rx='4' fill='%23c9a84c'/%3E%3C/svg%3E">
<link rel="icon" type="image/png" sizes="192x192" href="/icon192.png">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon192.png">
<link rel="apple-touch-icon" sizes="192x192" href="/icon192.png">
<link rel="apple-touch-icon-precomposed" href="/icon192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Mass Finder">
<meta name="theme-color" content="#1a2744">
<meta name="description" content="Find Mass, Confession, Adoration and more across Western Massachusetts">
<title>Mass Finder — Catholic Services Directory</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  :root {
    --navy: #1a2744;
    --navy-light: #243260;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-pale: #fdf6e3;
    --cream: #faf8f4;
    --warm-gray: #f0ece4;
    --mid-gray: #8a8278;
    --text: #2c2820;
    --text-light: #5c5650;
    --border: #ddd8ce;
    --red-warn: #9b2335;
    --green: #2d6a4f;
    --shadow: 0 2px 12px rgba(26,39,68,0.10);
    --shadow-lg: 0 8px 32px rgba(26,39,68,0.15);
    --header-height: 46px;
    --tab-bar-height: 46px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Source Sans 3', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--navy);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    cursor: pointer;
  }
  .header-inner {
    max-width: 1280px;
    margin: 0 auto;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    min-height: 44px;
  }
  .header-cross {
    color: var(--gold);
    font-size: 22px;
    line-height: 1;
    flex-shrink: 0;
  }
  .header-title {
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
  }
  .header-title h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.01em;
    line-height: 1;
    white-space: nowrap;
  }
  .header-title p {
    font-size: 0.7rem;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .header-badge {
    margin-left: auto;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 0.75rem;
    color: var(--gold-light);
    font-weight: 500;
    white-space: nowrap;
  }
  .header-add-btn {
    padding: 4px 12px;
    background: var(--gold);
    color: var(--navy);
    border: none;
    border-radius: 20px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s;
    flex-shrink: 0;
    letter-spacing: 0.02em;
  }
  .header-add-btn:hover { background: var(--gold-light); }

  /* CONTROLS */
  .controls-bar {
    background: var(--navy-light);
    border-bottom: 2px solid var(--gold);
  }
  .controls-inner {
    max-width: 1280px;
    margin: 0 auto;
    padding: 10px 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .controls-row-1 { padding-bottom: 4px; }
  .controls-row-2 { padding-top: 4px; }
  .search-wrap {
    position: relative;
    flex: 1;
    min-width: 220px;
    max-width: 340px;
  }
  .search-wrap input {
    width: 100%;
    padding: 9px 14px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.2s;
  }
  .search-wrap input::placeholder { color: rgba(255,255,255,0.45); }
  .search-wrap input:focus { background: rgba(255,255,255,0.18); border-color: var(--gold); }
  .search-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 500;
    background: #fff;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    max-height: 260px;
    overflow-y: auto;
    display: none;
  }
  .search-autocomplete.open { display: block; }
  .search-ac-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.12s;
  }
  .search-ac-item:last-child { border-bottom: none; }
  .search-ac-item:hover, .search-ac-item.ac-active { background: #f5f0e6; }
  .search-ac-name { font-weight: 600; color: var(--navy); font-size: 0.88rem; }
  .search-ac-town { color: #888; font-size: 0.78rem; margin-left: auto; white-space: nowrap; }
  .search-ac-match { color: var(--gold-dark, #b8942e); font-weight: 700; }
  select {
    padding: 9px 28px 9px 12px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    outline: none;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,0.5)'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    transition: all 0.2s;
  }
  select option { background: var(--navy); color: #fff; }
  select:focus { border-color: var(--gold); }
  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .chip {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    background: transparent;
    color: rgba(255,255,255,0.7);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .chip.active { background: var(--gold); border-color: var(--gold); color: var(--navy); font-weight: 600; }
  .results-count {
    margin-left: auto;
    color: rgba(255,255,255,0.5);
    font-size: 0.82rem;
    white-space: nowrap;
  }

  /* SUBFILTER BAR */
  .subfilter-bar {
    background: rgba(0,0,0,0.18);
    border-bottom: 1px solid rgba(201,168,76,0.2);
    animation: slideDown 0.18s ease;
  }
  @keyframes slideDown {
    from { opacity:0; transform:translateY(-6px); }
    to   { opacity:1; transform:translateY(0); }
  }
  .subfilter-label {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.45);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
    font-weight: 500;
    margin-right: 4px;
  }
  .subchip {
    padding: 4px 11px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.15);
    background: transparent;
    color: rgba(255,255,255,0.6);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.76rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .subchip:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .subchip.active { background: var(--gold-light); border-color: var(--gold-light); color: var(--navy); font-weight: 600; }

  /* MAIN */
  main {
    max-width: 1280px;
    margin: 0 auto;
    padding: 28px 24px 60px;
  }

  /* NO RESULTS */
  .no-results {
    text-align: center;
    padding: 80px 20px;
    color: var(--mid-gray);
  }
  .no-results .cross { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
  .no-results p { font-size: 1.1rem; }

  /* PARISH GRID */
  .parish-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 20px;
  }

  /* PARISH CARD */
  .parish-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.15s;
    display: flex;
    flex-direction: column;
  }
  .parish-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
  }
  .parish-card.low-confidence {
    border-left: 3px solid #e8a020;
  }

  .card-header {
    padding: 12px 14px 10px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
  }
  .card-header-text {
    flex: 1 1 0%;
    min-width: 0;
    overflow: hidden;
    word-break: break-word;
  }
  .card-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-weight: 600;
    color: #fff;
    line-height: 1.2;
    margin-bottom: 2px;
  }
  .card-location {
    font-size: 0.78rem;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 0.04em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* WP1-1B: Multi-site sibling locations */
  .also-at {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.55);
    margin-top: 2px;
    margin-bottom: 2px;
    font-style: italic;
    line-height: 1.3;
  }
  /* WP1-1C: Location label on service lines for multi-site parishes */
  .svc-location-label {
    font-size: 0.72rem;
    color: #888;
    margin-left: 4px;
    font-weight: 400;
    white-space: nowrap;
  }
  .county-badge {
    flex: 0 0 auto;
    font-size: 0.72rem;
    font-weight: 600;
    line-height: 1;
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: nowrap;
    margin-top: 1px;
  }
  /* Override verified-badge when it lives inside .county-badge (card header) */
  .county-badge .verified-badge {
    font-size: 0.72rem;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.25);
    padding: 2px 8px;
    position: relative;
    z-index: 1;
  }
  .county-badge .verified-badge.open {
    z-index: 9999;
  }
  .confidence-warn {
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.72rem;
    color: #e8a020;
    font-weight: 500;
  }

  /* Visitation hours bar */
  .visitation-bar {
    padding: 5px 16px;
    background: rgba(201,168,76,0.10);
    border-bottom: 1px solid rgba(201,168,76,0.18);
    font-size: 0.74rem;
    color: #6b5a28;
    line-height: 1.4;
  }

  .card-meta {
    padding: 6px 14px;
    background: var(--warm-gray);
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    gap: 6px 10px;
    font-size: 0.9rem;
    color: var(--text-light);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .card-meta::-webkit-scrollbar { display: none; }
  .card-meta a { color: var(--navy); text-decoration: none; font-weight: 500; }
  .card-meta a:hover { color: var(--gold); text-decoration: underline; }
  .meta-item { display: flex; align-items: center; gap: 4px; }
  .phone-link {
    color: var(--navy);
    font-weight: 600;
    text-decoration: underline;
    text-decoration-color: rgba(26,54,93,0.3);
    text-underline-offset: 2px;
  }
  .phone-link:hover { color: var(--gold); text-decoration-color: var(--gold); }

  .card-body { padding: 14px 18px 14px; flex: 1; }

  /* SERVICE SECTIONS */
  .service-section { margin-bottom: 14px; }
  .service-section:last-child { margin-bottom: 0; }
  .service-section-title {
    font-size: 0.84rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--mid-gray);
    margin-bottom: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* COLLAPSIBLE SERVICE SECTIONS */
  .svc-collapse { margin-bottom: 14px; }
  .svc-collapse:last-child { margin-bottom: 0; }
  .svc-collapse-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
  }
  .svc-collapse-header:hover { border-bottom-color: var(--gold-light); }
  .svc-collapse-chevron {
    font-size: 0.6rem;
    color: var(--mid-gray);
    transition: transform 0.2s ease;
    flex-shrink: 0;
    width: 10px;
    text-align: center;
  }
  .svc-collapse.open .svc-collapse-chevron { transform: rotate(90deg); }
  .svc-collapse-label {
    font-size: 0.84rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--mid-gray);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .svc-collapse-summary {
    margin-left: auto;
    font-size: 0.68rem;
    color: var(--mid-gray);
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 55%;
    opacity: 0.7;
  }
  .svc-collapse.open .svc-collapse-summary { display: none; }
  .svc-collapse-body {
    display: none;
    padding-top: 4px;
  }
  .svc-collapse.open .svc-collapse-body { display: block; }
  /* Remove redundant title inside collapsible body */
  .svc-collapse-body .service-section { margin-bottom: 0; }
  .svc-collapse-body .service-section-title { display: none; }
  /* Lent section purple accent */
  .svc-collapse--lent .svc-collapse-header { border-bottom-color: #d4b8e8; }
  .svc-collapse--lent .svc-collapse-label { color: #7c4fa0; }
  .svc-collapse--lent .svc-collapse-chevron { color: #7c4fa0; }
  .svc-collapse--lent .svc-collapse-summary { color: #7c4fa0; }
  .svc-collapse--lent.open {
    background: rgba(124,79,160,0.12);
    border-left: 3px solid #7c4fa0;
    padding-left: 10px;
    margin-left: -10px;
    border-radius: 0 6px 6px 0;
  }
  .svc-collapse--lent.open .svc-collapse-header { border-bottom-color: rgba(124,79,160,0.2); }
  .svc-collapse--lent.open .svc-collapse-body .service-section.lenten {
    border-left: none;
    padding-left: 0;
    margin-left: 0;
  }
  .service-list { list-style: none; margin: 0; padding: 0; }
  .service-row {
    display: grid;
    grid-template-columns: 104px 1fr;
    gap: 0 6px;
    padding: 5px 0;
    font-size: 1.0rem;
    line-height: 1.55;
    color: var(--text);
    align-items: start;
  }
  .svc-day {
    font-weight: 600;
    color: var(--navy);
    font-size: 0.95rem;
    word-break: break-word;
    hyphens: none;
    padding-top: 1px;
    line-height: 1.3;
  }
  .svc-times {
    color: var(--text);
    min-width: 0;
  }
  /* Inline layout: times only, no notes — e.g. "8 AM · 10 AM · 12 PM" */
  .svc-inline {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0;
  }
  .svc-t { white-space: nowrap; }
  .svc-sep { color: #ccc; padding: 0 5px; }
  /* Stacked layout: entries with notes — one per line, note inline if it fits */
  .svc-stack { display: flex; flex-direction: column; gap: 2px; }
  .svc-stack-row {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0 6px;
    row-gap: 0;
  }
  .svc-stack-main { display: contents; }
  .svc-type-tag {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-left: 2px;
  }
  .svc-note-line {
    font-size: 0.78rem;
    color: var(--mid-gray);
    font-style: italic;
    line-height: 1.3;
    /* B1: cap note width so countdown label never gets clipped off-screen */
    display: inline-block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: baseline;
  }
  .service-detail { color: var(--text-light); font-size: 0.78rem; }
  /* 4B: Now/Soon service row highlighting */
  .svc-row-now {
    background: rgba(45, 106, 79, 0.08);
    border-left: 3px solid var(--green);
    padding-left: 8px;
    margin-left: -8px;
    border-radius: 0 4px 4px 0;
  }
  .svc-row-soon {
    background: rgba(232, 168, 56, 0.08);
    border-left: 3px solid #e8a838;
    padding-left: 8px;
    margin-left: -8px;
    border-radius: 0 4px 4px 0;
  }
  /* When live/soon services are inside colored special sections, suppress the left bar */
  .service-section.lenten .svc-row-now,
  .service-section.lenten .svc-row-soon,
  .service-section.yc-events-section .svc-row-now,
  .service-section.yc-events-section .svc-row-soon,
  .service-section.events .svc-row-now,
  .service-section.events .svc-row-soon {
    border-left: none;
    padding-left: 0;
    margin-left: 0;
    background: none;
  }
  .svc-now-label {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.6rem;
    font-weight: 800;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-left: 6px;
    background: var(--green);
    padding: 2px 7px 2px 5px;
    border-radius: 3px;
    animation: nowPulse 2s ease-in-out infinite;
    vertical-align: middle;
  }
  .svc-now-label::before {
    content: '';
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #4ade80;
    animation: nowDot 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes nowPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.75; }
  }
  @keyframes nowDot {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.6); }
    50% { opacity: 0.6; box-shadow: 0 0 0 3px rgba(74, 222, 128, 0); }
  }
  /* Live indicator strip at top of card when any service is happening now */
  .card-live-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 14px;
    background: linear-gradient(90deg, #1a5c38, #2d6a4f);
    font-size: 0.68rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .card-live-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #4ade80;
    animation: liveDotPulse 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes liveDotPulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
    50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(74, 222, 128, 0); }
  }
  .svc-soon-label {
    font-size: 0.65rem;
    font-weight: 600;
    color: #d4920a;
    margin-left: 6px;
  }
  .lang-tag {
    display: inline-block;
    background: var(--gold-pale);
    border: 1px solid var(--gold-light);
    border-radius: 3px;
    padding: 0 4px;
    font-size: 0.65rem;
    font-weight: 700;
    color: #8a6a00;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-left: 3px;
    vertical-align: middle;
  }
  .rite-tag {
    display: inline-block;
    background: rgba(128,0,32,0.08);
    border: 1px solid rgba(128,0,32,0.22);
    border-radius: 3px;
    padding: 0 4px;
    font-size: 0.65rem;
    font-weight: 700;
    color: #800020;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-left: 3px;
    vertical-align: middle;
  }
  .seasonal-tag {
    display: inline-block;
    background: #eef7f0;
    border: 1px solid #a8d5b5;
    border-radius: 3px;
    padding: 0 4px;
    font-size: 0.65rem;
    font-weight: 500;
    color: var(--green);
    margin-left: 3px;
    vertical-align: middle;
  }
  .service-note { font-size: 0.74rem; color: var(--mid-gray); font-style: italic; }
  .office-hours-bar {
    background: #f5f3ee;
    border-bottom: 1px solid var(--border);
    padding: 5px 16px;
    font-size: 0.76rem;
    color: #666;
  }
  .office-note { color: #aaa; font-style: italic; font-size: 0.72rem; }
  /* CARD FOOTER */
  .card-footer {
    padding: 6px 16px;
    background: var(--warm-gray);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.86rem;
    color: var(--mid-gray);
  }
  .pastor-name { font-style: italic; }
  .verified-badge {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.72rem;
    font-weight: 500;
  }
  .verified-badge.verified { color: var(--green); }
  .verified-badge.low { color: #e8a020; }
  .verified-badge.needs-review { color: #b07d00; }
  .verified-badge.low-confidence { color: #c0550a; }

  /* SORT TOGGLE */
  .sort-toggle {
    display: inline-flex;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .sort-btn {
    font-size: 0.72rem;
    font-weight: 600;
    padding: 4px 9px;
    background: #fff;
    border: none;
    border-right: 1px solid var(--border);
    color: var(--text-light);
    cursor: pointer;
    font-family: inherit;
    transition: background 0.12s, color 0.12s;
    white-space: nowrap;
  }
  .sort-btn:last-child { border-right: none; }
  .sort-btn:hover { background: var(--warm-gray); color: var(--navy); }
  .sort-btn.active { background: var(--navy); color: #fff; }
  /* Hide sort toggle until location is available — shown by JS */
  .sort-toggle { display: none; }
  .sort-toggle.location-ready { display: inline-flex; }

  /* VERIFICATION BADGE — compact trust indicator */
  .verify-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.66rem;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    transition: all 0.15s;
    font-family: 'Source Sans 3', sans-serif;
    line-height: 1.4;
    white-space: nowrap;
    user-select: none;
    -webkit-user-select: none;
    letter-spacing: 0.01em;
  }
  .verify-badge:hover { transform: scale(1.05); }
  .verify-badge .verify-icon { font-size: 0.6rem; flex-shrink: 0; }

  .verify-green  { background: rgba(46,125,82,0.12); color: #2e7d52; border: 1px solid rgba(46,125,82,0.3); }
  .verify-yellow { background: rgba(180,140,0,0.1); color: #8d6e00; border: 1px solid rgba(180,140,0,0.25); }
  .verify-orange { background: rgba(192,85,10,0.1); color: #bf360c; border: 1px solid rgba(192,85,10,0.25); }
  .verify-red    { background: rgba(192,57,43,0.08); color: #c62828; border: 1px solid rgba(192,57,43,0.2); }

  /* Expanded detail panel */
  .verify-detail {
    display: none;
    position: fixed; /* B4 fix: fixed escapes overflow:hidden ancestors (e.g. fav-section-wrapper) */
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    padding: 12px 14px;
    z-index: 10000;
    min-width: 230px;
    max-width: 290px;
    text-align: left;
    white-space: normal;
    font-weight: 400;
    color: var(--text);
  }
  .verify-badge.open .verify-detail { display: block; }
  .verify-detail-title {
    font-size: 0.72rem; font-weight: 700; margin-bottom: 6px;
    display: flex; align-items: center; gap: 5px;
  }
  /* B5: Close button inside verify-detail popover */
  .verify-detail-close {
    margin-left: auto;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--mid-gray);
    padding: 0 2px;
    line-height: 1;
    flex-shrink: 0;
  }
  .verify-detail-close:hover { color: var(--text); }
  .verify-detail-row {
    font-size: 0.7rem; line-height: 1.4; margin-bottom: 4px;
    color: var(--text-light);
  }
  .verify-detail-row strong { color: var(--text); }
  .verify-detail-action {
    font-size: 0.68rem; font-weight: 600; margin-top: 8px; padding-top: 6px;
    border-top: 1px solid var(--border); color: var(--navy);
  }

  /* BULLETIN LINK */
  .bulletin-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--navy);
    background: var(--gold-light);
    border: 1px solid var(--gold);
    border-radius: 4px;
    padding: 3px 8px;
    text-decoration: none;
    transition: background 0.15s;
  }
  .bulletin-link:hover { background: var(--gold); color: var(--navy); }

  /* CONTACT DRAWER */
  .contact-toggle-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--navy);
    background: transparent;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    padding: 4px 10px;
    cursor: pointer;
    font-family: inherit;
    transition: border-color 0.15s, background 0.15s;
  }
  .contact-toggle-btn:hover { border-color: var(--navy); background: var(--warm-gray); }
  .contact-toggle-btn.open { border-color: var(--navy); background: var(--navy); color: #fff; }
  .contact-drawer {
    display: none;
    background: var(--warm-gray);
    border-top: 1px solid var(--border);
    padding: 10px 16px;
    font-size: 0.78rem;
    color: var(--text);
    gap: 6px;
    flex-direction: column;
  }
  .contact-drawer.open { display: flex; }
  .contact-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    line-height: 1.4;
  }
  .contact-row-label {
    font-weight: 700;
    color: var(--text-light);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    min-width: 80px;
    flex-shrink: 0;
    padding-top: 1px;
  }
  .contact-row-val { color: var(--text); }
  .contact-row-val a { color: var(--navy); font-weight: 600; }

  /* CLEAR FILTERS BUTTON */
  .clear-filters-btn {
    padding: 6px 16px;
    border-radius: 20px;
    border: 1.5px solid #c0392b;
    background: #fff0ee;
    color: #c0392b;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    min-height: 34px;
    -webkit-tap-highlight-color: rgba(192,57,43,0.2);
  }
  .clear-filters-btn:hover, .clear-filters-btn:active { background: #c0392b; color: #fff; }

  /* LOCATION DENIED NOTICE */
  .location-denied-notice {
    background: #fff8ee;
    border: 1px solid #f0c060;
    border-radius: 6px;
    padding: 10px 16px;
    font-size: 0.82rem;
    color: #7a5200;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  /* STATS BAR */
  .stats-bar {
    background: var(--gold-pale);
    border-bottom: 1px solid var(--gold-light);
    padding: 10px 24px;
  }
  .stats-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    gap: 28px;
    flex-wrap: wrap;
    align-items: center;
  }
  .stat { font-size: 0.82rem; color: var(--text-light); }
  .stat strong { color: var(--navy); font-weight: 700; font-size: 1rem; }
  .stat-divider { width: 1px; height: 20px; background: var(--border); }

  /* Lenten services section */
  .service-section.lenten {
    border-left: 3px solid #7c4fa0;
    padding-left: 10px;
    margin-left: -10px;
  }
  .service-section.lenten .service-section-title {
    color: #7c4fa0;
    border-bottom-color: #d4b8e8;
  }
  .service-section.lenten .service-section-title span.icon-lent {
    color: #7c4fa0;
  }
  /* Lenten tag override — purple instead of green */
  .service-section.lenten .seasonal-tag {
    background: #f5eeff;
    border-color: #c9a0e0;
    color: #7c4fa0;
  }

  /* YC Events section — warm amber treatment (mirrors Lenten purple) */
  .service-section.yc-events-section {
    border-left: 3px solid #e8a838;
    padding-left: 10px;
    margin-left: -10px;
    background: linear-gradient(135deg, rgba(232,168,56,0.06) 0%, rgba(212,131,26,0.03) 100%);
    border-radius: 0 8px 8px 0;
    padding-top: 6px;
    padding-bottom: 6px;
    margin-bottom: 4px;
  }
  .service-section.yc-events-section .service-section-title {
    color: #b8860b;
    border-bottom-color: #f0dfa0;
  }

  /* Holy Day sub-divider within Mass section */
  .holyday-divider {
    border: none;
    border-top: 1px dashed var(--border);
    margin: 6px 0 4px;
  }
  .holyday-sub-label {
    font-size: 0.63rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9b8040;
    margin-bottom: 2px;
    display: block;
  }

  /* WP2-2C: Special Events section */
  .service-section.special-events .service-section-title {
    color: #b8860b;
    border-bottom-color: #e8d5a0;
  }
  .special-event-row {
    display: flex;
    gap: 10px;
    padding: 4px 0;
    font-size: 0.9rem;
    line-height: 1.35;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    align-items: flex-start;
    overflow: visible;
  }
  .special-event-row .cal-dropdown { flex-shrink: 0; }
  .special-event-row:last-child { border-bottom: none; }
  .special-event-date {
    font-weight: 600;
    color: #b8860b;
    white-space: nowrap;
    min-width: 50px;
    flex-shrink: 0;
    max-width: 90px;
  }

  /* ─── SIMPLE MODE ────────────────────────────────── */
  .simple-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 14px;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 20px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--gold-light);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    flex-shrink: 0;
    margin-left: 6px;
  }
  .simple-toggle:hover { background: rgba(201,168,76,0.25); }
  .simple-toggle.active { background: var(--gold); color: var(--navy); border-color: var(--gold); }

  /* Simple mode filter buttons */
  .simple-filters {
    display: none;
    padding: 12px 24px;
    background: var(--navy-light);
    border-bottom: 2px solid var(--gold);
  }
  .simple-filters-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  .simple-filter-btn {
    flex: 1;
    min-width: 180px;
    max-width: 340px;
    padding: 14px 20px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.85);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .simple-filter-btn:hover { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.35); }
  .simple-filter-btn.active { background: var(--gold); border-color: var(--gold); color: var(--navy); font-weight: 700; }
  .simple-lent-btn {
    border-color: rgba(196,160,224,0.5);
    color: #dcc8ed;
  }
  .simple-lent-btn:hover { background: rgba(124,79,160,0.25); border-color: rgba(196,160,224,0.7); color: #f0e0ff; }
  .simple-lent-btn.active { background: #7c4fa0; border-color: #7c4fa0; color: #fff; }

  /* When simple mode is active, hide full controls, tab bar; bump fonts */
  body.simple-mode .controls-bar { display: none !important; }
  body.simple-mode #appTabBar { display: none !important; }
  body.simple-mode .simple-filters { display: block; }
  body.simple-mode .svc-collapse-header { display: none; }
  body.simple-mode .svc-collapse-body { display: block !important; }
  body.simple-mode .svc-collapse-body .service-section-title { display: flex !important; }
  body.simple-mode .service-row { font-size: 1.1rem; }
  body.simple-mode .svc-day { font-size: 1.05rem; }
  body.simple-mode .card-header h2 { font-size: 1.15rem; }
  body.simple-mode .card-location { font-size: 0.88rem; }
  body.simple-mode .card-meta { font-size: 1.0rem; }
  body.simple-mode .card-footer { font-size: 0.95rem; }
  body.simple-mode .service-section-title { font-size: 0.92rem; }
  body.simple-mode .svc-note-line { font-size: 0.85rem; }
  body.simple-mode .special-event-row { font-size: 1.0rem; }

  /* 5D: Special events sub-groups */
  .special-events-subgroup-title {
    font-size: 0.68rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #b8860b;
    margin-bottom: 4px;
    margin-top: 8px;
    opacity: 0.8;
  }
  .special-events-subgroup-title:first-child { margin-top: 0; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .parish-grid { grid-template-columns: 1fr; }
    .header-badge { font-size: 0.65rem; padding: 3px 10px; }
    .simple-toggle { margin-left: auto; }
    .header-add-btn { margin-left: 0; }
    .header-inner { gap: 8px; padding: 8px 12px; }
    .controls-inner { padding: 8px 14px; }
    .controls-row-1 { padding-bottom: 2px; }
    .controls-row-2 { padding-top: 2px; }
    .search-wrap { min-width: 140px; }
    main { padding: 16px 14px 40px; }
    .simple-filters { padding: 10px 14px; }
    .simple-filter-btn { min-width: 100px; font-size: 0.95rem; padding: 12px 16px; }
    /* B2: Reduce h2 size on mobile to prevent overflow into fav/verify buttons */
    .card-header h2 { font-size: 0.98rem; }
  }
  @media (max-width: 520px) {
    :root { --header-height: 40px; --tab-bar-height: 42px; }
    .header-inner { gap: 6px; padding: 8px 10px; min-height: 40px; flex-wrap: wrap; }
    .header-cross { font-size: 18px; }
    .header-title h1 { font-size: 0.95rem; }
    .header-title p { display: none; }
    .header-badge { font-size: 0.6rem; padding: 2px 8px; order: 10; margin-left: 0; }
    .simple-toggle { font-size: 0.68rem; padding: 3px 10px; }
    .header-add-btn { font-size: 0.66rem; padding: 3px 9px; }
    .controls-row-1 {
      flex-wrap: wrap;
      gap: 5px;
      padding: 6px 10px 2px;
    }
    .controls-row-1 .search-wrap {
      min-width: 0;
      max-width: none;
      flex: 1 1 100%;
    }
    .controls-row-1 .search-wrap input {
      padding: 8px 10px;
      font-size: 0.82rem;
    }
    .controls-row-1 select {
      flex: 1;
      min-width: 0;
      padding: 7px 20px 7px 8px;
      font-size: 0.75rem;
      background-position: right 5px center;
      background-size: 10px;
    }
    .controls-row-2 { padding: 2px 10px 6px; gap: 5px; }
    .simple-filters { padding: 8px 10px; }
    .simple-filters-inner { gap: 6px; }
    .simple-filter-btn { min-width: 0; flex: 1; font-size: 0.85rem; padding: 10px 8px; }
  }

  /* EMPTY STATE HELPERS */
  .loading { text-align: center; padding: 60px; color: var(--mid-gray); font-size: 1.1rem; }

  /* FADE IN */
  .parish-card { animation: fadeUp 0.25s ease both; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ─── FEATURED BANNERS ────────────────────────────────────── */
  .featured-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 20px 14px;
    margin-bottom: 16px;
    border-radius: 8px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.84rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .featured-banner:hover { filter: brightness(1.05); }
  .featured-banner.banner-active {
    box-shadow: 0 0 0 2px var(--gold), 0 2px 12px rgba(0,0,0,0.2);
  }
  .featured-banner.banner-active .banner-action { text-decoration: none; }
  .featured-banner .banner-action {
    font-size: 0.74rem;
    font-weight: 700;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .banner-triduum {
    background: linear-gradient(135deg, #3d1f4e, #522466);
    color: #e8d5f5;
    border-bottom: 1px solid rgba(201,168,76,0.3);
  }
  .banner-triduum .banner-action { color: var(--gold-light); }
  .banner-lent, .banner-seasonal {
    background: var(--season-gradient, linear-gradient(135deg, #4a2264, #5c2d82));
    color: var(--season-text, #dcc8ed);
    border-bottom: 1px solid rgba(201,168,76,0.2);
  }
  .banner-lent .banner-action, .banner-seasonal .banner-action { color: var(--season-action, var(--gold-light)); }
  .banner-yc {
    background: linear-gradient(135deg, #7a5c00, #9a7200);
    color: #fff5d6;
    border-bottom: 1px solid rgba(201,168,76,0.3);
  }
  .banner-yc .banner-action { color: #fff; }

  /* ─── SHOW ALL SERVICES BUTTON ─────────────────────────────── */
  .show-all-btn {
    display: block;
    width: 100%;
    padding: 8px 0;
    margin-top: 6px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--navy);
    background: rgba(26,54,93,0.04);
    border: 1px dashed rgba(26,54,93,0.2);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .show-all-btn:hover {
    background: rgba(26,54,93,0.08);
    border-color: rgba(26,54,93,0.35);
  }

  /* ─── REPORT BUTTON ─────────────────────────────────────── */
  .reconcile-btn {
    padding: 3px 10px;
    font-size: 0.71rem;
    font-family: 'Source Sans 3', sans-serif;
    background: transparent;
    border: 1px solid rgba(201,168,76,0.5);
    color: var(--gold);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .reconcile-btn:hover {
    background: var(--gold);
    color: var(--navy);
    border-color: var(--gold);
  }

  /* ─── RECONCILIATION MODAL ─────────────────────────────────── */
  .modal-backdrop {
    display: none;
    position: fixed; inset: 0; z-index: 2000;
    background: rgba(8,18,40,0.78);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    padding: 16px;
  }
  .modal-backdrop.open { display: flex; }

  .modal-box {
    background: #fff;
    border-radius: 12px;
    width: 100%;
    max-width: 780px;
    max-height: 92dvh;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.45);
    animation: mIn 0.2s ease;
    overflow: hidden;
  }
  @keyframes mIn {
    from { opacity:0; transform: translateY(-18px) scale(0.98); }
    to   { opacity:1; transform: none; }
  }

  /* Modal header */
  .mhdr {
    background: var(--navy);
    color: #fff;
    padding: 18px 24px 14px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-shrink: 0;
  }
  .mhdr-left h2 { margin: 0; font-size: 1.05rem; font-weight: 700; }
  .mhdr-left .mhdr-parish {
    font-size: 0.8rem;
    color: var(--gold);
    font-style: italic;
    margin-top: 3px;
  }
  .mhdr-close {
    background: transparent; border: none;
    color: rgba(255,255,255,0.55); font-size: 1.6rem;
    cursor: pointer; line-height: 1; padding: 0;
    transition: color 0.15s; flex-shrink: 0;
  }
  .mhdr-close:hover { color: #fff; }

  /* Mode tabs */
  .mode-tabs {
    display: flex;
    border-bottom: 2px solid #e4e8f0;
    background: #f9fafc;
    flex-shrink: 0;
  }
  .mode-tab {
    flex: 1;
    padding: 12px 8px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: #777;
    transition: all 0.15s;
    margin-bottom: -2px;
  }
  .mode-tab:hover { color: var(--navy); }
  .mode-tab.active { color: var(--navy); border-bottom-color: var(--gold); background: #fff; }

  /* Modal body */
  .mbody { padding: 22px 24px; overflow-y: auto; flex: 1 1 auto; }

  /* ─── Tabs panels */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ─── Existing service list (Flag mode) */
  .svc-list {
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid #d8dce8;
    border-radius: 7px;
    background: #fafbfd;
    margin-bottom: 14px;
  }
  .svc-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid #edf0f7;
    cursor: pointer;
    transition: background 0.12s;
  }
  .svc-item:last-child { border-bottom: none; }
  .svc-item:hover { background: #eef2ff; }
  .svc-item input[type=radio] { margin-top: 3px; accent-color: var(--navy); flex-shrink: 0; }
  .svc-item-main { flex: 1; }
  .svc-item-type { font-weight: 600; font-size: 0.88rem; color: #1a2244; }
  .svc-item-meta { font-size: 0.76rem; color: #777; margin-top: 1px; }
  .svc-item-note { font-size: 0.74rem; color: #999; font-style: italic; }

  /* Selected service detail (editable fields) */
  .selected-svc-detail {
    display: none;
    background: #f0f4ff;
    border: 1px solid #c4cef0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 4px;
  }
  .selected-svc-detail.visible { display: block; }
  .selected-svc-detail .detail-label {
    font-size: 0.74rem;
    font-weight: 700;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 10px;
  }

  /* ─── Form grid */
  .fgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 13px; }
  .fgrid.cols1 { grid-template-columns: 1fr; }
  .fgrid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
  .fg { display: flex; flex-direction: column; gap: 4px; }
  .fg.span2 { grid-column: 1 / -1; }
  .fg label {
    font-size: 0.73rem;
    font-weight: 700;
    color: #444;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }
  .fg label .req { color: #c0392b; }
  .fg input, .fg select, .fg textarea {
    padding: 8px 10px;
    border: 1px solid #c8d0e0;
    border-radius: 5px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.9rem;
    color: #1a2244;
    background: #fff;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .fg input:focus, .fg select:focus, .fg textarea:focus {
    outline: none;
    border-color: var(--navy);
    box-shadow: 0 0 0 3px rgba(10,22,75,0.1);
  }
  .fg textarea { resize: vertical; min-height: 72px; }
  .fg .hint { font-size: 0.71rem; color: #999; font-style: italic; }

  /* Inline checkbox row */
  .check-row { flex-direction: row !important; align-items: center; gap: 8px; }
  .check-row label { text-transform: none !important; font-weight: 400 !important; font-size: 0.88rem !important; letter-spacing: 0 !important; }
  .check-row input[type=checkbox] { width: 16px; height: 16px; padding: 0; accent-color: var(--navy); cursor: pointer; flex-shrink: 0; }

  /* Day-of-week toggle chips */
  .day-chips { display: flex; flex-wrap: wrap; gap: 5px; }
  .dc {
    padding: 4px 11px;
    border: 1px solid #c8d0e0;
    border-radius: 20px;
    font-size: 0.78rem;
    cursor: pointer;
    user-select: none;
    transition: all 0.13s;
    background: #fff;
    color: #555;
  }
  .dc.on { background: var(--navy); border-color: var(--navy); color: #fff; font-weight: 600; }

  /* Section dividers within the form */
  .fsection {
    margin-bottom: 20px;
    border: 1px solid #e4e8f0;
    border-radius: 8px;
    overflow: hidden;
  }
  .fsection-title {
    background: #f3f5fb;
    border-bottom: 1px solid #e4e8f0;
    padding: 8px 14px;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.09em;
  }
  .fsection-body { padding: 15px 14px; }

  /* Modal footer */
  .mftr {
    background: #f5f7fb;
    border-top: 1px solid #e4e8f0;
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    flex-shrink: 0;
  }
  .mftr .mftr-note { font-size: 0.74rem; color: #999; font-style: italic; flex: 1; }

  .mbtn-cancel {
    padding: 9px 18px;
    background: transparent;
    border: 1px solid #bbb;
    border-radius: 6px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    color: #555;
    cursor: pointer;
    transition: all 0.13s;
  }
  .mbtn-cancel:hover { border-color: #555; color: #222; }
  .mbtn-submit {
    padding: 9px 22px;
    background: var(--navy);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.13s;
  }
  .mbtn-submit:hover { background: #162a70; }
  .mbtn-submit.danger { background: #c0392b; }

  /* Success screen */
  .msuccess {
    display: none;
    text-align: center;
    padding: 48px 32px;
  }
  .msuccess .sicon { font-size: 3.2rem; }
  .msuccess h3 { color: var(--navy); font-size: 1.2rem; margin: 14px 0 8px; }
  .msuccess p { color: #555; font-size: 0.92rem; line-height: 1.6; }
  .msuccess .ref-id { font-size: 0.78rem; color: #aaa; margin-top: 12px; font-family: monospace; }


  /* ─── ADD PARISH CTA STRIP ─────────────────────────────────── */
  /* ─── NEW PARISH MODAL ──────────────────────────────────────── */
  .np-backdrop {
    display: none;
    position: fixed; inset: 0; z-index: 3000;
    background: rgba(8,18,40,0.82);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    padding: 16px;
  }
  .np-backdrop.open { display: flex; }

  .np-box {
    background: #fff;
    border-radius: 12px;
    width: 100%;
    max-width: 860px;
    max-height: 92dvh;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    animation: mIn 0.2s ease;
    overflow: hidden;
  }

  /* reuse mhdr, mbody, mftr, fg, fgrid, fsection from reconcile modal */

  .np-intro {
    background: #f5f7fb;
    border-bottom: 1px solid #e4e8f0;
    padding: 14px 24px;
    font-size: 0.84rem;
    color: #555;
    line-height: 1.55;
    flex-shrink: 0;
  }
  .np-intro strong { color: var(--navy); }

  /* progress stepper */
  .np-stepper {
    display: flex;
    background: #f9fafc;
    border-bottom: 2px solid #e4e8f0;
    overflow-x: auto;
    flex-shrink: 0;
  }
  .np-step {
    flex: 1;
    min-width: 80px;
    text-align: center;
    padding: 10px 6px;
    font-size: 0.72rem;
    font-weight: 700;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 3px solid transparent;
    cursor: default;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .np-step.active { color: var(--navy); border-bottom-color: var(--gold); background: #fff; }
  .np-step.done   { color: #4caf50; border-bottom-color: #4caf50; }

  /* service builder */
  .svc-builder { }
  .svc-entry {
    background: #f5f7fb;
    border: 1px solid #e0e4f0;
    border-radius: 7px;
    padding: 14px;
    margin-bottom: 10px;
    position: relative;
  }
  .svc-entry-num {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 10px;
  }
  .svc-remove {
    position: absolute; top: 10px; right: 12px;
    background: transparent; border: none;
    color: #bbb; font-size: 1.1rem; cursor: pointer;
    transition: color 0.13s;
  }
  .svc-remove:hover { color: #c0392b; }
  .add-svc-btn {
    width: 100%;
    padding: 9px;
    background: transparent;
    border: 2px dashed #c8d0e0;
    border-radius: 7px;
    color: #888;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.13s;
    margin-top: 4px;
  }
  .add-svc-btn:hover { border-color: var(--navy); color: var(--navy); background: #f0f4ff; }


  @media (max-width: 600px) {
    .modal-backdrop, .np-backdrop { padding: 10px; align-items: flex-end; }
    .modal-box, .np-box {
      max-height: 96dvh; max-height: 96vh;
      border-bottom-left-radius: 0; border-bottom-right-radius: 0;
    }
    .mbody { padding: 16px; }
    .fgrid { grid-template-columns: 1fr !important; }
    .fgrid.cols3 { grid-template-columns: 1fr !important; }
    .fg.span2 { grid-column: 1 !important; }
    .mftr { padding: 12px 16px; flex-wrap: wrap; }
    .mftr-note { display: none; }
    .mode-tab { font-size: 0.72rem; padding: 10px 4px; }
    .mhdr { padding: 14px 16px 12px; }
    .mhdr-left h2 { font-size: 0.95rem; }
    .fsection-body { padding: 12px 10px; }
  }


  /* ── HAPPENING SOON BANNER ── */
  #happeningSoon {
    background: var(--navy);
    color: #fff;
    padding: 0;
    border-bottom: 2px solid var(--gold);
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s;
  }
  .soon-inner {
    max-width: 1280px;
    margin: 0 auto;
    padding: 8px 16px;
  }
  .soon-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .soon-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .soon-row-title {
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .soon-title {
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--gold-light);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .soon-location {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.55);
    cursor: pointer;
    text-decoration: underline dotted;
    flex-shrink: 0;
  }
  .soon-cards {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 2px;
  }
  .soon-cards::-webkit-scrollbar { display: none; }
  .soon-card {
    flex-shrink: 0;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 7px 11px;
    min-width: 140px;
    max-width: 200px;
    cursor: pointer;
    transition: background 0.15s;
    text-decoration: none;
    display: block;
  }
  .soon-card:hover { background: rgba(255,255,255,0.15); }
  .soon-card-time {
    font-size: 1.0rem;
    font-weight: 700;
    color: var(--gold-light);
    line-height: 1;
    margin-bottom: 3px;
  }
  .soon-card-starts {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }
  .soon-card-parish {
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
    line-height: 1.2;
    margin-bottom: 2px;
  }
  .soon-card-town {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.55);
  }
  .soon-card-dist {
    font-size: 0.65rem;
    color: var(--gold-light);
    margin-top: 3px;
  }
  .soon-card-type {
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.5);
    margin-bottom: 2px;
  }
  .soon-card.lenten {
    border-color: rgba(196,160,224,0.35);
    background: rgba(124,79,160,0.2);
  }
  .soon-card.lenten .soon-card-time { color: #d4b8e8; }
  .soon-card.lenten .soon-card-dist { color: #d4b8e8; }
  /* WP2-2A: In-progress services get a subtle green accent */
  .soon-card.happening-now {
    border-color: rgba(52,168,83,0.45);
    background: rgba(52,168,83,0.12);
  }
  .soon-card.happening-now .soon-card-starts {
    color: #34a853;
    font-weight: 600;
  }
  .soon-none {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.5);
    padding: 4px 0;
  }

  /* Mode toggle tabs */
  .soon-mode-tabs {
    display: flex;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 5px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .soon-mode-tab {
    font-size: 0.68rem;
    font-weight: 600;
    background: none;
    border: none;
    border-right: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.55);
    padding: 4px 10px;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    font-family: inherit;
    white-space: nowrap;
  }
  .soon-mode-tab:last-child { border-right: none; }
  .soon-mode-tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .soon-mode-tab.active { background: rgba(255,255,255,0.18); color: #fff; }
  .soon-mode-tab.seasonal-tab.active { background: rgba(128,0,128,0.3); color: #e8c8ff; }

  /* Collapse toggle - mobile only */
  .soon-collapse-btn {
    display: none;
    background: none;
    border: 1px solid rgba(255,255,255,0.25);
    color: rgba(255,255,255,0.6);
    font-size: 0.9rem;
    line-height: 1;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    flex-shrink: 0;
    padding: 0;
  }
  .soon-collapse-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .soon-body { max-height: 300px; transition: max-height 0.2s ease, opacity 0.2s; overflow: hidden; opacity: 1; }
  .soon-body.collapsed { max-height: 0; opacity: 0; padding: 0; }

  /* ── MOBILE: soon section ── */
  @media (max-width: 520px) {
    .soon-collapse-btn { display: flex; align-items: center; justify-content: center; }
    .soon-header { margin-bottom: 0; }
    .soon-body:not(.collapsed) { margin-top: 6px; }
    .soon-row-title {
      flex-wrap: wrap;
      gap: 4px;
    }
    .soon-title {
      font-size: 0.72rem;
    }
    .soon-mode-tab {
      padding: 5px 12px;
      font-size: 0.72rem;
    }
    .soon-location {
      font-size: 0.65rem;
      width: 100%;
    }
  }


  /* ── LANGUAGE BAR ── */
  .lang-bar {
    max-width: 1280px;
    margin: 0 auto;
    padding: 6px 16px 0;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }
  .lang-bar-label {
    font-size: 0.72rem;
    color: var(--mid-gray);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 2px;
  }
  .lang-btn {
    padding: 4px 10px;
    border-radius: 14px;
    border: 1.5px solid var(--border);
    background: #fff;
    color: var(--text);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .lang-btn:hover { border-color: var(--gold); background: var(--gold-pale); }
  .lang-btn.active { background: var(--navy); border-color: var(--navy); color: #fff; }

  /* ── DIRECTIONS BUTTON ON CARD ── */
  .directions-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1.5px solid #34A853;
    background: #e8f5e9;
    color: #1a6b2a;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .directions-btn:hover { background: #c8e6c9; }
  .directions-btn svg { flex-shrink: 0; }

  /* ── DISTANCE BADGE ON CARD ── */
  .dist-badge {
    font-size: 0.68rem;
    color: var(--mid-gray);
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }

  /* ── INFOGRAPHIC MODAL ── */
  .info-backdrop {
    display: none;
    position: fixed; inset: 0; z-index: 2500;
    background: rgba(8,18,40,0.82);
    backdrop-filter: blur(6px);
    justify-content: center;
    align-items: center;
    padding: 12px;
  }
  .info-backdrop.open { display: flex; }
  .info-box {
    background: #faf8f4;
    border-radius: 14px;
    width: 100%;
    max-width: 920px;
    height: min(96vh, 780px);
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.45);
    animation: mIn 0.2s ease;
    overflow: hidden;
    position: relative;
  }
  .info-header {
    background: linear-gradient(135deg, #1a2744 0%, #243260 100%);
    padding: 16px 24px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .info-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.35rem;
    font-weight: 700;
    color: #fff;
    margin: 0;
  }
  .info-header .info-sub {
    font-size: 0.88rem;
    color: var(--gold-light);
    margin-top: 2px;
  }
  .info-close {
    background: none; border: none; color: rgba(255,255,255,0.5);
    font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;
  }
  .info-close:hover { color: #fff; }
  .info-body {
    flex: 1;
    overflow: hidden;
    padding: 16px 20px 12px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto 1fr auto;
    gap: 10px;
  }
  .info-hero { grid-column: 1 / -1; }
  .info-hero-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  .info-stat-card {
    background: #fff;
    border: 1px solid #eae6df;
    border-radius: 10px;
    padding: 14px 10px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .info-stat-card::before {
    content: '';
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    width: 32px; height: 3px; border-radius: 0 0 3px 3px;
    background: var(--gold);
  }
  .info-stat-num {
    font-family: 'Playfair Display', serif;
    font-size: 2.3rem;
    font-weight: 700;
    line-height: 1;
    color: var(--navy);
  }
  .info-stat-label {
    font-size: 0.94rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-light);
    margin-top: 5px;
  }
  .info-stat-sub {
    font-size: 0.8rem;
    color: var(--mid-gray);
    margin-top: 2px;
  }
  .info-card {
    background: #fff;
    border: 1px solid #eae6df;
    border-radius: 10px;
    padding: 14px 16px;
    overflow: hidden;
  }
  .info-card-title {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--gold);
    margin-bottom: 10px;
  }
  .info-donut-row {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .info-legend { display: flex; flex-direction: column; gap: 6px; flex: 1; }
  .info-legend-row {
    display: flex; align-items: center; gap: 8px; font-size: 1rem;
  }
  .info-legend-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .info-legend-label { flex: 1; color: var(--text); font-weight: 500; }
  .info-legend-num { color: var(--text-light); font-weight: 700; font-size: 1rem; }
  .info-legend-pct { color: var(--mid-gray); font-size: 0.84rem; min-width: 36px; text-align: right; }
  .info-bar-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 7px;
  }
  .info-bar-label {
    font-size: 0.94rem; font-weight: 600; color: var(--text); min-width: 78px;
  }
  .info-bar-track {
    flex: 1; height: 10px; background: #f0ece4; border-radius: 5px; overflow: hidden;
  }
  .info-bar-fill {
    height: 100%; border-radius: 5px;
  }
  @keyframes barGrowIn { from { width: 0; } }
  .info-bar-fill { animation: barGrowIn 0.8s ease-out both; }
  .info-bar-num {
    font-size: 0.94rem; color: var(--text-light); font-weight: 700; min-width: 24px; text-align: right;
  }
  .info-lang-pills { display: flex; flex-wrap: wrap; gap: 5px; }
  .info-lang-pill {
    padding: 5px 12px; border-radius: 14px; font-size: 0.88rem; font-weight: 600;
  }
  .info-lang-pill.major { background: rgba(26,39,68,0.08); color: var(--navy); }
  .info-lang-pill.minor { background: rgba(0,0,0,0.03); color: var(--mid-gray); }
  .info-mini-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
  }
  .info-mini-card {
    padding: 10px 10px; border-radius: 8px; text-align: center;
    border: 1px solid rgba(0,0,0,0.06);
  }
  .info-mini-num {
    font-family: 'Playfair Display', serif;
    font-size: 1.7rem; font-weight: 700; line-height: 1;
  }
  .info-mini-label {
    font-size: 0.82rem; font-weight: 600; margin-top: 3px;
  }
  .info-mini-sub { font-size: 0.72rem; color: var(--mid-gray); margin-top: 1px; }
  .info-features-row { grid-column: 1 / -1; }
  .info-features-grid {
    display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;
  }
  .info-feature {
    text-align: center; padding: 10px 4px;
    background: #fff; border: 1px solid #eae6df; border-radius: 8px;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .info-feature:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .info-feature-icon { font-size: 1.5rem; margin-bottom: 4px; }
  .info-feature-label { font-size: 0.78rem; font-weight: 600; color: var(--text); line-height: 1.2; }
  .info-footer {
    grid-column: 1 / -1;
    text-align: center;
    font-size: 0.86rem;
    color: var(--mid-gray);
    padding: 6px 0 0;
    border-top: 1px solid #eae6df;
  }
  .info-footer strong { color: var(--green); }
  @media (max-width: 640px) {
    .info-body {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
      overflow-y: auto;
      gap: 10px;
      padding: 12px 14px;
    }
    .info-hero-grid { grid-template-columns: repeat(2, 1fr); }
    .info-donut-row { flex-direction: column; align-items: flex-start; gap: 10px; }
    .info-box { height: min(96vh, 90vh); }
    .info-features-grid { grid-template-columns: repeat(3, 1fr); }
    .info-stat-num { font-size: 1.8rem; }
    .info-stat-label { font-size: 0.92rem; }
    .info-stat-sub { font-size: 0.78rem; }
    .info-card-title { font-size: 0.8rem; }
    .info-legend-row { font-size: 0.95rem; }
    .info-legend-num { font-size: 0.95rem; }
    .info-legend-pct { font-size: 0.82rem; }
    .info-bar-label { font-size: 0.9rem; }
    .info-bar-num { font-size: 0.9rem; }
    .info-lang-pill { font-size: 0.85rem; }
    .info-mini-num { font-size: 1.6rem; }
    .info-mini-label { font-size: 0.82rem; }
    .info-mini-sub { font-size: 0.72rem; }
    .info-feature-label { font-size: 0.78rem; }
    .info-feature-icon { font-size: 1.5rem; }
    .info-footer { font-size: 0.84rem; }
    .info-header h2 { font-size: 1.15rem; }
    .info-header .info-sub { font-size: 0.82rem; }
  }

  /* ── DISTANCE BADGE ON CARD ── */
  .dist-badge {
    font-size: 0.68rem;
    color: var(--mid-gray);
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }
  .dist-badge.near { color: var(--green); font-weight: 600; }
  /* 3B: Distance badge in card header */
  .county-badge .dist-badge {
    color: rgba(255,255,255,0.6);
    font-weight: 500;
    font-size: 0.68rem;
  }
  .county-badge .dist-badge.near {
    color: rgba(80,200,120,0.9);
    font-weight: 600;
  }

  /* ── SHARE BUTTON ── */
  .share-btn {
    padding: 2px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }
  .share-btn:hover { border-color: var(--navy); color: var(--navy); }
  .share-btn.copied { background: var(--green); color: #fff; border-color: var(--green); }

  /* Card meta overflow menu */
  .card-meta-overflow {
    position: relative;
    display: inline-flex;
    margin-left: auto;
  }
  .card-meta-overflow-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 26px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: #fff;
    font-size: 1rem;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 1px;
    line-height: 1;
    padding: 0;
    font-family: inherit;
  }
  .card-meta-overflow-btn:hover { border-color: var(--navy); color: var(--navy); background: var(--warm-gray); }
  .card-meta-overflow-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 4px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    z-index: 200;
    min-width: 130px;
    padding: 4px 0;
  }
  .card-meta-overflow.open .card-meta-overflow-menu { display: block; }
  .card-meta-overflow-item {
    display: flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    padding: 8px 14px;
    border: none;
    background: none;
    font-family: inherit;
    font-size: 0.78rem;
    font-weight: 500;
    color: var(--text);
    cursor: pointer;
    text-align: left;
    white-space: nowrap;
  }
  .card-meta-overflow-item:hover { background: var(--warm-gray); }
  .card-meta-overflow-item.copied { color: var(--green); font-weight: 600; }

  /* ── ACCESSIBILITY BADGE ── */
  .access-badge {
    display: inline-flex;
    align-items: center;
    font-size: 22px;
    line-height: 1;
    white-space: nowrap;
    cursor: default;
  }

  /* ── CALENDAR BUTTON ── */
  .cal-btn {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 7px;
    border: 1px solid rgba(232,168,56,0.35);
    border-radius: 4px;
    background: transparent;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.62rem;
    font-weight: 600;
    color: #e8a838;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    text-decoration: none;
  }
  .yc-card .cal-dropdown { margin-top: 5px; display: block; }
  .cal-btn:hover { background: rgba(232,168,56,0.15); border-color: #e8a838; }
  .cal-dropdown {
    position: relative;
    display: inline-block;
  }
  .cal-dropdown-menu {
    display: none;
    position: fixed;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: var(--shadow-lg);
    z-index: 200;
    min-width: 160px;
    padding: 4px 0;
  }
  .cal-dropdown-menu.open { display: block; }
  .cal-dropdown-menu a {
    display: block;
    padding: 7px 14px;
    font-size: 0.8rem;
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
  }
  .cal-dropdown-menu a:hover { background: var(--warm-gray); }
  .special-event-cal {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 1px 6px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: transparent;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.62rem;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    text-decoration: none;
    margin-left: 6px;
  }
  .special-event-cal:hover { background: var(--warm-gray); border-color: var(--navy); color: var(--navy); }

  /* ── PROXIMITY SORT INDICATOR ── */
  .sort-indicator {
    font-size: 0.72rem;
    color: var(--mid-gray);
    padding: 4px 0 0 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ── YOUNG & CATHOLIC EVENTS ── */
  #ycEventsSection {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    padding: 10px 0 12px;
  }
  .yc-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 12px;
  }
  .yc-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .yc-title {
    font-size: 0.82rem;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .yc-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e8a838 0%, #d4831a 100%);
    color: #1a1a2e;
    font-size: 0.58rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    padding: 2px 6px;
    border-radius: 3px;
    text-transform: uppercase;
  }
  .yc-subtitle {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.45);
  }
  .yc-cards {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 4px;
  }
  .yc-cards::-webkit-scrollbar { height: 3px; }
  .yc-cards::-webkit-scrollbar-thumb { background: rgba(232,168,56,0.3); border-radius: 2px; }
  .yc-card {
    flex: 0 0 auto;
    min-width: 155px;
    max-width: 180px;
    background: rgba(232,168,56,0.08);
    border: 1px solid rgba(232,168,56,0.25);
    border-radius: 8px;
    padding: 10px 11px 9px;
    scroll-snap-align: start;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    text-decoration: none;
    color: inherit;
    display: block;
  }
  .yc-card:hover { background: rgba(232,168,56,0.15); border-color: rgba(232,168,56,0.45); }
  .yc-card-date {
    font-size: 0.68rem;
    font-weight: 700;
    color: #e8a838;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .yc-card-title {
    font-size: 0.82rem;
    font-weight: 600;
    color: #fff;
    margin: 3px 0 2px;
    line-height: 1.2;
  }
  .yc-card-time {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.7);
  }
  .yc-card-place {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.45);
    margin-top: 3px;
    line-height: 1.25;
  }
  .yc-card-social {
    display: inline-block;
    font-size: 0.56rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #e8a838;
    margin-top: 4px;
    opacity: 0.8;
  }
  .yc-card-dist {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.5);
    margin-top: 3px;
  }
  /* YC View — filters, series cards */
  .yc-view-filters {
    display: flex;
    gap: 6px;
    padding: 0 0 12px;
  }
  .yc-filter-btn {
    background: #fff;
    border: 1.5px solid var(--border);
    color: var(--text-light);
    padding: 7px 16px;
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
  }
  .yc-filter-btn:hover {
    border-color: var(--gold);
    background: var(--gold-pale);
    color: var(--text);
  }
  .yc-filter-btn.active {
    background: var(--navy);
    color: #fff;
    border-color: var(--navy);
  }

  /* YC Hero Header */
  .yc-hero-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    margin: -16px -24px 20px;
    padding: 20px 24px 16px;
    border-radius: 0 0 14px 14px;
    box-shadow: 0 3px 16px rgba(26,39,68,0.15);
  }
  .yc-hero-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-wrap: wrap;
  }
  .yc-hero-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: #fff;
    margin: 0;
    line-height: 1.2;
  }
  .yc-hero-subtitle {
    font-size: 0.8rem;
    color: var(--gold-light);
    display: block;
    margin-top: 4px;
    font-weight: 500;
  }
  .yc-hero-header .yc-view-filters {
    margin-top: 14px;
    padding: 0;
  }
  .yc-hero-header .yc-filter-btn {
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.7);
    border-color: rgba(255,255,255,0.2);
  }
  .yc-hero-header .yc-filter-btn:hover {
    background: rgba(255,255,255,0.15);
    color: #fff;
    border-color: rgba(255,255,255,0.4);
  }
  .yc-hero-header .yc-filter-btn.active {
    background: var(--gold);
    color: var(--navy);
    border-color: var(--gold);
    font-weight: 700;
  }
  @media (max-width: 520px) {
    .yc-hero-header {
      margin: -12px -14px 16px;
      padding: 16px 14px 14px;
      border-radius: 0 0 10px 10px;
    }
    .yc-hero-title { font-size: 1.1rem; }
  }
  .yc-series-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }
  @media (min-width: 769px) {
    .yc-series-grid {
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
  }
  .yc-series-card {
    background: #fff;
    border: 1px solid var(--border);
    border-left: 4px solid var(--gold);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 6px rgba(26,39,68,0.07);
    transition: box-shadow 0.2s, transform 0.15s;
    display: flex;
    flex-direction: column;
    animation: fadeUp 0.3s ease both;
  }
  .yc-series-card:hover {
    box-shadow: 0 6px 24px rgba(26,39,68,0.13);
    transform: translateY(-1px);
  }
  .yc-series-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    color: #fff;
    padding: 14px 16px 12px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .yc-series-header-info { flex: 1; min-width: 0; }
  .yc-series-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    line-height: 1.25;
    margin-bottom: 3px;
    color: #fff;
  }
  .yc-series-parish {
    font-size: 0.84rem;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 0.02em;
  }
  .yc-series-dist {
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--gold-light);
    white-space: nowrap;
    background: rgba(201,168,76,0.18);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 12px;
    padding: 3px 10px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .yc-series-body {
    padding: 14px 16px 16px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .yc-series-next {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  .yc-series-next-label {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #fff;
    background: var(--gold);
    padding: 2px 8px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .yc-series-next-detail {
    font-size: 1.0rem;
    font-weight: 700;
    color: var(--navy);
  }
  .yc-series-time {
    font-size: 0.95rem;
    color: var(--text);
    font-weight: 600;
    margin-bottom: 6px;
  }
  .yc-series-social {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(45,106,79,0.08);
    color: var(--green);
    font-size: 0.72rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 10px;
    margin: 4px 0;
    border: 1px solid rgba(45,106,79,0.18);
    width: fit-content;
  }
  .yc-series-desc {
    font-size: 0.84rem;
    color: var(--text-light);
    line-height: 1.5;
    margin: 6px 0;
  }
  .yc-series-note {
    font-size: 0.78rem;
    color: var(--mid-gray);
    font-style: italic;
    margin: 4px 0;
    padding: 6px 10px;
    background: rgba(0,0,0,0.02);
    border-radius: 4px;
    border-left: 2px solid var(--border);
  }
  .yc-series-future {
    font-size: 0.78rem;
    color: var(--text-light);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed var(--border);
    line-height: 1.5;
  }
  .yc-series-future strong { color: var(--navy); font-weight: 700; }
  .yc-series-actions {
    display: flex;
    gap: 8px;
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .yc-series-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    border: 1.5px solid var(--border);
    background: #fff;
    color: var(--text);
    text-decoration: none;
    transition: all 0.18s;
    font-family: 'Source Sans 3', sans-serif;
  }
  .yc-series-btn:hover { background: var(--warm-gray); border-color: var(--navy-light); color: var(--navy); }
  .yc-series-btn.primary {
    background: var(--navy);
    color: #fff;
    border-color: var(--navy);
    font-weight: 700;
  }
  .yc-series-btn.primary:hover {
    background: var(--navy-light);
  }
  .yc-series-flyer {
    margin: 10px 0 6px;
  }
  .yc-series-flyer img {
    max-width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  }
  .yc-series-flyer a {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: var(--navy);
    font-size: 0.82rem;
    font-weight: 600;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  /* YC badge on parish cards — sits above the card header as its own strip */
  .parish-yc-banner {
    background: linear-gradient(135deg, #e8a838 0%, #d4831a 100%);
    color: #1a1a2e;
    padding: 6px 12px;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    display: flex;
    align-items: center;
    gap: 10px;
    line-height: 1.3;
    min-height: 32px;
  }
  .parish-yc-banner .yc-banner-label {
    flex-shrink: 0;
    font-size: 0.78rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    background: rgba(26,26,46,0.2);
    color: #1a1a2e;
    padding: 3px 10px;
    border-radius: 4px;
  }
  .parish-yc-banner .yc-banner-text {
    flex: 1;
    min-width: 0;
    font-weight: 600;
    font-size: 0.78rem;
    opacity: 0.85;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* YC badge inline on individual service lines — more prominent */
  .svc-yc-tag {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #e8a838 0%, #d4831a 100%);
    color: #fff;
    font-size: 0.55rem;
    font-weight: 800;
    letter-spacing: 0.06em;
    padding: 2px 6px;
    border-radius: 3px;
    text-transform: uppercase;
    margin-left: 5px;
    vertical-align: middle;
    text-shadow: 0 0.5px 1px rgba(0,0,0,0.2);
    box-shadow: 0 1px 3px rgba(212,131,26,0.35);
  }

  /* YC active this week — full card highlight */
  .parish-card.yc-active-week {
    border: 2px solid #e8a838;
    box-shadow: 0 0 0 1px rgba(232,168,56,0.2), 0 4px 16px rgba(232,168,56,0.15);
  }
  .parish-card.yc-active-week:hover {
    box-shadow: 0 0 0 1px rgba(232,168,56,0.3), 0 6px 24px rgba(232,168,56,0.22);
  }
  .parish-card.yc-active-week .card-header {
    background: linear-gradient(135deg, #2a2540 0%, #3a2f50 100%);
  }
  .parish-card.yc-active-week .parish-yc-banner {
    padding: 8px 12px;
  }
  .parish-card.yc-active-week .parish-yc-banner .yc-banner-label {
    font-size: 0.78rem;
    padding: 4px 12px;
  }

  /* YC literal event rows in Upcoming Events section */
  .yc-event-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 5px 0;
    border-bottom: 1px solid #f0ead6;
  }
  .yc-event-row:last-child { border-bottom: none; }
  .yc-event-date-col {
    flex-shrink: 0;
    font-size: 0.82rem;
    font-weight: 700;
    color: #b8860b;
    min-width: 54px;
  }
  .yc-event-detail-col {
    font-size: 0.88rem;
    color: #333;
    line-height: 1.35;
  }
  .yc-event-title-tag {
    font-weight: 600;
  }
  .yc-event-social-tag {
    font-size: 0.72rem;
    color: #b8860b;
    font-weight: 600;
    margin-left: 4px;
  }
  .yc-recurrence-note {
    font-size: 0.75rem;
    color: #999;
    font-style: italic;
    margin-top: 1px;
  }
  @media (max-width: 768px) {
    .yc-event-detail-col { font-size: max(0.88rem, 13px); }
    .yc-event-date-col { font-size: max(0.82rem, 13px); }
  }

  /* Special event text truncation with tap-to-expand */
  .special-event-detail {
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    cursor: pointer;
  }
  .special-event-detail.expanded {
    -webkit-line-clamp: unset;
    display: block;
    overflow: visible;
  }

  /* ── TAB BAR (WP8) ── */
  .app-tab-bar {
    background: var(--navy);
    border-bottom: 2px solid var(--gold);
    display: flex;
    justify-content: center;
    gap: 0;
    position: sticky;
    top: 42px;
    z-index: 99;
  }
  .app-tab {
    flex: 1;
    max-width: 180px;
    padding: 12px 14px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.5);
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    white-space: nowrap;
    margin-bottom: -2px;
  }
  .app-tab:hover { color: rgba(255,255,255,0.8); }
  .app-tab.active { color: #fff; border-bottom-color: var(--gold); }

  /* ── APP VIEWS ── */
  .app-view { display: none; }
  .app-view.active { display: block; }

  /* ── TODAY VIEW V2 ─────────────────────────── */
  .today-section {
    margin-bottom: 32px;
    padding-bottom: 28px;
    border-bottom: 2px solid var(--border);
    position: relative;
  }
  .today-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  /* Gold accent on section dividers */
  .today-section::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 48px;
    height: 2px;
    background: var(--gold);
  }
  .today-section:last-child::after { display: none; }
  .today-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    gap: 8px;
    flex-wrap: wrap;
  }
  .today-section-label {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--navy);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .today-section-meta {
    font-size: 0.82rem;
    color: var(--mid-gray);
    font-weight: 500;
  }
  .today-pulse {
    display: inline-block;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: var(--green);
    animation: todayPulse 2s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes todayPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(45,106,79,0.5); }
    50% { box-shadow: 0 0 0 7px rgba(45,106,79,0); }
  }

  /* Favorites onboarding nudge */
  .today-fav-nudge {
    background: linear-gradient(135deg, var(--gold-pale) 0%, #fff 100%);
    border: 1.5px dashed var(--gold);
    border-radius: 12px;
    padding: 28px 28px;
    text-align: center;
  }
  .today-fav-nudge-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.7;
  }
  .today-fav-nudge-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 6px;
  }
  .today-fav-nudge-text {
    font-size: 0.92rem;
    color: var(--text-light);
    line-height: 1.55;
    margin-bottom: 16px;
    max-width: 440px;
    margin-left: auto;
    margin-right: auto;
  }
  .today-fav-nudge-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    background: var(--navy);
    color: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.92rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.18s;
  }
  .today-fav-nudge-btn:hover { background: var(--navy-light); transform: translateY(-1px); box-shadow: var(--shadow); }

  /* Past services dimming */
  .now-item.past-service {
    opacity: 0.4;
    pointer-events: none;
  }
  .now-item.past-service .time-big { text-decoration: line-through; }

  /* Tomorrow preview compact style */
  .tomorrow-compact {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  @media (min-width: 769px) {
    .tomorrow-compact {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 8px;
    }
    .tomorrow-compact .tomorrow-expand-btn,
    .tomorrow-compact .tomorrow-overflow { grid-column: 1 / -1; }
  }
  .tomorrow-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    transition: all 0.18s;
    cursor: pointer;
  }
  .tomorrow-item:hover { border-color: var(--gold-light); box-shadow: var(--shadow); transform: translateY(-1px); }
  .tomorrow-item-time {
    font-weight: 700;
    color: var(--navy);
    font-size: 1.0rem;
    min-width: 68px;
    flex-shrink: 0;
  }
  .tomorrow-item-info { flex: 1; min-width: 0; }
  .tomorrow-item-type {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--mid-gray);
    margin-bottom: 1px;
  }
  .tomorrow-item-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.94rem;
    line-height: 1.25;
  }
  .tomorrow-expand-btn {
    display: block; width: 100%; padding: 10px; margin-top: 4px;
    background: var(--warm-gray); border: 1px dashed var(--border); border-radius: 8px;
    color: var(--navy); font-size: 0.82rem; font-weight: 600; cursor: pointer;
    text-align: center; font-family: 'Source Sans 3', sans-serif;
    transition: background 0.15s;
  }
  .tomorrow-expand-btn:hover { background: #e8e4dc; }

  /* Parish group header within Today schedule */
  .today-parish-group {
    margin-bottom: 20px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(26,39,68,0.05);
    transition: box-shadow 0.2s;
    animation: fadeUp 0.3s ease both;
  }
  .today-parish-group:last-child { margin-bottom: 0; }
  .today-parish-group:hover { box-shadow: var(--shadow); }
  .today-parish-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    color: #fff;
    cursor: pointer;
    transition: filter 0.15s;
  }
  .today-parish-header:hover { filter: brightness(1.1); }
  .today-parish-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 600;
    flex: 1;
  }
  .today-parish-town {
    font-size: 0.82rem;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 0.03em;
  }
  .today-parish-items {
    padding: 8px 10px;
  }
  @media (min-width: 769px) {
    .today-parish-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      padding: 10px 12px;
    }
  }
  @media (min-width: 1024px) {
    .today-parish-items {
      grid-template-columns: 1fr 1fr 1fr;
    }
  }
  .today-parish-items .now-item {
    border-radius: 6px;
    border: 1px solid rgba(0,0,0,0.06);
    background: var(--cream);
  }
  .today-parish-items .now-item:hover {
    background: var(--warm-gray);
    border-color: var(--gold-light);
  }
  .today-parish-items .now-item.happening {
    background: #f0faf4;
    border-color: rgba(45,106,79,0.2);
    border-left: 3px solid var(--green);
  }
  .today-parish-items .now-item.lent-item {
    background: #faf5ff;
    border-color: rgba(124,79,160,0.15);
    border-left: 3px solid #7c4fa0;
  }

  /* ── WHAT'S NOW VIEW (WP8) ── */
  .now-view {
    max-width: 1280px;
    margin: 0 auto;
    padding: 16px 24px 60px;
  }
  .now-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    gap: 8px;
    flex-wrap: wrap;
  }
  .now-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--navy);
  }
  .now-location-btn {
    padding: 7px 16px;
    border-radius: 20px;
    border: 1.5px solid var(--gold);
    background: var(--gold-pale);
    color: var(--navy);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.84rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .now-location-btn:hover { background: var(--gold-light); }
  .now-location-btn.active { background: var(--green); border-color: var(--green); color: #fff; }
  .now-filter-pills {
    display: flex;
    gap: 6px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .now-pill {
    padding: 7px 16px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: #fff;
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.86rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .now-pill:hover { border-color: var(--gold); background: var(--gold-pale); }
  .now-pill.active { background: var(--navy); border-color: var(--navy); color: #fff; }
  .now-pill.seasonal-pill.active { background: #7c4fa0; border-color: #7c4fa0; }
  .now-timeline { display: flex; flex-direction: column; gap: 8px; }
  /* Desktop grid for Today and YC Events */
  @media (min-width: 769px) {
    .now-view { max-width: 1080px; margin: 0 auto; }
    .now-timeline {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 10px;
    }
    .now-section-label { grid-column: 1 / -1; }
    .now-overflow-wrapper { grid-column: 1 / -1; display: none; }
    .now-overflow-wrapper.open {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 10px;
    }
    .now-expand-btn { grid-column: 1 / -1; }
    .now-empty { grid-column: 1 / -1; }
  }
  .now-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.18s;
    text-decoration: none;
    color: inherit;
  }
  .now-item:hover { box-shadow: var(--shadow); border-color: var(--gold-light); transform: translateY(-1px); }
  .now-item.happening { border-left: 3px solid var(--green); background: #f0faf4; }
  .now-item.yc-event { border-left: 3px solid #e8a838; background: #fffbf0; }
  .now-item.seasonal-item { border-left: 3px solid #7c4fa0; background: #faf5ff; }
  .now-item-time {
    flex-shrink: 0;
    min-width: 64px;
    text-align: center;
  }
  .now-item-time .time-big {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--navy);
    line-height: 1.1;
  }
  .now-item-time .time-status {
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #fff;
    margin-top: 3px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--green);
    padding: 2px 7px 2px 5px;
    border-radius: 3px;
    animation: nowPulse 2s ease-in-out infinite;
  }
  .now-item-time .time-status::before {
    content: '';
    display: inline-block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: #4ade80;
    animation: nowDot 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }
  .now-item-time .time-away {
    font-size: 0.7rem;
    color: var(--mid-gray);
    margin-top: 2px;
    display: block;
  }
  .now-item-info { flex: 1; min-width: 0; }
  .now-item-info .item-type {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--mid-gray);
    margin-bottom: 2px;
  }
  .now-item-info .item-name {
    font-size: 0.98rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.25;
  }
  .now-item-info .item-location {
    font-size: 0.78rem;
    color: var(--text-light);
    margin-top: 1px;
  }
  .now-item-dist {
    flex-shrink: 0;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--mid-gray);
    text-align: right;
  }
  .now-item-dist.near { color: var(--green); }
  .now-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--mid-gray);
  }
  .now-empty .cross { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.25; }
  .now-empty p { font-size: 0.94rem; line-height: 1.5; }
  .now-overflow-wrapper { display: none; }
  .now-overflow-wrapper.open { display: block; }
  .now-expand-btn {
    display: block; width: 100%; padding: 11px; margin: 4px 0 8px;
    background: var(--warm-gray); border: 1px dashed var(--border); border-radius: 8px;
    color: var(--navy); font-size: 0.84rem; font-weight: 600; cursor: pointer;
    text-align: center; letter-spacing: 0.02em; font-family: 'Source Sans 3', sans-serif;
    transition: background 0.15s;
  }
  .now-expand-btn:hover { background: #e8e4dc; }
  .yc-item-actions {
    width: 100%; display: flex; gap: 8px; padding: 6px 0 2px;
    margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.06);
  }
  .yc-action-btn {
    flex: 1; padding: 7px 10px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600; cursor: pointer;
    text-align: center; text-decoration: none; border: 1px solid var(--border);
    background: #fff; color: var(--navy); transition: background 0.15s;
  }
  .yc-action-btn:hover { background: var(--warm-gray); }
  .now-section-label {
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--mid-gray);
    margin: 16px 0 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .now-section-label:first-child { margin-top: 0; }

  /* ── YC EVENTS IN NOW VIEW ── */
  .now-yc-section {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 2px solid rgba(232,168,56,0.2);
  }
  .now-yc-section h3 {
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }



  /* Deep link share view button */
  .share-view-btn {
    padding: 5px 12px; border-radius: 16px; border: 1px solid var(--border);
    background: #fff; color: var(--text); font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .share-view-btn:hover { border-color: var(--gold); background: var(--gold-pale); }
  .share-view-btn.copied { background: var(--green); border-color: var(--green); color: #fff; }

  /* ── MAP VIEW (WP-Map) ── */
  #mapContainer {
    height: calc(100vh - var(--header-height) - var(--tab-bar-height));
    width: 100%;
    background: var(--cream);
  }
  .map-view-wrapper {
    position: relative;
  }
  .map-filter-bar {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    gap: 5px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    padding: 4px 6px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    backdrop-filter: blur(8px);
  }
  .map-chip {
    padding: 5px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .map-chip:hover { border-color: var(--gold); }
  .map-chip.active { background: var(--navy); border-color: var(--navy); color: #fff; }
  .leaflet-popup-content {
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.85rem;
    line-height: 1.4;
    min-width: 180px;
  }
  .leaflet-popup-content h3 {
    font-family: 'Playfair Display', serif;
    font-size: 0.95rem;
    color: var(--navy);
    margin: 0 0 4px;
  }
  .leaflet-popup-content .popup-town {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-bottom: 6px;
  }
  .leaflet-popup-content .popup-services {
    font-size: 0.75rem;
    color: var(--text);
  }
  .leaflet-popup-content .popup-link {
    display: inline-block;
    margin-top: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--navy);
    cursor: pointer;
    text-decoration: underline;
  }

  /* ── FAVORITES (WP-Favorites) ── */
  .fav-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 4px 6px;
    line-height: 1;
    transition: transform 0.15s;
    filter: grayscale(1) opacity(0.35);
    min-width: 36px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .fav-btn:hover { transform: scale(1.2); filter: none; }
  .fav-btn.favorited { filter: none; }
  /* ── COLLAPSED FAVORITES SECTION (MOBILE ONLY) ── */
  .fav-section-wrapper {
    grid-column: 1 / -1;
    display: none;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: #fff;
  }
  @media (max-width: 768px) {
    .fav-section-wrapper { display: block; }
    /* Hide the full stand-alone fav cards on mobile when collapsed section exists */
    .parish-card[data-fav-card="true"] { display: none !important; }
  }
  .fav-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--warm-gray);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  .fav-section-header:active { background: #e4e0d8; }
  .fav-section-header-label {
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--navy);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .fav-section-toggle {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--mid-gray);
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .fav-section-toggle .chevron {
    display: inline-block;
    font-size: 0.6rem;
  }
  .fav-share-btn {
    background: none;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.72rem;
    cursor: pointer;
    line-height: 1;
    transition: background 0.15s;
  }
  .fav-share-btn:hover { background: rgba(0,0,0,0.06); }
  .fav-collapsed-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 14px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    cursor: pointer;
    border-top: 1px solid rgba(255,255,255,0.08);
    min-height: 48px;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  .fav-collapsed-row:active { background: #2a3f6e; }
  .fav-collapsed-row .fcc-name {
    flex: 1;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    line-height: 1.2;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .fav-collapsed-row .fcc-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .fav-collapsed-row .fcc-town {
    font-size: 0.72rem;
    color: var(--gold-light);
    white-space: nowrap;
  }
  .fav-collapsed-row .fcc-live {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.58rem;
    font-weight: 800;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--green);
    padding: 2px 6px;
    border-radius: 3px;
    animation: nowPulse 2s ease-in-out infinite;
  }
  .fav-collapsed-row .fcc-live::before {
    content: '';
    width: 5px; height: 5px;
    border-radius: 50%;
    background: #4ade80;
    animation: nowDot 1.5s ease-in-out infinite;
  }
  .fav-collapsed-row .fcc-heart {
    font-size: 0.95rem;
    flex-shrink: 0;
  }
  .fav-collapsed-row .fcc-chevron {
    color: rgba(255,255,255,0.4);
    font-size: 0.7rem;
    flex-shrink: 0;
    transition: transform 0.2s;
  }
  .fav-collapsed-row.row-open {
    display: none;
  }
  .fav-collapsed-row.row-open .fcc-chevron { transform: rotate(90deg); }
  /* Inline expanded card within the fav section */
  .fav-inline-card {
    display: none;
    border-top: 1px solid var(--border);
  }
  .fav-inline-card.open { display: block; }
  .fav-inline-card .parish-card {
    border-radius: 0;
    border: none;
    box-shadow: none;
  }
  .fav-inline-collapse {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 14px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    color: rgba(255,255,255,0.7);
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .fav-inline-collapse:active { background: #2a3f6e; }
  .fav-chip {
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    background: transparent;
    color: rgba(255,255,255,0.7);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    display: none;
  }
  .fav-chip.visible { display: inline-flex; align-items: center; gap: 4px; }
  .fav-chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .fav-chip.active { background: #e8a838; border-color: #e8a838; color: var(--navy); font-weight: 600; }

  /* ── RESPONSIVE OVERRIDES ── */
  @media (max-width: 520px) {
    .app-tab-bar { top: 38px; }
    .app-tab { font-size: 0.85rem; padding: 10px 6px; letter-spacing: 0.03em; }
    .now-view { padding: 12px 14px 40px; }
    .now-item { padding: 8px 10px; gap: 8px; }
    .now-item-time .time-big { font-size: 0.9rem; }
    .now-item-info .item-name { font-size: 0.82rem; }
    #mapContainer { height: calc(100vh - var(--header-height) - var(--tab-bar-height)); }
    .map-filter-bar { padding: 3px 4px; gap: 3px; }
    .map-chip { padding: 4px 8px; font-size: 0.68rem; }
  }

  /* ── PWA INSTALL BANNER ── */
  .install-banner {
    background: linear-gradient(135deg, #243260 0%, #1a2744 100%);
    display: flex; align-items: center; gap: 8px;
    padding: 7px 16px; font-family: 'Source Sans 3', sans-serif;
    font-size: 0.75rem; color: rgba(255,255,255,0.85);
    border-bottom: 1px solid rgba(201,168,76,0.25);
    position: relative; z-index: 98;
  }
  .install-banner .ib-icon { color: var(--gold); font-size: 0.85rem; flex-shrink: 0; }
  .install-banner .ib-text { flex: 1; min-width: 0; line-height: 1.3; }
  .install-banner .ib-text strong { color: #fff; }
  .install-banner .ib-text .ib-hint {
    font-size: 0.68rem; opacity: 0.7; margin-left: 4px;
  }
  .install-banner .ib-action {
    background: var(--gold); color: var(--navy); border: none;
    padding: 5px 14px; border-radius: 14px; font-weight: 700;
    font-size: 0.72rem; cursor: pointer; white-space: nowrap;
    flex-shrink: 0; transition: background 0.15s;
  }
  .install-banner .ib-action:hover { background: var(--gold-light); }
  .install-banner .ib-close {
    background: transparent; border: none; color: rgba(255,255,255,0.4);
    font-size: 1.1rem; cursor: pointer; padding: 2px 4px; flex-shrink: 0;
    line-height: 1; transition: color 0.15s;
  }
  .install-banner .ib-close:hover { color: rgba(255,255,255,0.8); }
  /* iOS share icon inline */
  .install-banner .ios-share-icon {
    display: inline-block; width: 14px; height: 14px; vertical-align: -2px;
    margin: 0 1px;
  }
  @media (min-width: 769px) {
    .install-banner { padding: 7px 24px; font-size: 0.78rem; justify-content: center; }
    .install-banner .ib-text { flex: none; }
  }

  /* ── MOBILE HAMBURGER MENU ── */
  .header-hamburger {
    display: none;
    position: relative;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 6px;
    color: var(--gold-light);
    font-size: 1.15rem;
    cursor: pointer;
    padding: 5px 9px;
    line-height: 1;
    flex-shrink: 0;
    margin-left: auto;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  .header-hamburger:active { background: rgba(201,168,76,0.3); }
  .hamburger-menu {
    display: none;
    position: fixed;
    top: 0; right: 0; bottom: 0; left: 0;
    z-index: 1100;
  }
  .hamburger-menu.open { display: block; }
  .hamburger-menu-scrim {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.3);
    animation: fadeIn 0.12s ease;
  }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  .hamburger-menu-panel {
    position: absolute;
    top: 52px;
    right: 10px;
    background: var(--navy);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 12px;
    box-shadow: 0 12px 48px rgba(0,0,0,0.5);
    min-width: 230px;
    padding: 8px 0;
    animation: menuDropIn 0.15s ease;
  }
  @keyframes menuDropIn {
    from { opacity: 0; transform: translateY(-8px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  .hamburger-menu-panel .hm-item {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 14px 22px;
    background: none;
    border: none;
    color: rgba(255,255,255,0.85);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 1.05rem;
    font-weight: 500;
    cursor: pointer;
    text-align: left;
    transition: background 0.1s;
    -webkit-tap-highlight-color: transparent;
  }
  .hamburger-menu-panel .hm-item:active { background: rgba(255,255,255,0.12); }
  .hamburger-menu-panel .hm-item .hm-icon {
    width: 24px; text-align: center; font-size: 1.1rem; flex-shrink: 0; opacity: 0.7;
  }
  .hamburger-menu-panel .hm-item .hm-label { flex: 1; }
  .hamburger-menu-panel .hm-divider {
    height: 1px;
    background: rgba(201,168,76,0.15);
    margin: 6px 16px;
  }

  @media (max-width: 768px) {
    .header-hamburger { display: block; }
    .header-badge.desktop-hide { display: none !important; }
    .simple-toggle.desktop-hide { display: none !important; }
    .header-add-btn.desktop-hide { display: none !important; }
  }

  /* How-To panel */
  .howto-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
  }
  .howto-intro {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #eae6df;
  }
  .howto-intro h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    color: var(--navy);
    margin-bottom: 4px;
  }
  .howto-intro p {
    font-size: 0.85rem;
    color: var(--text-light);
  }
  .howto-steps {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .howto-step {
    background: #fff;
    border: 1px solid #eae6df;
    border-radius: 10px;
    padding: 16px;
    position: relative;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .howto-step:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.07); }
  .howto-step-num {
    display: none;
  }
  .howto-step-icon { font-size: 1.4rem; margin-bottom: 6px; }
  .howto-step-title { font-size: 0.88rem; font-weight: 700; color: var(--navy); margin-bottom: 4px; }
  .howto-step-desc { font-size: 0.78rem; color: var(--text-light); line-height: 1.4; }
  .howto-tip {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, rgba(201,168,76,0.08), rgba(201,168,76,0.03));
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 10px;
    padding: 14px 18px;
    display: flex; align-items: flex-start; gap: 10px;
  }
  .howto-tip-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
  .howto-tip-text { font-size: 0.82rem; color: var(--text); line-height: 1.45; }
  .howto-tip-text strong { color: var(--navy); }
  @media (max-width: 640px) {
    .howto-steps { grid-template-columns: 1fr; }
    .howto-body { padding: 14px 16px; }
    .howto-intro h3 { font-size: 1.3rem; }
    .howto-intro p { font-size: 0.95rem; }
    .howto-step-title { font-size: 1rem; }
    .howto-step-desc { font-size: 0.88rem; }
    .howto-step-icon { font-size: 1.6rem; }
    .howto-tip-text { font-size: 0.92rem; }
    .howto-tip-icon { font-size: 1.4rem; }
  }

  /* ── G4: PRINT STYLESHEET ── */
  @media print {
    body { background: #fff; color: #000; font-size: 11pt; }
    header, .app-tab-bar, .controls-row-1, .controls-row-2, .subfilter-bar,
    .featured-banner, .fav-section-wrapper, .install-banner, .results-count,
    .clear-filters-btn, .share-view-btn, .sort-toggle, .fav-chip,
    .card-footer, .card-meta, .show-all-btn, .svc-collapse-header,
    .print-btn, .fav-share-btn, #happeningSoon, .live-indicator,
    .cal-dropdown, .special-event-cal, .hamburger-menu { display: none !important; }
    .app-view { display: block !important; }
    .parish-card { break-inside: avoid; page-break-inside: avoid; box-shadow: none; border: 1px solid #ccc; margin-bottom: 12px; }
    .parish-card[data-fav-card="true"] { display: block !important; }
    .card-header { background: #1a2744 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .card-header h2 { color: #fff !important; font-size: 14pt; }
    .card-location { color: #c9a84c !important; }
    .county-badge .verified-badge, .county-badge .fav-btn, .county-badge .dist-badge { display: none; }
    .card-body { padding: 8px 16px; }
    .svc-collapse-body { display: block !important; max-height: none !important; }
    .service-section { margin-bottom: 8px; }
    .service-section-title { font-size: 10pt; font-weight: 700; border-bottom: 1px solid #ccc; margin-bottom: 4px; padding-bottom: 2px; }
    .svc-times { font-size: 10pt; }
    .confidence-warn { color: #c00 !important; }
    #grid { display: block !important; }
    .parish-card + .parish-card { margin-top: 8px; }
  }
  .print-btn {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 7px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #fff;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    font-family: inherit;
  }
  .print-btn:hover { background: var(--warm-gray); }
  @media print { .print-btn { display: none !important; } }

</style>
</head>
<body>
<a href="#parishGrid" class="skip-link" style="position:absolute;left:-9999px;top:0;z-index:10000;background:var(--navy);color:#fff;padding:8px 16px;font-weight:700;text-decoration:none;">Skip to content</a>
<style>.skip-link:focus{left:0;}</style>


<header onclick="window.scrollTo({top:0,behavior:'smooth'})">
  <div class="header-inner">
    <div class="header-cross">✝</div>
    <div class="header-title">
      <h1>Mass Finder</h1>
      <p>Catholic Services Directory</p>
    </div>
    <div class="header-badge desktop-hide" id="headerBadge" onclick="event.stopPropagation(); openInfoModal('metrics');" style="cursor:pointer;margin-left:auto;" title="View directory stats">Loading…</div>
    <button class="header-add-btn desktop-hide" onclick="event.stopPropagation(); openInfoModal('howto');" title="How to use Mass Finder" style="background:transparent;color:var(--gold-light);border:1px solid rgba(201,168,76,0.3);">? How To</button>
    <button class="header-add-btn desktop-hide" id="headerAddBtn" onclick="event.stopPropagation(); openNewParish();" title="Add a church">+ Add A Church</button>
    <button class="simple-toggle desktop-hide" id="simpleModeToggle" onclick="event.stopPropagation(); toggleSimpleMode();" title="Switch between Simple and Full view">☰ Simple</button>
    <div class="header-hamburger" id="headerHamburger" onclick="event.stopPropagation(); openHamburgerMenu();" aria-label="Menu">☰</div>
  </div>
</header>

<!-- MOBILE HAMBURGER MENU (separate overlay, no nested buttons) -->
<div class="hamburger-menu" id="hamburgerMenu">
  <div class="hamburger-menu-scrim" onclick="closeHamburgerMenu()"></div>
  <div class="hamburger-menu-panel">
    <button class="hm-item" id="hmSimple" onclick="closeHamburgerMenu(); toggleSimpleMode();">
      <span class="hm-icon">☰</span>
      <span class="hm-label" id="hmSimpleLabel">Simple Mode</span>
    </button>
    <button class="hm-item" onclick="closeHamburgerMenu(); openNewParish();">
      <span class="hm-icon">+</span>
      <span class="hm-label">Add A Church</span>
    </button>
    <div class="hm-divider"></div>
    <button class="hm-item" onclick="closeHamburgerMenu(); openInfoModal('howto');">
      <span class="hm-icon">?</span>
      <span class="hm-label">How To Use Mass Finder</span>
    </button>
    <button class="hm-item" onclick="closeHamburgerMenu(); openInfoModal('metrics');">
      <span class="hm-icon">📊</span>
      <span class="hm-label">Metrics</span>
    </button>
  </div>
</div>

<!-- TAB BAR (WP8) -->
<nav class="app-tab-bar" id="appTabBar" role="tablist" aria-label="App navigation">
  <button class="app-tab active" data-view="churches" role="tab" aria-selected="true" aria-controls="viewChurches" id="tabChurches" onclick="switchAppView('churches')">Churches</button>
  <button class="app-tab" data-view="now" role="tab" aria-selected="false" aria-controls="viewNow" id="tabNow" onclick="switchAppView('now')">Today</button>
  <button class="app-tab" data-view="yc" role="tab" aria-selected="false" aria-controls="viewYc" id="tabYc" onclick="switchAppView('yc')">YC Events</button>
  <button class="app-tab" data-view="map" role="tab" aria-selected="false" aria-controls="viewMap" id="tabMap" onclick="switchAppView('map')">Map</button>
</nav>
<div id="installBannerSlot"></div>

<!-- SIMPLE MODE FILTERS -->
<div class="simple-filters" id="simpleFilters">
  <div class="simple-filters-inner">
    <button class="simple-filter-btn active" data-simple-cat="mass_confession" onclick="setSimpleFilter('mass_confession')">✝ Mass &amp; Confession</button>
    <button class="simple-filter-btn" data-simple-cat="devotion" onclick="setSimpleFilter('devotion')">🙏 Devotions</button>
    <button class="simple-filter-btn simple-lent-btn" data-simple-cat="lenten" id="simpleLentBtn" onclick="setSimpleFilter('lenten')" style="display:none">✟ Lenten Services</button>
  </div>
</div>

<!-- ══════ CHURCHES VIEW ══════ -->
<div class="app-view active" id="viewChurches" role="tabpanel" aria-labelledby="tabChurches">

<!-- Hidden data containers — JS needs these elements for data population -->
<div id="happeningSoon" style="display:none!important">
  <div class="soon-inner">
    <div class="soon-body" id="soonBody">
      <div class="soon-cards" id="soonCards"></div>
    </div>
  </div>
</div>
<div id="ycEventsSection" style="display:none!important">
  <div class="yc-inner">
    <span class="yc-subtitle" id="ycSubtitle"></span>
    <div class="yc-cards" id="ycCards"></div>
  </div>
</div>

<div class="controls-bar">
  <div class="controls-inner controls-row-1">
    <div class="search-wrap" role="search">
      <input type="text" id="searchInput" placeholder="Search by name, town, or pastor…" autocomplete="off" aria-label="Search parishes by name, town, pastor, language, or service type">
      <div class="search-autocomplete" id="searchAutocomplete" role="listbox" aria-label="Search suggestions"></div>
    </div>
    <select id="countyFilter" style="display:none">
      <option value="">All Counties</option>
      <option value="Berkshire">Berkshire</option>
      <option value="Franklin">Franklin</option>
      <option value="Hampshire">Hampshire</option>
      <option value="Hampden">Hampden</option>
    </select>
    <select id="dayFilter" aria-label="Filter by day">
      <option value="">Any Day</option>
      <option value="monday">Monday</option>
      <option value="tuesday">Tuesday</option>
      <option value="wednesday">Wednesday</option>
      <option value="thursday">Thursday</option>
      <option value="friday">Friday</option>
      <option value="saturday">Saturday</option>
      <option value="sunday">Sunday</option>
    </select>
    <select id="timeFilter" aria-label="Filter by time">
      <option value="">Any Time</option>
      <option value="early">Early · before 8a</option>
      <option value="morning">Morning · 8a–12p</option>
      <option value="afternoon">Afternoon · 12–4p</option>
      <option value="evening">Evening · 4p+</option>
    </select>
    <select id="langFilter" aria-label="Filter by language">
      <option value="">Any Language</option>
      <option value="la">Latin (Traditional)</option>
      <option value="es">Spanish</option>
      <option value="pl">Polish</option>
      <option value="pt">Portuguese</option>
      <option value="fr">French</option>
      <option value="vi">Vietnamese</option>
      <option value="asl">ASL</option>
    </select>
  </div>
  <div class="controls-inner controls-row-2">
    <div class="filter-chips" id="categoryChips">
      <button class="chip active" data-cat="">All</button>
      <button class="chip" data-cat="mass">Mass</button>
      <button class="chip" data-cat="confession">Confession</button>
      <button class="chip" data-cat="devotion">Devotions</button>
    </div>
    <button class="fav-chip" id="favFilterChip" onclick="toggleFavFilter()" aria-label="Filter by favorites" aria-pressed="false">❤️ Favorites</button>
    <div class="sort-toggle" id="sortToggle" role="group" aria-label="Sort order">
      <button class="sort-btn active" data-sort="proximity" id="sortProximity" title="Sort by distance" aria-label="Sort by distance" onclick="setSortMode('proximity')">Near</button>
      <button class="sort-btn" data-sort="alpha" id="sortAlpha" title="Sort A→Z" aria-label="Sort alphabetically" onclick="setSortMode('alpha')">A→Z</button>
    </div>
    <button class="clear-filters-btn" id="clearFiltersBtn" style="display:none;">&#10005; Clear Filters</button>
    <button class="share-view-btn" id="shareViewBtn" style="display:none;" onclick="shareCurrentView(this)">🔗 Share View</button>
    <span class="results-count" id="resultsCount"></span>
  </div>
  <div class="subfilter-bar" id="subfilterBar" style="display:none">
    <div class="controls-inner" style="padding-top:8px;padding-bottom:8px;">
      <span class="subfilter-label" id="subfilterLabel"></span>
      <div class="filter-chips" id="subtypeChips"></div>
    </div>
  </div>
</div>





<main>
  <div id="featuredBanners"></div>
  <div class="parish-grid" id="parishGrid" role="main" aria-label="Parish listings">
    <div class="loading">Loading churches…</div>
  </div>
</main>

</div><!-- /viewChurches -->

<!-- ══════ TODAY VIEW (V2) ══════ -->
<div class="app-view" id="viewNow" role="tabpanel" aria-labelledby="tabNow">>
  <div class="now-view">

    <!-- SECTION 1: Live & Starting Soon (proximity) -->
    <div class="today-section" id="todayLiveSection">
      <div class="today-section-header">
        <div class="today-section-label"><span class="today-pulse"></span> Live &amp; Starting Soon</div>
        <button class="now-location-btn" id="nowLocationBtn" onclick="requestLocation()">📍 Enable Location</button>
      </div>
      <div class="now-filter-pills" id="nowFilterPills">
        <button class="now-pill active" data-now-mode="all" onclick="setNowMode('all')">All</button>
        <button class="now-pill" data-now-mode="mass" onclick="setNowMode('mass')">Mass</button>
        <button class="now-pill" data-now-mode="confession" onclick="setNowMode('confession')">Confession</button>
        <button class="now-pill" data-now-mode="adoration" onclick="setNowMode('adoration')">Adoration</button>
        <button class="now-pill seasonal-pill" data-now-mode="seasonal" onclick="setNowMode('seasonal')" id="nowSeasonalPill">Seasonal</button>
      </div>
      <div class="now-timeline" id="nowTimeline"></div>
    </div>

    <!-- SECTION 2: Your Parishes Today (favorites-driven) -->
    <div class="today-section" id="todayFavSection">
      <div class="today-section-header">
        <div class="today-section-label">📅 Your Parishes Today</div>
        <span class="today-section-meta" id="todayFavMeta"></span>
      </div>
      <div id="todayFavContent"></div>
    </div>

    <!-- SECTION 3: Tomorrow Preview (favorites-driven) -->
    <div class="today-section" id="todayTomorrowSection">
      <div class="today-section-header">
        <div class="today-section-label">👀 Tomorrow</div>
        <span class="today-section-meta" id="tomorrowMeta"></span>
      </div>
      <div id="todayTomorrowContent"></div>
    </div>

  </div>
</div>

<!-- ══════ YC EVENTS VIEW ══════ -->
<div class="app-view" id="viewYc" role="tabpanel" aria-labelledby="tabYc">
  <div class="now-view">
    <div class="yc-hero-header">
      <div class="yc-hero-top">
        <div>
          <h2 class="yc-hero-title"><span class="yc-badge" style="font-size:0.65rem;margin-right:8px;vertical-align:middle;">YC</span>Young &amp; Catholic</h2>
          <span class="yc-hero-subtitle" id="ycViewSubtitle"></span>
        </div>
      </div>
      <div class="yc-view-filters" id="ycViewFilters">
        <button class="yc-filter-btn active" data-yc-range="upcoming" onclick="setYcRange('upcoming')">All Upcoming</button>
        <button class="yc-filter-btn" data-yc-range="week" onclick="setYcRange('week')">This Week</button>
        <button class="yc-filter-btn" data-yc-range="month" onclick="setYcRange('month')">This Month</button>
      </div>
    </div>
    <div id="ycViewMap" style="height:220px;border-radius:12px;margin:12px 0;display:none;position:relative;z-index:1;box-shadow:0 2px 12px rgba(26,39,68,0.10);border:1px solid var(--border);"></div>
    <div class="yc-series-grid" id="ycViewTimeline"></div>
  </div>
</div>

<!-- ══════ MAP VIEW ══════ -->
<div class="app-view" id="viewMap" role="tabpanel" aria-labelledby="tabMap">
  <div class="map-view-wrapper">
    <div class="map-filter-bar" id="mapFilterBar">
      <button class="map-chip active" data-map-cat="" onclick="setMapFilter('')">All</button>
      <button class="map-chip" data-map-cat="mass" onclick="setMapFilter('mass')">Mass</button>
      <button class="map-chip" data-map-cat="confession" onclick="setMapFilter('confession')">Confession</button>
      <button class="map-chip" data-map-cat="devotion" onclick="setMapFilter('devotion')">Devotions</button>
    </div>
    <div id="mapContainer"></div>
  </div>
</div>

<script>
const PARISH_DATA_URL = './parish_data.json';
let PARISH_DATA; // set async on load

// Sub-type definitions per category
const SUBTYPES = {
  mass: [
    { key: 'weekend_mass',  label: 'Weekend Mass',    types: ['sunday_mass'],  days: ['saturday','sunday'] },
    { key: 'weekday_mass',  label: 'Weekday Mass',    types: ['daily_mass'],   days: ['monday','tuesday','wednesday','thursday','friday','weekday'] },
    { key: 'first_friday_mass', label: '1st Friday', types: ['daily_mass','sunday_mass'],  days: ['first_friday'] },
    { key: 'first_saturday_mass', label: '1st Saturday', types: ['daily_mass','sunday_mass'], days: ['first_saturday'] },
    { key: 'holyday_mass',  label: 'Holy Days',       types: ['daily_mass'],   days: ['holyday','holyday_eve'] },
    { key: 'latin_mass',    label: 'Latin Mass',      types: ['sunday_mass','daily_mass'], language: 'la' },
    { key: 'spanish_mass',  label: 'Spanish Mass',    types: ['sunday_mass','daily_mass'], language: 'es' },
    { key: 'polish_mass',   label: 'Polish Mass',     types: ['sunday_mass','daily_mass'], language: 'pl' },
  ],
  devotion: [
    { key: 'eucharistic',   label: 'Adoration',            types: ['adoration'] },
    { key: 'holy_hour',     label: 'Holy Hour',             types: ['holy_hour'] },
    { key: 'rosary',        label: 'Rosary',               types: ['rosary'] },
    { key: 'divine_mercy',  label: 'Divine Mercy',         types: ['divine_mercy'] },
    { key: 'miraculous',    label: 'Miraculous Medal',     types: ['miraculous_medal'] },
    { key: 'stations',      label: 'Stations of the Cross', types: ['stations_of_cross','stations_of_the_cross'] },
    { key: 'novena',        label: 'Novena',               types: ['novena'] },
    { key: 'anointing',     label: 'Anointing of the Sick', types: ['anointing_of_sick','anointing'] },
    { key: 'communion_svc', label: 'Communion Service',    types: ['communion_service'] },
  ],
};

function serviceMatchesSubtype(svc, subtype) {
  if (!subtype) return true;
  // Find the subtype def
  for (const cat of Object.values(SUBTYPES)) {
    const def = cat.find(s => s.key === subtype);
    if (!def) continue;
    // Must match type
    if (!def.types.includes(svc.type)) return false;
    // Language filter
    if (def.language && svc.language !== def.language) return false;
    // Season filter
    if (def.season && (!svc.seasonal || svc.seasonal.season !== def.season)) return false;
    // Day filter
    if (def.days) {
      const svcDays = svc.days || (svc.day ? [svc.day] : []);
      const overlap = def.days.some(d => svcDays.includes(d));
      if (!overlap) return false;
    }
    return true;
  }
  return false;
}

const SERVICE_LABELS = {
  sunday_mass:'Mass', daily_mass:'Mass', confession:'Confession',
  adoration:'Adoration', holy_hour:'Holy Hour', perpetual_adoration:'Perp. Adoration',
  benediction:'Benediction', rosary:'Rosary', divine_mercy:'Divine Mercy',
  miraculous_medal:'Miraculous Medal', novena:'Novena',
  stations_of_cross:'Stations of the Cross', stations_of_the_cross:'Stations of the Cross',
  anointing_of_sick:'Anointing of the Sick', communion_service:'Communion Service',
  devotion:'Devotion',
  holy_thursday_mass:'Holy Thursday Mass', good_friday_service:'Good Friday Service',
  easter_vigil_mass:'Easter Vigil Mass', divine_mercy_chaplet:'Divine Mercy Chaplet',
  devotional:'Devotion', gorzkie_zale:'Gorzkie \u017Bale',
  bible_study:'Bible Study', mens_group:"Men's Group", social_event:'Social Event',
  special_mass:'Special Mass', special_event:'Special Event',
  fellowship:'Fellowship', educational:'Educational', volunteering:'Volunteering',
  social:'Social', anointing:'Anointing',
  vespers:'Vespers', prayer_group:'Prayer Group',
};

const DAY_LABELS = {
  monday:'Mon', tuesday:'Tue', wednesday:'Wed', thursday:'Thu',
  friday:'Fri', saturday:'Sat', sunday:'Sun',
  first_friday:'1st Fri', first_saturday:'1st Sat',
  first_sunday:'1st Sun', first_thursday:'1st Thu',
  holyday:'Holy Day', holyday_eve:'Holy Day Eve',
  weekday:'Weekday', daily:'Daily',
  monday_friday:'Mon\u2013Fri', tuesday_friday:'Tue\u2013Fri',
  Holy_Thursday:'Holy Thu', Good_Friday:'Good Fri', Easter_Vigil:'Easter Vigil',
  civil_holiday:'Civil Holiday', lent:'Lent',
  '':'Varies',
};

const SEASON_LABELS = {
  lent:'Lent', advent:'Advent', school_year:'School Year', summer:'Summer',
  academic_year:'Academic Year', holy_week:'Holy Week', year_round:'Year Round',
};

const LANG_NAMES = {
  en:'English', es:'Spanish', pl:'Polish', pt:'Portuguese',
  vi:'Vietnamese', asl:'ASL', fr:'French', it:'Italian', la:'Latin',
};
const LANG_LABELS = {
  en:'EN', es:'ES', pl:'PL', pt:'PT', vi:'VI', asl:'ASL', fr:'FR', it:'IT', la:'LA',
};

const SERVICE_TYPE_GROUPS = {
  mass:       ['sunday_mass','daily_mass','communion_service','holy_thursday_mass','good_friday_service','easter_vigil_mass'],
  confession: ['confession'],
  mass_confession: ['sunday_mass','daily_mass','communion_service','holy_thursday_mass','good_friday_service','easter_vigil_mass','confession'],
  devotion:   ['adoration','holy_hour','perpetual_adoration','benediction',
               'rosary','divine_mercy','miraculous_medal','novena',
               'stations_of_cross','stations_of_the_cross','anointing_of_sick',
               'anointing','devotion','vespers','prayer_group',
               'divine_mercy_chaplet','devotional','gorzkie_zale'],
  community:  ['bible_study','mens_group','social_event'],
};

// 5A: Simple Mode state
let isSimpleMode = false;
let simpleFilter = 'mass_confession';

function getSimpleModeCookie() {
  return document.cookie.split('; ').some(c => c.startsWith('pf_simple=1'));
}
function setSimpleModeCookie(on) {
  const d = new Date(); d.setFullYear(d.getFullYear() + 1);
  document.cookie = 'pf_simple=' + (on ? '1' : '0') + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
}

function toggleSimpleMode() {
  isSimpleMode = !isSimpleMode;
  setSimpleModeCookie(isSimpleMode);
  applySimpleMode();
  if (window._renderFn) window._renderFn();
}

function setSimpleFilter(cat) {
  simpleFilter = cat;
  // Tie 'lenten' simple button into the seasonal banner filter
  if (cat === 'lenten') {
    seasonalBannerFilter = 'seasonal';
  } else {
    seasonalBannerFilter = '';
  }
  document.querySelectorAll('[data-simple-cat]').forEach(b =>
    b.classList.toggle('active', b.dataset.simpleCat === cat)
  );
  if (window._renderFn) window._renderFn();
}

function applySimpleMode() {
  document.body.classList.toggle('simple-mode', isSimpleMode);
  // E4: Synchronize both toggle instances before any DOM paint
  requestAnimationFrame(function() {
    const btn = document.getElementById('simpleModeToggle');
    if (btn) {
      btn.classList.toggle('active', isSimpleMode);
      btn.innerHTML = isSimpleMode ? '☰ Full' : '☰ Simple';
    }
    const hmBtn = document.getElementById('hmSimple');
    const hmLabel = document.getElementById('hmSimpleLabel');
    if (hmBtn) hmBtn.classList.toggle('active', isSimpleMode);
    if (hmLabel) hmLabel.textContent = isSimpleMode ? 'Full Mode' : 'Simple Mode';
  });
  // When entering simple mode, lock to churches view, request location, sort by proximity
  if (isSimpleMode) {
    if (typeof switchAppView === 'function') switchAppView('churches');
    // Request location and sort by proximity for simple mode users
    if (typeof requestLocation === 'function' && (!window.userLat || window.userLat === null)) {
      requestLocation();
    }
    if (typeof setSortMode === 'function' && window.userLat) {
      setSortMode('proximity');
    }
  }
}

function fmt12(t) {
  if (!t) return 'Varies';
  const [h, m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12  = h % 12 || 12;
  return m === 0 ? `${h12} ${ampm}` : `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
}

function fmtTimeRange(s) {
  if (s.times_vary && !s.time) return 'Varies';
  let t = fmt12(s.time);
  if (s.end_time) t += `–${fmt12(s.end_time)}`;
  return t;
}

function getDays(s) {
  if (s.days && s.days.length) return s.days;
  if (s.day) return [s.day];
  return [];
}

function fmtDays(days) {
  if (!days.length) return '';
  const labels = days.map(d => DAY_LABELS[d] || d);
  // Collapse Mon-Fri
  const wkdaySet = ['Mon','Tue','Wed','Thu','Fri'];
  const allWkday = wkdaySet.every(d => labels.includes(d)) && labels.length === 5;
  if (allWkday) return 'Mon–Fri';
  // Mon-Thu
  const monThu = ['Mon','Tue','Wed','Thu'];
  if (monThu.every(d => labels.includes(d)) && labels.length === 4 && !labels.includes('Fri')) return 'Mon–Thu';
  return labels.join(', ');
}

function serviceMatchesDay(svc, dayFilter) {
  if (!dayFilter) return true;
  const days = getDays(svc);
  if (days.includes(dayFilter)) return true;
  // 'weekday' services match Mon-Fri only
  const WEEKDAYS = ['monday','tuesday','wednesday','thursday','friday'];
  if (days.includes('weekday') && WEEKDAYS.includes(dayFilter)) return true;
  // 'daily' services match all 7 days (Mon-Sun)
  const ALL_DAYS = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
  if (days.includes('daily') && ALL_DAYS.includes(dayFilter)) return true;
  return false;
}

function serviceMatchesTime(svc, timeFilter) {
  if (!timeFilter) return true;
  if (!svc.time) return false; // no time = can't match a time filter
  const [h] = svc.time.split(':').map(Number);
  if (timeFilter === 'early')     return h < 8;
  if (timeFilter === 'morning')   return h >= 8 && h < 12;
  if (timeFilter === 'afternoon') return h >= 12 && h < 16;
  if (timeFilter === 'evening')   return h >= 16;
  return true;
}

function serviceMatchesType(svc, categoryFilter, subtypeFilter) {
  // If subtype active, use subtype matching (more specific)
  if (subtypeFilter) return serviceMatchesSubtype(svc, subtypeFilter);
  if (!categoryFilter) return true;
  const group = SERVICE_TYPE_GROUPS[categoryFilter];
  return group ? group.includes(svc.type) : true;
}

// Common abbreviations → expansions for search
const SEARCH_ABBREVIATIONS = {
  'olv': 'our lady valley',
  'olc': 'our lady czestochowa',
  'olbs': 'our lady blessed sacrament',
  'olsh': 'our lady sacred heart',
  'olmc': 'our lady mount carmel',
  'olp': 'our lady peace',
  'olf': 'our lady fatima',
  'mmh': 'mary mother hope',
  'bvm': 'blessed virgin mary',
  'smu': 'st mary assumption',
  'hf': 'holy family',
  'hc': 'holy cross',
  'hn': 'holy name',
  'ht': 'holy trinity',
  'bt': 'blessed trinity',
  'bs': 'blessed sacrament',
  'ck': 'christ king',
  'ic': 'immaculate conception',
  'dm': 'divine mercy',
  'sh': 'sacred heart',
  'stj': 'st joseph',
  'sta': 'st ann',
  'sm': 'st mary',
  'sp': 'st patrick',
  'sc': 'st cecilia',
  'se': 'st elizabeth',
  'sfa': 'st francis assisi',
  'stm': 'st michael',
  'cathedral': 'st michael cathedral',
  'tlm': 'latin traditional',
  'asl': 'asl sign language',
  'sotc': 'stations cross',
};

function parishMatchesSearch(p, q) {
  if (!q) return true;
  const svcNotes = (p.services || []).map(s => s.notes || '').join(' ');
  const svcTypes = (p.services || []).map(s => {
    const label = SERVICE_LABELS[s.type] || (s.type || 'Service').replace(/_/g, ' ');
    return label;
  }).join(' ');
  // H2: Include language names and codes in search
  const svcLangs = [...new Set((p.services || []).map(s => {
    const code = s.language || 'en';
    return (LANG_NAMES[code] || '') + ' ' + code;
  }))].join(' ');
  // WP1: Include location/church names in search index
  const locNames = (p.locations || []).map(l => l.name || '').join(' ');
  const locAddresses = (p.locations || []).map(l => l.address || '').join(' ');
  const clergyStr = (p.clergy || []).map(cl => cl.name || '').join(' ');
  const haystack = `${p.name} ${locNames} ${locAddresses} ${p.town} ${p.county} ${svcNotes} ${svcTypes} ${svcLangs} ${clergyStr}`.toLowerCase();

  // Normalize query: expand abbreviations, handle "st"/"saint" equivalence
  const words = q.toLowerCase().split(/\s+/).filter(Boolean);
  const expanded = [];
  for (const w of words) {
    // Check if the whole query (joined) is an abbreviation
    if (words.length === 1 && SEARCH_ABBREVIATIONS[w]) {
      expanded.push(...SEARCH_ABBREVIATIONS[w].split(' '));
      continue;
    }
    // Normalize st/saint/st.
    if (w === 'saint') { expanded.push('st'); continue; }
    if (w === 'st.' || w === 'st') { expanded.push('st'); continue; }
    // Normalize fr/father/fr./rev
    if (w === 'father' || w === 'reverend' || w === 'rev' || w === 'rev.') { expanded.push('fr'); continue; }
    if (w === 'fr.' || w === 'fr') { expanded.push('fr'); continue; }
    expanded.push(w);
  }

  // Also check if multi-word query forms an abbreviation
  const initials = words.map(w => w[0]).join('');
  if (initials.length >= 2 && SEARCH_ABBREVIATIONS[initials]) {
    const abbrevWords = SEARCH_ABBREVIATIONS[initials].split(' ');
    if (abbrevWords.every(aw => haystack.includes(aw))) return true;
  }

  // Build a normalized haystack with st/saint and fr/father equivalence
  const normHaystack = haystack
    .replace(/\bsaint\b/g, 'st')
    .replace(/\bst\.\b/g, 'st')
    .replace(/\bfather\b/g, 'fr')
    .replace(/\bfr\.\b/g, 'fr')
    .replace(/\bfriar\b/g, 'fr')
    .replace(/\brev\.\b/g, 'fr')
    .replace(/\brevd?\b/g, 'fr');

  return expanded.every(w => normHaystack.includes(w));
}

// ─── WP2: SEASONAL DATE AWARENESS ──────────────────────────────────────────

// Compute Easter Sunday for a given year using the Anonymous Gregorian algorithm
function computeEaster(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31); // 3=March, 4=April
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(year, month - 1, day);
}

// Get Lent date range for a given year: Ash Wednesday through Holy Saturday
function getLentRange(year) {
  const easter = computeEaster(year);
  const ashWednesday = new Date(easter);
  ashWednesday.setDate(easter.getDate() - 46); // 46 days before Easter
  const holySaturday = new Date(easter);
  holySaturday.setDate(easter.getDate() - 1);  // day before Easter
  return { start: ashWednesday, end: holySaturday };
}

// Check if a seasonal service should be visible right now
function isCurrentSeason(svc) {
  if (!svc.seasonal || !svc.seasonal.is_seasonal) return true; // not seasonal = always show
  const season = svc.seasonal.season;
  if (!season) return true;

  const now = new Date();
  const year = now.getFullYear();

  if (season === 'lent') {
    const lent = getLentRange(year);
    const today = new Date(year, now.getMonth(), now.getDate());
    return today >= lent.start && today <= lent.end;
  }
  if (season === 'holy_week') {
    const easter = computeEaster(year);
    const palmSunday = new Date(easter);
    palmSunday.setDate(easter.getDate() - 7);
    const holySaturday = new Date(easter);
    holySaturday.setDate(easter.getDate() - 1);
    const today = new Date(year, now.getMonth(), now.getDate());
    return today >= palmSunday && today <= holySaturday;
  }
  if (season === 'advent') {
    // Advent: 4 Sundays before Christmas through Dec 24
    const christmas = new Date(year, 11, 25);
    const christmasDay = christmas.getDay();
    const fourthSunday = new Date(year, 11, 25 - christmasDay);
    const adventStart = new Date(fourthSunday);
    adventStart.setDate(fourthSunday.getDate() - 21);
    const adventEnd = new Date(year, 11, 24);
    const today = new Date(year, now.getMonth(), now.getDate());
    return today >= adventStart && today <= adventEnd;
  }
  if (season === 'school_year' || season === 'academic_year') {
    const month = now.getMonth(); // 0-indexed: 0=Jan, 8=Sep
    // Sep 1 through May 15
    return month >= 8 || month <= 3 || (month === 4 && now.getDate() <= 15);
  }
  if (season === 'summer') {
    const month = now.getMonth();
    // May 16 through Aug 31
    return (month === 4 && now.getDate() >= 16) || (month >= 5 && month <= 7);
  }
  return true; // unknown season = show
}

// Determine the current liturgical season for the banner (C5)
function getCurrentLiturgicalSeason() {
  const now = new Date();
  const year = now.getFullYear();
  const today = new Date(year, now.getMonth(), now.getDate());

  // Easter & related ranges
  const easter = computeEaster(year);
  const lent = getLentRange(year);
  const palmSunday = new Date(easter); palmSunday.setDate(easter.getDate() - 7);
  const holySaturday = new Date(easter); holySaturday.setDate(easter.getDate() - 1);
  const pentecost = new Date(easter); pentecost.setDate(easter.getDate() + 49);

  // Advent: 4 Sundays before Christmas through Dec 24
  const christmas = new Date(year, 11, 25);
  const christmasDay = christmas.getDay();
  const fourthSunday = new Date(year, 11, 25 - christmasDay);
  const adventStart = new Date(fourthSunday); adventStart.setDate(fourthSunday.getDate() - 21);
  const adventEnd = new Date(year, 11, 24);

  if (today >= palmSunday && today <= holySaturday) {
    return { key: 'holy_week', label: 'Holy Week', color: '#522466', gradient: 'linear-gradient(135deg, #3d1f4e, #522466)',
             textColor: '#e8d5f5', actionColor: 'var(--gold-light)', icon: '✟' };
  }
  if (today >= lent.start && today < palmSunday) {
    return { key: 'lent', label: 'Lenten', color: '#5c2d82', gradient: 'linear-gradient(135deg, #4a2264, #5c2d82)',
             textColor: '#dcc8ed', actionColor: 'var(--gold-light)', icon: '✟' };
  }
  if (today >= easter && today <= pentecost) {
    return { key: 'easter', label: 'Easter', color: '#a68a2a', gradient: 'linear-gradient(135deg, #8a7020, #a68a2a)',
             textColor: '#fff8e1', actionColor: '#fff', icon: '✦' };
  }
  if (today >= adventStart && today <= adventEnd) {
    return { key: 'advent', label: 'Advent', color: '#2d4a7a', gradient: 'linear-gradient(135deg, #1e3a5f, #2d4a7a)',
             textColor: '#c8d8f0', actionColor: '#e8d5f5', icon: '✦' };
  }
  // Ordinary Time
  return { key: 'ordinary', label: 'Ordinary Time', color: '#3a7a3a', gradient: 'linear-gradient(135deg, #2a5e2a, #3a7a3a)',
           textColor: '#d4ecd4', actionColor: '#fff', icon: '✦' };
}

// ─── RENDERING ───────────────────────────────────────────────────────────────

// Canonical day sort order
const DAY_ORDER = [
  'sunday','saturday','monday','tuesday','wednesday','thursday','friday',
  'weekday','daily','first_friday','first_saturday',
  'holyday','holyday_eve',
];

function dayRank(day) {
  const i = DAY_ORDER.indexOf(day);
  return i === -1 ? 99 : i;
}

// Regular days eligible for collapsing (special/nth days stay separate)
const COLLAPSIBLE_DAYS = new Set([
  'monday','tuesday','wednesday','thursday','friday','saturday','sunday'
]);

// Collapse services that share the same time+type+language+notes into combined day rows.
// e.g. Mon 8AM + Tue 8AM + Thu 8AM → [Mon,Tue,Thu] 8AM as a single entry.
function collapseServiceDays(services) {
  const collapsible = services.filter(s => {
    const days = getDays(s);
    return days.length === 1 && COLLAPSIBLE_DAYS.has(days[0]);
  });
  const fixed = services.filter(s => {
    const days = getDays(s);
    return !(days.length === 1 && COLLAPSIBLE_DAYS.has(days[0]));
  });

  // Group collapsible by signature: type|time|end_time|language|notes|seasonal|location_id
  const buckets = new Map();
  for (const svc of collapsible) {
    const sig = `${svc.type}|${svc.time||''}|${svc.end_time||''}|${svc.language||'en'}|${svc.notes||''}|${(svc.seasonal&&svc.seasonal.season)||''}|${svc.location_id||''}`;
    if (!buckets.has(sig)) buckets.set(sig, { proto: svc, days: [] });
    buckets.get(sig).days.push(getDays(svc)[0]);
  }

  const collapsed = [...buckets.values()].map(({ proto, days }) => {
    if (days.length === 1) return proto; // no change needed
    // Return a synthetic entry with a `days` array (plural)
    return { ...proto, day: undefined, days: days.sort((a,b) => dayRank(a)-dayRank(b)) };
  });

  return [...fixed, ...collapsed];
}

// Card-level grouping: keeps adoration separate from devotion for display
const CARD_TYPE_GROUPS = {
  mass:       ['sunday_mass','daily_mass','communion_service','holy_thursday_mass','good_friday_service','easter_vigil_mass'],
  confession: ['confession'],
  adoration:  ['adoration','holy_hour','perpetual_adoration','benediction'],
  devotion:   ['rosary','divine_mercy','miraculous_medal','novena',
               'stations_of_cross','stations_of_the_cross','anointing_of_sick',
               'anointing','devotion','vespers','prayer_group',
               'divine_mercy_chaplet','devotional','gorzkie_zale'],
  community:  ['bible_study','mens_group','social_event'],
};

function isServiceActive(svc) {
  if (svc.status === 'inactive') return false;
  if (svc.effective_date) {
    const today = new Date().toISOString().slice(0, 10);
    if (svc.effective_date > today) return false;
  }
  return true;
}

function groupServices(services) {
  const groups = { mass:[], confession:[], adoration:[], devotion:[], community:[], other:[] };
  // Pre-pass: remove cross-type duplicates in devotion family
  // When devotion + a more specific type (divine_mercy, holy_hour, benediction) share same day+time,
  // keep the specific type and drop the generic 'devotion' entry
  const DEVOTION_SPECIFIC = new Set(['divine_mercy','holy_hour','benediction','divine_mercy_chaplet']);
  const specificKeys = new Set();
  for (const svc of services) {
    if (!isServiceActive(svc)) continue;
    if (DEVOTION_SPECIFIC.has(svc.type)) {
      const days = getDays(svc);
      for (const d of (days.length ? days : [''])) {
        specificKeys.add(`${d}|${svc.time || ''}`);
      }
    }
  }
  const filtered = services.filter(svc => {
    if (!isServiceActive(svc)) return true; // let groupServices skip these below
    if (svc.type !== 'devotion') return true;
    const days = getDays(svc);
    for (const d of (days.length ? days : [''])) {
      if (specificKeys.has(`${d}|${svc.time || ''}`)) return false;
    }
    return true;
  });

  for (const svc of filtered) {
    if (!isServiceActive(svc)) continue;
    let placed = false;
    for (const [key, types] of Object.entries(CARD_TYPE_GROUPS)) {
      if (types.includes(svc.type)) { groups[key].push(svc); placed = true; break; }
    }
    if (!placed) groups.other.push(svc);
  }
  // Deduplicate within each group:
  // Remove exact duplicates (same type+day+time); prefer year_round over seasonal, prefer more notes
  for (const key of Object.keys(groups)) {
    const arr = groups[key];
    if (arr.length < 2) continue;
    const seen = new Map(); // key -> best service
    for (const s of arr) {
      const sea = s.seasonal;
      const seasonTag = (sea && sea.is_seasonal && sea.season !== 'year_round') ? sea.season : 'yr';
      const days = getDays(s);
      const dayList = days.length ? days : [''];
      for (const d of dayList) {
        const k = `${s.type}|${d}|${s.time || ''}`;
        if (!seen.has(k)) {
          seen.set(k, s);
        } else {
          const existing = seen.get(k);
          const exSea = existing.seasonal;
          const exTag = (exSea && exSea.is_seasonal && exSea.season !== 'year_round') ? exSea.season : 'yr';
          if (seasonTag === 'yr' && exTag !== 'yr') {
            seen.set(k, s);
          } else if (seasonTag === 'yr' && exTag === 'yr') {
            const sInfo = (s.notes || '').length + (s.end_time ? 1 : 0);
            const eInfo = (existing.notes || '').length + (existing.end_time ? 1 : 0);
            if (sInfo > eInfo) seen.set(k, s);
          }
        }
      }
    }
    const winners = new Set(seen.values());
    const unique = [];
    const refs = new Set();
    for (const s of arr) {
      if (winners.has(s) && !refs.has(s)) { unique.push(s); refs.add(s); }
    }
    groups[key] = unique;
  }
  return groups;
}

// ─── COLLAPSIBLE SECTION HELPERS ──────────────────────────────────────────────

function toggleSection(el) {
  const wrapper = el.closest('.svc-collapse');
  if (wrapper) wrapper.classList.toggle('open');
}

function buildSectionSummary(sectionKey, filteredServices) {
  if (!filteredServices.length) return '';
  const n = filteredServices.length;

  if (sectionKey === 'mass') {
    const daySet = new Set();
    filteredServices.forEach(s => getDays(s).forEach(d => daySet.add(d)));
    const dayStr = fmtDays([...daySet].sort((a,b) => dayRank(a) - dayRank(b)));
    return `${n} service${n!==1?'s':''} · ${dayStr}`;
  }

  if (sectionKey === 'confession') {
    // Show up to 3 actual day+time combos
    const combos = filteredServices
      .filter(s => s.time)
      .sort((a,b) => dayRank(getDays(a)[0]||'') - dayRank(getDays(b)[0]||''))
      .slice(0, 3)
      .map(s => {
        const d = fmtDays(getDays(s));
        return `${d} ${fmtTimeRange(s)}`;
      });
    if (combos.length) return combos.join(', ');
    return `${n} time${n!==1?'s':''}`;
  }

  if (sectionKey === 'adoration') {
    const daySet = new Set();
    filteredServices.forEach(s => getDays(s).forEach(d => daySet.add(d)));
    const dayStr = fmtDays([...daySet].sort((a,b) => dayRank(a) - dayRank(b)));
    return `${n} service${n!==1?'s':''}` + (dayStr ? ` · ${dayStr}` : '');
  }

  if (sectionKey === 'devotion') {
    // List distinct service type labels
    const typeSet = new Set();
    filteredServices.forEach(s => {
      const label = SERVICE_LABELS[s.type] || (s.type || 'Service').replace(/_/g,' ');
      typeSet.add(label);
    });
    const types = [...typeSet].slice(0, 4);
    return types.join(', ') + (typeSet.size > 4 ? ` +${typeSet.size - 4}` : '');
  }

  if (sectionKey === 'lent') {
    const typeSet = new Set();
    filteredServices.forEach(s => {
      const label = SERVICE_LABELS[s.type] || (s.type || 'Service').replace(/_/g,' ');
      typeSet.add(label);
    });
    const daySet = new Set();
    filteredServices.forEach(s => getDays(s).forEach(d => daySet.add(d)));
    const dayStr = fmtDays([...daySet].sort((a,b) => dayRank(a) - dayRank(b)));
    const types = [...typeSet].slice(0, 3).join(', ');
    return types + (dayStr ? ` · ${dayStr}` : '');
  }

  return `${n} service${n!==1?'s':''}`;
}

function wrapCollapsible(sectionKey, title, icon, innerHtml, filteredServices, collapsed) {
  if (!innerHtml) return '';
  const summary = buildSectionSummary(sectionKey, filteredServices);
  const openClass = collapsed ? '' : ' open';
  return `<div class="svc-collapse svc-collapse--${sectionKey}${openClass}">
    <div class="svc-collapse-header" onclick="toggleSection(this)">
      <span class="svc-collapse-chevron">▶</span>
      <span class="svc-collapse-label">${title}</span>
      <span class="svc-collapse-summary">${summary}</span>
    </div>
    <div class="svc-collapse-body">${innerHtml}</div>
  </div>`;
}


// 4B: Determine if a service is happening now or starting soon
function getSvcTimeStatus(svc) {
  if (!svc.time || !svc.day) return { status: null, minsAway: null };
  // B3: Don't mark out-of-season services as live (e.g. lenten service in ordinary time)
  if (!isCurrentSeason(svc)) return { status: null, minsAway: null };

  const now = new Date();
  const currentDay = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][now.getDay()];

  const svcDays = Array.isArray(svc.day) ? svc.day : [svc.day];
  const dayMatches = svcDays.some(d =>
    d === currentDay || d === 'daily' || d === 'weekday' ||
    (d === 'monday_friday' && now.getDay() >= 1 && now.getDay() <= 5)
  );
  if (!dayMatches) return { status: null, minsAway: null };

  const [h, m] = svc.time.split(':').map(Number);
  const svcMins = h * 60 + m;
  const nowMins = now.getHours() * 60 + now.getMinutes();

  let endMins = svcMins + 60;
  if (svc.end_time) {
    const [eh, em] = svc.end_time.split(':').map(Number);
    endMins = eh * 60 + em;
  }

  if (nowMins >= svcMins && nowMins < endMins) {
    return { status: 'now', minsAway: 0 };
  }
  const minsUntil = svcMins - nowMins;
  if (minsUntil > 0 && minsUntil <= 60) {
    return { status: 'soon', minsAway: minsUntil };
  }
  return { status: null, minsAway: null };
}

// 4C: Strip redundant info from service notes
function cleanNote(note, svcType, day, season) {
  if (!note) return '';

  const SERVICE_LABELS_LOCAL = {
    'sunday_mass':'Mass', 'daily_mass':'Mass', 'confession':'Confession',
    'adoration':'Adoration', 'holy_hour':'Holy Hour', 'perpetual_adoration':'Perp. Adoration',
    'benediction':'Benediction', 'rosary':'Rosary', 'divine_mercy':'Divine Mercy',
    'stations_of_cross':'Stations of the Cross', 'stations_of_the_cross':'Stations of the Cross',
    'bible_study':'Bible Study', 'devotion':'Devotion', 'devotional':'Devotion',
    'divine_mercy_chaplet':'Divine Mercy Chaplet', 'communion_service':'Communion Service',
  };

  const DAY_VARIANTS = {
    monday:['mondays','monday'], tuesday:['tuesdays','tuesday'],
    wednesday:['wednesdays','wednesday'], thursday:['thursdays','thursday'],
    friday:['fridays','friday'], saturday:['saturdays','saturday'],
    sunday:['sundays','sunday']
  };

  const LANG_PREFIXES = ['Polish','Spanish','French','Latin','Vietnamese','Portuguese'];

  let cleaned = note;
  const typeLabel = SERVICE_LABELS_LOCAL[svcType] || (svcType || '').replace(/_/g, ' ');

  // Build type variants
  const typeVars = new Set([typeLabel.toLowerCase()]);
  if (!typeLabel.endsWith('s')) typeVars.add(typeLabel.toLowerCase() + 's');
  if (svcType === 'confession') { typeVars.add('confessions'); typeVars.add('reconciliation'); }
  if (svcType && svcType.includes('stations')) { typeVars.add('stations of the cross'); typeVars.add('stations'); }
  if (svcType === 'bible_study') typeVars.add('bible study');
  if (svcType === 'adoration') typeVars.add('eucharistic adoration');

  const sortedVars = [...typeVars].sort((a,b) => b.length - a.length);

  // Strip language prefix + type
  let detectedLang = '';
  for (const lp of LANG_PREFIXES) {
    for (const tv of sortedVars) {
      const combo = lp.toLowerCase() + ' ' + tv;
      if (cleaned.toLowerCase().startsWith(combo)) {
        cleaned = cleaned.slice(combo.length).replace(/^[\s\u2014\u2013\-,.:;]+/, '');
        detectedLang = lp;
        break;
      }
    }
    if (detectedLang) break;
  }

  // Strip "Lenten" + type, or just type from start
  if (!detectedLang) {
    for (const prefix of ['lenten ', '']) {
      for (const tv of sortedVars) {
        const pattern = prefix + tv;
        if (cleaned.toLowerCase().startsWith(pattern)) {
          cleaned = cleaned.slice(pattern.length).replace(/^[\s\u2014\u2013\-,.:;]+/, '');
          break;
        }
      }
    }
  }

  // Strip leading dash
  cleaned = cleaned.replace(/^[\s\u2014\u2013\-]+/, '');

  // Strip season references
  if (season === 'lent') {
    cleaned = cleaned.replace(/\s*during Lent\b/gi, '');
    cleaned = cleaned.replace(/\s*of Lent\b/gi, '');
    cleaned = cleaned.replace(/\bLenten season\b/gi, '');
    cleaned = cleaned.replace(/\bLenten\b/gi, '');
  }

  // Strip day references
  const dayList = Array.isArray(day) ? day : (day ? [day] : []);
  for (const d of dayList) {
    if (DAY_VARIANTS[d]) {
      for (const dp of DAY_VARIANTS[d]) {
        cleaned = cleaned.replace(new RegExp('\\b' + dp + '\\b', 'gi'), '');
      }
    }
  }

  // Strip filler
  cleaned = cleaned.replace(/\bevery\b/gi, '');

  // Cleanup punctuation artifacts
  cleaned = cleaned.replace(/[\s\u2014\u2013\-,.:;]+$/g, '');
  cleaned = cleaned.replace(/^[\s\u2014\u2013\-,.:;]+/g, '');
  cleaned = cleaned.replace(/\s+/g, ' ').trim();

  // Re-add language prefix if it was stripped
  if (detectedLang && !cleaned) return detectedLang;
  if (detectedLang && cleaned) return detectedLang + ' \u2014 ' + cleaned;

  // If what's left is very short and generic, hide entirely
  if (cleaned.length <= 3) return '';

  return cleaned;
}


function renderServiceSection(title, icon, services, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite) {
  const filtered = services.filter(s =>
    isCurrentSeason(s) &&
    serviceMatchesDay(s, dayFilter) &&
    serviceMatchesTime(s, timeFilter) &&
    serviceMatchesType(s, categoryFilter, subtypeFilter) &&
    (!langFilter || s.language === langFilter)
  );
  if (!filtered.length) return '';

  // Collapse Mon/Tue/Wed etc. entries that share time+type into single multi-day rows
  const collapsed = collapseServiceDays(filtered);

  // Group by day key
  const byDay = new Map();
  for (const svc of collapsed) {
    const days = getDays(svc);
    const key  = days.sort((a,b) => dayRank(a)-dayRank(b)).join(',') || 'varies';
    if (!byDay.has(key)) byDay.set(key, { days, svcs: [] });
    byDay.get(key).svcs.push(svc);
  }

  // Sort day-groups by canonical day order
  const sorted = [...byDay.values()].sort((a, b) => {
    const ra = Math.min(...a.days.map(dayRank));
    const rb = Math.min(...b.days.map(dayRank));
    return ra - rb;
  });

  const rows = sorted.map(({ days, svcs }) => {
    const dayStr = fmtDays(days);

    // Sort services within day by time
    svcs.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

    // Decide layout: stack if any entry has a note after cleaning; inline otherwise
    const anyNote = svcs.some(s => {
      const svcSeason = (s.seasonal && s.seasonal.season) || '';
      return !!cleanNote(s.notes, s.type, s.day, svcSeason);
    });

    const entryHtml = svc => {
      const timePrefix = svc.time_is_inferred ? '~' : '';
      const timeStr = timePrefix + fmtTimeRange(svc);
      const timeTitle = svc.time_is_inferred ? ' title="Time is approximate — check bulletin to confirm"' : '';
      const lang    = svc.language && svc.language !== 'en'
        ? `<span class="lang-tag" title="${LANG_NAMES[svc.language]||svc.language}">${LANG_LABELS[svc.language]||svc.language}</span>` : '';
      const rite    = svc.rite === 'tridentine'
        ? '<span class="rite-tag" title="Traditional Latin Mass">TLM</span>' : '';
      const season  = svc.seasonal && svc.seasonal.is_seasonal && SEASON_LABELS[svc.seasonal.season]
        ? `<span class="seasonal-tag">${SEASON_LABELS[svc.seasonal.season]}</span>` : '';
      const label   = SERVICE_LABELS[svc.type] || (svc.type || 'Service').replace(/_/g,' ');
      const showLabel = label.toLowerCase() !== title.toLowerCase();
      const typeTag = showLabel ? `<span class="svc-type-tag">${label}</span>` : '';
      // 4C: Clean redundant info from notes
      const svcSeason = (svc.seasonal && svc.seasonal.season) || '';
      const note    = cleanNote(svc.notes, svc.type, svc.day, svcSeason);
      // WP1-1C: Location label for multi-site parishes
      const locLabel = (isMultiSite && svc.location_id && locMap && locMap[svc.location_id])
        ? `<span class="svc-location-label">&middot; ${locMap[svc.location_id].short_name || locMap[svc.location_id].name}</span>` : '';
      // WP3: YC badge on linked services
      const ycTag = ycServiceIds.has(svc.id) ? '<span class="svc-yc-tag">YC</span>' : '';
      // 4B: Now/Soon status
      const timeStatus = getSvcTimeStatus(svc);
      const nowLabel = timeStatus.status === 'now'
        ? '<span class="svc-now-label">Now</span>'
        : (timeStatus.status === 'soon'
          ? `<span class="svc-soon-label">In ${timeStatus.minsAway} min</span>`
          : '');
      const rowClass = timeStatus.status === 'now' ? ' svc-row-now'
        : (timeStatus.status === 'soon' ? ' svc-row-soon' : '');
      return { timeStr, timeTitle, lang, rite, season, typeTag, note, locLabel, ycTag, nowLabel, rowClass };
    };

    let timesHtml;
    // For inline layout, determine the most urgent rowClass across all svcs in the day-group
    let groupRowClass = '';
    if (!anyNote) {
      // Inline: "8 AM · 10:30 AM · Noon"
      const entries = svcs.map(svc => ({ svc, e: entryHtml(svc) }));
      // Pick most urgent status for the <li> row class
      for (const { e } of entries) {
        if (e.rowClass === ' svc-row-now') { groupRowClass = ' svc-row-now'; break; }
        if (e.rowClass === ' svc-row-soon') groupRowClass = ' svc-row-soon';
      }
      timesHtml = `<span class="svc-inline">${
        entries.map(({ e }) => {
          return `<span class="svc-t"${e.timeTitle}>${e.timeStr}${e.locLabel}${e.typeTag}${e.lang}${e.rite}${e.season}${e.ycTag}${e.nowLabel}</span>`;
        }).join('<span class="svc-sep">·</span>')
      }</span>`;
    } else {
      // Stacked: one entry per line, note beneath — apply rowClass per svc-stack-row
      const entries = svcs.map(svc => ({ svc, e: entryHtml(svc) }));
      for (const { e } of entries) {
        if (e.rowClass === ' svc-row-now') { groupRowClass = ' svc-row-now'; break; }
        if (e.rowClass === ' svc-row-soon') groupRowClass = ' svc-row-soon';
      }
      timesHtml = `<span class="svc-stack">${
        entries.map(({ e }) => {
          const noteHtml = e.note ? `<span class="svc-note-line">${e.note}</span>` : '';
          // B1: nowLabel after note so countdown never gets clipped by note text
          return `<span class="svc-stack-row"><span class="svc-t"${e.timeTitle}>${e.timeStr}</span>${e.locLabel}${e.typeTag}${e.lang}${e.rite}${e.season}${e.ycTag}${noteHtml}${e.nowLabel}</span>`;
        }).join('')
      }</span>`;
    }

    return `<li class="service-row${groupRowClass}">
      <span class="svc-day">${dayStr || 'Varies'}</span>
      <span class="svc-times">${timesHtml}</span>
    </li>`;
  }).join('');

  return `<div class="service-section">
    <div class="service-section-title">${title}</div>
    <ul class="service-list">${rows}</ul>
  </div>`;
}

// Renders Mass section with holy day entries pinned at bottom behind a sub-divider
function renderMassSectionWithHolyDays(services, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite) {
  const HOLYDAY_DAYS = ['holyday', 'holyday_eve'];

  // Split into regular (excluding lenten) and holy day services
  const regular  = services.filter(s => !HOLYDAY_DAYS.includes(s.day) && !(s.seasonal && s.seasonal.season === 'lent'));
  const holydays = services.filter(s => HOLYDAY_DAYS.includes(s.day));

  const regularSect  = renderServiceSection('Mass', 'mass', regular,   dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  const holydaySect  = renderServiceSection('Mass', 'mass', holydays,  dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);

  if (!regularSect && !holydaySect) return '';

  if (regularSect && holydaySect) {
    // Inject holy days at the bottom of the same section with a sub-divider
    const holyRows = holydaySect.match(/<ul class="service-list">([\s\S]*?)<\/ul>/)?.[1] || '';
    return regularSect.replace(/<\/ul>\s*<\/div>$/,
      `<hr class="holyday-divider"><span class="holyday-sub-label">Holy Days of Obligation</span>${holyRows}</ul></div>`);
  }

  // Only one of the two has content — render whichever exists, adding holy day label if needed
  if (holydaySect && !regularSect) {
    return holydaySect.replace(/<ul class="service-list">/,
      `<ul class="service-list"><span class="holyday-sub-label">Holy Days of Obligation</span>`);
  }
  return regularSect;
}

// Renders a dedicated Lenten Services section aggregating all seasonal=lent services
function renderLentenSection(allServices, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite) {
  const lentSvcs = allServices.filter(s => s.seasonal && s.seasonal.season === 'lent' && isCurrentSeason(s));
  if (!lentSvcs.length) return '';

  // Apply active filters
  const filtered = lentSvcs.filter(s =>
    serviceMatchesDay(s, dayFilter) &&
    serviceMatchesTime(s, timeFilter) &&
    serviceMatchesType(s, categoryFilter, subtypeFilter) &&
    (!langFilter || s.language === langFilter)
  );
  if (!filtered.length) return '';

  // Group by day
  const byDay = new Map();
  for (const svc of filtered) {
    const days = getDays(svc);
    const key  = days.sort((a,b) => dayRank(a)-dayRank(b)).join(',') || 'varies';
    if (!byDay.has(key)) byDay.set(key, { days, svcs: [] });
    byDay.get(key).svcs.push(svc);
  }

  const sorted = [...byDay.values()].sort((a, b) =>
    Math.min(...a.days.map(dayRank)) - Math.min(...b.days.map(dayRank))
  );

  const rows = sorted.map(({ days, svcs }) => {
    const dayStr = fmtDays(days);
    svcs.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

    const entryHtml = svc => {
      const timePrefix = svc.time_is_inferred ? '~' : '';
      const timeStr = timePrefix + fmtTimeRange(svc);
      const timeTitle = svc.time_is_inferred ? ' title="Time is approximate — check bulletin to confirm"' : '';
      const label   = SERVICE_LABELS[svc.type] || (svc.type || 'Service').replace(/_/g,' ');
      const typeTag = `<span class="svc-type-tag">${label}</span>`;
      const lang    = svc.language && svc.language !== 'en'
        ? `<span class="lang-tag">${LANG_LABELS[svc.language]||svc.language}</span>` : '';
      const rite    = svc.rite === 'tridentine'
        ? '<span class="rite-tag" title="Traditional Latin Mass">TLM</span>' : '';
      // WP1-1C: Location label for multi-site parishes
      const locLabel = (isMultiSite && svc.location_id && locMap && locMap[svc.location_id])
        ? `<span class="svc-location-label">&middot; ${locMap[svc.location_id].short_name || locMap[svc.location_id].name}</span>` : '';
      const ycTag = ycServiceIds.has(svc.id) ? '<span class="svc-yc-tag">YC</span>' : '';
      // 4C: Clean redundant info from lenten notes
      const note = cleanNote(svc.notes, svc.type, svc.day, 'lent');
      // 4B: Now/Soon status
      const timeStatus = getSvcTimeStatus(svc);
      const nowLabel = timeStatus.status === 'now'
        ? '<span class="svc-now-label">Now</span>'
        : (timeStatus.status === 'soon'
          ? `<span class="svc-soon-label">In ${timeStatus.minsAway} min</span>`
          : '');
      const rowClass = timeStatus.status === 'now' ? ' svc-row-now'
        : (timeStatus.status === 'soon' ? ' svc-row-soon' : '');
      return { html: `<span class="svc-stack-row"><span class="svc-t"${timeTitle}>${timeStr}</span>${locLabel}${typeTag}${lang}${rite}${ycTag}${nowLabel}${note ? `<span class="svc-note-line">${note}</span>` : ''}</span>`, rowClass };
    };

    // Determine most urgent status for the row
    const entries = svcs.map(entryHtml);
    let groupRowClass = '';
    for (const e of entries) {
      if (e.rowClass === ' svc-row-now') { groupRowClass = ' svc-row-now'; break; }
      if (e.rowClass === ' svc-row-soon') groupRowClass = ' svc-row-soon';
    }

    return `<li class="service-row${groupRowClass}">
      <span class="svc-day">${dayStr || 'Varies'}</span>
      <span class="svc-times"><span class="svc-stack">${entries.map(e => e.html).join('')}</span></span>
    </li>`;
  }).join('');

  return `<div class="service-section lenten">
    <div class="service-section-title"><span class="icon-lent"></span>Lenten Services</div>
    <ul class="service-list">${rows}</ul>
  </div>`;
}

// WP2-2C: Render special_events (one-time events) on parish cards
function renderSpecialEvents(p) {
  if (!p.special_events || !p.special_events.length) return '';

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // DAY_ABBR map for recurring events that use 'day' field instead of 'date'
  const DAY_ABBR = {
    sunday: 'Sun', monday: 'Mon', tuesday: 'Tue', wednesday: 'Wed',
    thursday: 'Thu', friday: 'Fri', saturday: 'Sat'
  };

  // Show events that are:
  //  1) dated in the future, OR
  //  2) recurring (frequency = weekly/monthly) with an active season or year_round, OR
  //  3) seasonal-recurrence events (old schema) whose season is active
  const eligible = p.special_events.filter(evt => {
    // Old schema: recurrence object with seasonal type
    if (evt.recurrence && evt.recurrence.type === 'seasonal' && evt.recurrence.season) {
      const fakeSvc = { seasonal: { is_seasonal: true, season: evt.recurrence.season } };
      return isCurrentSeason(fakeSvc);
    }
    // New schema: frequency-based recurring events (weekly/monthly)
    if (evt.frequency === 'weekly' || evt.frequency === 'monthly') {
      // If seasonal, check if season is active; otherwise always show
      if (evt.seasonal && evt.seasonal.is_seasonal && evt.seasonal.season !== 'year_round') {
        const fakeSvc = { seasonal: evt.seasonal };
        return isCurrentSeason(fakeSvc);
      }
      return true;
    }
    // Date-based events: show if date is today or future
    if (evt.date) {
      const evtDate = new Date(evt.date + 'T00:00:00');
      return evtDate >= today;
    }
    // Annual/one-time events with seasonal info but no date: show if season active
    if (evt.seasonal && evt.seasonal.is_seasonal && evt.seasonal.season !== 'year_round') {
      const fakeSvc = { seasonal: evt.seasonal };
      return isCurrentSeason(fakeSvc);
    }
    // Fallback: skip events with no date and no recurrence/frequency
    return false;
  });

  if (!eligible.length) return '';

  // 5D: Split into recurring vs upcoming (dated)
  const recurring = [];
  const upcoming = [];
  for (const evt of eligible) {
    const isOldRecurring = evt.recurrence && evt.recurrence.type === 'seasonal';
    const isNewRecurring = evt.frequency === 'weekly' || evt.frequency === 'monthly';
    if (isOldRecurring || isNewRecurring) {
      recurring.push(evt);
    } else {
      upcoming.push(evt);
    }
  }

  // Sort recurring by day of week
  const dayOrder = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  recurring.sort((a, b) => {
    const aDay = a.day || (a.recurrence && a.recurrence.days && a.recurrence.days[0]) || '';
    const bDay = b.day || (b.recurrence && b.recurrence.days && b.recurrence.days[0]) || '';
    return (dayOrder.indexOf(aDay) - dayOrder.indexOf(bDay)) || (a.time || '').localeCompare(b.time || '');
  });

  // Sort upcoming by date
  upcoming.sort((a, b) => {
    return (a.date || 'zzzz').localeCompare(b.date || 'zzzz') || (a.time || '').localeCompare(b.time || '');
  });

  function renderEventRow(evt) {
    const isOldRecurring = evt.recurrence && evt.recurrence.type === 'seasonal';
    const isNewRecurring = evt.frequency === 'weekly' || evt.frequency === 'monthly';

    let dateStr;
    if (isOldRecurring && evt.recurrence.days && evt.recurrence.days.length) {
      const dayAbbrs = evt.recurrence.days.map(d => d.charAt(0).toUpperCase() + d.slice(1,3));
      dateStr = dayAbbrs.join(', ');
    } else if (isNewRecurring && evt.day) {
      const abbr = DAY_ABBR[evt.day] || (evt.day.charAt(0).toUpperCase() + evt.day.slice(1,3));
      dateStr = evt.frequency === 'monthly' ? `${abbr} (mo.)` : abbr;
    } else if (evt.date) {
      const d = new Date(evt.date + 'T12:00:00');
      const month = d.toLocaleString('en-US', { month: 'short' });
      const day = d.getDate();
      dateStr = `${month} ${day}`;
    } else {
      dateStr = 'See notes';
    }

    const isStandardTime = evt.time && /^\d{1,2}:\d{2}$/.test(evt.time);
    const timeStr = isStandardTime ? fmt12(evt.time) : (evt.time || '');
    const endStr = (evt.end_time && isStandardTime) ? ` – ${fmt12(evt.end_time)}` : '';

    const evtType = evt.type || evt.category || '';
    const typeName = SERVICE_LABELS[evtType] || (evtType ? evtType.replace(/_/g, ' ') : '');
    // Build display: prefer title, then use notes as the main label if available
    let displayLabel, note;
    if (evt.title) {
      displayLabel = `<strong>${evt.title}</strong>`;
      note = evt.notes ? ` — ${evt.notes}` : '';
    } else if (evt.notes) {
      // Notes IS the title content — display it as the label
      displayLabel = `<strong>${evt.notes}</strong>`;
      note = '';
    } else if (typeName) {
      displayLabel = `<strong>${typeName}</strong>`;
      note = '';
    } else {
      displayLabel = `<strong>Event</strong>`;
      note = '';
    }

    // Calendar button for dated events with a standard time
    // Bug 3 fix: recurring events with a specific date should also get a cal button
    let calHtml = '';
    if (evt.date && isStandardTime) {
      const loc0 = p.locations && p.locations[0];
      const evtLoc = (loc0 && loc0.name ? loc0.name : p.name) + ', ' + (p.town || '') + ', MA';
      const evtTitle = (evt.title || evt.notes || typeName || 'Event') + ' at ' + (loc0 ? loc0.name : p.name);
      const evtDesc = buildCalDescription({
        type: typeName || evt.type,
        notes: evt.notes || '',
        language: evt.language,
        verification: p.validation ? (p.validation.status || '') : '',
        url: (p.contact && p.contact.website) || ''
      });
      const icsUrl = generateICS(evtTitle, evt.date, evt.time, evt.end_time, evtLoc, evtDesc);
      const gcalUrl = generateGCalURL(evtTitle, evt.date, evt.time, evt.end_time, evtLoc, evtDesc);
      calHtml = `<span class="cal-dropdown"><button class="special-event-cal" onclick="event.stopPropagation(); toggleCalDropdown(this);">📅</button><div class="cal-dropdown-menu"><a href="${gcalUrl}" target="_blank" rel="noopener">Google Calendar</a><a href="${icsUrl}" download="event.ics">Download .ics</a></div></span>`;
    }

    return `<li class="special-event-row">
      <span class="special-event-date">${dateStr}</span>
      <span class="special-event-detail">${displayLabel} ${timeStr}${endStr}${note}</span>
      ${calHtml}
    </li>`;
  }

  let html = '';
  if (recurring.length && upcoming.length) {
    // Both sub-groups — show labels
    html += `<div class="special-events-subgroup-title">Recurring</div>`;
    html += recurring.map(renderEventRow).join('');
    html += `<div class="special-events-subgroup-title">Upcoming</div>`;
    html += upcoming.map(renderEventRow).join('');
  } else if (recurring.length) {
    html += recurring.map(renderEventRow).join('');
  } else {
    html += upcoming.map(renderEventRow).join('');
  }

  return `<div class="service-section special-events">
    <div class="service-section-title">Events</div>
    <ul class="service-list special-events-list">${html}</ul>
  </div>`;
}

// Render YC literal events (no service_id) on parish cards in an Events-style section
function renderYCLiteralEvents(p) {
  // Bug 2 fix: use all YC events for this parish, not just service_id-less ones.
  // service_id events were previously excluded, leaving this section always empty.
  const allYCForParish = (PARISH_DATA.yc_events || []).filter(evt => evt.parish_id === p.id);
  if (!allYCForParish.length) return '';

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const upcoming = allYCForParish.filter(evt => {
    if (!evt.date) return false;
    const evtDate = new Date(evt.date + 'T00:00:00');
    return evtDate >= today;
  }).sort((a, b) => a.date.localeCompare(b.date));
  if (!upcoming.length) return '';

  // Group by title to consolidate recurring events
  const byTitle = new Map();
  for (const evt of upcoming) {
    const key = evt.title || evt.id;
    if (!byTitle.has(key)) byTitle.set(key, []);
    byTitle.get(key).push(evt);
  }

  const rows = [];
  for (const [title, group] of byTitle) {
    const next = group[0]; // soonest
    const d = new Date(next.date + 'T12:00:00');
    const dayName = d.toLocaleString('en-US', { weekday: 'short' });
    const month = d.toLocaleString('en-US', { month: 'short' });
    const dayNum = d.getDate();
    const dateStr = `${dayName}, ${month} ${dayNum}`;

    const timeStr = next.time ? fmt12(next.time) : '';
    const endStr = next.end_time ? ` – ${fmt12(next.end_time)}` : '';
    const socialTag = next.social ? '<span class="yc-event-social-tag">✦ Social after</span>' : '';
    const noteTag = next.notes ? ` <span style="opacity:0.65;font-size:0.75rem;">— ${next.notes}</span>` : '';

    // Recurrence note for series with 2+ dates
    let recurrenceNote = '';
    if (group.length > 1) {
      const futureDates = group.slice(1).map(e => {
        const fd = new Date(e.date + 'T12:00:00');
        return `${fd.toLocaleString('en-US', { month: 'short' })} ${fd.getDate()}`;
      }).join(', ');
      recurrenceNote = `<div class="yc-recurrence-note">Monthly · also ${futureDates}</div>`;
    }

    // Calendar button for the next occurrence
    let ycCalHtml = '';
    if (next.date && next.time) {
      const loc0 = p.locations && p.locations[0];
      const evtLoc = (loc0 ? loc0.name : p.name) + ', ' + (p.town || '') + ', MA';
      const ycDesc = buildCalDescription({
        type: 'Young Catholic Event',
        notes: next.notes || '',
        verification: p.validation ? (p.validation.status || '') : '',
        url: (p.contact && p.contact.website) || ''
      });
      const icsUrl = generateICS(next.title, next.date, next.time, next.end_time, evtLoc, ycDesc);
      const gcalUrl = generateGCalURL(next.title, next.date, next.time, next.end_time, evtLoc, ycDesc);
      ycCalHtml = ` <span class="cal-dropdown"><button class="special-event-cal" onclick="event.stopPropagation(); toggleCalDropdown(this);">📅</button><div class="cal-dropdown-menu"><a href="${gcalUrl}" target="_blank" rel="noopener">Google Calendar</a><a href="${icsUrl}" download="${next.id || 'yc-event'}.ics">Download .ics</a></div></span>`;
    }

    rows.push(`<li class="yc-event-row">
      <span class="yc-event-date-col">${dateStr}</span>
      <span class="yc-event-detail-col">
        <span class="yc-event-title-tag">${next.title}</span>
        ${timeStr ? ` · ${timeStr}${endStr}` : ''}${socialTag}${ycCalHtml}${noteTag}
        ${recurrenceNote}
      </span>
    </li>`);
  }

  return `<div class="service-section special-events yc-events-section">
    <div class="service-section-title" style="color:#b8860b;"><span class="svc-yc-tag" style="margin-right:6px;font-size:0.55rem;">YC</span>Young &amp; Catholic Events</div>
    <ul class="service-list special-events-list">${rows.join('')}</ul>
  </div>`;
}


function getVerifiedBadge(p) {
  const val = p.validation;

  // No validation data at all
  if (!val) return buildVerifyBadge('red', '?', 'Unknown', {
    title: 'Not Yet Verified',
    rows: ['We haven\'t checked this parish\'s schedule yet.'],
    action: 'Call ahead to confirm times. You can help — tap "Report" to share what you know!',
  });

  // Parse source to determine how it was verified
  let sourceType = 'unknown';
  let sourceUrl = '';
  const rawSource = val.source || '';
  if (rawSource.startsWith('bulletin')) {
    sourceType = 'bulletin';
    const urlMatch = rawSource.match(/— (.+)$/);
    if (urlMatch) sourceUrl = urlMatch[1];
  } else if (rawSource.startsWith('website') || rawSource.startsWith('shrine website')) {
    sourceType = 'website';
    const urlMatch = rawSource.match(/— (.+)$/);
    if (urlMatch) sourceUrl = urlMatch[1];
  }

  // Calculate age
  let monthsOld = Infinity;
  if (val.last_checked) {
    const checked = new Date(val.last_checked);
    const now = new Date();
    monthsOld = (now.getFullYear() - checked.getFullYear()) * 12 + (now.getMonth() - checked.getMonth());
  }

  // Date label for display
  let dateLabel = '';
  if (val.bulletin_date) {
    const [yr, mo] = val.bulletin_date.split('-');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    dateLabel = months[parseInt(mo,10)-1] + ' \'' + yr.slice(2);
  } else if (val.last_checked) {
    const d = new Date(val.last_checked);
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    dateLabel = months[d.getMonth()] + ' \'' + String(d.getFullYear()).slice(2);
  }

  const status = val.status;

  // Build based on status + age
  if (status === 'verified' || status === 'manually_verified') {
    const howChecked = status === 'manually_verified'
      ? 'Confirmed directly by a parishioner'
      : sourceType === 'bulletin' ? 'Checked against the parish bulletin'
      : sourceType === 'website' ? 'Checked against the parish website'
      : 'Verified by our team';

    // Fresh (< 3 months)
    if (monthsOld < 3) {
      const shortDate = dateLabel || '';
      return buildVerifyBadge('green', '✓', shortDate || 'Verified', {
        title: '✓ Schedule Verified',
        rows: [
          `<strong>How:</strong> ${howChecked}`,
          dateLabel ? `<strong>As of:</strong> ${dateLabel}` : '',
          sourceUrl ? `<strong>Source:</strong> <a href="${sourceUrl.startsWith('http') ? sourceUrl : 'https://' + sourceUrl}" target="_blank" rel="noopener" style="color:var(--navy);text-decoration:underline;">${sourceUrl.replace(/^https?:\/\//, '').split('/')[0]}</a>` : '',
        ].filter(Boolean),
        action: 'Times should be accurate as of the date listed. Confirm with the parish bulletin before a first visit.',
      });
    }
    // Aging (3-6 months)
    else if (monthsOld < 6) {
      const shortDateY = dateLabel || '';
      return buildVerifyBadge('yellow', '–', shortDateY || 'Review', {
        title: 'Verified a Few Months Ago',
        rows: [
          `<strong>How:</strong> ${howChecked}`,
          dateLabel ? `<strong>As of:</strong> ${dateLabel}` : '',
        ].filter(Boolean),
        action: 'Times were accurate as of the date listed — worth a quick check with the parish to confirm.',
      });
    }
    // Stale (6+ months)
    else {
      return buildVerifyBadge('orange', '!', 'Older', {
        title: 'Checked a While Ago',
        rows: [
          `<strong>How:</strong> ${howChecked}`,
          dateLabel ? `<strong>As of:</strong> ${dateLabel}` : '',
        ].filter(Boolean),
        action: 'Times were accurate when checked — confirm with the parish as schedules may have updated since then.',
      });
    }
  }
  // Needs verification / deferred
  else if (status === 'needs_verification' || status === 'deferred') {
    return buildVerifyBadge('yellow', '–', 'Pending', {
      title: 'Awaiting Verification',
      rows: [
        'We have times listed but haven\'t confirmed them recently.',
        dateLabel ? `<strong>Data from:</strong> ${dateLabel}` : '',
      ].filter(Boolean),
      action: 'Give the parish a call to confirm. You can help us out — tap "Report" to share what you know!',
    });
  }
  // Low confidence
  else if (status === 'low_confidence') {
    return buildVerifyBadge('orange', '!', 'Unconfirmed', {
      title: 'Not Yet Confirmed',
      rows: [
        'These times are from an older source and haven\'t been confirmed yet.',
        dateLabel ? `<strong>Source date:</strong> ${dateLabel}` : '',
        val.recommended_action ? `<strong>Note:</strong> ${val.recommended_action}` : '',
      ].filter(Boolean),
      action: 'Check the parish bulletin or give them a call before visiting. Help us by tapping "Report"!',
    });
  }
  // Fallback
  else {
    return buildVerifyBadge('red', '?', 'Unknown', {
      title: 'Not Yet Verified',
      rows: ['We haven\'t checked this parish\'s schedule yet.'],
      action: 'Call ahead to confirm times. You can help — tap "Report" to share what you know!',
    });
  }
}

function buildVerifyBadge(tier, icon, label, detail) {
  const cls = 'verify-' + tier;
  const detailRows = detail.rows.map(r => `<div class="verify-detail-row">${r}</div>`).join('');
  return `<span class="verify-badge ${cls}" onclick="event.stopPropagation(); toggleVerifyDetail(this);">
    <span class="verify-icon">${icon}</span>${label}
    <div class="verify-detail">
      <div class="verify-detail-title">${detail.title}<button class="verify-detail-close" onclick="event.stopPropagation(); this.closest('.verify-badge').classList.remove('open');" title="Close">✕</button></div>
      ${detailRows}
      <div class="verify-detail-action">${detail.action}</div>
    </div>
  </span>`;
}

function toggleVerifyDetail(el) {
  // Close any other open badges
  document.querySelectorAll('.verify-badge.open').forEach(b => {
    if (b !== el) {
      b.classList.remove('open');
      // Reset parent card z-index
      const parentCard = b.closest('.parish-card');
      if (parentCard) parentCard.style.zIndex = '';
    }
  });
  const isOpening = !el.classList.contains('open');
  el.classList.toggle('open');
  // Elevate parent card z-index so fixed popup isn't clipped
  const parentCard = el.closest('.parish-card');
  if (parentCard) parentCard.style.zIndex = isOpening ? '9998' : '';
  // B4 fix: position the fixed detail panel relative to the badge on open
  // E6 fix: clamp to bottom viewport; flip above badge if needed
  if (isOpening) {
    const detail = el.querySelector('.verify-detail');
    if (detail) {
      const rect = el.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      // Temporarily show to measure height
      detail.style.visibility = 'hidden';
      detail.style.display = 'block';
      const detailH = detail.offsetHeight;
      detail.style.visibility = '';
      // Check if there's room below the badge
      const spaceBelow = vh - rect.bottom - 6;
      if (spaceBelow >= detailH || spaceBelow > rect.top) {
        // Place below, clamped to not overflow viewport bottom
        detail.style.top = Math.min(rect.bottom + 6, vh - detailH - 6) + 'px';
      } else {
        // Flip above the badge
        detail.style.top = Math.max(6, rect.top - detailH - 6) + 'px';
      }
      // Align right edge to badge right, but clamp to viewport
      const rightFromRight = vw - rect.right;
      detail.style.right = Math.max(6, rightFromRight) + 'px';
      detail.style.left = 'auto';
      // If it would overflow left edge, flip to left-aligned
      const estLeft = rect.right - 290;
      if (estLeft < 6) {
        detail.style.left = Math.max(6, rect.left) + 'px';
        detail.style.right = 'auto';
      }
    }
  }
}

// Close verify detail on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.verify-badge')) {
    document.querySelectorAll('.verify-badge.open').forEach(b => {
      b.classList.remove('open');
      const parentCard = b.closest('.parish-card');
      if (parentCard) parentCard.style.zIndex = '';
    });
  }
});

var ycParishIds = new Set(); // populated by renderYCEvents(), used by card rendering
var ycServiceIds = new Set(); // service IDs linked to YC events
var ycNextEventByParish = {}; // parish_id → next upcoming YC event object
var ycActiveThisWeek = new Set(); // parish_ids with a YC event this week (Sun-Sat)
var ycLiteralEventsByParish = {}; // parish_id → array of upcoming YC events without service_id
var favorites = new Set(); // WP-Favorites: parish IDs the user has favorited
var favFilterActive = false;

function renderParishCard(p, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, distMiles) {
  const isShowAll = showAllParishes.has(p.id);
  const effDay = isShowAll ? '' : dayFilter;
  const effTime = isShowAll ? '' : timeFilter;
  const effCat = isShowAll ? '' : (categoryFilter === '__lenten_only__' ? '' : categoryFilter);
  const effSub = isShowAll ? '' : subtypeFilter;
  const effLang = isShowAll ? '' : langFilter;

  const groups = groupServices(p.services || []);

  const isLentenOnly = categoryFilter === '__lenten_only__';
  const hasAny = isLentenOnly
    ? (p.services||[]).some(s => s.seasonal && s.seasonal.season === 'lent' && isCurrentSeason(s))
    : Object.values(groups).flat().some(s =>
        isCurrentSeason(s) &&
        serviceMatchesDay(s, dayFilter) &&
        serviceMatchesTime(s, timeFilter) &&
        serviceMatchesType(s, categoryFilter, subtypeFilter) &&
        (!langFilter || s.language === langFilter)
      );
  if (!hasAny && (dayFilter || timeFilter || categoryFilter || subtypeFilter || langFilter)) return '';

  const isLowConf = p.validation && (p.validation.status === 'low_confidence');

  const loc = p.locations && p.locations[0];

  // WP1-1A: Derive church display name from primary location
  let churchName = (loc && loc.name) ? loc.name : p.name;
  // Strip trailing "Church" from all names for cleaner card display
  churchName = churchName.replace(/\s+Church$/i, '');

  // WP1-1B: Multi-site detection & sibling churches
  const worshipSites = (p.locations || []).filter(l =>
    ['church', 'chapel', 'mission'].includes(l.type)
  );
  const isMultiSite = worshipSites.length > 1;
  let alsoAtHtml = '';
  if (isMultiSite) {
    const siblings = worshipSites.slice(1);
    const siblingLines = siblings.map(s => {
      const cityLabel = (s.city && s.city.toLowerCase() !== (p.town||'').toLowerCase())
        ? `, ${s.city}` : '';
      const shortLabel = s.short_name ? ` (${s.short_name})` : '';
      return `${s.name}${cityLabel}${shortLabel}`;
    }).join('<br>');
    alsoAtHtml = `<div class="also-at">Also at:<br>${siblingLines}</div>`;
  }

  // WP1-1C: Build location lookup map for service-level labels
  const locMap = {};
  (p.locations || []).forEach(l => { locMap[l.id] = l; });

  const massSect  = renderMassSectionWithHolyDays(groups.mass, effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);
  const confSect  = renderServiceSection('Confession', 'confession', groups.confession, effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);
  const adorSect  = renderServiceSection('Adoration & Prayer', 'adoration', groups.adoration, effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);
  const devotSect = renderServiceSection('Devotions', 'devotion', groups.devotion, effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);
  const commSect  = renderServiceSection('Community', 'community', groups.community, effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);
  const otherSect = renderServiceSection('Other Services', 'other', groups.other, effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);
  // Lenten section always renders if lent services exist (independent of any filter)
  const lentSect  = renderLentenSection(p.services || [], effDay, effTime, effCat, effSub, effLang, locMap, isMultiSite);

  // Pre-filter services for summaries (mirrors renderServiceSection's internal filter)
  const svcFilter = (s) =>
    isCurrentSeason(s) &&
    serviceMatchesDay(s, effDay) &&
    serviceMatchesTime(s, effTime) &&
    serviceMatchesType(s, effCat, effSub) &&
    (!effLang || s.language === effLang);
  const massFiltered  = groups.mass.filter(svcFilter);
  const confFiltered  = groups.confession.filter(svcFilter);
  const adorFiltered  = groups.adoration.filter(svcFilter);
  const devotFiltered = groups.devotion.filter(svcFilter);
  const commFiltered  = groups.community.filter(svcFilter);
  const otherFiltered = groups.other.filter(svcFilter);
  const lentFiltered  = (p.services || []).filter(s => s.seasonal && s.seasonal.season === 'lent' && isCurrentSeason(s) && serviceMatchesDay(s, effDay) && serviceMatchesTime(s, effTime) && serviceMatchesType(s, effCat, effSub) && (!effLang || s.language === effLang));

  // Determine collapse state: expanded (false) vs collapsed (true)
  // Defaults: Mass + Confession expanded; rest collapsed
  // Auto-expand: if a category filter targets this section, or search is active
  // 3C: When showAll is active, force all sections open
  const hasSearch = !!(document.getElementById('searchInput') && document.getElementById('searchInput').value.trim());
  const massCollapsed  = false; // always open
  const confCollapsed  = false; // always open
  const adorCollapsed  = isShowAll ? false : !(effCat === 'devotion' || hasSearch);
  const devotCollapsed = isShowAll ? false : !(effCat === 'devotion' || hasSearch);
  const lentCollapsed  = false; // WP9: expanded by default when pinned to top
  const otherCollapsed = isShowAll ? false : !hasSearch;
  const commCollapsed  = isShowAll ? false : !hasSearch;

  // Wrap each in collapsible
  const massWrapped  = wrapCollapsible('mass',      'Mass',              'mass',       massSect,  massFiltered,  massCollapsed);
  const confWrapped  = wrapCollapsible('confession', 'Confession',       'confession', confSect,  confFiltered,  confCollapsed);
  const adorWrapped  = wrapCollapsible('adoration',  'Adoration & Prayer','adoration', adorSect,  adorFiltered,  adorCollapsed);
  const devotWrapped = wrapCollapsible('devotion',   'Devotions',        'devotion',   devotSect, devotFiltered, devotCollapsed);
  const commWrapped  = wrapCollapsible('community',  'Community',        'community',  commSect,  commFiltered,  commCollapsed);
  const lentWrapped  = wrapCollapsible('lent',       'Lenten Services',  'lent',       lentSect,  lentFiltered,  lentCollapsed);
  const otherWrapped = wrapCollapsible('other',      'Other Services',   'other',      otherSect, otherFiltered, otherCollapsed);

  const addr = loc && loc.address ? loc.address : `${churchName}, ${p.town}, MA`;
  const mapsUrl = /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent) && !window.MSStream
    ? `https://maps.apple.com/?q=${encodeURIComponent(addr)}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
  const appleMapsIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C7.58 2 4 5.58 4 10c0 5.25 8 12 8 12s8-6.75 8-12c0-4.42-3.58-8-8-8z" fill="#34A853"/><path d="M12 2C7.58 2 4 5.58 4 10c0 5.25 8 12 8 12s8-6.75 8-12c0-4.42-3.58-8-8-8zm0 2c3.31 0 6 2.69 6 6 0 1.01-.31 2.15-.82 3.32L12 17.5l-5.18-4.18C6.31 12.15 6 11.01 6 10c0-3.31 2.69-6 6-6z" fill="#2E7D32"/><circle cx="12" cy="10" r="2.5" fill="white"/></svg>`;
  const directionsBtn = `<a class="directions-btn" href="${mapsUrl}" target="_blank" rel="noopener">${appleMapsIcon} Directions</a>`;

  const distHtml = (distMiles !== undefined && distMiles !== null)
    ? `<span class="dist-badge${distMiles <= 5 ? ' near' : ''}">${distMiles.toFixed(1)} mi</span>`
    : '';

  const multiSite = ''; // WP1-1B: replaced by alsoAtHtml in card header

  const bulletinLink = p.bulletin_url
    ? `<a class="bulletin-link" href="${p.bulletin_url}" target="_blank" rel="noopener">Bulletin</a>` : '';

  // Build contact drawer rows
  const c = p.contact || {};
  const clergy = p.clergy || [];
  const contactRows = [];
  if (c.phone) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Phone</span><span class="contact-row-val"><a href="tel:${c.phone.replace(/\D/g,'')}" class="phone-link">${c.phone}</a></span></div>`);

  if (c.emails && c.emails.length) {
    const emailList = c.emails.map(e => `<a href="mailto:${e}">${e}</a>`).join(', ');
    contactRows.push(`<div class="contact-row"><span class="contact-row-label">Email</span><span class="contact-row-val">${emailList}</span></div>`);
  }
  if (c.website) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Website</span><span class="contact-row-val"><a href="${c.website}" target="_blank" rel="noopener">${c.website.replace(/^https?:\/\//,'')}</a></span></div>`);
  if (c.office_hours) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Office hrs</span><span class="contact-row-val">${c.office_hours}</span></div>`);
  if (loc && loc.address) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Address</span><span class="contact-row-val">${loc.address}</span></div>`);
  if (c.office_address) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Mailing</span><span class="contact-row-val">${c.office_address}</span></div>`);
  // Clergy from data
  for (const cl of clergy) {
    if (cl.name) contactRows.push(`<div class="contact-row"><span class="contact-row-label">${cl.title || 'Clergy'}</span><span class="contact-row-val">${cl.name}</span></div>`);
  }
  // 5C: When clergy array is empty, show fallback message in contact drawer
  if (clergy.length === 0) {
    contactRows.push(`<div class="contact-row"><span class="contact-row-label">Clergy</span><span class="contact-row-val" style="font-style:italic;opacity:0.7;">Contact parish for clergy information</span></div>`);
  }
  if (c.notes) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Notes</span><span class="contact-row-val">${c.notes}</span></div>`);
  // 2E: Accessibility notes
  if (loc && loc.accessibility_notes) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Access</span><span class="contact-row-val" style="font-style:italic;font-size:0.72rem;">${loc.accessibility_notes}</span></div>`);

  const contactDrawer = contactRows.length
    ? `<button class="contact-toggle-btn" onclick="toggleContact(this)">Contact</button>
       <div class="contact-drawer">${contactRows.join('')}</div>` : '';

  // Pastor name for card footer — find first clergy with "Pastor" or "Rector" title
  const pastorClergy = clergy.find(cl => cl.name && /pastor|rector/i.test(cl.title || ''));
  const pastorFooter = pastorClergy
    ? `<span class="pastor-name">${pastorClergy.name}</span>`
    : (clergy.length === 0
      ? '<span class="pastor-name" style="font-style:italic;opacity:0.7;">Contact parish</span>'
      : `<span></span>`);

  // Accessibility badge
  const accessBadge = (loc && loc.is_accessible)
    ? '<span class="access-badge" title="Wheelchair accessible">♿</span>' : '';

  const confBadge = getVerifiedBadge(p);

  const confWarn = isLowConf
    ? `<div class="confidence-warn">⚠ Times may not be accurate — please check with the parish before visiting</div>` : '';

  let ycBannerHtml = '';
  if (ycParishIds.has(p.id)) {
    const nextEvt = ycNextEventByParish[p.id];
    let bannerText = '';
    if (nextEvt) {
      const d = new Date(nextEvt.date + 'T12:00:00');
      const dayName = d.toLocaleString('en-US', { weekday: 'short' });
      const month = d.toLocaleString('en-US', { month: 'short' });
      const dayNum = d.getDate();
      const timeStr = nextEvt.time ? fmt12(nextEvt.time) : '';
      bannerText = `${nextEvt.title} · ${dayName} ${month} ${dayNum}${timeStr ? ' · ' + timeStr : ''}${nextEvt.social ? ' · Social after' : ''}`;
    }
    ycBannerHtml = `<div class="parish-yc-banner"><span class="yc-banner-label">YC</span>${bannerText ? `<span class="yc-banner-text">${bannerText}</span>` : '<span class="yc-banner-text">Young &amp; Catholic</span>'}</div>`;
  }

  const isFav = favorites.has(p.id);

  // Detect if any service is happening right now for live indicator
  const now = new Date();
  const todayDayName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][now.getDay()];
  const nowMinsCard = now.getHours() * 60 + now.getMinutes();
  let hasLiveService = false;
  let liveServiceName = '';
  (p.services || []).forEach(s => {
    if (!s.time || !isCurrentSeason(s)) return;
    const days = getDays(s);
    if (!days.includes(todayDayName)) return;
    const [h, m] = s.time.split(':').map(Number);
    const svcMins = h * 60 + m;
    let endMins = svcMins + 60;
    if (s.end_time) { const [eh, em] = s.end_time.split(':').map(Number); endMins = eh * 60 + em; }
    if (nowMinsCard >= svcMins && nowMinsCard < endMins) {
      hasLiveService = true;
      if (!liveServiceName) liveServiceName = SERVICE_LABELS[s.type] || (s.type || 'Service').replace(/_/g,' ');
    }
  });
  const liveIndicatorHtml = hasLiveService
    ? `<div class="card-live-indicator"><span class="card-live-dot"></span> Live Now — ${liveServiceName}</div>`
    : '';

  // 3C: Show All Services button when filters active
  const anyFilterActive = dayFilter || timeFilter || categoryFilter || subtypeFilter || langFilter;
  const showAllBtn = anyFilterActive
    ? `<button class="show-all-btn" onclick="event.stopPropagation(); toggleShowAll(this, '${p.id}');">${isShowAll ? 'Show filtered only \u25B4' : 'Show all services \u25BE'}</button>`
    : '';

  return `<article class="parish-card${isLowConf ? ' low-confidence' : ''}${ycActiveThisWeek.has(p.id) ? ' yc-active-week' : ''}" data-parish-id="${p.id}">
    ${ycBannerHtml}
    ${liveIndicatorHtml}
    <div class="card-header">
      <div class="card-header-text">
        <h2>${churchName}</h2>
        ${alsoAtHtml}
        <div class="card-location">${p.town}, ${p.state || 'MA'}</div>
        ${confWarn}
      </div>
      <span class="county-badge">${distHtml}<button class="fav-btn${isFav ? ' favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${p.id}', this);" title="${isFav ? 'Remove from favorites' : 'Add to favorites'}">${isFav ? '❤️' : '🤍'}</button> ${confBadge}</span>
    </div>
    ${p.visitation && p.visitation.hours_note ? `<div class="visitation-bar">🕊 Open for prayer: ${p.visitation.hours_note}</div>` : ''}
    <div class="card-meta">${accessBadge}${contactDrawer}${bulletinLink}${directionsBtn}<span class="card-meta-overflow"><button class="card-meta-overflow-btn" onclick="event.stopPropagation(); toggleCardOverflow(this.parentElement);" title="More actions">⋯</button><div class="card-meta-overflow-menu"><button class="card-meta-overflow-item" onclick="event.stopPropagation(); shareParish('${p.id}', this); toggleCardOverflow(this.closest('.card-meta-overflow'));">📋 Share</button><button class="card-meta-overflow-item" onclick="event.stopPropagation(); printParish('${p.id}'); toggleCardOverflow(this.closest('.card-meta-overflow'));">🖨 Print</button></div></span></div>
    <div class="card-body">
      ${categoryFilter === '__lenten_only__' ? (
        lentWrapped +
        '<button class="show-all-btn" onclick="event.stopPropagation(); toggleShowAll(this, \'' + p.id + '\');">' + (isShowAll ? 'Show filtered only \u25B4' : 'See all services \u25BE') + '</button>' +
        (isShowAll ? massWrapped + confWrapped + adorWrapped + devotWrapped + commWrapped + otherWrapped : '')
      ) : (
        renderYCLiteralEvents(p) +
        lentWrapped + massWrapped + confWrapped + adorWrapped + devotWrapped + commWrapped + otherWrapped +
        (() => {
          const evtHtml = renderSpecialEvents(p);
          if (!evtHtml) return '';
          const evtCollapsed = isShowAll ? false : true;
          const evtCount = (p.special_events || []).length;
          return wrapCollapsible('events', 'Events', 'events', evtHtml, Array(evtCount).fill({}), evtCollapsed);
        })() +
        showAllBtn
      )}
    </div>
    <div class="card-footer">
      ${pastorFooter}
      <button class="reconcile-btn" onclick="openReconcile('${p.id}')" title="Report an update or correction">Report</button>
    </div>
  </article>`;
}

// ═══════════════════════════════════════════════════
// CALENDAR INTEGRATION
// ═══════════════════════════════════════════════════

function formatICSDate(dateStr, timeStr) {
  if (!dateStr) return '';
  const d = dateStr.replace(/-/g, '');
  const t = timeStr ? timeStr.replace(/:/g, '') + '00' : '000000';
  return d + 'T' + t;
}

// D3: Build a rich calendar event description with service metadata
function buildCalDescription(opts) {
  const lines = [];
  if (opts.type) lines.push('Service: ' + opts.type);
  if (opts.notes) lines.push('Notes: ' + opts.notes);
  if (opts.language && opts.language !== 'en') {
    const langName = LANG_NAMES[opts.language] || opts.language;
    lines.push('Language: ' + langName);
  }
  if (opts.verification) lines.push('Verification: ' + opts.verification);
  if (opts.url) lines.push(opts.url);
  return lines.join('\n');
}

function generateICS(title, dateStr, timeStr, endTimeStr, location, description) {
  const dtStart = formatICSDate(dateStr, timeStr);
  const dtEnd = endTimeStr ? formatICSDate(dateStr, endTimeStr)
    : formatICSDate(dateStr, timeStr ? (() => {
        const [h, m] = timeStr.split(':').map(Number);
        const endH = h + 1;
        return `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      })() : null);

  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//WMass Parish Finder//EN',
    'BEGIN:VEVENT',
    `DTSTART:${dtStart}`,
    dtEnd ? `DTEND:${dtEnd}` : '',
    `SUMMARY:${(title || '').replace(/[,;\\]/g, ' ')}`,
    location ? `LOCATION:${location.replace(/[,;\\]/g, ' ')}` : '',
    description ? `DESCRIPTION:${description.replace(/[,;\\]/g, ' ').replace(/\n/g, '\\n')}` : '',
    `UID:${Date.now()}-${Math.random().toString(36).slice(2)}@parishfinder`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');

  return 'data:text/calendar;charset=utf-8,' + encodeURIComponent(lines);
}

function generateGCalURL(title, dateStr, timeStr, endTimeStr, location, description) {
  const dtStart = formatICSDate(dateStr, timeStr);
  const dtEnd = endTimeStr ? formatICSDate(dateStr, endTimeStr)
    : formatICSDate(dateStr, timeStr ? (() => {
        const [h, m] = timeStr.split(':').map(Number);
        return `${String(h + 1).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      })() : null);

  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: title || '',
    dates: dtStart + '/' + (dtEnd || dtStart),
  });
  if (location) params.set('location', location);
  if (description) params.set('details', description);

  return 'https://calendar.google.com/calendar/render?' + params.toString();
}

function toggleCalDropdown(el) {
  // Close any already-open dropdown
  const existing = document.getElementById('calDropdownPortal');
  if (existing) {
    existing.remove();
    // If clicking same button that opened it, just close
    if (existing._srcBtn === el) return;
  }

  const menu = el.parentElement.querySelector('.cal-dropdown-menu');
  if (!menu) return;

  // Clone the menu and portal it to body
  const portal = menu.cloneNode(true);
  portal.id = 'calDropdownPortal';
  portal._srcBtn = el;
  portal.classList.add('open');

  // Position below the button
  const rect = el.getBoundingClientRect();
  portal.style.position = 'fixed';
  portal.style.top = (rect.bottom + 4) + 'px';
  portal.style.left = Math.max(4, Math.min(rect.left, window.innerWidth - 170)) + 'px';
  portal.style.zIndex = '9999';

  document.body.appendChild(portal);
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.cal-dropdown') && !e.target.closest('#calDropdownPortal')) {
    const portal = document.getElementById('calDropdownPortal');
    if (portal) portal.remove();
  }
});

window.addEventListener('scroll', function() {
  const portal = document.getElementById('calDropdownPortal');
  if (portal) portal.remove();
}, true);

// 3C: Show All Services toggle — Set at global scope so renderParishCard can access it
const showAllParishes = new Set();
function toggleShowAll(btn, parishId) {
  if (showAllParishes.has(parishId)) {
    showAllParishes.delete(parishId);
  } else {
    showAllParishes.add(parishId);
  }
  // render() is inside the IIFE; we call it via the scheduled re-render
  if (window._renderFn) window._renderFn();
  setTimeout(() => scrollToParish(parishId), 50);
}

(async function() {
  try {
    const resp = await fetch(PARISH_DATA_URL);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    PARISH_DATA = await resp.json();
  } catch(e) {
    document.body.innerHTML = '<div style="padding:2rem;text-align:center;color:red;font-size:1.2rem;">Error loading data. Please refresh the page.<br><small>' + e.message + '</small></div>';
    return;
  }

const parishes      = PARISH_DATA.parishes.filter(p => !(p.validation && p.validation.status === 'excluded'));
const grid          = document.getElementById('parishGrid');
const searchInput   = document.getElementById('searchInput');
const countyFilter  = document.getElementById('countyFilter');
const dayFilterEl   = document.getElementById('dayFilter');
const timeFilterEl  = document.getElementById('timeFilter');
const langFilterEl  = document.getElementById('langFilter');
const categoryChips = document.getElementById('categoryChips');
const subfilterBar  = document.getElementById('subfilterBar');
const subtypeChips  = document.getElementById('subtypeChips');
const subfilterLabel= document.getElementById('subfilterLabel');
const resultsCount  = document.getElementById('resultsCount');

let activeCategory = '';
let activeSubtype  = '';

// Stats
const totalSvc = parishes.reduce((n,p) => n + (p.services||[]).filter(s => isServiceActive(s)).length, 0);
document.getElementById('headerBadge').textContent   = `${parishes.length} Churches · ${totalSvc} Services`;

const CAT_LABELS = { mass: 'Mass type', confession: 'When', adoration: 'Type', devotion: 'Devotion' };

function buildSubChips(category) {
  const defs = SUBTYPES[category] || [];
  subtypeChips.innerHTML =
    `<button class="subchip active" data-sub="">All ${CAT_LABELS[category] || ''}</button>` +
    defs.map(d => `<button class="subchip" data-sub="${d.key}">${d.label}</button>`).join('');
  subfilterLabel.textContent = CAT_LABELS[category] || '';
}

function isAnyFilterActive() {
  return !!(searchInput.value.trim() || countyFilter.value || dayFilterEl.value ||
            timeFilterEl.value || langFilterEl.value || activeCategory);
}

function updateClearFiltersBtn() {
  const btn = document.getElementById('clearFiltersBtn');
  if (btn) btn.style.display = isAnyFilterActive() ? '' : 'none';
}

var _deepLinkParishId = null; // captured before render can strip it

function syncUrlParams() {
  const params = new URLSearchParams();
  if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
  if (countyFilter.value)       params.set('county', countyFilter.value);
  if (dayFilterEl.value)        params.set('day', dayFilterEl.value);
  if (timeFilterEl.value)       params.set('time', timeFilterEl.value);
  if (langFilterEl.value)       params.set('lang', langFilterEl.value);
  if (activeCategory)           params.set('cat', activeCategory);
  if (activeSubtype)            params.set('sub', activeSubtype);
  // Preserve deep link parish param during initial load
  if (_deepLinkParishId) params.set('parish', _deepLinkParishId);
  const str = params.toString();
  history.replaceState(null, '', str ? '?' + str : location.pathname);
}

function render() {
  const q        = searchInput.value.trim();
  const county   = countyFilter.value;
  const day      = dayFilterEl.value;
  const time     = timeFilterEl.value;
  const lang     = langFilterEl.value;
  const cat      = activeCategory;
  const subtype  = activeSubtype;

  const filtered = parishes.filter(p => {
    if (favFilterActive && !favorites.has(p.id)) return false;
    if (!parishMatchesSearch(p, q)) return false;
    if (county && p.county !== county) return false;
    // Seasonal banner filter (seasonal/triduum)
    if (seasonalBannerFilter) {
      if (seasonalBannerFilter === 'seasonal') {
        const hasSeasonal = (p.services||[]).some(s =>
          isServiceActive(s) && s.seasonal && s.seasonal.is_seasonal
          && s.seasonal.season !== 'year_round' && isCurrentSeason(s)
        );
        if (!hasSeasonal) return false;
      } else if (seasonalBannerFilter === 'triduum') {
        const hasTriduum = (p.services||[]).some(s =>
          isServiceActive(s) && ['holy_thursday_mass','good_friday_service','easter_vigil_mass'].includes(s.type)
        );
        if (!hasTriduum) return false;
      }
    }
    // 5A: Simple mode filtering
    if (isSimpleMode && simpleFilter) {
      if (simpleFilter === 'lenten') {
        // Show parishes with active Lenten services
        const hasLenten = (p.services||[]).some(s =>
          isServiceActive(s) && s.seasonal && s.seasonal.season === 'lent' && isCurrentSeason(s)
        );
        if (!hasLenten) return false;
        return true;
      }
      const sGroup = SERVICE_TYPE_GROUPS[simpleFilter];
      if (sGroup) {
        const hasMatch = (p.services||[]).some(s =>
          isServiceActive(s) && isCurrentSeason(s) && sGroup.includes(s.type)
        );
        if (!hasMatch) return false;
      }
      return true;
    }
    if (day || time || cat || subtype || lang) {
      const hasMatch = (p.services||[]).some(s =>
        isServiceActive(s) &&
        isCurrentSeason(s) &&
        serviceMatchesDay(s, day) &&
        serviceMatchesTime(s, time) &&
        serviceMatchesType(s, cat, subtype) &&
        (!lang || s.language === lang)
      );
      if (!hasMatch) return false;
    }
    return true;
  });

  // Sort based on sortMode
  if (sortMode === 'proximity' && userLat !== null) {
    filtered.sort((a, b) => {
      const da = getDistMiles(a);
      const db = getDistMiles(b);
      if (da === null && db === null) return 0;
      if (da === null) return 1;
      if (db === null) return -1;
      return da - db;
    });
  } else {
    // Alphabetical (default)
    filtered.sort((a, b) => a.name.localeCompare(b.name));
  }

  // Pin YC active-this-week parishes to top (regardless of filters)
  if (ycActiveThisWeek.size > 0) {
    const filteredIds = new Set(filtered.map(p => p.id));
    const missingYC = parishes.filter(p => ycActiveThisWeek.has(p.id) && !filteredIds.has(p.id));
    if (missingYC.length) filtered.unshift(...missingYC);
    filtered.sort((a, b) => {
      const aYC = ycActiveThisWeek.has(a.id) ? 0 : 1;
      const bYC = ycActiveThisWeek.has(b.id) ? 0 : 1;
      return aYC - bYC;
    });
  }

  // WP-Favorites: Pin favorites to top when not in favorites-only mode
  if (favorites.size > 0 && !favFilterActive) {
    filtered.sort((a, b) => {
      const aF = favorites.has(a.id) ? 0 : 1;
      const bF = favorites.has(b.id) ? 0 : 1;
      return aF - bF;
    });
  }

  var html = '';
  // Mobile collapsed favorites section — cards rendered inline within the wrapper
  if (favorites.size > 0 && !favFilterActive) {
    var favParishes = filtered.filter(function(p) { return favorites.has(p.id); });
    if (favParishes.length > 0) {
      var favRowsHtml = '';
      favParishes.forEach(function(p) {
        var loc = p.locations && p.locations[0];
        var dispName = (loc && loc.name) ? loc.name : p.name;
        dispName = dispName.replace(/\s+Church$/i, '');
        var nowD = new Date();
        var dayN = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][nowD.getDay()];
        var nowM = nowD.getHours() * 60 + nowD.getMinutes();
        var isLive = false;
        (p.services || []).forEach(function(s) {
          if (!s.time || !isCurrentSeason(s)) return;
          if (!getDays(s).includes(dayN)) return;
          var parts = s.time.split(':');
          var sm = parseInt(parts[0]) * 60 + parseInt(parts[1]);
          var em = sm + 60;
          if (s.end_time) { var ep = s.end_time.split(':'); em = parseInt(ep[0]) * 60 + parseInt(ep[1]); }
          if (nowM >= sm && nowM < em) isLive = true;
        });
        var liveHtml = isLive ? '<span class="fcc-live">Live</span>' : '';
        var badge = getVerifiedBadge(p);
        // Render full card inline
        var fullCard = '';
        try {
          if (isSimpleMode && simpleFilter) {
            fullCard = simpleFilter === 'lenten'
              ? renderParishCard(p, '', '', '__lenten_only__', '', '', getDistMiles(p))
              : renderParishCard(p, '', '', simpleFilter, '', '', getDistMiles(p));
          } else {
            fullCard = renderParishCard(p, day, time, cat, subtype, lang, getDistMiles(p));
          }
        } catch(e) { fullCard = ''; }

        favRowsHtml += '<div class="fav-collapsed-row" data-fav-row="' + p.id + '">' +
          '<span class="fcc-heart">\u2764\uFE0F</span>' +
          '<span class="fcc-name">' + dispName + '</span>' +
          liveHtml +
          '<span class="fcc-meta">' +
            '<span class="fcc-town">' + p.town + '</span>' +
            badge +
          '</span>' +
          '<span class="fcc-chevron">\u25B6</span>' +
        '</div>' +
        '<div class="fav-inline-card" data-fav-inline="' + p.id + '">' +
          (fullCard || '') +
          '<div class="fav-inline-collapse" data-fav-collapse="' + p.id + '">\u25B2 Collapse</div>' +
        '</div>';
      });

      html += '<div class="fav-section-wrapper" id="favSectionWrapper">' +
        '<div class="fav-section-header" data-fav-toggle="header">' +
          '<span class="fav-section-header-label">\u2764\uFE0F Your Churches (' + favParishes.length + ')</span>' +
          '<span style="display:flex;align-items:center;gap:8px;">' +
            '' +
            '<span class="fav-section-toggle"><span class="chevron" id="favSectionChevron">\u25BC</span> <span id="favToggleLabel">Expand</span></span>' +
          '</span>' +
        '</div>' +
        '<div class="fav-collapsed-body" id="favCollapsedBody">' + favRowsHtml + '</div>' +
      '</div>';
    }
  }

  // Render all cards (fav cards tagged for mobile CSS hiding)
  html += filtered.map(function(p) {
    try {
      var cardHtml;
      if (isSimpleMode && simpleFilter) {
        if (simpleFilter === 'lenten') {
          cardHtml = renderParishCard(p, '', '', '__lenten_only__', '', '', getDistMiles(p));
        } else {
          cardHtml = renderParishCard(p, '', '', simpleFilter, '', '', getDistMiles(p));
        }
      } else {
        cardHtml = renderParishCard(p, day, time, cat, subtype, lang, getDistMiles(p));
      }
      if (cardHtml && favorites.has(p.id) && !favFilterActive) {
        cardHtml = cardHtml.replace('<article class="parish-card', '<article data-fav-card="true" class="parish-card');
      }
      return cardHtml || '';
    } catch(e) {
      console.error('Error rendering parish', p.id, e);
      return '';
    }
  }).join('');
  grid.innerHTML = html || '<div class="no-results"><div class="cross">\u271D</div><p>No churches found matching your filters.</p></div>';

  // E3: Guard — if a fav card was tagged for hiding but doesn't exist in the favorites section, unhide it
  if (!favFilterActive) {
    grid.querySelectorAll('[data-fav-card="true"]').forEach(function(card) {
      const pid = card.getAttribute('data-parish-id');
      if (pid && !document.querySelector('[data-fav-inline="' + pid + '"]')) {
        card.removeAttribute('data-fav-card');
      }
    });
  }

  var shown = filtered.length;
  resultsCount.textContent = shown + ' of ' + parishes.length + ' shown';

  updateClearFiltersBtn();
  syncUrlParams();

  // 3D: Featured banners (Triduum > Lent > YC)
  const bannersEl = document.getElementById('featuredBanners');
  if (bannersEl) {
    let bannerHtml = '';
    const now = new Date();
    const year = now.getFullYear();

    // Check if we're in Lent
    const lentRange = getLentRange(year);
    const todayDate = new Date(year, now.getMonth(), now.getDate());
    const isLentNow = todayDate >= lentRange.start && todayDate <= lentRange.end;

    // Check if we're in Holy Week
    const easter = computeEaster(year);
    const palmSunday = new Date(easter); palmSunday.setDate(easter.getDate() - 7);
    const holySaturday = new Date(easter); holySaturday.setDate(easter.getDate() - 1);
    const isHolyWeek = todayDate >= palmSunday && todayDate <= holySaturday;

    // Show/hide the Lenten simple-mode button based on season
    const simpleLentBtn = document.getElementById('simpleLentBtn');
    if (simpleLentBtn) {
      const showLentBtn = isLentNow || isHolyWeek;
      simpleLentBtn.style.display = showLentBtn ? '' : 'none';
      // If Lent ended while lenten filter was active, reset to default
      if (!showLentBtn && simpleFilter === 'lenten') {
        simpleFilter = 'mass_confession';
        seasonalBannerFilter = '';
        document.querySelectorAll('[data-simple-cat]').forEach(b =>
          b.classList.toggle('active', b.dataset.simpleCat === 'mass_confession')
        );
      }
    }

    // In simple mode, skip the big featured banners (the button replaces them)
    if (!isSimpleMode) {

    // Triduum banner (Holy Week)
    if (isHolyWeek) {
      const hasTriduum = parishes.some(p => (p.services||[]).some(s =>
        isServiceActive(s) && ['holy_thursday_mass','good_friday_service','easter_vigil_mass'].includes(s.type)
      ));
      if (hasTriduum) {
        const isTriActive = seasonalBannerFilter === 'triduum';
        bannerHtml += `<div class="featured-banner banner-triduum${isTriActive ? ' banner-active' : ''}" onclick="filterSeasonalServices('triduum');">
          ✟ Holy Week Services — Holy Thursday · Good Friday · Easter Vigil
          <span class="banner-action">${isTriActive ? 'Clear' : 'Nearby'}</span>
        </div>`;
      }
    }

    // Seasonal services banner (C1–C5: generic, season-aware)
    // Skip if Triduum banner is already showing (avoid double banner in Holy Week)
    if (!isHolyWeek) {
      const seasonInfo = getCurrentLiturgicalSeason();
      const seasonalChurchCount = parishes.filter(p => (p.services||[]).some(s =>
        isServiceActive(s) && s.seasonal && s.seasonal.is_seasonal
        && s.seasonal.season !== 'year_round' && isCurrentSeason(s)
      )).length;
      if (seasonalChurchCount > 0) {
        const isActive = seasonalBannerFilter === 'seasonal';
        bannerHtml += `<div class="featured-banner banner-seasonal${isActive ? ' banner-active' : ''}" onclick="filterSeasonalServices('seasonal');" style="--season-gradient:${seasonInfo.gradient}; --season-text:${seasonInfo.textColor}; --season-action:${seasonInfo.actionColor};">
          ${seasonInfo.icon} Seasonal Services at ${seasonalChurchCount} Churches
          <span class="banner-action">${isActive ? 'Clear' : 'Nearby'}</span>
        </div>`;
      }
    }

    // YC banner
    if (ycActiveThisWeek.size > 0) {
      bannerHtml += `<div class="featured-banner banner-yc" onclick="switchAppView('yc');">
        ✦ Young Catholic Events This Week
        <span class="banner-action">View YC Events →</span>
      </div>`;
    }

    } // end !isSimpleMode

    bannersEl.innerHTML = bannerHtml;
  }
}

// Category chips
categoryChips.addEventListener('click', e => {
  const chip = e.target.closest('[data-cat]');
  if (!chip) return;
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  activeCategory = chip.dataset.cat;
  activeSubtype  = '';

  if (activeCategory && SUBTYPES[activeCategory]) {
    buildSubChips(activeCategory);
    subfilterBar.style.display = '';
  } else {
    subfilterBar.style.display = 'none';
    subtypeChips.innerHTML = '';
  }
  render();
});

// Subtype chips (event delegation)
subtypeChips.addEventListener('click', e => {
  const chip = e.target.closest('[data-sub]');
  if (!chip) return;
  subtypeChips.querySelectorAll('[data-sub]').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  activeSubtype = chip.dataset.sub;
  render();
});

// Other controls
searchInput.addEventListener('input', function() {
  render();
  updateAutocomplete();
});
// G5: Autocomplete dropdown
const acDropdown = document.getElementById('searchAutocomplete');
let acIndex = -1;
function updateAutocomplete() {
  const q = searchInput.value.trim().toLowerCase();
  if (q.length < 2) { acDropdown.classList.remove('open'); acDropdown.innerHTML = ''; acIndex = -1; return; }
  const matches = [];
  for (const p of parishes) {
    if (matches.length >= 7) break;
    const loc = p.locations && p.locations[0];
    const name = (loc && loc.name) ? loc.name : p.name;
    const town = p.town || '';
    const haystack = (name + ' ' + p.name + ' ' + town).toLowerCase();
    if (haystack.includes(q)) {
      matches.push({ id: p.id, name: name.replace(/\s+Church$/i, ''), town: town, parish: p.name });
    }
  }
  if (matches.length === 0) { acDropdown.classList.remove('open'); acDropdown.innerHTML = ''; acIndex = -1; return; }
  acIndex = -1;
  acDropdown.innerHTML = matches.map((m, i) =>
    `<div class="search-ac-item" role="option" data-ac-id="${m.id}" data-ac-idx="${i}"><span class="search-ac-name">${escHtml(m.name)}</span><span class="search-ac-town">${escHtml(m.town)}, MA</span></div>`
  ).join('');
  acDropdown.classList.add('open');
}
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function selectAcItem(id) {
  acDropdown.classList.remove('open');
  acDropdown.innerHTML = '';
  acIndex = -1;
  searchInput.value = '';
  render();
  scrollToParish(id);
}
acDropdown.addEventListener('mousedown', function(e) {
  e.preventDefault(); // keep focus on input
  const item = e.target.closest('.search-ac-item');
  if (item) selectAcItem(item.dataset.acId);
});
searchInput.addEventListener('keydown', function(e) {
  if (!acDropdown.classList.contains('open')) return;
  const items = acDropdown.querySelectorAll('.search-ac-item');
  if (e.key === 'ArrowDown') { e.preventDefault(); acIndex = Math.min(acIndex + 1, items.length - 1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); acIndex = Math.max(acIndex - 1, -1); }
  else if (e.key === 'Enter' && acIndex >= 0) { e.preventDefault(); selectAcItem(items[acIndex].dataset.acId); return; }
  else if (e.key === 'Escape') { acDropdown.classList.remove('open'); acIndex = -1; return; }
  else return;
  items.forEach((it, i) => it.classList.toggle('ac-active', i === acIndex));
  if (acIndex >= 0) items[acIndex].scrollIntoView({ block: 'nearest' });
});
searchInput.addEventListener('blur', function() { setTimeout(() => { acDropdown.classList.remove('open'); acIndex = -1; }, 150); });
countyFilter.addEventListener('change', render);
dayFilterEl.addEventListener('change', render);
timeFilterEl.addEventListener('change', render);
langFilterEl.addEventListener('change', render);
document.getElementById('clearFiltersBtn').addEventListener('click', function(e) {
  e.stopPropagation();
  clearAllFilters();
});

// Tap-to-expand/collapse special event detail text
grid.addEventListener('click', function(e) {
  if (e.target.closest('.cal-dropdown')) return;
  const detail = e.target.closest('.special-event-detail');
  if (detail) {
    detail.classList.toggle('expanded');
    return;
  }
});

// Proximity stubs — real implementation in location block below
var userLat = null;
var userLng = null;
function getDistMiles(p) {
  if (userLat === null) return null;
  var loc = p.locations && p.locations[0];
  if (!loc || !loc.lat || !loc.lng) return null;
  return haversine(userLat, userLng, loc.lat, loc.lng);
}
function haversine(lat1, lng1, lat2, lng2) {
  var R = 3958.8;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.pow(Math.sin(dLat/2),2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.pow(Math.sin(dLng/2),2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// Apply URL params if present (before initial render)
(function applyUrlParams() {
  const p = new URLSearchParams(location.search);
  // Capture deep link parish before render/syncUrlParams can strip it
  if (p.get('parish')) _deepLinkParishId = p.get('parish');
  if (p.get('q'))      searchInput.value = p.get('q');
  if (p.get('county')) countyFilter.value = p.get('county');
  if (p.get('day'))    dayFilterEl.value = p.get('day');
  if (p.get('time'))   timeFilterEl.value = p.get('time');
  if (p.get('lang'))   langFilterEl.value = p.get('lang');
  if (p.get('cat')) {
    activeCategory = p.get('cat');
    categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === activeCategory));
    if (SUBTYPES[activeCategory]) { buildSubChips(activeCategory); subfilterBar.style.display = ''; }
    if (p.get('sub')) {
      activeSubtype = p.get('sub');
      subtypeChips.querySelectorAll('[data-sub]').forEach(c => c.classList.toggle('active', c.dataset.sub === activeSubtype));
    }
  }
})();

// 5A: Restore simple mode from cookie
isSimpleMode = getSimpleModeCookie();
applySimpleMode();

// Load favorites before initial render so collapsed section appears immediately
loadFavorites();

// C5: Expose current liturgical season color as CSS custom property
(function setSeasonColor() {
  const season = getCurrentLiturgicalSeason();
  document.documentElement.style.setProperty('--season-color', season.color);
})();

// Initial render
renderYCEvents();
render();
applyDeepLinkParams();
window._renderFn = render;

// ═══════════════════════════════════════════════════
// LOCATION & PROXIMITY
// ═══════════════════════════════════════════════════

// userLat, userLng, haversine, getDistMiles declared in main block above
var locationStatus = 'unknown';
var soonRadiusMiles = 10;
var soonMode = 'mass'; // 'mass' | 'confession' | 'adoration' | 'seasonal'
var sortMode = 'alpha'; // 'proximity' | 'alpha'  — proximity only when location known

function requestLocation() {
  if (!navigator.geolocation) {
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      locationStatus = 'granted';
      sortMode = 'proximity';
      document.getElementById('sortToggle').classList.add('location-ready');
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === 'proximity'));
      renderYCEvents();
      render();
      if (currentView === 'now') {
        renderNowView();
      }
      if (currentView === 'yc') renderYCView();
      if (mapInitialized && appMap) {
        L.circleMarker([userLat, userLng], {
          radius: 8, fillColor: '#4285F4', fillOpacity: 0.9, color: '#fff', weight: 2
        }).addTo(appMap).bindPopup('You are here');
      }
    },
    () => {
      locationStatus = 'denied';
    },
    { timeout: 10000, enableHighAccuracy: false, maximumAge: 300000 }
  );
}

// Passive location attempt on load (no prompt shown if permission not already granted)
function initLocationBanner() {
  // Happening Soon section removed from visible UI — just attempt passive location
}
try {
  if (navigator.permissions) {
    navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
      if (result.state === 'granted') {
        requestLocation();
      } else if (result.state === 'prompt') {
        // Permissions API available but not yet decided — request will show prompt
        requestLocation();
      } else {
        initLocationBanner();
      }
    }).catch(function() {
      // Permissions API threw — fall back to direct request (Safari)
      requestLocation();
    });
  } else {
    // No Permissions API (Safari) — request directly; browser shows its own prompt
    requestLocation();
  }
} catch(e) {
  initLocationBanner();
}

// ═══════════════════════════════════════════════════
// HAPPENING SOON
// ═══════════════════════════════════════════════════

const DAY_NAMES = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

function timeToMinutes(t) {
  if (!t) return null;
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}


// Refresh soon every minute
setInterval(() => { if (currentView === 'now') renderNowView(); }, 60000);

// ═══════════════════════════════════════════════════
// YOUNG & CATHOLIC EVENTS
// ═══════════════════════════════════════════════════

function renderYCEvents() {
  const ycEvents = (PARISH_DATA.yc_events || []);
  if (!ycEvents.length) return;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const upcoming = ycEvents.filter(evt => {
    if (!evt.date) return false;
    const evtDate = new Date(evt.date + 'T00:00:00');
    return evtDate >= today;
  }).sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));

  if (!upcoming.length) return;

  // Build parish ID → name lookup for card labels
  ycParishIds.clear();
  ycServiceIds.clear();
  ycNextEventByParish = {};
  ycActiveThisWeek.clear();
  ycLiteralEventsByParish = {};

  // Compute current week window (Sunday through Saturday)
  const nowForWeek = new Date();
  const dayOfWeek = nowForWeek.getDay(); // 0=Sun
  const weekStart = new Date(nowForWeek);
  weekStart.setDate(nowForWeek.getDate() - dayOfWeek);
  weekStart.setHours(0, 0, 0, 0);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999);

  upcoming.forEach(evt => {
    if (evt.parish_id) ycParishIds.add(evt.parish_id);
    if (evt.service_id) ycServiceIds.add(evt.service_id);
    // Track the next (soonest) event per parish
    if (evt.parish_id && !ycNextEventByParish[evt.parish_id]) {
      ycNextEventByParish[evt.parish_id] = evt;
    }
    // Check if event falls within this week
    if (evt.parish_id && evt.date) {
      const evtDate = new Date(evt.date + 'T12:00:00');
      if (evtDate >= weekStart && evtDate <= weekEnd) {
        ycActiveThisWeek.add(evt.parish_id);
      }
    }
    // Build literal events map (no service_id = standalone event)
    if (evt.parish_id && !evt.service_id) {
      if (!ycLiteralEventsByParish[evt.parish_id]) {
        ycLiteralEventsByParish[evt.parish_id] = [];
      }
      ycLiteralEventsByParish[evt.parish_id].push(evt);
    }
  });

  const section = document.getElementById('ycEventsSection');
  const container = document.getElementById('ycCards');
  const subtitle = document.getElementById('ycSubtitle');

  subtitle.textContent = upcoming.length + ' upcoming';

  container.innerHTML = upcoming.map(evt => {
    // Date formatting: "Fri Mar 12"
    const d = new Date(evt.date + 'T12:00:00');
    const dayName = d.toLocaleString('en-US', { weekday: 'short' });
    const month = d.toLocaleString('en-US', { month: 'short' });
    const dayNum = d.getDate();
    const dateStr = `${dayName}, ${month} ${dayNum}`;

    const timeStr = evt.time ? fmt12(evt.time) : '';
    const endStr = evt.end_time ? ` – ${fmt12(evt.end_time)}` : '';

    // Resolve location name
    let placeName = '';
    if (evt.parish_id) {
      const p = parishes.find(x => x.id === evt.parish_id);
      if (p) {
        if (evt.location_id) {
          const loc = (p.locations || []).find(l => l.id === evt.location_id);
          if (loc) placeName = loc.name;
        }
        if (!placeName) {
          const primary = p.locations && p.locations[0];
          if (primary) {
            placeName = primary.name;
            if (/Cathedral|Basilica/i.test(placeName)) placeName = placeName.replace(/\s+Church$/i, '');
          } else {
            placeName = p.name;
          }
        }
      }
    }
    if (evt.venue_name) placeName = evt.venue_name;

    const socialTag = evt.social ? '<div class="yc-card-social">✦ Social after</div>' : '';
    const noteTag = evt.notes ? `<div style="font-size:0.6rem;color:rgba(255,255,255,0.4);margin-top:2px;">${evt.notes}</div>` : '';

    // Distance calculation
    let distTag = '';
    if (userLat !== null) {
      let evtLat = evt.venue_lat, evtLng = evt.venue_lng;
      if (!evtLat && evt.parish_id) {
        const ep = parishes.find(x => x.id === evt.parish_id);
        if (ep) {
          const eLoc = evt.location_id
            ? (ep.locations || []).find(l => l.id === evt.location_id)
            : (ep.locations && ep.locations[0]);
          if (eLoc && eLoc.lat) { evtLat = eLoc.lat; evtLng = eLoc.lng; }
        }
      }
      if (evtLat && evtLng) {
        const evtDist = haversine(userLat, userLng, evtLat, evtLng);
        distTag = `<div class="yc-card-dist">${evtDist.toFixed(1)} mi</div>`;
      }
    }

    // Calendar button
    const evtLocation = evt.venue_address || (placeName ? placeName + ', MA' : '');
    const ycTopParish = evt.parish_id ? parishes.find(x => x.id === evt.parish_id) : null;
    const evtDesc = buildCalDescription({
      type: 'Young Catholic Event' + (evt.social ? ' (Social after)' : ''),
      notes: evt.notes || '',
      verification: ycTopParish && ycTopParish.validation ? (ycTopParish.validation.status || '') : '',
      url: (ycTopParish && ycTopParish.contact && ycTopParish.contact.website) || ''
    });
    const icsUrl = generateICS(evt.title, evt.date, evt.time, evt.end_time, evtLocation, evtDesc);
    const gcalUrl = generateGCalURL(evt.title, evt.date, evt.time, evt.end_time, evtLocation, evtDesc);
    const calBtnHtml = evt.date && evt.time
      ? `<div class="cal-dropdown" onclick="event.stopPropagation();">
           <button class="cal-btn" onclick="event.stopPropagation(); toggleCalDropdown(this);">📅 Add</button>
           <div class="cal-dropdown-menu">
             <a href="${gcalUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation();">Google Calendar</a>
             <a href="${icsUrl}" download="${evt.id || 'event'}.ics" onclick="event.stopPropagation();">Download .ics</a>
           </div>
         </div>` : '';

    return `<div class="yc-card" data-parish-id="${evt.parish_id || ''}" onclick="scrollToParish('${evt.parish_id || ''}')">
      <div class="yc-card-date">${dateStr}</div>
      <div class="yc-card-title">${evt.title}</div>
      <div class="yc-card-time">${timeStr}${endStr}</div>
      <div class="yc-card-place">${placeName}</div>
      ${distTag}${socialTag}${calBtnHtml}${noteTag}
    </div>`;
  }).join('');

  // Strip moved to dedicated YC Events tab — keep container hidden
  // section.style.display = '';
}

function scrollToParish(parishId) {
  if (!parishId) return;
  const card = document.querySelector(`.parish-card[data-parish-id="${parishId}"]`);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.style.transition = 'box-shadow 0.3s';
    card.style.boxShadow = '0 0 0 2px #e8a838, 0 0 16px rgba(232,168,56,0.3)';
    setTimeout(() => { card.style.boxShadow = ''; }, 2500);
    return;
  }
  // Card not in DOM — clear filters, re-render, then try again
  clearAllFilters();
  setTimeout(() => {
    const card2 = document.querySelector(`.parish-card[data-parish-id="${parishId}"]`);
    if (card2) {
      card2.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card2.style.transition = 'box-shadow 0.3s';
      card2.style.boxShadow = '0 0 0 2px #e8a838, 0 0 16px rgba(232,168,56,0.3)';
      setTimeout(() => { card2.style.boxShadow = ''; }, 2500);
    }
  }, 150);
}

// ═══════════════════════════════════════════════════
// LANGUAGE BAR
// ═══════════════════════════════════════════════════

// langBar removed from DOM — language filtering via langFilterEl select only

// Add parish now handled via header button → openNewParish()

// ═══════════════════════════════════════════════════
// QUICK ACTIONS
// ═══════════════════════════════════════════════════

let quickActive = null;

function setQuickActive(id) {
  ['btnThisWeekend','btnLentNearMe','btnConfession','btnNearMe'].forEach(b => {
    const el = document.getElementById(b);
    if (el) el.classList.toggle('active', b === id);
  });
  const clearBtn = document.getElementById('btnClearQuick');
  if (clearBtn) clearBtn.style.display = id ? '' : 'none';
  quickActive = id;
}

function clearQuick() {
  // Reset all filters
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  if (timeFilterEl) timeFilterEl.value = '';
  langFilterEl.value = '';
  // langBar removed
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  subfilterBar.style.display = 'none';
  setQuickActive(null);
  render();
}

function quickThisWeekend() {
  if (quickActive === 'btnThisWeekend') { clearQuick(); return; }
  searchInput.value = '';
  countyFilter.value = '';
  // Saturday + Sunday = set day to sunday and also let saturday vigils show
  // Best approach: set category to mass, clear day (both days show)
  dayFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === 'mass'));
  activeCategory = 'mass';
  activeSubtype = '';
  // Build subchips for mass
  if (SUBTYPES['mass']) {
    buildSubChips('mass');
    // Auto-select weekend subtype if available
    const wkndChip = [...subtypeChips.querySelectorAll('[data-sub]')].find(c => c.dataset.sub === 'weekend_mass');
    if (wkndChip) {
      subtypeChips.querySelectorAll('[data-sub]').forEach(c => c.classList.remove('active'));
      wkndChip.classList.add('active');
      activeSubtype = 'weekend_mass';
    }
    subfilterBar.style.display = '';
  }
  setQuickActive('btnThisWeekend');
  render();
}

function quickConfession() {
  if (quickActive === 'btnConfession') { clearQuick(); return; }
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === 'confession'));
  activeCategory = 'confession';
  activeSubtype = '';
  if (SUBTYPES['confession']) {
    buildSubChips('confession');
    subfilterBar.style.display = '';
  }
  setQuickActive('btnConfession');
  render();
}

function quickNearMe() {
  if (quickActive === 'btnNearMe') { clearQuick(); return; }
  if (userLat === null) {
    requestLocation();
    // Will re-render after location granted
  }
  setQuickActive('btnNearMe');
  render();
}

function quickLentNearMe() {
  if (quickActive === 'btnLentNearMe') { clearQuick(); return; }
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  langFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  subfilterBar.style.display = 'none';
  if (userLat === null) requestLocation();
  setQuickActive('btnLentNearMe');
  render();
}

function clearAllFilters() {
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  langFilterEl.value = '';
  if (timeFilterEl) timeFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  seasonalBannerFilter = '';
  subfilterBar.style.display = 'none';
  subtypeChips.innerHTML = '';
  setQuickActive(null);
  render();
}

// 5: Seasonal banner filter — shows only parishes with seasonal services, sorted by proximity
var seasonalBannerFilter = ''; // '' | 'seasonal' | 'triduum'
function filterSeasonalServices(season) {
  // Toggle off if already active
  if (seasonalBannerFilter === season) {
    seasonalBannerFilter = '';
    render();
    return;
  }
  seasonalBannerFilter = season;
  // Request location if needed for proximity sort
  if (userLat === null) requestLocation();
  sortMode = 'proximity';
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === 'proximity'));
  document.getElementById('sortToggle').classList.add('location-ready');
  // Clear other filters so we get a clean seasonal view
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  langFilterEl.value = '';
  if (timeFilterEl) timeFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  subfilterBar.style.display = 'none';
  render();
}

function setSortMode(mode) {
  sortMode = mode;
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === mode));
  // If switching to proximity and no location yet, request it
  if (mode === 'proximity' && userLat === null) requestLocation();
  render();
}

function toggleContact(btn) {
  btn.classList.toggle('open');
  const drawer = btn.nextElementSibling;
  if (drawer) drawer.classList.toggle('open');
}

function clearLocationSort() {
  userLat = null;
  userLng = null;
  locationStatus = 'unknown';
  sortMode = 'alpha';
  const st = document.getElementById('sortToggle');
  if (st) { st.classList.remove('location-ready'); }
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === 'alpha'));
  render();
}

// ═══════════════════════════════════════════════════
// SHARE PARISH DEEP LINK
// ═══════════════════════════════════════════════════

function shareParish(parishId, btnEl) {
  const base = window.location.origin + window.location.pathname;
  const shareUrl = base + '?parish=' + encodeURIComponent(parishId);

  // Find parish name for share sheet
  const parish = parishes.find(p => p.id === parishId);
  const loc = parish && parish.locations && parish.locations[0];
  const churchName = (loc && loc.name) ? loc.name : (parish ? parish.name : 'Church');

  function showCopied() {
    if (btnEl) {
      btnEl.classList.add('copied');
      const origText = btnEl.textContent;
      btnEl.textContent = '✓ Shared!';
      setTimeout(() => { btnEl.classList.remove('copied'); btnEl.textContent = origText; }, 1800);
    }
  }

  function fallbackCopy() {
    if (navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext) {
      navigator.clipboard.writeText(shareUrl).then(showCopied).catch(() => {
        prompt('Copy this link:', shareUrl);
      });
    } else {
      const ta = document.createElement('textarea');
      ta.value = shareUrl;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); showCopied(); }
      catch(e) { prompt('Copy this link:', shareUrl); }
      document.body.removeChild(ta);
    }
  }

  // Use native share sheet on mobile if available
  // Include URL in text field — many platforms (iOS Messages, WhatsApp) only use text, not url
  if (navigator.share) {
    navigator.share({
      text: churchName + ' — Mass Finder\n' + shareUrl,
    }).then(showCopied).catch(() => { /* user cancelled share */ });
  } else {
    fallbackCopy();
  }
}

// G4: Print a single parish card
function printParish(parishId) {
  const card = document.querySelector(`[data-parish-id="${parishId}"]`);
  if (!card) return;
  // @media print stylesheet handles expanding collapsed sections
  // Add a class for print targeting
  card.classList.add('print-target');
  // Inject a print-only style that hides everything except this card
  const style = document.createElement('style');
  style.id = 'printSingleCard';
  style.textContent = `@media print { .parish-card:not(.print-target) { display: none !important; } }`;
  document.head.appendChild(style);
  window.print();
  // Clean up
  card.classList.remove('print-target');
  const s = document.getElementById('printSingleCard');
  if (s) s.remove();
}

// Card meta overflow menu
function toggleCardOverflow(el) {
  // Close all other open menus first
  document.querySelectorAll('.card-meta-overflow.open').forEach(m => {
    if (m !== el) m.classList.remove('open');
  });
  el.classList.toggle('open');
}
// Close overflow menus on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.card-meta-overflow')) {
    document.querySelectorAll('.card-meta-overflow.open').forEach(m => m.classList.remove('open'));
  }
});

// Handle ?parish=xxx deep link on load
(function handleParishDeepLink() {
  if (!_deepLinkParishId) return;
  const pid = _deepLinkParishId;
  // Wait for DOM to settle after render
  setTimeout(() => {
    const card = document.querySelector(`[data-parish-id="${pid}"]`);
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.style.transition = 'box-shadow 0.3s';
      card.style.boxShadow = '0 0 0 3px var(--gold), 0 0 20px rgba(201,168,76,0.3)';
      setTimeout(() => {
        card.style.boxShadow = '';
        // Clear deep link param from URL after highlight fades
        _deepLinkParishId = null;
        syncUrlParams();
      }, 3500);
    }
  }, 400);
})();

// ═══════════════════════════════════════════════════
// FAVORITES (WP-Favorites)
// ═══════════════════════════════════════════════════

function loadFavorites() {
  try {
    const raw = document.cookie.split('; ').find(c => c.startsWith('pf_favs='));
    if (raw) {
      const ids = JSON.parse(decodeURIComponent(raw.split('=')[1]));
      ids.forEach(id => favorites.add(id));
    }
  } catch(e) {}
  // G3: Import favorites from URL param
  try {
    const urlFavs = new URLSearchParams(location.search).get('favs');
    if (urlFavs) {
      const imported = urlFavs.split(',').filter(Boolean);
      let added = 0;
      imported.forEach(id => {
        if (!favorites.has(id)) { favorites.add(id); added++; }
      });
      if (added > 0) {
        saveFavorites(); // persist imported favorites
        // Clean the favs param from URL
        const p = new URLSearchParams(location.search);
        p.delete('favs');
        const str = p.toString();
        history.replaceState(null, '', str ? '?' + str : location.pathname);
      }
    }
  } catch(e) {}
  updateFavChip();
}

// G3: Share favorites as URL
function shareFavorites(btnEl) {
  if (favorites.size === 0) return;
  const ids = [...favorites].join(',');
  const url = location.origin + location.pathname + '?favs=' + encodeURIComponent(ids);
  if (navigator.share) {
    navigator.share({ title: 'My Mass Finder Churches', url: url }).catch(() => {});
  } else if (navigator.clipboard) {
    navigator.clipboard.writeText(url).then(() => {
      if (btnEl) { const orig = btnEl.textContent; btnEl.textContent = 'Copied!'; setTimeout(() => btnEl.textContent = orig, 1500); }
    });
  }
}

function saveFavorites() {
  const val = JSON.stringify([...favorites]);
  const d = new Date(); d.setFullYear(d.getFullYear() + 2);
  document.cookie = 'pf_favs=' + encodeURIComponent(val) + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
  updateFavChip();
}

// ── Collapsible favorites section (mobile only, event delegation) ──
grid.addEventListener('click', function(e) {
  // Header toggle: expand/collapse ALL rows
  var header = e.target.closest('[data-fav-toggle="header"]');
  if (header) {
    e.stopPropagation();
    var body = document.getElementById('favCollapsedBody');
    var chevron = document.getElementById('favSectionChevron');
    var label = document.getElementById('favToggleLabel');
    if (!body) return;
    var isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : '';
    if (chevron) chevron.textContent = isOpen ? '\u25B6' : '\u25BC';
    if (label) label.textContent = isOpen ? 'Expand' : 'Collapse';
    return;
  }
  // Row toggle: expand/collapse individual church card
  var row = e.target.closest('[data-fav-row]');
  if (row) {
    e.stopPropagation();
    var pid = row.getAttribute('data-fav-row');
    var inlineCard = document.querySelector('[data-fav-inline="' + pid + '"]');
    if (!inlineCard) return;
    var wasOpen = inlineCard.classList.contains('open');
    // Close all other open inline cards
    document.querySelectorAll('.fav-inline-card.open').forEach(function(el) {
      el.classList.remove('open');
    });
    document.querySelectorAll('.fav-collapsed-row.row-open').forEach(function(el) {
      el.classList.remove('row-open');
    });
    if (!wasOpen) {
      inlineCard.classList.add('open');
      row.classList.add('row-open');
      setTimeout(function() {
        inlineCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 50);
    }
    return;
  }
  // Collapse bar: close the expanded inline card
  var collapseBar = e.target.closest('[data-fav-collapse]');
  if (collapseBar) {
    e.stopPropagation();
    var cpid = collapseBar.getAttribute('data-fav-collapse');
    var cInline = document.querySelector('[data-fav-inline="' + cpid + '"]');
    var cRow = document.querySelector('[data-fav-row="' + cpid + '"]');
    if (cInline) cInline.classList.remove('open');
    if (cRow) cRow.classList.remove('row-open');
    if (cRow) {
      setTimeout(function() {
        cRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 50);
    }
    return;
  }
});

function toggleFavorite(parishId, btnEl) {
  if (favorites.has(parishId)) {
    favorites.delete(parishId);
    if (btnEl) { btnEl.classList.remove('favorited'); btnEl.textContent = '🤍'; btnEl.title = 'Add to favorites'; }
  } else {
    favorites.add(parishId);
    if (btnEl) { btnEl.classList.add('favorited'); btnEl.textContent = '❤️'; btnEl.title = 'Remove from favorites'; }
  }
  saveFavorites();
  if (favFilterActive) render();
  // Re-render Today tab if it's active
  if (currentView === 'now') { renderTodayFavSection(); renderTomorrowSection(); }
}

function toggleFavFilter() {
  favFilterActive = !favFilterActive;
  const chip = document.getElementById('favFilterChip');
  if (chip) chip.classList.toggle('active', favFilterActive);
  render();
}

function updateFavChip() {
  const chip = document.getElementById('favFilterChip');
  if (chip) {
    chip.classList.toggle('visible', favorites.size > 0);
    chip.classList.toggle('active', favFilterActive);
  }
}

// loadFavorites() is called earlier, before initial render()

function getFavorites() {
  return [...favorites];
}

// ═══════════════════════════════════════════════════
// TAB NAVIGATION (WP8)
// ═══════════════════════════════════════════════════

var currentView = 'churches';
var mapInitialized = false;

function switchAppView(view) {
  currentView = view;
  document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.app-tab').forEach(t => {
    t.classList.remove('active');
    t.setAttribute('aria-selected', 'false');
    t.setAttribute('tabindex', '-1');
  });
  const viewEl = document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1));
  if (viewEl) viewEl.classList.add('active');
  const tabEl = document.querySelector(`.app-tab[data-view="${view}"]`);
  if (tabEl) {
    tabEl.classList.add('active');
    tabEl.setAttribute('aria-selected', 'true');
    tabEl.setAttribute('tabindex', '0');
  }
  // Show/hide controls bar based on view
  document.querySelector('.controls-bar').style.display = (view === 'churches') ? '' : 'none';

  if (view === 'now') {
    renderNowView();
  }
  if (view === 'yc') renderYCView();
  if (view === 'map' && !mapInitialized) initMap();

  // Update URL: use hash for backward compat, also sync params
  const hash = view === 'churches' ? '' : '#' + view;
  history.replaceState(null, '', (location.search || location.pathname) + hash);
}

// H5: Arrow key navigation for tab bar
document.getElementById('appTabBar').addEventListener('keydown', function(e) {
  const tabs = [...this.querySelectorAll('.app-tab')];
  const idx = tabs.indexOf(document.activeElement);
  if (idx === -1) return;
  let next = -1;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') next = (idx + 1) % tabs.length;
  else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') next = (idx - 1 + tabs.length) % tabs.length;
  else if (e.key === 'Home') next = 0;
  else if (e.key === 'End') next = tabs.length - 1;
  if (next >= 0) {
    e.preventDefault();
    tabs[next].focus();
    switchAppView(tabs[next].dataset.view);
  }
});

// Handle hash on load
(function checkHash() {
  const h = location.hash.replace('#', '');
  if (h === 'now' || h === 'map' || h === 'yc') {
    setTimeout(() => switchAppView(h), 100);
  }
})();

// ═══════════════════════════════════════════════════
// WHAT'S NOW VIEW — V2 "TODAY"
// ═══════════════════════════════════════════════════

var nowMode = 'all';

function setNowMode(mode) {
  nowMode = mode;
  document.querySelectorAll('[data-now-mode]').forEach(p => p.classList.toggle('active', p.dataset.nowMode === mode));
  renderNowView();
}

function renderNowView() {
  renderLiveSection();
  renderTodayFavSection();
  renderTomorrowSection();
}

// ─── SECTION 1: Live & Starting Soon (proximity-based, mostly unchanged) ───
function renderLiveSection() {
  const now = new Date();
  const todayIdx = now.getDay();
  const todayName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][todayIdx];
  const nowMin = now.getHours() * 60 + now.getMinutes();

  // Update location button state
  const locBtn = document.getElementById('nowLocationBtn');
  if (locBtn) {
    if (userLat !== null) {
      locBtn.textContent = '📍 Location Active';
      locBtn.classList.add('active');
    } else {
      locBtn.textContent = '📍 Enable Location';
      locBtn.classList.remove('active');
    }
  }

  // Hide/show Seasonal pill
  const seasonalPill = document.getElementById('nowSeasonalPill');
  if (seasonalPill) {
    const hasActiveSeasonal = parishes.some(p =>
      (p.services || []).some(s => s.seasonal && s.seasonal.is_seasonal && isCurrentSeason(s))
    );
    seasonalPill.style.display = hasActiveSeasonal ? '' : 'none';
    if (hasActiveSeasonal) {
      const activeSeasons = new Set();
      for (const p of parishes) {
        for (const s of (p.services || [])) {
          if (s.seasonal && s.seasonal.is_seasonal && isCurrentSeason(s) && s.seasonal.season) {
            activeSeasons.add(s.seasonal.season);
          }
        }
      }
      const label = activeSeasons.size === 1
        ? (SEASON_LABELS[Array.from(activeSeasons)[0]] || 'Seasonal')
        : 'Seasonal';
      seasonalPill.textContent = label;
    }
  }

  function svcMatchesNowMode(svc) {
    if (nowMode === 'all') return true;
    if (nowMode === 'mass') return svc.type === 'sunday_mass' || svc.type === 'daily_mass';
    if (nowMode === 'confession') return svc.type === 'confession';
    if (nowMode === 'adoration') return svc.type === 'adoration' || svc.type === 'holy_hour';
    if (nowMode === 'seasonal') return svc.seasonal && svc.seasonal.is_seasonal && isCurrentSeason(svc);
    return false;
  }

  const results = [];

  for (const p of parishes) {
    const primaryLoc = p.locations && p.locations[0];
    for (const svc of (p.services || [])) {
      if (!isServiceActive(svc)) continue;
      if (!svcMatchesNowMode(svc)) continue;
      if (!isCurrentSeason(svc)) continue;
      const svcMin = timeToMinutes(svc.time);
      if (svcMin === null) continue;

      const svcDay = svc.day;
      const isWeekday = todayIdx >= 1 && todayIdx <= 5;
      const matchesToday = svcDay === todayName || svcDay === 'daily' || (svcDay === 'weekday' && isWeekday);
      if (!matchesToday) continue;

      let endMin = svc.end_time ? timeToMinutes(svc.end_time) : svcMin + (svc.type.includes('mass') ? 90 : 60);
      const minsAway = svcMin - nowMin;

      let status = null;
      if (nowMin >= svcMin && nowMin <= endMin) status = 'now';
      else if (minsAway > 0 && minsAway <= 60) status = 'soon';

      if (!status) continue;

      let dist = null;
      if (userLat !== null && primaryLoc && primaryLoc.lat) {
        let svcLat = primaryLoc.lat, svcLng = primaryLoc.lng;
        if (svc.location_id) {
          const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
          if (svcLoc && svcLoc.lat) { svcLat = svcLoc.lat; svcLng = svcLoc.lng; }
        }
        dist = haversine(userLat, userLng, svcLat, svcLng);
        if (dist > 10) continue;
      }

      let displayName = (primaryLoc && primaryLoc.name) || p.name;
      if (/Cathedral|Basilica/i.test(displayName)) displayName = displayName.replace(/\s+Church$/i, '');
      if (svc.location_id) {
        const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
        if (svcLoc) displayName = svcLoc.name;
      }

      results.push({ p, svc, dist, minsAway, svcMin, status, displayName });
    }
  }

  results.sort((a, b) => {
    const statusRank = { now: 0, soon: 1 };
    if (statusRank[a.status] !== statusRank[b.status]) return statusRank[a.status] - statusRank[b.status];
    if (a.status === 'now' && b.status === 'now') return (a.dist || 999) - (b.dist || 999);
    return a.minsAway - b.minsAway || (a.dist || 999) - (b.dist || 999);
  });

  let displayResults = results;
  if (userLat === null) {
    const catCounts = {};
    displayResults = results.filter(r => {
      let cat = 'other';
      if (r.svc.type === 'sunday_mass' || r.svc.type === 'daily_mass') cat = 'mass';
      else if (r.svc.type === 'confession') cat = 'confession';
      else if (r.svc.type === 'adoration' || r.svc.type === 'holy_hour') cat = 'adoration';
      catCounts[cat] = (catCounts[cat] || 0) + 1;
      return catCounts[cat] <= 3;
    });
  }

  const container = document.getElementById('nowTimeline');

  if (!displayResults.length) {
    const noLocNote = userLat === null ? '<br><small style="color:#999;">Enable location for nearby results.</small>' : '';
    container.innerHTML = `<div class="now-empty"><div class="cross">✝</div><p>Nothing live or starting within the hour.${noLocNote}</p></div>`;
    // Hide pulse when nothing live
    const pulseEl = document.querySelector('.today-pulse');
    if (pulseEl) pulseEl.style.display = 'none';
  } else {
    const pulseEl = document.querySelector('.today-pulse');
    if (pulseEl) pulseEl.style.display = '';

    const grouped = { now: [], soon: [] };
    for (const r of displayResults) {
      if (grouped[r.status]) grouped[r.status].push(r);
    }

    const SVCTYPE_SHORT = { confession:'Confession', mass:'Mass', sunday_mass:'Mass', daily_mass:'Mass',
      stations_of_cross:'Stations', adoration:'Adoration', holy_hour:'Holy Hour', rosary:'Rosary',
      divine_mercy:'Divine Mercy', devotion:'Devotion', communion_service:'Communion', novena:'Novena',
      holy_thursday_mass:'Holy Thu Mass', good_friday_service:'Good Friday', easter_vigil_mass:'Easter Vigil',
      divine_mercy_chaplet:'Divine Mercy', devotional:'Devotion', gorzkie_zale:'Gorzkie \u017Bale',
      bible_study:'Bible Study', mens_group:"Men's Group", social_event:'Social Event' };
    const SECTION_LIMIT = 3;

    function renderItem(r) {
      let minsLabel = '';
      if (r.status === 'now') minsLabel = '<span class="time-status">Happening now</span>';
      else if (r.minsAway <= 5) minsLabel = '<span class="time-away">In a few min</span>';
      else minsLabel = `<span class="time-away">In ${r.minsAway} min</span>`;

      const isLenten = r.svc.seasonal && r.svc.seasonal.season === 'lent';
      const itemClass = r.status === 'now' ? ' happening' : (isLenten ? ' lent-item' : '');
      const typeLabel = SVCTYPE_SHORT[r.svc.type] || (r.svc.type || 'Service').replace(/_/g, ' ');
      const riteTag = r.svc.rite === 'tridentine' ? ' <span class="rite-tag" title="Traditional Latin Mass">TLM</span>' : '';
      const timePrefix = r.svc.time_is_inferred ? '~' : '';
      const distHtml = r.dist !== null
        ? `<span class="now-item-dist${r.dist <= 5 ? ' near' : ''}">${r.dist.toFixed(1)} mi</span>` : '';

      return `<div class="now-item${itemClass}" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${r.p.id}'), 400);">
        <div class="now-item-time"><div class="time-big"${r.svc.time_is_inferred ? ' title="Time is approximate"' : ''}>${timePrefix}${fmt12(r.svc.time)}</div>${minsLabel}</div>
        <div class="now-item-info"><div class="item-type">${typeLabel}${riteTag}</div><div class="item-name">${r.displayName}</div><div class="item-location">${r.p.town}, MA</div></div>
        ${distHtml}
      </div>`;
    }

    let html = '';
    const sectionLabels = { now: 'Happening Now', soon: 'Starting Soon' };

    for (const status of ['now', 'soon']) {
      const items = grouped[status];
      if (!items.length) continue;
      html += `<div class="now-section-label">${sectionLabels[status]}</div>`;
      for (let i = 0; i < Math.min(items.length, SECTION_LIMIT); i++) {
        html += renderItem(items[i]);
      }
      if (items.length > SECTION_LIMIT) {
        const overflowCount = items.length - SECTION_LIMIT;
        html += `<div class="now-overflow-wrapper" id="nowOverflow_${status}">`;
        for (let i = SECTION_LIMIT; i < items.length; i++) {
          html += renderItem(items[i]);
        }
        html += `</div>`;
        html += `<button class="now-expand-btn" id="nowExpandBtn_${status}" onclick="toggleNowOverflow('${status}')">Show ${overflowCount} more ▾</button>`;
      }
    }
    container.innerHTML = html;
  }
}

// ─── SECTION 2: Your Parishes Today (favorites-driven) ───
function renderTodayFavSection() {
  const container = document.getElementById('todayFavContent');
  const metaEl = document.getElementById('todayFavMeta');
  const favIds = getFavorites();

  if (!favIds.length) {
    if (metaEl) metaEl.textContent = '';
    container.innerHTML = `<div class="today-fav-nudge">
      <div class="today-fav-nudge-icon">⛪</div>
      <div class="today-fav-nudge-title">See your parishes' full schedule</div>
      <div class="today-fav-nudge-text">Favorite a few churches from the Churches tab and their entire daily schedule will appear here — Mass times, confessions, adoration, everything.</div>
      <button class="today-fav-nudge-btn" onclick="switchAppView('churches')">⭐ Browse Churches</button>
    </div>`;
    return;
  }

  const now = new Date();
  const todayIdx = now.getDay();
  const todayName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][todayIdx];
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const isWeekday = todayIdx >= 1 && todayIdx <= 5;

  const SVCTYPE_SHORT = { confession:'Confession', sunday_mass:'Mass', daily_mass:'Mass',
    stations_of_cross:'Stations', adoration:'Adoration', holy_hour:'Holy Hour', rosary:'Rosary',
    divine_mercy:'Divine Mercy', devotion:'Devotion', communion_service:'Communion', novena:'Novena',
    holy_thursday_mass:'Holy Thu Mass', good_friday_service:'Good Friday', easter_vigil_mass:'Easter Vigil',
    divine_mercy_chaplet:'Divine Mercy', devotional:'Devotion', gorzkie_zale:'Gorzkie Żale',
    bible_study:'Bible Study', mens_group:"Men's Group", social_event:'Social',
    benediction:'Benediction', perpetual_adoration:'Perp. Adoration', vespers:'Vespers',
    miraculous_medal:'Miraculous Medal', anointing_of_sick:'Anointing', anointing:'Anointing',
    prayer_group:'Prayer Group' };

  let totalServices = 0;
  let html = '';
  let groupIdx = 0;

  const favParishes = parishes.filter(p => favIds.includes(p.id));

  for (const p of favParishes) {
    const primaryLoc = p.locations && p.locations[0];
    const displayName = (primaryLoc && (primaryLoc.short_name || primaryLoc.name)) || p.name;

    // Get today's services for this parish
    const todayServices = [];
    for (const svc of (p.services || [])) {
      if (!isServiceActive(svc)) continue;
      if (!isCurrentSeason(svc)) continue;
      const svcMin = timeToMinutes(svc.time);
      if (svcMin === null) continue;
      const svcDay = svc.day;
      const matchesToday = svcDay === todayName || svcDay === 'daily' || (svcDay === 'weekday' && isWeekday)
        || (svcDay === 'monday_friday' && isWeekday) || (svcDay === 'tuesday_friday' && todayIdx >= 2 && todayIdx <= 5);
      if (!matchesToday) continue;
      const endMin = svc.end_time ? timeToMinutes(svc.end_time) : svcMin + 60;
      const isPast = nowMin > endMin;
      const isLive = nowMin >= svcMin && nowMin <= endMin;
      todayServices.push({ svc, svcMin, isPast, isLive, p });
    }

    if (!todayServices.length) continue;
    todayServices.sort((a, b) => a.svcMin - b.svcMin);
    totalServices += todayServices.length;

    html += `<div class="today-parish-group" style="animation-delay:${groupIdx * 0.08}s">`;
    html += `<div class="today-parish-header" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${p.id}'), 400);">`;
    html += `<span class="today-parish-name">${displayName}</span>`;
    html += `<span class="today-parish-town">${p.town}</span>`;
    html += `</div>`;
    html += `<div class="today-parish-items">`;
    groupIdx++;

    for (const item of todayServices) {
      const { svc, isPast, isLive } = item;
      const typeLabel = SVCTYPE_SHORT[svc.type] || (svc.type || 'Service').replace(/_/g, ' ');
      const isLenten = svc.seasonal && svc.seasonal.season === 'lent';
      let statusClass = '';
      if (isPast) statusClass = ' past-service';
      else if (isLive) statusClass = ' happening';
      else if (isLenten) statusClass = ' lent-item';

      let statusHtml = '';
      if (isLive) statusHtml = '<span class="time-status">Now</span>';
      else if (isPast) statusHtml = '<span class="time-away">Done</span>';

      const timeStr = fmt12(svc.time);
      const endStr = svc.end_time ? ` – ${fmt12(svc.end_time)}` : '';
      const noteStr = svc.notes ? `<span class="svc-note-line" style="margin-left:6px;">${svc.notes}</span>` : '';
      const langTag = svc.language && svc.language !== 'en' ? ` <span class="lang-tag">${LANG_LABELS[svc.language] || svc.language}</span>` : '';
      const riteTag = svc.rite === 'tridentine' ? ' <span class="rite-tag">TLM</span>' : '';

      // Location label for multi-site parishes
      let locLabel = '';
      if (p.locations && p.locations.length > 1 && svc.location_id) {
        const svcLoc = p.locations.find(l => l.id === svc.location_id);
        if (svcLoc && svcLoc.short_name) {
          locLabel = `<span class="svc-location-label">@ ${svcLoc.short_name}</span>`;
        }
      }

      html += `<div class="now-item${statusClass}" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${p.id}'), 400);">
        <div class="now-item-time"><div class="time-big">${timeStr}</div>${statusHtml}</div>
        <div class="now-item-info">
          <div class="item-type">${typeLabel}${riteTag}${langTag}${locLabel}</div>
          <div class="item-name">${timeStr}${endStr}${noteStr}</div>
        </div>
      </div>`;
    }

    html += `</div></div>`;
  }

  if (!html) {
    html = `<div class="now-empty"><p>No services scheduled at your favorited parishes today.</p></div>`;
  }

  if (metaEl) {
    const dayLabel = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][todayIdx];
    metaEl.textContent = `${dayLabel} · ${totalServices} service${totalServices !== 1 ? 's' : ''}`;
  }
  container.innerHTML = html;
}

// ─── SECTION 3: Tomorrow Preview (favorites-driven) ───
function renderTomorrowSection() {
  const container = document.getElementById('todayTomorrowContent');
  const metaEl = document.getElementById('tomorrowMeta');
  const favIds = getFavorites();

  if (!favIds.length) {
    container.innerHTML = '';
    document.getElementById('todayTomorrowSection').style.display = 'none';
    return;
  }
  document.getElementById('todayTomorrowSection').style.display = '';

  const now = new Date();
  const tomorrowIdx = (now.getDay() + 1) % 7;
  const tomorrowName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][tomorrowIdx];
  const tomorrowIsWeekday = tomorrowIdx >= 1 && tomorrowIdx <= 5;
  const tomorrowLabel = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][tomorrowIdx];

  const SVCTYPE_SHORT = { confession:'Confession', sunday_mass:'Mass', daily_mass:'Mass',
    adoration:'Adoration', holy_hour:'Holy Hour', rosary:'Rosary',
    divine_mercy:'Divine Mercy', novena:'Novena', stations_of_cross:'Stations',
    communion_service:'Communion', devotion:'Devotion', benediction:'Benediction',
    vespers:'Vespers', perpetual_adoration:'Perp. Adoration',
    miraculous_medal:'Miraculous Medal', devotional:'Devotion',
    holy_thursday_mass:'Holy Thu Mass', good_friday_service:'Good Friday', easter_vigil_mass:'Easter Vigil' };

  const results = [];
  const favParishes = parishes.filter(p => favIds.includes(p.id));

  for (const p of favParishes) {
    const primaryLoc = p.locations && p.locations[0];
    const displayName = (primaryLoc && (primaryLoc.short_name || primaryLoc.name)) || p.name;

    for (const svc of (p.services || [])) {
      if (!isServiceActive(svc)) continue;
      if (!isCurrentSeason(svc)) continue;
      const svcMin = timeToMinutes(svc.time);
      if (svcMin === null) continue;
      const svcDay = svc.day;
      const matchesTomorrow = svcDay === tomorrowName || svcDay === 'daily' || (svcDay === 'weekday' && tomorrowIsWeekday)
        || (svcDay === 'monday_friday' && tomorrowIsWeekday) || (svcDay === 'tuesday_friday' && tomorrowIdx >= 2 && tomorrowIdx <= 5);
      if (!matchesTomorrow) continue;
      results.push({ svc, svcMin, displayName, p });
    }
  }

  results.sort((a, b) => a.svcMin - b.svcMin);

  if (metaEl) metaEl.textContent = `${tomorrowLabel} · ${results.length} service${results.length !== 1 ? 's' : ''}`;

  if (!results.length) {
    container.innerHTML = `<div class="now-empty" style="padding:16px;"><p style="font-size:0.85rem;">No services at your parishes tomorrow.</p></div>`;
    return;
  }

  const PREVIEW_LIMIT = 5;
  let html = '<div class="tomorrow-compact">';
  const showAll = results.length <= PREVIEW_LIMIT + 2; // avoid "show 1 more" silliness
  const toShow = showAll ? results.length : PREVIEW_LIMIT;

  for (let i = 0; i < toShow; i++) {
    const r = results[i];
    const typeLabel = SVCTYPE_SHORT[r.svc.type] || (r.svc.type || 'Service').replace(/_/g, ' ');
    html += `<div class="tomorrow-item" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${r.p.id}'), 400);">
      <span class="tomorrow-item-time">${fmt12(r.svc.time)}</span>
      <div class="tomorrow-item-info">
        <div class="tomorrow-item-type">${typeLabel}</div>
        <div class="tomorrow-item-name">${r.displayName}</div>
      </div>
    </div>`;
  }

  if (!showAll && results.length > PREVIEW_LIMIT) {
    const remaining = results.length - PREVIEW_LIMIT;
    html += `<div class="tomorrow-overflow" id="tomorrowOverflow" style="display:none;">`;
    for (let i = PREVIEW_LIMIT; i < results.length; i++) {
      const r = results[i];
      const typeLabel = SVCTYPE_SHORT[r.svc.type] || (r.svc.type || 'Service').replace(/_/g, ' ');
      html += `<div class="tomorrow-item" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${r.p.id}'), 400);">
        <span class="tomorrow-item-time">${fmt12(r.svc.time)}</span>
        <div class="tomorrow-item-info">
          <div class="tomorrow-item-type">${typeLabel}</div>
          <div class="tomorrow-item-name">${r.displayName}</div>
        </div>
      </div>`;
    }
    html += `</div>`;
    html += `<button class="tomorrow-expand-btn" onclick="toggleTomorrowOverflow()">Show ${remaining} more ▾</button>`;
  }

  html += '</div>';
  container.innerHTML = html;
}

function toggleTomorrowOverflow() {
  const wrapper = document.getElementById('tomorrowOverflow');
  const btn = wrapper && wrapper.nextElementSibling;
  if (!wrapper || !btn) return;
  const isOpen = wrapper.style.display !== 'none';
  wrapper.style.display = isOpen ? 'none' : 'flex';
  wrapper.style.flexDirection = 'column';
  wrapper.style.gap = '6px';
  if (isOpen) {
    const count = wrapper.children.length;
    btn.textContent = `Show ${count} more ▾`;
  } else {
    btn.textContent = 'Show less ▴';
  }
}

function toggleNowOverflow(status) {
  const wrapper = document.getElementById('nowOverflow_' + status);
  const btn = document.getElementById('nowExpandBtn_' + status);
  if (!wrapper || !btn) return;
  const isOpen = wrapper.classList.toggle('open');
  if (isOpen) {
    btn.textContent = 'Show less ▴';
  } else {
    const count = wrapper.children.length;
    btn.textContent = `Show ${count} more ▾`;
  }
}

// ═══════════════════════════════════════════════════
// ═══════════════════════════════════════════════════
// DEEP LINKS — SHAREABLE FILTER URLS (WP-DeepLinks)
// ═══════════════════════════════════════════════════

function shareCurrentView(btnEl) {
  const base = window.location.origin + window.location.pathname;
  const params = new URLSearchParams();

  // Capture all active filters
  if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
  if (countyFilter.value)       params.set('county', countyFilter.value);
  if (dayFilterEl.value)        params.set('day', dayFilterEl.value);
  if (timeFilterEl.value)       params.set('time', timeFilterEl.value);
  if (langFilterEl.value)       params.set('lang', langFilterEl.value);
  if (activeCategory)           params.set('cat', activeCategory);
  if (activeSubtype)            params.set('sub', activeSubtype);
  if (sortMode === 'proximity') params.set('sort', 'proximity');

  // Capture tab state
  if (currentView !== 'churches') params.set('view', currentView);

  // If in now view, capture now mode and view mode
  if (currentView === 'now') {
    if (nowMode !== 'all') params.set('nowMode', nowMode);
  }

  const shareUrl = base + (params.toString() ? '?' + params.toString() : '');

  // Build share description
  const filterParts = [];
  if (activeCategory) filterParts.push(activeCategory);
  if (dayFilterEl.value) filterParts.push(dayFilterEl.value);
  if (searchInput.value.trim()) filterParts.push('"' + searchInput.value.trim() + '"');
  const desc = filterParts.length ? filterParts.join(', ') : 'all churches';

  function showCopied() {
    if (btnEl) {
      btnEl.classList.add('copied');
      const orig = btnEl.innerHTML;
      btnEl.innerHTML = '✓ Copied!';
      setTimeout(() => { btnEl.classList.remove('copied'); btnEl.innerHTML = orig; }, 2000);
    }
  }

  if (navigator.share) {
    navigator.share({
      text: `Mass Finder — ${desc}\n${shareUrl}`,
    }).then(showCopied).catch(() => {});
  } else if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl).then(showCopied).catch(() => {
      prompt('Copy this link:', shareUrl);
    });
  } else {
    prompt('Copy this link:', shareUrl);
  }
}

// Enhanced URL parameter application (supports new deep link params)
function applyDeepLinkParams() {
  const p = new URLSearchParams(location.search);

  // Tab view
  if (p.get('view')) {
    const v = p.get('view');
    if (['now', 'yc', 'map'].includes(v)) {
      setTimeout(() => switchAppView(v), 150);
    }
  }

  // Now view mode
  if (p.get('nowMode')) {
    const nm = p.get('nowMode');
    if (['mass', 'confession', 'adoration', 'seasonal'].includes(nm)) {
      nowMode = nm;
      document.querySelectorAll('[data-now-mode]').forEach(pill =>
        pill.classList.toggle('active', pill.dataset.nowMode === nm)
      );
    }
  }


  // Sort mode
  if (p.get('sort') === 'proximity' && userLat !== null) {
    sortMode = 'proximity';
    document.querySelectorAll('.sort-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.sort === 'proximity')
    );
  }
}

// Override syncUrlParams to include new deep link params
const _origSyncUrlParams = syncUrlParams;
syncUrlParams = function() {
  const params = new URLSearchParams();
  if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
  if (countyFilter.value)       params.set('county', countyFilter.value);
  if (dayFilterEl.value)        params.set('day', dayFilterEl.value);
  if (timeFilterEl.value)       params.set('time', timeFilterEl.value);
  if (langFilterEl.value)       params.set('lang', langFilterEl.value);
  if (activeCategory)           params.set('cat', activeCategory);
  if (activeSubtype)            params.set('sub', activeSubtype);
  if (_deepLinkParishId) params.set('parish', _deepLinkParishId);
  // Include tab state in URL
  if (currentView && currentView !== 'churches') params.set('view', currentView);
  const str = params.toString();
  history.replaceState(null, '', str ? '?' + str : location.pathname);
};

// Update isAnyFilterActive and share button visibility
const _origUpdateClear = updateClearFiltersBtn;
updateClearFiltersBtn = function() {
  _origUpdateClear();
  const shareBtn = document.getElementById('shareViewBtn');
  if (shareBtn) shareBtn.style.display = isAnyFilterActive() ? '' : 'none';
};

// ═══════════════════════════════════════════════════
// YC EVENTS VIEW
// ═══════════════════════════════════════════════════

var ycRange = 'upcoming'; // 'upcoming' | 'week' | 'month'
var ycMapInitialized = false;
var ycMap = null;

function setYcRange(range) {
  ycRange = range;
  document.querySelectorAll('[data-yc-range]').forEach(b =>
    b.classList.toggle('active', b.dataset.ycRange === range)
  );
  renderYCView();
}

function renderYCView() {
  const ycEvents = (PARISH_DATA.yc_events || []);
  const today = new Date(); today.setHours(0,0,0,0);

  // Date range filtering
  let rangeEnd = null;
  if (ycRange === 'week') {
    rangeEnd = new Date(today);
    rangeEnd.setDate(rangeEnd.getDate() + 7);
  } else if (ycRange === 'month') {
    rangeEnd = new Date(today);
    rangeEnd.setMonth(rangeEnd.getMonth() + 1);
  }

  const upcoming = ycEvents.filter(evt => {
    if (!evt.date) return false;
    const evtDate = new Date(evt.date + 'T00:00:00');
    if (evtDate < today) return false;
    if (rangeEnd && evtDate > rangeEnd) return false;
    return true;
  }).sort((a,b) => a.date.localeCompare(b.date) || (a.time||'').localeCompare(b.time||''));

  // Group into series (same title + same parish)
  const seriesMap = new Map();
  for (const evt of upcoming) {
    const key = `${evt.parish_id}||${evt.title}`;
    if (!seriesMap.has(key)) seriesMap.set(key, []);
    seriesMap.get(key).push(evt);
  }

  const subtitle = document.getElementById('ycViewSubtitle');
  if (subtitle) subtitle.textContent = seriesMap.size + ' event series · ' + upcoming.length + ' date' + (upcoming.length !== 1 ? 's' : '');

  const container = document.getElementById('ycViewTimeline');
  if (!seriesMap.size) {
    const mapEl = document.getElementById('ycViewMap');
    if (mapEl) mapEl.style.display = 'none';
    container.innerHTML = '<div class="now-empty" style="grid-column:1/-1;"><div class="cross">✝</div><p>No ' + (ycRange === 'upcoming' ? 'upcoming' : ycRange === 'week' ? 'events this week' : 'events this month') + ' YC events found.</p></div>';
    return;
  }

  // Build series data with distance for sorting
  const seriesArr = [];
  for (const [key, evts] of seriesMap) {
    const first = evts[0];
    let dist = Infinity;
    if (userLat !== null && first.parish_id) {
      const ep = parishes.find(x => x.id === first.parish_id);
      if (ep) {
        const eLoc = first.location_id
          ? (ep.locations || []).find(l => l.id === first.location_id)
          : (ep.locations && ep.locations[0]);
        if (eLoc && eLoc.lat) {
          dist = haversine(userLat, userLng, eLoc.lat, eLoc.lng);
        }
      }
    }
    seriesArr.push({ key, evts, dist, first });
  }

  // Sort by proximity if location available, otherwise by next date
  if (userLat !== null) {
    seriesArr.sort((a, b) => a.dist - b.dist);
  }

  // Render series cards
  let html = '';
  for (const series of seriesArr) {
    const { evts, dist, first } = series;
    const next = evts[0];

    // Parish info
    let parishName = '', placeName = '', parishId = first.parish_id;
    let loc = null;
    if (parishId) {
      const ep = parishes.find(x => x.id === parishId);
      if (ep) {
        parishName = ep.name;
        loc = first.location_id
          ? (ep.locations || []).find(l => l.id === first.location_id)
          : (ep.locations && ep.locations[0]);
        placeName = (loc && loc.name) || ep.name;
      }
    }
    if (first.venue_name) placeName = first.venue_name;

    // Distance badge
    const distHtml = (dist < Infinity) ? `<span class="yc-series-dist">${dist.toFixed(1)} mi</span>` : '';

    // Next date formatting
    const nextDate = new Date(next.date + 'T12:00:00');
    const nextDateStr = nextDate.toLocaleString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    // Time
    const timeStr = next.time ? fmt12(next.time) : '';
    const endStr = next.end_time ? ` – ${fmt12(next.end_time)}` : '';

    // Social tag
    const socialHtml = next.social ? '<span class="yc-series-social">✦ Social after</span>' : '';

    // Description (new field)
    const descHtml = next.description ? `<div class="yc-series-desc">${next.description}</div>` : '';

    // Notes
    const noteHtml = next.notes ? `<div class="yc-series-note">${next.notes}</div>` : '';

    // Flyer support (new field)
    let flyerHtml = '';
    if (next.flyer_url) {
      const isPdf = next.flyer_url.toLowerCase().endsWith('.pdf');
      if (isPdf) {
        flyerHtml = `<div class="yc-series-flyer"><a href="${next.flyer_url}" target="_blank" rel="noopener">📄 View Event Flyer (PDF)</a></div>`;
      } else {
        flyerHtml = `<div class="yc-series-flyer"><img src="${next.flyer_url}" alt="${next.title} flyer" loading="lazy"></div>`;
      }
    }

    // Future dates
    let futureHtml = '';
    if (evts.length > 1) {
      const futureDates = evts.slice(1).map(e => {
        const fd = new Date(e.date + 'T12:00:00');
        return `${fd.toLocaleString('en-US', { month: 'short' })} ${fd.getDate()}`;
      }).join(', ');
      const freqLabel = evts.length >= 3 ? 'Monthly' : 'Recurring';
      futureHtml = `<div class="yc-series-future"><strong>${freqLabel}</strong> · also ${futureDates}</div>`;
    }

    // Calendar URL for next event
    const calLoc = placeName + (loc ? ', ' + (loc.address || '') : '');
    let calBtn = '';
    if (next.date && next.time) {
      const ep2 = parishId ? parishes.find(x => x.id === parishId) : null;
      const ycSeriesDesc = buildCalDescription({
        type: 'Young Catholic Event',
        notes: next.notes || '',
        verification: ep2 && ep2.validation ? (ep2.validation.status || '') : '',
        url: (ep2 && ep2.contact && ep2.contact.website) || ''
      });
      const icsUrl = generateICS(next.title, next.date, next.time, next.end_time || null, calLoc, ycSeriesDesc);
      calBtn = `<a class="yc-series-btn primary" href="${icsUrl}" download="${(next.title||'event').replace(/[^a-zA-Z0-9]/g,'_')}.ics" onclick="event.stopPropagation();">📅 Add to Calendar</a>`;
    }

    // Directions
    const addr = loc ? loc.address : (first.venue_address || placeName);
    const mapsUrl = /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)
      ? `https://maps.apple.com/?q=${encodeURIComponent(addr)}`
      : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const directionsBtn = `<a class="yc-series-btn" href="${mapsUrl}" target="_blank" rel="noopener">📍 Directions</a>`;

    // View church button
    const churchBtn = parishId ? `<button class="yc-series-btn" onclick="event.stopPropagation(); switchAppView('churches'); setTimeout(() => scrollToParish('${parishId}'), 400);">⛪ View Church</button>` : '';

    html += `<div class="yc-series-card">
      <div class="yc-series-header">
        <div class="yc-series-header-info">
          <div class="yc-series-title">${next.title}</div>
          <div class="yc-series-parish">${placeName}</div>
        </div>
        ${distHtml}
      </div>
      <div class="yc-series-body">
        <div class="yc-series-next">
          <span class="yc-series-next-label">Next</span>
          <span class="yc-series-next-detail">${nextDateStr}</span>
        </div>
        <div class="yc-series-time">${timeStr}${endStr}</div>
        ${socialHtml}
        ${descHtml}
        ${noteHtml}
        ${flyerHtml}
        ${futureHtml}
        <div class="yc-series-actions">
          ${calBtn}
          ${directionsBtn}
          ${churchBtn}
        </div>
      </div>
    </div>`;
  }

  container.innerHTML = html;

  // Stagger card entrance animation
  container.querySelectorAll('.yc-series-card').forEach((card, i) => {
    card.style.animationDelay = `${i * 0.06}s`;
  });

  // Initialize or update YC mini map
  initYcMap(seriesArr);
}

function initYcMap(seriesArr) {
  const mapEl = document.getElementById('ycViewMap');
  if (!mapEl) return;
  if (!seriesArr.length) { mapEl.style.display = 'none'; return; }

  mapEl.style.display = 'block';

  if (!ycMapInitialized) {
    ycMap = L.map('ycViewMap', {
      scrollWheelZoom: false,
      zoomControl: true,
      attributionControl: false,
    }).setView([42.1, -72.6], 9);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      maxZoom: 18,
    }).addTo(ycMap);
    ycMapInitialized = true;
  }

  // Clear existing markers
  ycMap.eachLayer(l => { if (l instanceof L.CircleMarker || l instanceof L.Marker) ycMap.removeLayer(l); });

  const bounds = [];
  const seen = new Set();
  for (const { first } of seriesArr) {
    const ep = parishes.find(x => x.id === first.parish_id);
    if (!ep) continue;
    const loc = first.location_id
      ? (ep.locations || []).find(l => l.id === first.location_id)
      : (ep.locations && ep.locations[0]);
    if (!loc || !loc.lat) continue;
    const locKey = `${loc.lat},${loc.lng}`;
    if (seen.has(locKey)) continue;
    seen.add(locKey);

    const marker = L.circleMarker([loc.lat, loc.lng], {
      radius: 10,
      fillColor: '#c9a84c',
      fillOpacity: 0.95,
      color: '#1a2744',
      weight: 2.5,
    }).addTo(ycMap);
    marker.bindPopup(`<strong style="font-family:'Playfair Display',serif;color:#1a2744;">${loc.name || ep.name}</strong><br><span style="color:#5c5650;font-size:0.8rem;">${first.title}</span>`);
    bounds.push([loc.lat, loc.lng]);
  }

  // Add user location
  if (userLat) {
    L.circleMarker([userLat, userLng], {
      radius: 7, fillColor: '#4285F4', fillOpacity: 0.9, color: '#fff', weight: 2
    }).addTo(ycMap).bindPopup('You are here');
    bounds.push([userLat, userLng]);
  }

  if (bounds.length > 1) {
    ycMap.fitBounds(bounds, { padding: [40, 40] });
  } else if (bounds.length === 1) {
    ycMap.setView(bounds[0], 12);
  }
}

// ═══════════════════════════════════════════════════
// MAP VIEW (WP-Map)
// ═══════════════════════════════════════════════════

var appMap = null;
var mapMarkers = [];
var mapFilter = '';

function initMap() {
  if (mapInitialized) return;
  mapInitialized = true;

  // Center on western MA
  appMap = L.map('mapContainer', { zoomControl: true, tap: true, tapTolerance: 20 }).setView([42.18, -72.60], 10);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18,
  }).addTo(appMap);

  // Invalidate size after view becomes visible
  setTimeout(() => { appMap.invalidateSize(); }, 200);

  renderMapMarkers();

  // Show user location if available
  if (userLat !== null) {
    L.circleMarker([userLat, userLng], {
      radius: 8, fillColor: '#4285F4', fillOpacity: 0.9, color: '#fff', weight: 2
    }).addTo(appMap).bindPopup('You are here');
  }
}

function renderMapMarkers() {
  if (!appMap) return;

  // Clear existing
  mapMarkers.forEach(m => appMap.removeLayer(m));
  mapMarkers = [];

  const markerColors = {
    mass: '#1a2744',
    confession: '#7c4fa0',
    devotion: '#c9a84c',
    default: '#1a2744'
  };

  for (const p of parishes) {
    if (!p.locations || !p.locations.length) continue;

    // Filter check at parish level
    if (mapFilter) {
      const group = SERVICE_TYPE_GROUPS[mapFilter];
      if (group) {
        const hasType = (p.services || []).some(s => isServiceActive(s) && group.includes(s.type) && isCurrentSeason(s));
        if (!hasType) continue;
      }
    }

    // 5B: Iterate ALL locations, not just locations[0]
    for (const loc of p.locations) {
      if (!loc.lat || !loc.lng) continue;

      let buildingName = loc.short_name || loc.name || p.name;
      if (/Cathedral|Basilica/i.test(buildingName)) buildingName = buildingName.replace(/\s+Church$/i, '');

      // Count services at THIS specific location
      const allSvcs = (p.services || []).filter(s => isServiceActive(s) && isCurrentSeason(s));
      // Match services to this location — services with matching location_id, or if no location_id, assign to primary location
      const locSvcs = allSvcs.filter(s =>
        s.location_id ? s.location_id === loc.id : loc === p.locations[0]
      );
      const massSvcs = locSvcs.filter(s => s.type === 'sunday_mass' || s.type === 'daily_mass').length;
      const confSvcs = locSvcs.filter(s => s.type === 'confession').length;
      const otherSvcs = locSvcs.length - massSvcs - confSvcs;

      const svcSummary = [];
      if (massSvcs) svcSummary.push(`${massSvcs} Mass`);
      if (confSvcs) svcSummary.push(`${confSvcs} Confession`);
      if (otherSvcs) svcSummary.push(`${otherSvcs} other`);
      // If no services at this specific location, show parish-level summary
      if (!svcSummary.length) {
        const totalActive = allSvcs.length;
        if (totalActive) svcSummary.push(`${totalActive} service${totalActive !== 1 ? 's' : ''} (parish)`);
      }

      const color = mapFilter ? (markerColors[mapFilter] || markerColors.default) : markerColors.default;

      const marker = L.circleMarker([loc.lat, loc.lng], {
        radius: 12,
        fillColor: color,
        fillOpacity: 0.85,
        color: '#fff',
        weight: 2,
      }).addTo(appMap);

      const locTypeLabel = loc.type ? ` · ${loc.type.charAt(0).toUpperCase() + loc.type.slice(1)}` : '';
      marker.bindPopup(`
        <h3>${buildingName}</h3>
        <div class="popup-town">${loc.city || p.town}, MA · ${p.county} County${locTypeLabel}</div>
        <div class="popup-services">${svcSummary.join(' · ')}</div>
        <span class="popup-link" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${p.id}'), 400);">View Details →</span>
      `, { closeButton: true, minWidth: 180 });

      // Enlarge on hover for desktop discoverability
      marker.on('mouseover', function() { this.setRadius(16); this.setStyle({ weight: 3 }); });
      marker.on('mouseout', function() { if (!this.isPopupOpen()) { this.setRadius(12); this.setStyle({ weight: 2 }); } });

      mapMarkers.push(marker);
    }
  }
}

function setMapFilter(cat) {
  mapFilter = cat;
  document.querySelectorAll('[data-map-cat]').forEach(c => c.classList.toggle('active', c.dataset.mapCat === cat));
  renderMapMarkers();
}

// Expose all interactive functions to global scope
// (they're defined inside an async IIFE — inline onclick attributes require global scope)
window.requestLocation  = requestLocation;
window.clearAllFilters  = clearAllFilters;
window.clearLocationSort = clearLocationSort;
window.setSortMode       = setSortMode;
window.toggleContact     = toggleContact;
window.shareParish       = shareParish;
window.printParish       = printParish;
window.toggleCardOverflow = toggleCardOverflow;
window.shareFavorites    = shareFavorites;
window.scrollToParish   = scrollToParish;
window.switchAppView    = switchAppView;
window.setNowMode       = setNowMode;
window.toggleNowOverflow = toggleNowOverflow;
window.renderYCView     = renderYCView;
window.setYcRange       = setYcRange;
window.setMapFilter     = setMapFilter;
window.toggleFavorite   = toggleFavorite;
window.toggleFavFilter  = toggleFavFilter;
window.shareCurrentView  = shareCurrentView;
window.toggleVerifyDetail = toggleVerifyDetail;
window.toggleShowAll     = toggleShowAll;
window.toggleSimpleMode  = toggleSimpleMode;
window.setSimpleFilter   = setSimpleFilter;
window.filterSeasonalServices = filterSeasonalServices;

})();
</script>

<!-- ══════════════════════════════════════════════════
     RECONCILIATION MODAL
══════════════════════════════════════════════════ -->
<!-- ══════════════════════════════════════════════════
     INFOGRAPHIC MODAL — Directory Stats
══════════════════════════════════════════════════ -->
<div class="info-backdrop" id="infoBackdrop">
<div class="info-box">
  <div class="info-header">
    <div>
      <h2 id="infoModalTitle">✝ Directory at a Glance</h2>
      <div class="info-sub">Diocese of Springfield — Western Massachusetts</div>
    </div>
    <button class="info-close" onclick="closeInfoModal()">×</button>
  </div>
  <div class="info-body" id="infoBody">
    <!-- populated by JS -->
  </div>
  <div class="howto-body" id="howtoBody" style="display:none">
    <!-- populated by JS -->
  </div>
</div>
</div>

<script>
/* ── HAMBURGER MENU ── */
function openHamburgerMenu() {
  // Update simple mode label
  var label = document.getElementById('hmSimpleLabel');
  if (label) label.textContent = (typeof isSimpleMode !== 'undefined' && isSimpleMode) ? 'Full Mode' : 'Simple Mode';
  document.getElementById('hamburgerMenu').classList.add('open');
}
function closeHamburgerMenu() {
  document.getElementById('hamburgerMenu').classList.remove('open');
}
window.openHamburgerMenu = openHamburgerMenu;
window.closeHamburgerMenu = closeHamburgerMenu;

/* ── INFOGRAPHIC MODAL WITH TABS ── */
function openInfoModal(tab) {
  tab = tab || 'metrics';
  switchInfoTab(tab);
  document.getElementById('infoBackdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeInfoModal() {
  document.getElementById('infoBackdrop').classList.remove('open');
  document.body.style.overflow = '';
}
document.getElementById('infoBackdrop').addEventListener('click', function(e) {
  if (e.target === this) closeInfoModal();
});

function switchInfoTab(tab) {
  var metricsBody = document.getElementById('infoBody');
  var howtoBody   = document.getElementById('howtoBody');
  var title       = document.getElementById('infoModalTitle');

  if (tab === 'metrics') {
    if (title) title.textContent = '\u271D Directory at a Glance';
    metricsBody.style.display = '';
    howtoBody.style.display = 'none';
    renderInfoGraphic();
  } else {
    if (title) title.textContent = '\u271D How To Use Mass Finder';
    metricsBody.style.display = 'none';
    howtoBody.style.display = '';
    renderHowTo();
  }
}

function renderHowTo() {
  document.getElementById('howtoBody').innerHTML =
    '<div class="howto-intro">' +
      '<h3>Welcome to Mass Finder</h3>' +
      '<p>Find Mass, Confession, Adoration, and more across Western Massachusetts</p>' +
    '</div>' +

    '<div class="howto-tip">' +
      '<div class="howto-tip-icon">\uD83D\uDCCD</div>' +
      '<div class="howto-tip-text"><strong>Pro tip:</strong> Allow location access and churches sort by distance automatically. Share a filtered view with friends using the \uD83D\uDD17 Share View button.</div>' +
    '</div>' +

    '<div class="howto-tip">' +
      '<div class="howto-tip-icon">\uD83D\uDCF2</div>' +
      '<div class="howto-tip-text"><strong>Install the app:</strong> Add Mass Finder to your home screen for quick access. On iPhone, tap the share icon \u2192 \u201CAdd to Home Screen.\u201D On Android, tap the Install banner.</div>' +
    '</div>' +

    '<div class="howto-steps">' +

      '<div class="howto-step">' +
        '<div class="howto-step-num">1</div>' +
        '<div class="howto-step-icon">\uD83D\uDD0D</div>' +
        '<div class="howto-step-title">Search &amp; Filter</div>' +
        '<div class="howto-step-desc">Type a church name, town, or pastor in the search bar. Use the day, time, and language dropdowns to narrow results.</div>' +
      '</div>' +

      '<div class="howto-step">' +
        '<div class="howto-step-num">2</div>' +
        '<div class="howto-step-icon">\u26EA</div>' +
        '<div class="howto-step-title">Browse by Category</div>' +
        '<div class="howto-step-desc">Tap the chips \u2014 <strong>Mass</strong>, <strong>Confession</strong>, or <strong>Devotions</strong> \u2014 to filter the directory. Subtypes appear for more specificity.</div>' +
      '</div>' +

      '<div class="howto-step">' +
        '<div class="howto-step-num">3</div>' +
        '<div class="howto-step-icon">\u2600\uFE0F</div>' +
        '<div class="howto-step-title">Today View</div>' +
        '<div class="howto-step-desc">Switch to the <strong>Today</strong> tab to see what\u2019s happening now and coming up next \u2014 sorted by time and proximity.</div>' +
      '</div>' +

      '<div class="howto-step">' +
        '<div class="howto-step-num">4</div>' +
        '<div class="howto-step-icon">\u2764\uFE0F</div>' +
        '<div class="howto-step-title">Favorite Churches</div>' +
        '<div class="howto-step-desc">Tap the heart on any church card to save it. Favorites appear in the Today view so you always know what\u2019s on at your go-to churches.</div>' +
      '</div>' +

      '<div class="howto-step">' +
        '<div class="howto-step-num">5</div>' +
        '<div class="howto-step-icon">\u2630</div>' +
        '<div class="howto-step-title">Simple Mode</div>' +
        '<div class="howto-step-desc">Too many options? Toggle <strong>Simple Mode</strong> for a cleaner view with just Mass &amp; Confession, Devotions, and seasonal services.</div>' +
      '</div>' +

      '<div class="howto-step">' +
        '<div class="howto-step-num">6</div>' +
        '<div class="howto-step-icon">\uD83D\uDEA9</div>' +
        '<div class="howto-step-title">Report &amp; Contribute</div>' +
        '<div class="howto-step-desc">See something wrong? Tap <strong>Report</strong> on any card to flag inaccurate times. Use <strong>+ Add A Church</strong> to suggest new listings.</div>' +
      '</div>' +

    '</div>';
}

function renderInfoGraphic() {
  const ps = (typeof PARISH_DATA !== 'undefined') ? PARISH_DATA.parishes : [];
  const allSvcs = [];
  ps.forEach(p => (p.services||[]).forEach(s => allSvcs.push(s)));

  const totalParishes = ps.length;
  const totalSvcs = allSvcs.length;
  const towns = new Set(ps.map(p => p.town)).size;
  const totalLocs = ps.reduce((n,p) => n + (p.locations||[]).length, 0);

  const massTypes = ['sunday_mass','daily_mass','communion_service','holy_thursday_mass','good_friday_service','easter_vigil_mass'];
  const adorTypes = ['adoration','holy_hour','perpetual_adoration','benediction'];
  const devTypes = ['rosary','divine_mercy','divine_mercy_chaplet','miraculous_medal','stations_of_cross','stations_of_the_cross','novena','devotion','devotional','vespers','gorzkie_zale','anointing','anointing_of_sick'];

  let massN=0, confN=0, adorN=0, devotN=0, otherN=0, sundayN=0, dailyN=0;
  allSvcs.forEach(s => {
    const t = s.type||'';
    if (massTypes.includes(t)) { massN++; if (t==='sunday_mass') sundayN++; if (t==='daily_mass') dailyN++; }
    else if (t === 'confession') confN++;
    else if (adorTypes.includes(t)) adorN++;
    else if (devTypes.includes(t)) devotN++;
    else otherN++;
  });

  const langMap = {};
  allSvcs.forEach(s => { const l = s.language||'en'; langMap[l] = (langMap[l]||0) + 1; });
  const langNames = {en:'English',es:'Spanish',pl:'Polish',la:'Latin',pt:'Portuguese',fr:'French',vi:'Vietnamese',asl:'ASL'};
  const langEntries = Object.entries(langMap).sort((a,b) => b[1]-a[1]);

  const countyMap = {};
  ps.forEach(p => { const c = p.county||'?'; countyMap[c] = (countyMap[c]||0) + 1; });
  const countyColors = {Hampden:'#5B4FC4',Berkshire:'#3B82F6',Hampshire:'#10B981',Franklin:'#E8832A'};
  const countyEntries = Object.entries(countyMap).sort((a,b) => b[1]-a[1]);
  const maxCounty = Math.max(...countyEntries.map(e => e[1]));

  let seasonalN=0, lentN=0, holyWeekN=0, academicN=0;
  allSvcs.forEach(s => {
    if (s.seasonal && s.seasonal.is_seasonal) {
      seasonalN++;
      const sn = s.seasonal.season||'';
      if (sn==='lent') lentN++;
      else if (sn==='holy_week') holyWeekN++;
      else if (sn==='academic_year') academicN++;
    }
  });

  const distinctTypes = new Set(allSvcs.map(s => s.type)).size;

  // Donut SVG
  const ds = 120, tk = 16, rd = (ds - tk) / 2, ci = 2 * Math.PI * rd;
  const cats = [
    {label:'Mass',n:massN,color:'#5B4FC4'},
    {label:'Confession',n:confN,color:'#D946A8'},
    {label:'Adoration',n:adorN,color:'#E8832A'},
    {label:'Devotions',n:devotN,color:'#2A9D8F'},
    {label:'Other',n:otherN,color:'#b0adb8'},
  ];
  let off = 0;
  const arcs = cats.map(c => {
    const d = (c.n/totalSvcs)*ci;
    const a = `<circle cx="${ds/2}" cy="${ds/2}" r="${rd}" fill="none" stroke="${c.color}" stroke-width="${tk}" stroke-dasharray="${d} ${ci-d}" stroke-dashoffset="${-off}" stroke-linecap="round" style="opacity:0.85"/>`;
    off += d; return a;
  }).join('');
  const donut = `<svg width="${ds}" height="${ds}" style="transform:rotate(-90deg);flex-shrink:0"><circle cx="${ds/2}" cy="${ds/2}" r="${rd}" fill="none" stroke="rgba(0,0,0,0.04)" stroke-width="${tk}"/>${arcs}</svg>`;

  const legend = cats.filter(c=>c.n>0).map(c =>
    `<div class="info-legend-row"><div class="info-legend-dot" style="background:${c.color}"></div><div class="info-legend-label">${c.label}</div><div class="info-legend-num">${c.n}</div><div class="info-legend-pct">${Math.round(c.n*100/totalSvcs)}%</div></div>`
  ).join('');

  const bars = countyEntries.map(([nm, ct], i) =>
    `<div class="info-bar-row"><div class="info-bar-label">${nm}</div><div class="info-bar-track"><div class="info-bar-fill" style="width:${Math.round(ct*100/maxCounty)}%;background:${countyColors[nm]||'#888'};animation-delay:${i*0.15}s"></div></div><div class="info-bar-num">${ct}</div></div>`
  ).join('');

  const pills = langEntries.map(([code, n]) =>
    `<span class="info-lang-pill ${n>10?'major':'minor'}">${langNames[code]||code} <span style="opacity:0.5">${n}</span></span>`
  ).join('');

  document.getElementById('infoBody').innerHTML =
    `<div class="info-hero"><div class="info-hero-grid">` +
      `<div class="info-stat-card"><div class="info-stat-num">${totalParishes}</div><div class="info-stat-label">Churches</div><div class="info-stat-sub">${countyEntries.length} counties</div></div>` +
      `<div class="info-stat-card"><div class="info-stat-num" style="color:#5B4FC4">${totalSvcs.toLocaleString()}</div><div class="info-stat-label">Services</div><div class="info-stat-sub">${distinctTypes} types</div></div>` +
      `<div class="info-stat-card"><div class="info-stat-num" style="color:#E8832A">${totalLocs}</div><div class="info-stat-label">Buildings</div><div class="info-stat-sub">All mapped</div></div>` +
      `<div class="info-stat-card"><div class="info-stat-num" style="color:#2A9D8F">${towns}</div><div class="info-stat-label">Towns</div><div class="info-stat-sub">W. Mass</div></div>` +
    `</div></div>` +

    `<div class="info-card"><div class="info-card-title">Services Breakdown</div>` +
      `<div class="info-donut-row"><div style="position:relative">${donut}<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center"><div style="font-family:Playfair Display,serif;font-size:1.35rem;font-weight:700;color:#1a2744">${totalSvcs.toLocaleString()}</div><div style="font-size:0.6rem;color:#8a8278;text-transform:uppercase;letter-spacing:0.1em">Total</div></div></div><div class="info-legend">${legend}</div></div>` +
      `<div style="margin-top:12px;border-top:1px solid #eae6df;padding-top:10px"><div class="info-card-title" style="margin-bottom:6px">Weekly Schedule</div>` +
        `<div class="info-mini-grid">` +
          `<div class="info-mini-card" style="background:rgba(91,79,196,0.06)"><div class="info-mini-num" style="color:#5B4FC4">${sundayN}</div><div class="info-mini-label">Sunday Masses</div></div>` +
          `<div class="info-mini-card" style="background:rgba(91,79,196,0.04)"><div class="info-mini-num" style="color:#6366F1">${dailyN}</div><div class="info-mini-label">Daily Masses</div></div>` +
          `<div class="info-mini-card" style="background:rgba(217,70,168,0.06)"><div class="info-mini-num" style="color:#D946A8">${confN}</div><div class="info-mini-label">Confession Slots</div></div>` +
          `<div class="info-mini-card" style="background:rgba(232,131,42,0.06)"><div class="info-mini-num" style="color:#E8832A">${adorN}</div><div class="info-mini-label">Adoration Hours</div></div>` +
        `</div></div></div>` +

    `<div style="display:flex;flex-direction:column;gap:10px">` +
      `<div class="info-card"><div class="info-card-title">Coverage by County</div>${bars}</div>` +
      `<div class="info-card"><div class="info-card-title">${langEntries.length} Liturgical Languages</div><div class="info-lang-pills">${pills}</div></div>` +
      `<div class="info-card" style="background:linear-gradient(135deg,rgba(124,79,160,0.06),rgba(217,70,168,0.03));border-color:rgba(124,79,160,0.15)">` +
        `<div class="info-card-title" style="color:#7c4fa0">Liturgical Seasons</div>` +
        `<div style="display:flex;gap:8px;align-items:baseline"><span style="font-family:Playfair Display,serif;font-size:1.5rem;font-weight:700;color:#7c4fa0">${seasonalN}</span><span style="font-size:0.82rem;color:#8a8278">seasonal services</span></div>` +
        `<div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap">` +
          `<span class="info-lang-pill" style="background:rgba(124,79,160,0.12);color:#7c4fa0">Lent &middot; ${lentN}</span>` +
          `<span class="info-lang-pill" style="background:rgba(217,70,168,0.1);color:#D946A8">Holy Week &middot; ${holyWeekN}</span>` +
        `</div></div></div>` +

    `<div class="info-features-row"><div class="info-features-grid">` +
      `<div class="info-feature"><div class="info-feature-icon">📍</div><div class="info-feature-label">By Location</div></div>` +
      `<div class="info-feature"><div class="info-feature-icon">🕐</div><div class="info-feature-label">By Time</div></div>` +
      `<div class="info-feature"><div class="info-feature-icon">🌐</div><div class="info-feature-label">By Language</div></div>` +
      `<div class="info-feature"><div class="info-feature-icon">⛪</div><div class="info-feature-label">By Rite</div></div>` +
      `<div class="info-feature"><div class="info-feature-icon">📅</div><div class="info-feature-label">By Season</div></div>` +
      `<div class="info-feature"><div class="info-feature-icon">🙏</div><div class="info-feature-label">By Type</div></div>` +
    `</div></div>` +

    `<div class="info-footer">Verified against church bulletins &amp; websites &middot; <strong>Updated February 2026</strong></div>`;
}

</script>


<div class="modal-backdrop" id="reconcileBackdrop">
<div class="modal-box" style="max-width:560px">

  <!-- HEADER -->
  <div class="mhdr">
    <div class="mhdr-left">
      <h2>Report a Problem</h2>
      <div class="mhdr-parish" id="mParishName"></div>
    </div>
    <button class="mhdr-close" onclick="closeReconcile()">×</button>
  </div>

  <!-- MODE TABS -->
  <div class="mode-tabs">
    <button class="mode-tab active" id="tab-flag"    onclick="switchTab('flag')">Flag a Service</button>
    <button class="mode-tab"        id="tab-general" onclick="switchTab('general')">General Note</button>
  </div>

  <!-- ── TAB: FLAG EXISTING ── -->
  <div class="tab-panel active mbody" id="panel-flag">

    <div class="fsection">
      <div class="fsection-title">Which service is wrong?</div>
      <div class="fsection-body">
        <div class="svc-list" id="svcList">
          <div style="padding:14px;color:#aaa;font-size:0.85rem">Loading…</div>
        </div>
      </div>
    </div>

    <div class="fsection">
      <div class="fsection-title">What's the problem?</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>Issue type <span class="req">*</span></label>
          <select id="fd_issue_type">
            <option value="">— Select —</option>
            <option value="wrong_time">Wrong time listed</option>
            <option value="wrong_day">Wrong day listed</option>
            <option value="no_longer_exists">Service no longer exists</option>
            <option value="seasonal_ended">Seasonal service has ended</option>
            <option value="new_time">Time has changed</option>
            <option value="missing_service">There's a service missing</option>
            <option value="wrong_info">Other info is incorrect</option>
          </select>
        </div>
        <div class="fg">
          <label>Brief description <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(what's wrong, what it should be)</span></label>
          <textarea id="fd_wrong" rows="3" placeholder="e.g. 'Saturday confession is now 3-4 PM, not 3:30-4:30'"></textarea>
        </div>
      </div>
    </div>

    <div class="fsection">
      <div class="fsection-title">How do you know? (optional)</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>Source</label>
          <select id="fd_source">
            <option value="bulletin">Saw it in the bulletin</option>
            <option value="website">Saw it on the website</option>
            <option value="attended">I go to this church</option>
            <option value="priest">I'm the priest, trust me</option>
            <option value="phone">Called the office</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="fg">
          <label>Link to bulletin or website <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(if you have it)</span></label>
          <input type="url" id="fd_source_url" placeholder="https://...">
        </div>
      </div>
    </div>

  </div><!-- /panel-flag -->


  <!-- ── TAB: GENERAL NOTE ── -->
  <div class="tab-panel mbody" id="panel-general">

    <div class="fsection">
      <div class="fsection-title">What would you like us to know?</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>Your note <span class="req">*</span></label>
          <textarea id="fg_notes" rows="4" placeholder="Anything — a new service, a correction, a question, whatever you've got."></textarea>
        </div>
        <div class="fg">
          <label>Link <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(bulletin, website, anything helpful)</span></label>
          <input type="url" id="fg_url" placeholder="https://...">
        </div>
      </div>
    </div>

  </div><!-- /panel-general -->


  <!-- SUCCESS SCREEN (hidden until submit) -->
  <div class="msuccess" id="mSuccess">
    <div class="sicon">✓</div>
    <h3>Got it — thank you!</h3>
    <p>We'll review this and update the listing if needed. You're helping keep things accurate for everyone.</p>
    <div class="ref-id" id="mRefId"></div>
    <br>
    <button class="mbtn-submit" onclick="closeReconcile()">Close</button>
  </div>


  <!-- MODAL FOOTER -->
  <div class="mftr" id="mFtr">
    <div class="mftr-note">Reviewed before any changes go live.</div>
    <button class="mbtn-cancel" onclick="closeReconcile()">Cancel</button>
    <button class="mbtn-submit" onclick="submitReconcile()">Submit →</button>
  </div>

</div><!-- /modal-box -->
</div><!-- /modal-backdrop -->


<script>
// ════════════════════════════════════════════════════════════
//  RECONCILIATION MODAL  — simplified v2
// ════════════════════════════════════════════════════════════

const SVC_TYPE_LABELS = {
  sunday_mass:'Sunday / Vigil Mass', daily_mass:'Daily Mass',
  confession:'Confession', anointing_of_sick:'Anointing of the Sick',
  communion_service:'Communion Service',
  adoration:'Eucharistic Adoration', holy_hour:'Holy Hour',
  perpetual_adoration:'Perpetual Adoration', benediction:'Benediction',
  rosary:'Rosary', divine_mercy:'Divine Mercy Chaplet',
  miraculous_medal:'Miraculous Medal Novena',
  stations_of_cross:'Stations of the Cross',
  stations_of_the_cross:'Stations of the Cross',
  novena:'Novena', devotion:'Devotion',
};

const DAY_FULL = {
  monday:'Monday', tuesday:'Tuesday', wednesday:'Wednesday',
  thursday:'Thursday', friday:'Friday', saturday:'Saturday', sunday:'Sunday',
  first_friday:'1st Fri', first_saturday:'1st Sat', first_sunday:'1st Sun',
  first_tuesday:'1st Tue', first_monday:'1st Mon',
  second_sunday:'2nd Sun', second_tuesday:'2nd Tue',
  third_friday:'3rd Fri',
  fourth_friday:'4th Fri', fourth_sunday:'4th Sun', fourth_tuesday:'4th Tue',
  holyday:'Holy Day', holyday_eve:'Holy Day Eve',
  daily:'Daily', weekday:'Weekday', last_sunday:'Last Sun', '':'Varies',
};

let _currentParish = null;
let _activeTab     = 'flag';
let _selectedSvcId = null;

// ── helpers ─────────────────────────────────────────────────

function fmtT(t) {
  if (!t) return '';
  const [h,m] = t.split(':');
  const hr = parseInt(h);
  return `${hr > 12 ? hr-12 : hr||12}:${m} ${hr>=12?'PM':'AM'}`;
}

function svcMeta(s) {
  const days = (s.days||[s.day]).filter(Boolean);
  const dayStr = days.map(d=>DAY_FULL[d]||d).join('/');
  const timeStr = s.time ? fmtT(s.time) : (s.times_vary ? 'time varies' : '');
  const endStr = s.end_time ? `–${fmtT(s.end_time)}` : '';
  const langStr = s.language && s.language!=='en' ? s.language.toUpperCase() : '';
  return [dayStr, timeStr+endStr, langStr].filter(Boolean).join(' · ');
}

// ── open / close ─────────────────────────────────────────────

function openReconcile(parishId) {
  _currentParish  = PARISH_DATA.parishes.find(p=>p.id===parishId);
  if (!_currentParish) return;
  _selectedSvcId  = null;

  // Display church name
  const recLoc = _currentParish.locations && _currentParish.locations[0];
  let recChurchName = (recLoc && recLoc.name) ? recLoc.name : _currentParish.name;
  if (/Cathedral|Basilica/i.test(recChurchName)) {
    recChurchName = recChurchName.replace(/\s+Church$/i, '');
  }
  document.getElementById('mParishName').textContent =
    recChurchName + ' — ' + _currentParish.town + ', MA';

  // reset tabs
  switchTab('flag');

  // build service list
  buildSvcList();

  // clear fields
  ['fd_wrong','fd_source_url','fg_notes','fg_url'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const issueEl = document.getElementById('fd_issue_type');
  if (issueEl) issueEl.value = '';
  const srcEl = document.getElementById('fd_source');
  if (srcEl) srcEl.value = 'bulletin';

  // hide success, show footer
  document.getElementById('mSuccess').style.display = 'none';
  document.getElementById('mFtr').style.display = 'flex';
  document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='');
  document.querySelectorAll('.mode-tab').forEach(t=>t.style.display='');

  document.getElementById('reconcileBackdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeReconcile() {
  document.getElementById('reconcileBackdrop').classList.remove('open');
  document.body.style.overflow = '';
}

// close on backdrop click
document.getElementById('reconcileBackdrop').addEventListener('click', function(e) {
  if (e.target === this) closeReconcile();
});

// ── tab switching ────────────────────────────────────────────

function switchTab(tab) {
  _activeTab = tab;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('panel-'+tab).classList.add('active');
}

// ── service list ─────────────────────────────────────────────

function buildSvcList() {
  const el = document.getElementById('svcList');
  const svcs = _currentParish.services || [];
  if (!svcs.length) {
    el.innerHTML = '<div style="padding:14px;color:#aaa;font-size:0.85rem">No services recorded yet — use the General Note tab instead.</div>';
    return;
  }
  el.innerHTML = svcs.map((s,i) => {
    const typeLbl = SVC_TYPE_LABELS[s.type] || s.type;
    const meta    = svcMeta(s);
    const note    = s.notes ? `<div class="svc-item-note">${s.notes}</div>` : '';
    return `<label class="svc-item">
      <input type="radio" name="svcRadio" value="${s.id}" onchange="selectService('${s.id}')">
      <div class="svc-item-main">
        <div class="svc-item-type">${typeLbl}</div>
        <div class="svc-item-meta">${meta}</div>
        ${note}
      </div>
    </label>`;
  }).join('');
}

function selectService(svcId) {
  _selectedSvcId = svcId;
}

// ── email via Web3Forms ──────────────────────────────────────
const W3F_KEY = 'bf7958f8-3eda-4ed3-8b61-9843af03fd5a';
const W3F_URL = 'https://api.web3forms.com/submit';

async function sendFormEmail(subject, htmlBody, refId) {
  try {
    const resp = await fetch(W3F_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        access_key: W3F_KEY,
        subject: subject,
        from_name: 'Mass Finder',
        to: 'mvadamski@gmail.com',
        message: htmlBody,
        replyto: 'noreply@parishfinder.vercel.app',
      })
    });
    const data = await resp.json();
    if (!data.success) console.warn('Web3Forms error:', data.message);
    return data.success;
  } catch(e) {
    console.warn('Email send failed:', e);
    return false;
  }
}

function formatReconcileEmail(payload) {
  const lines = [];
  lines.push(`Parish: ${payload.parish_name} (${payload.parish_id})`);
  lines.push(`Tab: ${payload.mode}`);
  lines.push(`Ref: ${payload.ref_id}`);
  lines.push(`Submitted: ${payload.submitted_at}`);
  lines.push('');

  if (payload.mode === 'flag') {
    if (payload.service_id) lines.push(`Service ID: ${payload.service_id}`);
    if (payload.selected_service_label) lines.push(`Service: ${payload.selected_service_label}`);
    lines.push(`Issue type: ${payload.issue_type || '(not specified)'}`);
    if (payload.description) lines.push(`Description: ${payload.description}`);
    if (payload.source) lines.push(`Source: ${payload.source}`);
    if (payload.source_url) lines.push(`Source URL: ${payload.source_url}`);
  } else {
    if (payload.notes) lines.push(`Notes: ${payload.notes}`);
    if (payload.source_url) lines.push(`URL: ${payload.source_url}`);
  }

  return lines.join('\n');
}

function formatNewParishEmail(payload) {
  const lines = [];
  lines.push(`New church request: ${payload.name}`);
  lines.push(`Ref: ${payload.ref_id}`);
  lines.push(`Submitted: ${payload.submitted_at}`);
  lines.push('');
  if (payload.state) lines.push(`State: ${payload.state}`);
  if (payload.link) lines.push(`Link provided: ${payload.link}`);
  if (payload.website) lines.push(`Website: ${payload.website}`);
  if (payload.bulletin_url) lines.push(`Bulletin: ${payload.bulletin_url}`);
  if (payload.notes) lines.push(`Notes: ${payload.notes}`);
  return lines.join('\n');
}

// ── submit ───────────────────────────────────────────────────

function submitReconcile() {
  let valid = true;
  if (_activeTab === 'flag') {
    const issueEl = document.getElementById('fd_issue_type');
    if (!issueEl.value) {
      issueEl.style.borderColor = '#c0392b';
      issueEl.focus();
      valid = false;
    } else issueEl.style.borderColor = '';
  } else if (_activeTab === 'general') {
    const notesEl = document.getElementById('fg_notes');
    if (!notesEl.value.trim()) {
      notesEl.style.borderColor = '#c0392b';
      notesEl.focus();
      valid = false;
    } else notesEl.style.borderColor = '';
  }
  if (!valid) return;

  const now  = new Date();
  const refId = 'REC-' + now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') +
                String(now.getDate()).padStart(2,'0') + '-' +
                Math.random().toString(36).slice(2,7).toUpperCase();

  const payload = {
    ref_id:       refId,
    submitted_at: now.toISOString(),
    parish_id:    _currentParish.id,
    parish_name:  _currentParish.name,
    mode:         _activeTab,
  };

  if (_activeTab === 'flag') {
    payload.service_id  = _selectedSvcId;
    // Get the label of the selected service for the email
    if (_selectedSvcId) {
      const svc = (_currentParish.services||[]).find(x=>x.id===_selectedSvcId);
      if (svc) payload.selected_service_label = (SVC_TYPE_LABELS[svc.type]||svc.type) + ' — ' + svcMeta(svc);
    }
    payload.issue_type  = document.getElementById('fd_issue_type').value;
    payload.description = document.getElementById('fd_wrong').value;
    payload.source      = document.getElementById('fd_source').value;
    payload.source_url  = document.getElementById('fd_source_url').value;

  } else {
    payload.notes      = document.getElementById('fg_notes').value;
    payload.source_url = document.getElementById('fg_url').value;
  }

  // Send email
  const modeLabels = { flag: 'Flag Service Issue', general: 'General Note' };
  const subject = `[Parish Finder] ${modeLabels[_activeTab] || _activeTab} — ${_currentParish.name} (${refId})`;
  const body = formatReconcileEmail(payload);
  sendFormEmail(subject, body, refId);

  // Show success screen
  document.querySelectorAll('.tab-panel').forEach(p => p.style.display='none');
  document.querySelectorAll('.mode-tab').forEach(t => t.style.display='none');
  document.getElementById('mFtr').style.display = 'none';
  document.getElementById('mSuccess').style.display = 'block';
  document.getElementById('mRefId').textContent = 'Reference ID: ' + refId;
}
</script>


<!-- ══════════════════════════════════════════════════
     NEW PARISH REQUEST MODAL  (simplified v2)
══════════════════════════════════════════════════ -->
<div class="np-backdrop" id="npBackdrop">
<div class="np-box" style="max-width:520px">

  <div class="mhdr">
    <div class="mhdr-left">
      <h2>Add a Church</h2>
      <div class="mhdr-parish">Know one that's missing? We'll look it up.</div>
    </div>
    <button class="mhdr-close" onclick="closeNewParish()">×</button>
  </div>

  <div class="np-intro">
    Just give us a name and a link — the data team handles the rest. The more you share the faster we can add it.
  </div>

  <div class="mbody" id="npFormBody">

    <div class="fsection">
      <div class="fsection-title">Church info</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>Church name <span class="req">*</span></label>
          <input type="text" id="np_name" placeholder="e.g. St. Mary's Parish">
        </div>
        <div class="fg">
          <label>State</label>
          <select id="np_state">
            <option value="MA" selected>Massachusetts</option>
            <option value="CT">Connecticut</option>
            <option value="VT">Vermont</option>
            <option value="NH">New Hampshire</option>
            <option value="NY">New York</option>
            <option value="RI">Rhode Island</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="fg">
          <label>Website or bulletin link <span class="req">*</span> <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(either one works)</span></label>
          <input type="url" id="np_link" placeholder="https://www.churchname.org or bulletin link">
        </div>
        <div class="fg">
          <label>Anything else? <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(town, schedule, whatever you know)</span></label>
          <textarea id="np_notes" rows="3" placeholder="Optional — anything helps"></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- SUCCESS -->
  <div class="msuccess" id="npSuccess" style="display:none">
    <div class="sicon">+</div>
    <h3>Got it — thank you!</h3>
    <p>We'll look this up and add it to the directory once we've verified the schedule.</p>
    <div class="ref-id" id="npRefId"></div>
    <br>
    <button class="mbtn-submit" onclick="closeNewParish()">Close</button>
  </div>

  <div class="mftr" id="npFtr">
    <div class="mftr-note">Reviewed before anything goes live.</div>
    <button class="mbtn-cancel" onclick="closeNewParish()">Cancel</button>
    <button class="mbtn-submit" onclick="submitNewParish()">Submit →</button>
  </div>

</div>
</div>

<script>
function openNewParish() {
  ['np_name','np_link','np_notes']
    .forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  const stateEl = document.getElementById('np_state');
  if (stateEl) stateEl.value = 'MA';
  document.getElementById('npFormBody').style.display = 'block';
  document.getElementById('npSuccess').style.display  = 'none';
  document.getElementById('npFtr').style.display      = 'flex';
  document.getElementById('npBackdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeNewParish() {
  document.getElementById('npBackdrop').classList.remove('open');
  document.body.style.overflow = '';
}
// close on backdrop click
document.getElementById('npBackdrop').addEventListener('click', function(e) {
  if (e.target === this) closeNewParish();
});


function submitNewParish() {
  const nameEl = document.getElementById('np_name');
  const linkEl = document.getElementById('np_link');
  if (!nameEl.value.trim()) {
    nameEl.style.borderColor = '#c0392b';
    nameEl.focus();
    return;
  }
  nameEl.style.borderColor = '';
  if (!linkEl.value.trim()) {
    linkEl.style.borderColor = '#c0392b';
    linkEl.focus();
    return;
  }
  linkEl.style.borderColor = '';

  const now = new Date();
  const refId = 'NP-' + now.getFullYear() +
    String(now.getMonth()+1).padStart(2,'0') +
    String(now.getDate()).padStart(2,'0') + '-' +
    Math.random().toString(36).slice(2,7).toUpperCase();

  const link = document.getElementById('np_link').value;
  // Auto-detect if it's a bulletin link or website
  const isBulletin = /bulletin|parishesonline|church-bulletin|ecatholic/i.test(link);

  const payload = {
    ref_id:       refId,
    submitted_at: now.toISOString(),
    type:         'new_parish_request',
    name:         document.getElementById('np_name').value,
    state:        document.getElementById('np_state').value,
    website:      isBulletin ? '' : link,
    bulletin_url: isBulletin ? link : '',
    link:         link,
    notes:        document.getElementById('np_notes').value,
  };

  // Send email
  const subject = `[Parish Finder] New Church Request — ${payload.name} (${refId})`;
  const body = formatNewParishEmail(payload);
  sendFormEmail(subject, body, refId);

  document.getElementById('npFormBody').style.display = 'none';
  document.getElementById('npFtr').style.display      = 'none';
  document.getElementById('npSuccess').style.display  = 'block';
  document.getElementById('npRefId').textContent      = 'Reference ID: ' + refId;
}
</script>

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}

// PWA Install Banner — platform-aware, slim, dismissible
(function initInstallBanner() {
  // Don't show if already running as installed PWA
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (window.navigator.standalone === true) return; // iOS standalone

  // Don't show if user dismissed recently (30-day cookie)
  if (document.cookie.split('; ').some(c => c.startsWith('pf_install_dismissed='))) return;

  const slot = document.getElementById('installBannerSlot');
  if (!slot) return;

  const ua = navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isSafari = isIOS && /Safari/i.test(ua) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(ua);
  const isAndroid = /Android/i.test(ua);
  const isChrome = /Chrome/i.test(ua) && !/Edge|OPR|Brave/i.test(ua);

  // iOS: manual "Add to Home Screen" instructions (works in Safari, Chrome, etc.)
  if (isIOS) {
    const isIOSChrome = /CriOS/.test(ua);
    const isIOSFirefox = /FxiOS/.test(ua);
    let hint;
    if (isIOSChrome) {
      // Chrome on iOS: tap ••• menu then "Add to Home Screen"
      hint = `— tap <strong>⋯</strong> (menu) then "Add to Home Screen"`;
    } else if (isIOSFirefox) {
      hint = `— tap the menu then "Share" then "Add to Home Screen"`;
    } else {
      // Safari: tap share icon then Add to Home Screen
      const shareIcon = `<svg class="ios-share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12M5 10l7-7 7 7"/><path d="M5 17h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2a1 1 0 011-1z"/></svg>`;
      hint = `— tap ${shareIcon} then "Add to Home Screen"`;
    }
    slot.innerHTML = `<div class="install-banner" id="installBanner">
      <span class="ib-icon">✝</span>
      <span class="ib-text"><strong>Add to Home Screen</strong><span class="ib-hint">${hint}</span></span>
      <button class="ib-close" onclick="dismissInstall()" aria-label="Dismiss">✕</button>
    </div>`;
    return;
  }

  // Android Chrome: use beforeinstallprompt when available
  if (isAndroid && isChrome) {
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      slot.innerHTML = `<div class="install-banner" id="installBanner">
        <span class="ib-icon">✝</span>
        <span class="ib-text"><strong>Install Mass Finder</strong><span class="ib-hint">— quick access from your home screen</span></span>
        <button class="ib-action" id="ibInstallBtn">Install</button>
        <button class="ib-close" onclick="dismissInstall()" aria-label="Dismiss">✕</button>
      </div>`;

      document.getElementById('ibInstallBtn').addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(() => { deferredPrompt = null; dismissInstall(); });
        }
      });
    });

    window.addEventListener('appinstalled', () => { dismissInstall(); });
    return;
  }

  // Desktop: show subtle install hint only if beforeinstallprompt fires
  let deferredPromptDesktop = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPromptDesktop = e;
    slot.innerHTML = `<div class="install-banner" id="installBanner">
      <span class="ib-icon">✝</span>
      <span class="ib-text"><strong>Install Mass Finder</strong><span class="ib-hint">— as a desktop app for quick access</span></span>
      <button class="ib-action" id="ibInstallBtnD">Install</button>
      <button class="ib-close" onclick="dismissInstall()" aria-label="Dismiss">✕</button>
    </div>`;

    document.getElementById('ibInstallBtnD').addEventListener('click', () => {
      if (deferredPromptDesktop) {
        deferredPromptDesktop.prompt();
        deferredPromptDesktop.userChoice.then(() => { deferredPromptDesktop = null; dismissInstall(); });
      }
    });
  });

  window.addEventListener('appinstalled', () => { dismissInstall(); });
})();

function dismissInstall() {
  const b = document.getElementById('installBanner');
  if (b) b.parentElement.innerHTML = '';
  // Set 30-day dismissal cookie
  const d = new Date(); d.setDate(d.getDate() + 30);
  document.cookie = 'pf_install_dismissed=1;expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
}
window.dismissInstall = dismissInstall;
</script>

<!-- H6: Service Worker registration + update toast -->
<style>
.sw-toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  background: var(--navy); color: #fff; padding: 10px 20px; border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 9999;
  display: none; align-items: center; gap: 12px; font-size: 0.85rem;
  font-family: 'Source Sans 3', sans-serif;
}
.sw-toast.show { display: flex; }
.sw-toast button { background: var(--gold); color: var(--navy); border: none; padding: 4px 14px;
  border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.82rem; }
</style>
<div class="sw-toast" id="swToast">New data available <button onclick="location.reload()">Refresh</button></div>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      // Check for updates periodically
      setInterval(() => {
        if (reg.active) reg.active.postMessage('checkUpdate');
      }, 5 * 60 * 1000); // every 5 min
    }).catch(() => {});
    navigator.serviceWorker.addEventListener('message', e => {
      if (e.data === 'updateAvailable') {
        document.getElementById('swToast').classList.add('show');
      }
    });
  });
}
</script>

</body>
</html>
