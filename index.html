<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%231a2744'/%3E%3Crect x='40' y='10' width='20' height='80' rx='4' fill='%23c9a84c'/%3E%3Crect x='14' y='30' width='72' height='20' rx='4' fill='%23c9a84c'/%3E%3C/svg%3E">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">
<link rel="apple-touch-icon-precomposed" href="/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Mass Finder">
<meta name="theme-color" content="#1a2744">
<meta name="description" content="Find Mass, Confession, Adoration and more across Western Massachusetts">
<title>Mass Finder — Catholic Services Directory</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  :root {
    --navy: #1a2744;
    --navy-light: #243260;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-pale: #fdf6e3;
    --cream: #faf8f4;
    --warm-gray: #f0ece4;
    --mid-gray: #8a8278;
    --text: #2c2820;
    --text-light: #5c5650;
    --border: #ddd8ce;
    --red-warn: #9b2335;
    --green: #2d6a4f;
    --shadow: 0 2px 12px rgba(26,39,68,0.10);
    --shadow-lg: 0 8px 32px rgba(26,39,68,0.15);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Source Sans 3', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--navy);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    cursor: pointer;
  }
  .header-inner {
    max-width: 1280px;
    margin: 0 auto;
    padding: 8px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .header-cross {
    color: var(--gold);
    font-size: 22px;
    line-height: 1;
    flex-shrink: 0;
  }
  .header-title {
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
  }
  .header-title h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.01em;
    line-height: 1;
    white-space: nowrap;
  }
  .header-title p {
    font-size: 0.7rem;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .header-badge {
    margin-left: auto;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 0.75rem;
    color: var(--gold-light);
    font-weight: 500;
    white-space: nowrap;
  }
  .header-add-btn {
    padding: 4px 12px;
    background: var(--gold);
    color: var(--navy);
    border: none;
    border-radius: 20px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s;
    flex-shrink: 0;
    letter-spacing: 0.02em;
  }
  .header-add-btn:hover { background: var(--gold-light); }

  /* CONTROLS */
  .controls-bar {
    background: var(--navy-light);
    border-bottom: 2px solid var(--gold);
  }
  .controls-inner {
    max-width: 1280px;
    margin: 0 auto;
    padding: 10px 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .controls-row-1 { padding-bottom: 4px; }
  .controls-row-2 { padding-top: 4px; }
  .search-wrap {
    position: relative;
    flex: 1;
    min-width: 220px;
    max-width: 340px;
  }
  .search-wrap input {
    width: 100%;
    padding: 9px 14px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.2s;
  }
  .search-wrap input::placeholder { color: rgba(255,255,255,0.45); }
  .search-wrap input:focus { background: rgba(255,255,255,0.18); border-color: var(--gold); }
  select {
    padding: 9px 28px 9px 12px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    outline: none;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,0.5)'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    transition: all 0.2s;
  }
  select option { background: var(--navy); color: #fff; }
  select:focus { border-color: var(--gold); }
  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .chip {
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    background: transparent;
    color: rgba(255,255,255,0.7);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .chip.active { background: var(--gold); border-color: var(--gold); color: var(--navy); font-weight: 600; }
  .results-count {
    margin-left: auto;
    color: rgba(255,255,255,0.5);
    font-size: 0.82rem;
    white-space: nowrap;
  }

  /* SUBFILTER BAR */
  .subfilter-bar {
    background: rgba(0,0,0,0.18);
    border-bottom: 1px solid rgba(201,168,76,0.2);
    animation: slideDown 0.18s ease;
  }
  @keyframes slideDown {
    from { opacity:0; transform:translateY(-6px); }
    to   { opacity:1; transform:translateY(0); }
  }
  .subfilter-label {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.45);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
    font-weight: 500;
    margin-right: 4px;
  }
  .subchip {
    padding: 4px 11px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.15);
    background: transparent;
    color: rgba(255,255,255,0.6);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.76rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .subchip:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .subchip.active { background: var(--gold-light); border-color: var(--gold-light); color: var(--navy); font-weight: 600; }

  /* MAIN */
  main {
    max-width: 1280px;
    margin: 0 auto;
    padding: 28px 24px 60px;
  }

  /* NO RESULTS */
  .no-results {
    text-align: center;
    padding: 80px 20px;
    color: var(--mid-gray);
  }
  .no-results .cross { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
  .no-results p { font-size: 1.1rem; }

  /* PARISH GRID */
  .parish-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 20px;
  }

  /* PARISH CARD */
  .parish-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.15s;
    display: flex;
    flex-direction: column;
  }
  .parish-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
  }
  .parish-card.low-confidence {
    border-left: 3px solid #e8a020;
  }

  .card-header {
    padding: 12px 16px 10px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    position: relative;
  }
  .card-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.0rem;
    font-weight: 600;
    color: #fff;
    line-height: 1.25;
    margin-bottom: 2px;
    padding-right: 70px;
  }
  .card-location {
    font-size: 0.8rem;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 0.04em;
  }
  /* WP1-1B: Multi-site sibling locations */
  .also-at {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.55);
    margin-top: 2px;
    margin-bottom: 2px;
    font-style: italic;
    padding-right: 70px;
    line-height: 1.45;
    line-height: 1.3;
  }
  /* WP1-1C: Location label on service lines for multi-site parishes */
  .svc-location-label {
    font-size: 0.72rem;
    color: #888;
    margin-left: 4px;
    font-weight: 400;
    white-space: nowrap;
  }
  .county-badge {
    position: absolute;
    top: 14px;
    right: 14px;
    font-size: 0.72rem;
    font-weight: 600;
    line-height: 1;
  }
  /* Override verified-badge when it lives inside .county-badge (card header) */
  .county-badge .verified-badge {
    font-size: 0.72rem;
    background: transparent;
    border: none;
    padding: 0;
  }
  .confidence-warn {
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.72rem;
    color: #e8a020;
    font-weight: 500;
  }

  .card-meta {
    padding: 6px 16px;
    background: var(--warm-gray);
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-wrap: wrap;
    gap: 6px 14px;
    font-size: 0.78rem;
    color: var(--text-light);
  }
  .card-meta a { color: var(--navy); text-decoration: none; font-weight: 500; }
  .card-meta a:hover { color: var(--gold); text-decoration: underline; }
  .meta-item { display: flex; align-items: center; gap: 4px; }
  .phone-link {
    color: var(--navy);
    font-weight: 600;
    text-decoration: underline;
    text-decoration-color: rgba(26,54,93,0.3);
    text-underline-offset: 2px;
  }
  .phone-link:hover { color: var(--gold); text-decoration-color: var(--gold); }

  .card-body { padding: 10px 16px 12px; flex: 1; }

  /* SERVICE SECTIONS */
  .service-section { margin-bottom: 10px; }
  .service-section:last-child { margin-bottom: 0; }
  .service-section-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--mid-gray);
    margin-bottom: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* COLLAPSIBLE SERVICE SECTIONS */
  .svc-collapse { margin-bottom: 10px; }
  .svc-collapse:last-child { margin-bottom: 0; }
  .svc-collapse-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
  }
  .svc-collapse-header:hover { border-bottom-color: var(--gold-light); }
  .svc-collapse-chevron {
    font-size: 0.6rem;
    color: var(--mid-gray);
    transition: transform 0.2s ease;
    flex-shrink: 0;
    width: 10px;
    text-align: center;
  }
  .svc-collapse.open .svc-collapse-chevron { transform: rotate(90deg); }
  .svc-collapse-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--mid-gray);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .svc-collapse-summary {
    margin-left: auto;
    font-size: 0.68rem;
    color: var(--mid-gray);
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 55%;
    opacity: 0.7;
  }
  .svc-collapse.open .svc-collapse-summary { display: none; }
  .svc-collapse-body {
    display: none;
    padding-top: 4px;
  }
  .svc-collapse.open .svc-collapse-body { display: block; }
  /* Remove redundant title inside collapsible body */
  .svc-collapse-body .service-section { margin-bottom: 0; }
  .svc-collapse-body .service-section-title { display: none; }
  /* Lent section purple accent */
  .svc-collapse--lent .svc-collapse-header { border-bottom-color: #d4b8e8; }
  .svc-collapse--lent .svc-collapse-label { color: #7c4fa0; }
  .svc-collapse--lent .svc-collapse-chevron { color: #7c4fa0; }
  .svc-collapse--lent .svc-collapse-summary { color: #7c4fa0; }
  .svc-collapse--lent.open {
    background: rgba(124,79,160,0.12);
    border-left: 3px solid #7c4fa0;
    padding-left: 10px;
    margin-left: -10px;
    border-radius: 0 6px 6px 0;
  }
  .svc-collapse--lent.open .svc-collapse-header { border-bottom-color: rgba(124,79,160,0.2); }
  .svc-collapse--lent.open .svc-collapse-body .service-section.lenten {
    border-left: none;
    padding-left: 0;
    margin-left: 0;
  }
  .service-list { list-style: none; margin: 0; padding: 0; }
  .service-row {
    display: grid;
    grid-template-columns: 96px 1fr;
    gap: 0 6px;
    padding: 3px 0;
    font-size: 0.82rem;
    line-height: 1.45;
    color: var(--text);
    align-items: start;
  }
  .svc-day {
    font-weight: 600;
    color: var(--navy);
    font-size: 0.78rem;
    word-break: break-word;
    hyphens: none;
    padding-top: 1px;
    line-height: 1.3;
  }
  .svc-times {
    color: var(--text);
    min-width: 0;
  }
  /* Inline layout: times only, no notes — e.g. "8 AM · 10 AM · 12 PM" */
  .svc-inline {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0;
  }
  .svc-t { white-space: nowrap; }
  .svc-sep { color: #ccc; padding: 0 5px; }
  /* Stacked layout: entries with notes — one per line, note inline if it fits */
  .svc-stack { display: flex; flex-direction: column; gap: 2px; }
  .svc-stack-row {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0 6px;
    row-gap: 0;
  }
  .svc-stack-main { display: contents; }
  .svc-type-tag {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-left: 2px;
  }
  .svc-note-line {
    font-size: 0.73rem;
    color: var(--mid-gray);
    font-style: italic;
    line-height: 1.3;
    /* stays inline with time, wraps to next line only if needed */
    display: inline;
  }
  .service-detail { color: var(--text-light); font-size: 0.78rem; }
  .lang-tag {
    display: inline-block;
    background: var(--gold-pale);
    border: 1px solid var(--gold-light);
    border-radius: 3px;
    padding: 0 4px;
    font-size: 0.65rem;
    font-weight: 700;
    color: #8a6a00;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-left: 3px;
    vertical-align: middle;
  }
  .seasonal-tag {
    display: inline-block;
    background: #eef7f0;
    border: 1px solid #a8d5b5;
    border-radius: 3px;
    padding: 0 4px;
    font-size: 0.65rem;
    font-weight: 500;
    color: var(--green);
    margin-left: 3px;
    vertical-align: middle;
  }
  .service-note { font-size: 0.74rem; color: var(--mid-gray); font-style: italic; }
  .office-hours-bar {
    background: #f5f3ee;
    border-bottom: 1px solid var(--border);
    padding: 5px 16px;
    font-size: 0.76rem;
    color: #666;
  }
  .office-note { color: #aaa; font-style: italic; font-size: 0.72rem; }
  /* CARD FOOTER */
  .card-footer {
    padding: 6px 16px;
    background: var(--warm-gray);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.74rem;
    color: var(--mid-gray);
  }
  .pastor-name { font-style: italic; }
  .verified-badge {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.72rem;
    font-weight: 500;
  }
  .verified-badge.verified { color: var(--green); }
  .verified-badge.low { color: #e8a020; }
  .verified-badge.needs-review { color: #b07d00; }
  .verified-badge.low-confidence { color: #c0550a; }

  /* SORT TOGGLE */
  .sort-toggle {
    display: inline-flex;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .sort-btn {
    font-size: 0.72rem;
    font-weight: 600;
    padding: 4px 9px;
    background: #fff;
    border: none;
    border-right: 1px solid var(--border);
    color: var(--text-light);
    cursor: pointer;
    font-family: inherit;
    transition: background 0.12s, color 0.12s;
    white-space: nowrap;
  }
  .sort-btn:last-child { border-right: none; }
  .sort-btn:hover { background: var(--warm-gray); color: var(--navy); }
  .sort-btn.active { background: var(--navy); color: #fff; }
  /* Hide sort toggle until location is available — shown by JS */
  .sort-toggle { display: none; }
  .sort-toggle.location-ready { display: inline-flex; }

  /* VERIFICATION BADGE — compact trust indicator */
  .verify-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 0.55rem;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    transition: all 0.15s;
    font-family: 'Source Sans 3', sans-serif;
    line-height: 1.4;
    white-space: nowrap;
    user-select: none;
    -webkit-user-select: none;
    letter-spacing: 0.01em;
  }
  .verify-badge:hover { transform: scale(1.05); }
  .verify-badge .verify-icon { font-size: 0.6rem; flex-shrink: 0; }

  .verify-green  { background: rgba(46,125,82,0.12); color: #2e7d52; border: 1px solid rgba(46,125,82,0.3); }
  .verify-yellow { background: rgba(180,140,0,0.1); color: #8d6e00; border: 1px solid rgba(180,140,0,0.25); }
  .verify-orange { background: rgba(192,85,10,0.1); color: #bf360c; border: 1px solid rgba(192,85,10,0.25); }
  .verify-red    { background: rgba(192,57,43,0.08); color: #c62828; border: 1px solid rgba(192,57,43,0.2); }

  /* Expanded detail panel */
  .verify-detail {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    padding: 12px 14px;
    z-index: 60;
    min-width: 230px;
    max-width: 290px;
    text-align: left;
    white-space: normal;
    font-weight: 400;
    color: var(--text);
  }
  .verify-badge.open .verify-detail { display: block; }
  .verify-detail-title {
    font-size: 0.72rem; font-weight: 700; margin-bottom: 6px;
    display: flex; align-items: center; gap: 5px;
  }
  .verify-detail-row {
    font-size: 0.7rem; line-height: 1.4; margin-bottom: 4px;
    color: var(--text-light);
  }
  .verify-detail-row strong { color: var(--text); }
  .verify-detail-action {
    font-size: 0.68rem; font-weight: 600; margin-top: 8px; padding-top: 6px;
    border-top: 1px solid var(--border); color: var(--navy);
  }

  /* BULLETIN LINK */
  .bulletin-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--navy);
    background: var(--gold-light);
    border: 1px solid var(--gold);
    border-radius: 4px;
    padding: 3px 8px;
    text-decoration: none;
    transition: background 0.15s;
  }
  .bulletin-link:hover { background: var(--gold); color: var(--navy); }

  /* CONTACT DRAWER */
  .contact-toggle-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--navy);
    background: transparent;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    padding: 4px 10px;
    cursor: pointer;
    font-family: inherit;
    transition: border-color 0.15s, background 0.15s;
  }
  .contact-toggle-btn:hover { border-color: var(--navy); background: var(--warm-gray); }
  .contact-toggle-btn.open { border-color: var(--navy); background: var(--navy); color: #fff; }
  .contact-drawer {
    display: none;
    background: var(--warm-gray);
    border-top: 1px solid var(--border);
    padding: 10px 16px;
    font-size: 0.78rem;
    color: var(--text);
    gap: 6px;
    flex-direction: column;
  }
  .contact-drawer.open { display: flex; }
  .contact-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    line-height: 1.4;
  }
  .contact-row-label {
    font-weight: 700;
    color: var(--text-light);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    min-width: 80px;
    flex-shrink: 0;
    padding-top: 1px;
  }
  .contact-row-val { color: var(--text); }
  .contact-row-val a { color: var(--navy); font-weight: 600; }

  /* CLEAR FILTERS BUTTON */
  .clear-filters-btn {
    padding: 6px 16px;
    border-radius: 20px;
    border: 1.5px solid #c0392b;
    background: #fff0ee;
    color: #c0392b;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    min-height: 34px;
    -webkit-tap-highlight-color: rgba(192,57,43,0.2);
  }
  .clear-filters-btn:hover, .clear-filters-btn:active { background: #c0392b; color: #fff; }

  /* LOCATION DENIED NOTICE */
  .location-denied-notice {
    background: #fff8ee;
    border: 1px solid #f0c060;
    border-radius: 6px;
    padding: 10px 16px;
    font-size: 0.82rem;
    color: #7a5200;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  /* STATS BAR */
  .stats-bar {
    background: var(--gold-pale);
    border-bottom: 1px solid var(--gold-light);
    padding: 10px 24px;
  }
  .stats-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    gap: 28px;
    flex-wrap: wrap;
    align-items: center;
  }
  .stat { font-size: 0.82rem; color: var(--text-light); }
  .stat strong { color: var(--navy); font-weight: 700; font-size: 1rem; }
  .stat-divider { width: 1px; height: 20px; background: var(--border); }

  /* Lenten services section */
  .service-section.lenten {
    border-left: 3px solid #7c4fa0;
    padding-left: 10px;
    margin-left: -10px;
  }
  .service-section.lenten .service-section-title {
    color: #7c4fa0;
    border-bottom-color: #d4b8e8;
  }
  .service-section.lenten .service-section-title span.icon-lent {
    color: #7c4fa0;
  }
  /* Lenten tag override — purple instead of green */
  .service-section.lenten .seasonal-tag {
    background: #f5eeff;
    border-color: #c9a0e0;
    color: #7c4fa0;
  }

  /* YC Events section — warm amber treatment (mirrors Lenten purple) */
  .service-section.yc-events-section {
    border-left: 3px solid #e8a838;
    padding-left: 10px;
    margin-left: -10px;
    background: linear-gradient(135deg, rgba(232,168,56,0.06) 0%, rgba(212,131,26,0.03) 100%);
    border-radius: 0 8px 8px 0;
    padding-top: 6px;
    padding-bottom: 6px;
    margin-bottom: 4px;
  }
  .service-section.yc-events-section .service-section-title {
    color: #b8860b;
    border-bottom-color: #f0dfa0;
  }

  /* Holy Day sub-divider within Mass section */
  .holyday-divider {
    border: none;
    border-top: 1px dashed var(--border);
    margin: 6px 0 4px;
  }
  .holyday-sub-label {
    font-size: 0.63rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9b8040;
    margin-bottom: 2px;
    display: block;
  }

  /* WP2-2C: Special Events section */
  .service-section.special-events .service-section-title {
    color: #b8860b;
    border-bottom-color: #e8d5a0;
  }
  .special-event-row {
    display: flex;
    gap: 10px;
    padding: 4px 0;
    font-size: 0.82rem;
    line-height: 1.35;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    align-items: flex-start;
    overflow: visible;
  }
  .special-event-row .cal-dropdown { flex-shrink: 0; }
  .special-event-row:last-child { border-bottom: none; }
  .special-event-date {
    font-weight: 600;
    color: #b8860b;
    white-space: nowrap;
    min-width: 50px;
    flex-shrink: 0;
    max-width: 90px;
  }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .parish-grid { grid-template-columns: 1fr; }
    .header-badge { display: none; }
    .header-add-btn { margin-left: auto; }
    .controls-inner { padding: 8px 14px; }
    .controls-row-1 { padding-bottom: 2px; }
    .controls-row-2 { padding-top: 2px; }
    .search-wrap { min-width: 140px; }
    main { padding: 16px 14px 40px; }
  }
  @media (max-width: 520px) {
    .controls-row-1 {
      flex-wrap: wrap;
      gap: 5px;
      padding: 6px 10px 2px;
    }
    .controls-row-1 .search-wrap {
      min-width: 0;
      max-width: none;
      flex: 1 1 100%;
    }
    .controls-row-1 .search-wrap input {
      padding: 8px 10px;
      font-size: 0.82rem;
    }
    .controls-row-1 select {
      flex: 1;
      min-width: 0;
      padding: 7px 20px 7px 8px;
      font-size: 0.75rem;
      background-position: right 5px center;
      background-size: 10px;
    }
    .controls-row-2 { padding: 2px 10px 6px; gap: 5px; }
  }

  /* EMPTY STATE HELPERS */
  .loading { text-align: center; padding: 60px; color: var(--mid-gray); font-size: 1.1rem; }

  /* FADE IN */
  .parish-card { animation: fadeUp 0.25s ease both; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ─── REPORT BUTTON ─────────────────────────────────────── */
  .reconcile-btn {
    padding: 3px 10px;
    font-size: 0.71rem;
    font-family: 'Source Sans 3', sans-serif;
    background: transparent;
    border: 1px solid rgba(201,168,76,0.5);
    color: var(--gold);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .reconcile-btn:hover {
    background: var(--gold);
    color: var(--navy);
    border-color: var(--gold);
  }

  /* ─── RECONCILIATION MODAL ─────────────────────────────────── */
  .modal-backdrop {
    display: none;
    position: fixed; inset: 0; z-index: 2000;
    background: rgba(8,18,40,0.78);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    padding: 16px;
  }
  .modal-backdrop.open { display: flex; }

  .modal-box {
    background: #fff;
    border-radius: 12px;
    width: 100%;
    max-width: 780px;
    max-height: 92dvh;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.45);
    animation: mIn 0.2s ease;
    overflow: hidden;
  }
  @keyframes mIn {
    from { opacity:0; transform: translateY(-18px) scale(0.98); }
    to   { opacity:1; transform: none; }
  }

  /* Modal header */
  .mhdr {
    background: var(--navy);
    color: #fff;
    padding: 18px 24px 14px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-shrink: 0;
  }
  .mhdr-left h2 { margin: 0; font-size: 1.05rem; font-weight: 700; }
  .mhdr-left .mhdr-parish {
    font-size: 0.8rem;
    color: var(--gold);
    font-style: italic;
    margin-top: 3px;
  }
  .mhdr-close {
    background: transparent; border: none;
    color: rgba(255,255,255,0.55); font-size: 1.6rem;
    cursor: pointer; line-height: 1; padding: 0;
    transition: color 0.15s; flex-shrink: 0;
  }
  .mhdr-close:hover { color: #fff; }

  /* Mode tabs */
  .mode-tabs {
    display: flex;
    border-bottom: 2px solid #e4e8f0;
    background: #f9fafc;
    flex-shrink: 0;
  }
  .mode-tab {
    flex: 1;
    padding: 12px 8px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: #777;
    transition: all 0.15s;
    margin-bottom: -2px;
  }
  .mode-tab:hover { color: var(--navy); }
  .mode-tab.active { color: var(--navy); border-bottom-color: var(--gold); background: #fff; }

  /* Modal body */
  .mbody { padding: 22px 24px; overflow-y: auto; flex: 1 1 auto; }

  /* ─── Tabs panels */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ─── Existing service list (Flag mode) */
  .svc-list {
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid #d8dce8;
    border-radius: 7px;
    background: #fafbfd;
    margin-bottom: 14px;
  }
  .svc-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid #edf0f7;
    cursor: pointer;
    transition: background 0.12s;
  }
  .svc-item:last-child { border-bottom: none; }
  .svc-item:hover { background: #eef2ff; }
  .svc-item input[type=radio] { margin-top: 3px; accent-color: var(--navy); flex-shrink: 0; }
  .svc-item-main { flex: 1; }
  .svc-item-type { font-weight: 600; font-size: 0.88rem; color: #1a2244; }
  .svc-item-meta { font-size: 0.76rem; color: #777; margin-top: 1px; }
  .svc-item-note { font-size: 0.74rem; color: #999; font-style: italic; }

  /* Selected service detail (editable fields) */
  .selected-svc-detail {
    display: none;
    background: #f0f4ff;
    border: 1px solid #c4cef0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 4px;
  }
  .selected-svc-detail.visible { display: block; }
  .selected-svc-detail .detail-label {
    font-size: 0.74rem;
    font-weight: 700;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 10px;
  }

  /* ─── Form grid */
  .fgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 13px; }
  .fgrid.cols1 { grid-template-columns: 1fr; }
  .fgrid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
  .fg { display: flex; flex-direction: column; gap: 4px; }
  .fg.span2 { grid-column: 1 / -1; }
  .fg label {
    font-size: 0.73rem;
    font-weight: 700;
    color: #444;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }
  .fg label .req { color: #c0392b; }
  .fg input, .fg select, .fg textarea {
    padding: 8px 10px;
    border: 1px solid #c8d0e0;
    border-radius: 5px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.9rem;
    color: #1a2244;
    background: #fff;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .fg input:focus, .fg select:focus, .fg textarea:focus {
    outline: none;
    border-color: var(--navy);
    box-shadow: 0 0 0 3px rgba(10,22,75,0.1);
  }
  .fg textarea { resize: vertical; min-height: 72px; }
  .fg .hint { font-size: 0.71rem; color: #999; font-style: italic; }

  /* Inline checkbox row */
  .check-row { flex-direction: row !important; align-items: center; gap: 8px; }
  .check-row label { text-transform: none !important; font-weight: 400 !important; font-size: 0.88rem !important; letter-spacing: 0 !important; }
  .check-row input[type=checkbox] { width: 16px; height: 16px; padding: 0; accent-color: var(--navy); cursor: pointer; flex-shrink: 0; }

  /* Day-of-week toggle chips */
  .day-chips { display: flex; flex-wrap: wrap; gap: 5px; }
  .dc {
    padding: 4px 11px;
    border: 1px solid #c8d0e0;
    border-radius: 20px;
    font-size: 0.78rem;
    cursor: pointer;
    user-select: none;
    transition: all 0.13s;
    background: #fff;
    color: #555;
  }
  .dc.on { background: var(--navy); border-color: var(--navy); color: #fff; font-weight: 600; }

  /* Section dividers within the form */
  .fsection {
    margin-bottom: 20px;
    border: 1px solid #e4e8f0;
    border-radius: 8px;
    overflow: hidden;
  }
  .fsection-title {
    background: #f3f5fb;
    border-bottom: 1px solid #e4e8f0;
    padding: 8px 14px;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.09em;
  }
  .fsection-body { padding: 15px 14px; }

  /* Modal footer */
  .mftr {
    background: #f5f7fb;
    border-top: 1px solid #e4e8f0;
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    flex-shrink: 0;
  }
  .mftr .mftr-note { font-size: 0.74rem; color: #999; font-style: italic; flex: 1; }

  .mbtn-cancel {
    padding: 9px 18px;
    background: transparent;
    border: 1px solid #bbb;
    border-radius: 6px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    color: #555;
    cursor: pointer;
    transition: all 0.13s;
  }
  .mbtn-cancel:hover { border-color: #555; color: #222; }
  .mbtn-submit {
    padding: 9px 22px;
    background: var(--navy);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.13s;
  }
  .mbtn-submit:hover { background: #162a70; }
  .mbtn-submit.danger { background: #c0392b; }

  /* Success screen */
  .msuccess {
    display: none;
    text-align: center;
    padding: 48px 32px;
  }
  .msuccess .sicon { font-size: 3.2rem; }
  .msuccess h3 { color: var(--navy); font-size: 1.2rem; margin: 14px 0 8px; }
  .msuccess p { color: #555; font-size: 0.92rem; line-height: 1.6; }
  .msuccess .ref-id { font-size: 0.78rem; color: #aaa; margin-top: 12px; font-family: monospace; }


  /* ─── ADD PARISH CTA STRIP ─────────────────────────────────── */
  /* ─── NEW PARISH MODAL ──────────────────────────────────────── */
  .np-backdrop {
    display: none;
    position: fixed; inset: 0; z-index: 3000;
    background: rgba(8,18,40,0.82);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    padding: 16px;
  }
  .np-backdrop.open { display: flex; }

  .np-box {
    background: #fff;
    border-radius: 12px;
    width: 100%;
    max-width: 860px;
    max-height: 92dvh;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    animation: mIn 0.2s ease;
    overflow: hidden;
  }

  /* reuse mhdr, mbody, mftr, fg, fgrid, fsection from reconcile modal */

  .np-intro {
    background: #f5f7fb;
    border-bottom: 1px solid #e4e8f0;
    padding: 14px 24px;
    font-size: 0.84rem;
    color: #555;
    line-height: 1.55;
    flex-shrink: 0;
  }
  .np-intro strong { color: var(--navy); }

  /* progress stepper */
  .np-stepper {
    display: flex;
    background: #f9fafc;
    border-bottom: 2px solid #e4e8f0;
    overflow-x: auto;
    flex-shrink: 0;
  }
  .np-step {
    flex: 1;
    min-width: 80px;
    text-align: center;
    padding: 10px 6px;
    font-size: 0.72rem;
    font-weight: 700;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 3px solid transparent;
    cursor: default;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .np-step.active { color: var(--navy); border-bottom-color: var(--gold); background: #fff; }
  .np-step.done   { color: #4caf50; border-bottom-color: #4caf50; }

  /* service builder */
  .svc-builder { }
  .svc-entry {
    background: #f5f7fb;
    border: 1px solid #e0e4f0;
    border-radius: 7px;
    padding: 14px;
    margin-bottom: 10px;
    position: relative;
  }
  .svc-entry-num {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 10px;
  }
  .svc-remove {
    position: absolute; top: 10px; right: 12px;
    background: transparent; border: none;
    color: #bbb; font-size: 1.1rem; cursor: pointer;
    transition: color 0.13s;
  }
  .svc-remove:hover { color: #c0392b; }
  .add-svc-btn {
    width: 100%;
    padding: 9px;
    background: transparent;
    border: 2px dashed #c8d0e0;
    border-radius: 7px;
    color: #888;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.13s;
    margin-top: 4px;
  }
  .add-svc-btn:hover { border-color: var(--navy); color: var(--navy); background: #f0f4ff; }


  @media (max-width: 600px) {
    .modal-backdrop, .np-backdrop { padding: 10px; align-items: flex-end; }
    .modal-box, .np-box {
      max-height: 96dvh; max-height: 96vh;
      border-bottom-left-radius: 0; border-bottom-right-radius: 0;
    }
    .mbody { padding: 16px; }
    .fgrid { grid-template-columns: 1fr !important; }
    .fgrid.cols3 { grid-template-columns: 1fr !important; }
    .fg.span2 { grid-column: 1 !important; }
    .mftr { padding: 12px 16px; flex-wrap: wrap; }
    .mftr-note { display: none; }
    .mode-tab { font-size: 0.72rem; padding: 10px 4px; }
    .mhdr { padding: 14px 16px 12px; }
    .mhdr-left h2 { font-size: 0.95rem; }
    .fsection-body { padding: 12px 10px; }
  }


  /* ── HAPPENING SOON BANNER ── */
  #happeningSoon {
    background: var(--navy);
    color: #fff;
    padding: 0;
    border-bottom: 2px solid var(--gold);
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s;
  }
  .soon-inner {
    max-width: 1280px;
    margin: 0 auto;
    padding: 8px 16px;
  }
  .soon-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .soon-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .soon-row-title {
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .soon-title {
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--gold-light);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .soon-location {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.55);
    cursor: pointer;
    text-decoration: underline dotted;
    flex-shrink: 0;
  }
  .soon-cards {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 2px;
  }
  .soon-cards::-webkit-scrollbar { display: none; }
  .soon-card {
    flex-shrink: 0;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 7px 11px;
    min-width: 140px;
    max-width: 200px;
    cursor: pointer;
    transition: background 0.15s;
    text-decoration: none;
    display: block;
  }
  .soon-card:hover { background: rgba(255,255,255,0.15); }
  .soon-card-time {
    font-size: 1.0rem;
    font-weight: 700;
    color: var(--gold-light);
    line-height: 1;
    margin-bottom: 3px;
  }
  .soon-card-starts {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }
  .soon-card-parish {
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
    line-height: 1.2;
    margin-bottom: 2px;
  }
  .soon-card-town {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.55);
  }
  .soon-card-dist {
    font-size: 0.65rem;
    color: var(--gold-light);
    margin-top: 3px;
  }
  .soon-card-type {
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.5);
    margin-bottom: 2px;
  }
  .soon-card.lenten {
    border-color: rgba(196,160,224,0.35);
    background: rgba(124,79,160,0.2);
  }
  .soon-card.lenten .soon-card-time { color: #d4b8e8; }
  .soon-card.lenten .soon-card-dist { color: #d4b8e8; }
  /* WP2-2A: In-progress services get a subtle green accent */
  .soon-card.happening-now {
    border-color: rgba(52,168,83,0.45);
    background: rgba(52,168,83,0.12);
  }
  .soon-card.happening-now .soon-card-starts {
    color: #34a853;
    font-weight: 600;
  }
  .soon-none {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.5);
    padding: 4px 0;
  }

  /* Mode toggle tabs */
  .soon-mode-tabs {
    display: flex;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 5px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .soon-mode-tab {
    font-size: 0.68rem;
    font-weight: 600;
    background: none;
    border: none;
    border-right: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.55);
    padding: 4px 10px;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    font-family: inherit;
    white-space: nowrap;
  }
  .soon-mode-tab:last-child { border-right: none; }
  .soon-mode-tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .soon-mode-tab.active { background: rgba(255,255,255,0.18); color: #fff; }
  .soon-mode-tab.lent-tab.active { background: rgba(128,0,128,0.3); color: #e8c8ff; }

  /* Collapse toggle - mobile only */
  .soon-collapse-btn {
    display: none;
    background: none;
    border: 1px solid rgba(255,255,255,0.25);
    color: rgba(255,255,255,0.6);
    font-size: 0.9rem;
    line-height: 1;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    flex-shrink: 0;
    padding: 0;
  }
  .soon-collapse-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .soon-body { max-height: 300px; transition: max-height 0.2s ease, opacity 0.2s; overflow: hidden; opacity: 1; }
  .soon-body.collapsed { max-height: 0; opacity: 0; padding: 0; }

  /* ── MOBILE: soon section ── */
  @media (max-width: 520px) {
    .soon-collapse-btn { display: flex; align-items: center; justify-content: center; }
    .soon-header { margin-bottom: 0; }
    .soon-body:not(.collapsed) { margin-top: 6px; }
    .soon-row-title {
      flex-wrap: wrap;
      gap: 4px;
    }
    .soon-title {
      font-size: 0.72rem;
    }
    .soon-mode-tab {
      padding: 5px 12px;
      font-size: 0.72rem;
    }
    .soon-location {
      font-size: 0.65rem;
      width: 100%;
    }
  }


  /* ── LANGUAGE BAR ── */
  .lang-bar {
    max-width: 1280px;
    margin: 0 auto;
    padding: 6px 16px 0;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }
  .lang-bar-label {
    font-size: 0.72rem;
    color: var(--mid-gray);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 2px;
  }
  .lang-btn {
    padding: 4px 10px;
    border-radius: 14px;
    border: 1.5px solid var(--border);
    background: #fff;
    color: var(--text);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .lang-btn:hover { border-color: var(--gold); background: var(--gold-pale); }
  .lang-btn.active { background: var(--navy); border-color: var(--navy); color: #fff; }

  /* ── DIRECTIONS BUTTON ON CARD ── */
  .directions-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1.5px solid #34A853;
    background: #e8f5e9;
    color: #1a6b2a;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .directions-btn:hover { background: #c8e6c9; }
  .directions-btn svg { flex-shrink: 0; }

  /* ── DISTANCE BADGE ON CARD ── */
  .dist-badge {
    font-size: 0.68rem;
    color: var(--mid-gray);
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }
  .dist-badge.near { color: var(--green); font-weight: 600; }

  /* ── SHARE BUTTON ── */
  .share-btn {
    padding: 2px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #fff;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }
  .share-btn:hover { border-color: var(--navy); color: var(--navy); }
  .share-btn.copied { background: var(--green); color: #fff; border-color: var(--green); }

  /* ── ACCESSIBILITY BADGE ── */
  .access-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 0.72rem;
    color: var(--text);
    font-weight: 600;
    white-space: nowrap;
  }

  /* ── CALENDAR BUTTON ── */
  .cal-btn {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 7px;
    border: 1px solid rgba(232,168,56,0.35);
    border-radius: 4px;
    background: transparent;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.62rem;
    font-weight: 600;
    color: #e8a838;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    text-decoration: none;
  }
  .yc-card .cal-dropdown { margin-top: 5px; display: block; }
  .cal-btn:hover { background: rgba(232,168,56,0.15); border-color: #e8a838; }
  .cal-dropdown {
    position: relative;
    display: inline-block;
  }
  .cal-dropdown-menu {
    display: none;
    position: fixed;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: var(--shadow-lg);
    z-index: 200;
    min-width: 160px;
    padding: 4px 0;
  }
  .cal-dropdown-menu.open { display: block; }
  .cal-dropdown-menu a {
    display: block;
    padding: 7px 14px;
    font-size: 0.8rem;
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
  }
  .cal-dropdown-menu a:hover { background: var(--warm-gray); }
  .special-event-cal {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 1px 6px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: transparent;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.62rem;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    text-decoration: none;
    margin-left: 6px;
  }
  .special-event-cal:hover { background: var(--warm-gray); border-color: var(--navy); color: var(--navy); }

  /* ── PROXIMITY SORT INDICATOR ── */
  .sort-indicator {
    font-size: 0.72rem;
    color: var(--mid-gray);
    padding: 4px 0 0 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ── YOUNG & CATHOLIC EVENTS ── */
  #ycEventsSection {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    padding: 10px 0 12px;
  }
  .yc-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 12px;
  }
  .yc-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .yc-title {
    font-size: 0.82rem;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .yc-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e8a838 0%, #d4831a 100%);
    color: #1a1a2e;
    font-size: 0.58rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    padding: 2px 6px;
    border-radius: 3px;
    text-transform: uppercase;
  }
  .yc-subtitle {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.45);
  }
  .yc-cards {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 4px;
  }
  .yc-cards::-webkit-scrollbar { height: 3px; }
  .yc-cards::-webkit-scrollbar-thumb { background: rgba(232,168,56,0.3); border-radius: 2px; }
  .yc-card {
    flex: 0 0 auto;
    min-width: 155px;
    max-width: 180px;
    background: rgba(232,168,56,0.08);
    border: 1px solid rgba(232,168,56,0.25);
    border-radius: 8px;
    padding: 10px 11px 9px;
    scroll-snap-align: start;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    text-decoration: none;
    color: inherit;
    display: block;
  }
  .yc-card:hover { background: rgba(232,168,56,0.15); border-color: rgba(232,168,56,0.45); }
  .yc-card-date {
    font-size: 0.68rem;
    font-weight: 700;
    color: #e8a838;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .yc-card-title {
    font-size: 0.82rem;
    font-weight: 600;
    color: #fff;
    margin: 3px 0 2px;
    line-height: 1.2;
  }
  .yc-card-time {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.7);
  }
  .yc-card-place {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.45);
    margin-top: 3px;
    line-height: 1.25;
  }
  .yc-card-social {
    display: inline-block;
    font-size: 0.56rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #e8a838;
    margin-top: 4px;
    opacity: 0.8;
  }
  .yc-card-dist {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.5);
    margin-top: 3px;
  }
  /* YC badge on parish cards — sits above the card header as its own strip */
  .parish-yc-banner {
    background: linear-gradient(135deg, #e8a838 0%, #d4831a 100%);
    color: #1a1a2e;
    padding: 6px 12px;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    display: flex;
    align-items: center;
    gap: 10px;
    line-height: 1.3;
    min-height: 32px;
  }
  .parish-yc-banner .yc-banner-label {
    flex-shrink: 0;
    font-size: 0.72rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    background: rgba(26,26,46,0.2);
    color: #1a1a2e;
    padding: 3px 10px;
    border-radius: 4px;
  }
  .parish-yc-banner .yc-banner-text {
    flex: 1;
    min-width: 0;
    font-weight: 600;
    font-size: 0.72rem;
    opacity: 0.85;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* YC badge inline on individual service lines — more prominent */
  .svc-yc-tag {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #e8a838 0%, #d4831a 100%);
    color: #fff;
    font-size: 0.55rem;
    font-weight: 800;
    letter-spacing: 0.06em;
    padding: 2px 6px;
    border-radius: 3px;
    text-transform: uppercase;
    margin-left: 5px;
    vertical-align: middle;
    text-shadow: 0 0.5px 1px rgba(0,0,0,0.2);
    box-shadow: 0 1px 3px rgba(212,131,26,0.35);
  }

  /* YC active this week — full card highlight */
  .parish-card.yc-active-week {
    border: 2px solid #e8a838;
    box-shadow: 0 0 0 1px rgba(232,168,56,0.2), 0 4px 16px rgba(232,168,56,0.15);
  }
  .parish-card.yc-active-week:hover {
    box-shadow: 0 0 0 1px rgba(232,168,56,0.3), 0 6px 24px rgba(232,168,56,0.22);
  }
  .parish-card.yc-active-week .card-header {
    background: linear-gradient(135deg, #2a2540 0%, #3a2f50 100%);
  }
  .parish-card.yc-active-week .parish-yc-banner {
    padding: 8px 12px;
  }
  .parish-card.yc-active-week .parish-yc-banner .yc-banner-label {
    font-size: 0.78rem;
    padding: 4px 12px;
  }

  /* YC literal event rows in Upcoming Events section */
  .yc-event-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 4px 0;
    border-bottom: 1px solid #f0ead6;
  }
  .yc-event-row:last-child { border-bottom: none; }
  .yc-event-date-col {
    flex-shrink: 0;
    font-size: 0.68rem;
    font-weight: 700;
    color: #b8860b;
    min-width: 48px;
  }
  .yc-event-detail-col {
    font-size: 0.72rem;
    color: #333;
    line-height: 1.3;
  }
  .yc-event-title-tag {
    font-weight: 600;
  }
  .yc-event-social-tag {
    font-size: 0.6rem;
    color: #b8860b;
    font-weight: 600;
    margin-left: 4px;
  }
  .yc-recurrence-note {
    font-size: 0.62rem;
    color: #999;
    font-style: italic;
    margin-top: 1px;
  }

  /* Special event text truncation with tap-to-expand */
  .special-event-detail {
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    cursor: pointer;
  }
  .special-event-detail.expanded {
    -webkit-line-clamp: unset;
    display: block;
    overflow: visible;
  }

  /* ── TAB BAR (WP8) ── */
  .app-tab-bar {
    background: var(--navy);
    border-bottom: 2px solid var(--gold);
    display: flex;
    justify-content: center;
    gap: 0;
    position: sticky;
    top: 42px;
    z-index: 99;
  }
  .app-tab {
    flex: 1;
    max-width: 180px;
    padding: 12px 14px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.82rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.5);
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    white-space: nowrap;
    margin-bottom: -2px;
  }
  .app-tab:hover { color: rgba(255,255,255,0.8); }
  .app-tab.active { color: #fff; border-bottom-color: var(--gold); }
  .app-tab .tab-icon { margin-right: 5px; font-size: 0.85rem; }

  /* ── APP VIEWS ── */
  .app-view { display: none; }
  .app-view.active { display: block; }

  /* ── WHAT'S NOW VIEW (WP8) ── */
  .now-view {
    max-width: 1280px;
    margin: 0 auto;
    padding: 16px 24px 60px;
  }
  .now-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    gap: 8px;
    flex-wrap: wrap;
  }
  .now-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--navy);
  }
  .now-location-btn {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--gold);
    background: var(--gold-pale);
    color: var(--navy);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .now-location-btn:hover { background: var(--gold-light); }
  .now-location-btn.active { background: var(--green); border-color: var(--green); color: #fff; }
  .now-filter-pills {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .now-pill {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: #fff;
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .now-pill:hover { border-color: var(--gold); background: var(--gold-pale); }
  .now-pill.active { background: var(--navy); border-color: var(--navy); color: #fff; }
  .now-pill.lent-pill.active { background: #7c4fa0; border-color: #7c4fa0; }
  .now-timeline { display: flex; flex-direction: column; gap: 6px; }
  /* Desktop grid for What's Now and YC Events */
  @media (min-width: 769px) {
    .now-view { max-width: 960px; margin: 0 auto; }
    .now-timeline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .now-section-label { grid-column: 1 / -1; }
    .now-overflow-wrapper { grid-column: 1 / -1; display: none; }
    .now-overflow-wrapper.open {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .now-expand-btn { grid-column: 1 / -1; }
    .now-empty { grid-column: 1 / -1; }
  }
  .now-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: box-shadow 0.15s, border-color 0.15s;
    text-decoration: none;
    color: inherit;
  }
  .now-item:hover { box-shadow: var(--shadow); border-color: var(--gold-light); }
  .now-item.happening { border-left: 3px solid var(--green); background: #f0faf4; }
  .now-item.yc-event { border-left: 3px solid #e8a838; background: #fffbf0; }
  .now-item.lent-item { border-left: 3px solid #7c4fa0; background: #faf5ff; }
  .now-item-time {
    flex-shrink: 0;
    min-width: 58px;
    text-align: center;
  }
  .now-item-time .time-big {
    font-size: 1rem;
    font-weight: 700;
    color: var(--navy);
    line-height: 1.1;
  }
  .now-item-time .time-status {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--green);
    margin-top: 2px;
  }
  .now-item-time .time-away {
    font-size: 0.65rem;
    color: var(--mid-gray);
    margin-top: 2px;
  }
  .now-item-info { flex: 1; min-width: 0; }
  .now-item-info .item-type {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--mid-gray);
    margin-bottom: 1px;
  }
  .now-item-info .item-name {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.2;
  }
  .now-item-info .item-location {
    font-size: 0.72rem;
    color: var(--text-light);
  }
  .now-item-dist {
    flex-shrink: 0;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--mid-gray);
    text-align: right;
  }
  .now-item-dist.near { color: var(--green); }
  .now-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--mid-gray);
  }
  .now-empty .cross { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.25; }
  .now-overflow-wrapper { display: none; }
  .now-overflow-wrapper.open { display: block; }
  .now-expand-btn {
    display: block; width: 100%; padding: 10px; margin: 2px 0 8px;
    background: var(--warm-gray); border: 1px dashed var(--border); border-radius: 8px;
    color: var(--navy); font-size: 0.78rem; font-weight: 600; cursor: pointer;
    text-align: center; letter-spacing: 0.02em;
  }
  .now-expand-btn:hover { background: #e8e4dc; }
  .yc-item-actions {
    width: 100%; display: flex; gap: 8px; padding: 6px 0 2px;
    margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.06);
  }
  .yc-action-btn {
    flex: 1; padding: 7px 10px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600; cursor: pointer;
    text-align: center; text-decoration: none; border: 1px solid var(--border);
    background: #fff; color: var(--navy); transition: background 0.15s;
  }
  .yc-action-btn:hover { background: var(--warm-gray); }
  .now-section-label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--mid-gray);
    margin: 16px 0 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }
  .now-section-label:first-child { margin-top: 0; }

  /* ── YC EVENTS IN NOW VIEW ── */
  .now-yc-section {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 2px solid rgba(232,168,56,0.2);
  }
  .now-yc-section h3 {
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ── WEEKLY CALENDAR VIEW (WP-WeekCal) ── */
  .now-view-toggle {
    display: flex; gap: 4px; background: var(--warm-gray); border-radius: 8px; padding: 3px;
  }
  .now-view-toggle button {
    padding: 5px 14px; border-radius: 6px; border: none; background: transparent;
    font-family: 'Source Sans 3', sans-serif; font-size: 0.75rem; font-weight: 600;
    color: var(--text-light); cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .now-view-toggle button.active { background: #fff; color: var(--navy); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .now-view-toggle button:hover:not(.active) { color: var(--text); }

  .week-cal { margin-top: 4px; }
  .week-cal-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;
    min-height: 200px;
  }
  .week-col {
    min-width: 0; background: #fff; border-radius: 10px; border: 1px solid var(--border);
    overflow: hidden;
  }
  .week-col.today { border-color: var(--gold); box-shadow: 0 0 0 1px var(--gold); }
  .week-col-head {
    padding: 8px 6px; text-align: center; font-size: 0.7rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light);
    border-bottom: 1px solid var(--border); background: var(--cream);
  }
  .week-col.today .week-col-head {
    background: var(--navy); color: #fff;
  }
  .week-col-head .week-date {
    display: block; font-size: 1.05rem; font-weight: 700; color: var(--navy);
    margin-top: 2px; letter-spacing: 0;
  }
  .week-col.today .week-col-head .week-date { color: var(--gold-light); }
  .week-col-body { padding: 4px; display: flex; flex-direction: column; gap: 3px; max-height: 55vh; overflow-y: auto; }
  .week-svc {
    padding: 5px 6px; border-radius: 6px; font-size: 0.68rem; line-height: 1.3;
    cursor: pointer; transition: background 0.1s; border-left: 3px solid transparent;
  }
  .week-svc:hover { background: var(--gold-pale); }
  .week-svc.type-mass { border-left-color: var(--navy); }
  .week-svc.type-confession { border-left-color: var(--green); }
  .week-svc.type-adoration { border-left-color: var(--gold); }
  .week-svc.type-lent { border-left-color: #7c4fa0; }
  .week-svc.type-other { border-left-color: var(--mid-gray); }
  .week-svc-time { font-weight: 700; color: var(--navy); }
  .week-svc-type { font-weight: 600; color: var(--text-light); font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.03em; }
  .week-svc-name { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .week-svc-dist { font-size: 0.6rem; color: var(--mid-gray); }
  .week-empty { text-align: center; padding: 20px 4px; color: var(--mid-gray); font-size: 0.7rem; opacity: 0.6; }

  /* Mobile: horizontal scroll for week calendar */
  @media (max-width: 768px) {
    .week-cal-grid {
      grid-template-columns: repeat(7, minmax(110px, 1fr));
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory; padding-bottom: 6px;
    }
    .week-col { scroll-snap-align: start; min-width: 110px; }
    .week-col-body { max-height: 45vh; }
  }

  /* Calendar export button */
  .cal-export-btn {
    padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--gold);
    background: var(--gold-pale); color: var(--navy); font-family: 'Source Sans 3', sans-serif;
    font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .cal-export-btn:hover { background: var(--gold-light); }
  .cal-export-dropdown {
    position: relative; display: inline-block;
  }
  .cal-export-menu {
    display: none; position: absolute; top: 100%; right: 0; margin-top: 4px;
    background: #fff; border: 1px solid var(--border); border-radius: 8px;
    box-shadow: var(--shadow-lg); z-index: 999; min-width: 180px; overflow: hidden;
  }
  .cal-export-menu.open { display: block; }
  .cal-export-menu a, .cal-export-menu button {
    display: block; width: 100%; padding: 10px 14px; text-align: left; border: none;
    background: transparent; font-family: 'Source Sans 3', sans-serif; font-size: 0.8rem;
    color: var(--text); cursor: pointer; text-decoration: none; transition: background 0.1s;
  }
  .cal-export-menu a:hover, .cal-export-menu button:hover { background: var(--warm-gray); }
  .cal-export-menu .menu-divider { border-top: 1px solid var(--border); margin: 2px 0; }

  /* Deep link share view button */
  .share-view-btn {
    padding: 5px 12px; border-radius: 16px; border: 1px solid var(--border);
    background: #fff; color: var(--text); font-family: 'Source Sans 3', sans-serif;
    font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .share-view-btn:hover { border-color: var(--gold); background: var(--gold-pale); }
  .share-view-btn.copied { background: var(--green); border-color: var(--green); color: #fff; }

  /* ── MAP VIEW (WP-Map) ── */
  #mapContainer {
    height: calc(100vh - 90px);
    width: 100%;
    background: var(--cream);
  }
  .map-view-wrapper {
    position: relative;
  }
  .map-filter-bar {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    gap: 5px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    padding: 4px 6px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    backdrop-filter: blur(8px);
  }
  .map-chip {
    padding: 5px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .map-chip:hover { border-color: var(--gold); }
  .map-chip.active { background: var(--navy); border-color: var(--navy); color: #fff; }
  .leaflet-popup-content {
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.85rem;
    line-height: 1.4;
    min-width: 180px;
  }
  .leaflet-popup-content h3 {
    font-family: 'Playfair Display', serif;
    font-size: 0.95rem;
    color: var(--navy);
    margin: 0 0 4px;
  }
  .leaflet-popup-content .popup-town {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-bottom: 6px;
  }
  .leaflet-popup-content .popup-services {
    font-size: 0.75rem;
    color: var(--text);
  }
  .leaflet-popup-content .popup-link {
    display: inline-block;
    margin-top: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--navy);
    cursor: pointer;
    text-decoration: underline;
  }

  /* ── FAVORITES (WP-Favorites) ── */
  .fav-btn {
    background: none;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 0 2px;
    line-height: 1;
    transition: transform 0.15s;
    filter: grayscale(1) opacity(0.35);
  }
  .fav-btn:hover { transform: scale(1.2); filter: none; }
  .fav-btn.favorited { filter: none; }
  .fav-chip {
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    background: transparent;
    color: rgba(255,255,255,0.7);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    display: none;
  }
  .fav-chip.visible { display: inline-flex; align-items: center; gap: 4px; }
  .fav-chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .fav-chip.active { background: #e8a838; border-color: #e8a838; color: var(--navy); font-weight: 600; }

  /* ── RESPONSIVE OVERRIDES ── */
  @media (max-width: 520px) {
    .app-tab-bar { top: 38px; }
    .app-tab { font-size: 0.72rem; padding: 10px 6px; letter-spacing: 0.03em; }
    .app-tab .tab-icon { margin-right: 3px; font-size: 0.8rem; }
    .now-view { padding: 12px 14px 40px; }
    .now-item { padding: 8px 10px; gap: 8px; }
    .now-item-time .time-big { font-size: 0.9rem; }
    .now-item-info .item-name { font-size: 0.82rem; }
    #mapContainer { height: calc(100vh - 82px); }
    .map-filter-bar { padding: 3px 4px; gap: 3px; }
    .map-chip { padding: 4px 8px; font-size: 0.68rem; }
  }

  /* ── PWA INSTALL BANNER ── */
  .install-banner {
    background: linear-gradient(135deg, #243260 0%, #1a2744 100%);
    display: flex; align-items: center; gap: 8px;
    padding: 7px 16px; font-family: 'Source Sans 3', sans-serif;
    font-size: 0.75rem; color: rgba(255,255,255,0.85);
    border-bottom: 1px solid rgba(201,168,76,0.25);
    position: relative; z-index: 98;
  }
  .install-banner .ib-icon { color: var(--gold); font-size: 0.85rem; flex-shrink: 0; }
  .install-banner .ib-text { flex: 1; min-width: 0; line-height: 1.3; }
  .install-banner .ib-text strong { color: #fff; }
  .install-banner .ib-text .ib-hint {
    font-size: 0.68rem; opacity: 0.7; margin-left: 4px;
  }
  .install-banner .ib-action {
    background: var(--gold); color: var(--navy); border: none;
    padding: 5px 14px; border-radius: 14px; font-weight: 700;
    font-size: 0.72rem; cursor: pointer; white-space: nowrap;
    flex-shrink: 0; transition: background 0.15s;
  }
  .install-banner .ib-action:hover { background: var(--gold-light); }
  .install-banner .ib-close {
    background: transparent; border: none; color: rgba(255,255,255,0.4);
    font-size: 1.1rem; cursor: pointer; padding: 2px 4px; flex-shrink: 0;
    line-height: 1; transition: color 0.15s;
  }
  .install-banner .ib-close:hover { color: rgba(255,255,255,0.8); }
  /* iOS share icon inline */
  .install-banner .ios-share-icon {
    display: inline-block; width: 14px; height: 14px; vertical-align: -2px;
    margin: 0 1px;
  }
  @media (min-width: 769px) {
    .install-banner { padding: 7px 24px; font-size: 0.78rem; justify-content: center; }
    .install-banner .ib-text { flex: none; }
  }

</style>
</head>
<body>


<header onclick="window.scrollTo({top:0,behavior:'smooth'})">
  <div class="header-inner">
    <div class="header-cross">✝</div>
    <div class="header-title">
      <h1>Mass Finder</h1>
      <p>Catholic Services Directory</p>
    </div>
    <div class="header-badge" id="headerBadge">Loading…</div>
    <button class="header-add-btn" id="headerAddBtn" onclick="event.stopPropagation(); openNewParish();" title="Add a church">+ Add A Church
  </div>
</header>

<!-- TAB BAR (WP8) -->
<nav class="app-tab-bar" id="appTabBar">
  <button class="app-tab active" data-view="churches" onclick="switchAppView('churches')"><span class="tab-icon">⛪</span>Churches</button>
  <button class="app-tab" data-view="now" onclick="switchAppView('now')"><span class="tab-icon">⏱</span>What's Now</button>
  <button class="app-tab" data-view="yc" onclick="switchAppView('yc')"><span class="tab-icon">✦</span>YC Events</button>
  <button class="app-tab" data-view="map" onclick="switchAppView('map')"><span class="tab-icon">🗺</span>Map</button>
</nav>
<div id="installBannerSlot"></div>

<!-- ══════ CHURCHES VIEW ══════ -->
<div class="app-view active" id="viewChurches">

<!-- Hidden data containers — JS needs these elements for data population -->
<div id="happeningSoon" style="display:none!important">
  <div class="soon-inner">
    <div class="soon-body" id="soonBody">
      <div class="soon-cards" id="soonCards"></div>
    </div>
  </div>
</div>
<div id="ycEventsSection" style="display:none!important">
  <div class="yc-inner">
    <span class="yc-subtitle" id="ycSubtitle"></span>
    <div class="yc-cards" id="ycCards"></div>
  </div>
</div>

<div class="controls-bar">
  <div class="controls-inner controls-row-1">
    <div class="search-wrap">
      <input type="text" id="searchInput" placeholder="Search by name, town, or pastor…" autocomplete="off">
    </div>
    <select id="countyFilter" style="display:none">
      <option value="">All Counties</option>
      <option value="Berkshire">Berkshire</option>
      <option value="Franklin">Franklin</option>
      <option value="Hampshire">Hampshire</option>
      <option value="Hampden">Hampden</option>
    </select>
    <select id="dayFilter">
      <option value="">Any Day</option>
      <option value="monday">Monday</option>
      <option value="tuesday">Tuesday</option>
      <option value="wednesday">Wednesday</option>
      <option value="thursday">Thursday</option>
      <option value="friday">Friday</option>
      <option value="saturday">Saturday</option>
      <option value="sunday">Sunday</option>
    </select>
    <select id="timeFilter">
      <option value="">Any Time</option>
      <option value="early">Early · before 8a</option>
      <option value="morning">Morning · 8a–12p</option>
      <option value="afternoon">Afternoon · 12–4p</option>
      <option value="evening">Evening · 4p+</option>
    </select>
    <select id="langFilter">
      <option value="">Any Language</option>
      <option value="es">Spanish</option>
      <option value="pl">Polish</option>
      <option value="pt">Portuguese</option>
      <option value="vi">Vietnamese</option>
      <option value="asl">ASL</option>
    </select>
  </div>
  <div class="controls-inner controls-row-2">
    <div class="filter-chips" id="categoryChips">
      <button class="chip active" data-cat="">All</button>
      <button class="chip" data-cat="mass">Mass</button>
      <button class="chip" data-cat="confession">Confession</button>
      <button class="chip" data-cat="devotion">Devotions</button>
    </div>
    <button class="fav-chip" id="favFilterChip" onclick="toggleFavFilter()">❤️ Favorites</button>
    <div class="sort-toggle" id="sortToggle">
      <button class="sort-btn active" data-sort="proximity" id="sortProximity" title="Sort by distance" onclick="setSortMode('proximity')">Near</button>
      <button class="sort-btn" data-sort="alpha" id="sortAlpha" title="Sort A→Z" onclick="setSortMode('alpha')">A→Z</button>
    </div>
    <button class="clear-filters-btn" id="clearFiltersBtn" style="display:none;">&#10005; Clear Filters</button>
    <button class="share-view-btn" id="shareViewBtn" style="display:none;" onclick="shareCurrentView(this)">🔗 Share View</button>
    <span class="results-count" id="resultsCount"></span>
  </div>
  <div class="subfilter-bar" id="subfilterBar" style="display:none">
    <div class="controls-inner" style="padding-top:8px;padding-bottom:8px;">
      <span class="subfilter-label" id="subfilterLabel"></span>
      <div class="filter-chips" id="subtypeChips"></div>
    </div>
  </div>
</div>





<main>
  <div class="parish-grid" id="parishGrid">
    <div class="loading">Loading churches…</div>
  </div>
</main>

</div><!-- /viewChurches -->

<!-- ══════ WHAT'S NOW VIEW ══════ -->
<div class="app-view" id="viewNow">
  <div class="now-view">
    <div class="now-header">
      <h2>What's Happening</h2>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <div class="now-view-toggle" id="nowViewToggle">
          <button class="active" data-now-view="timeline" onclick="setNowViewMode('timeline')">⏱ Now</button>
          <button data-now-view="week" onclick="setNowViewMode('week')">📅 This Week</button>
        </div>
        <div class="cal-export-dropdown" id="calExportDropdown">
          <button class="cal-export-btn" onclick="toggleCalExportMenu()" id="calExportBtn" style="display:none;">📅 Export</button>
          <div class="cal-export-menu" id="calExportMenu">
            <button onclick="exportFavoritesICS()">Download .ics (All Favorites)</button>
            <div class="menu-divider"></div>
            <button onclick="exportWeekICS()">Download This Week .ics</button>
          </div>
        </div>
        <button class="now-location-btn" id="nowLocationBtn" onclick="requestLocation()">📍 Enable Location</button>
      </div>
    </div>
    <div class="now-filter-pills" id="nowFilterPills">
      <button class="now-pill active" data-now-mode="all" onclick="setNowMode('all')">All</button>
      <button class="now-pill" data-now-mode="mass" onclick="setNowMode('mass')">Mass</button>
      <button class="now-pill" data-now-mode="confession" onclick="setNowMode('confession')">Confession</button>
      <button class="now-pill" data-now-mode="adoration" onclick="setNowMode('adoration')">Adoration</button>
      <button class="now-pill lent-pill" data-now-mode="lent" onclick="setNowMode('lent')" id="nowLentPill">Lent</button>
    </div>
    <div class="now-timeline" id="nowTimeline"></div>
    <div class="week-cal" id="weekCalendar" style="display:none;"></div>
  </div>
</div>

<!-- ══════ YC EVENTS VIEW ══════ -->
<div class="app-view" id="viewYc">
  <div class="now-view">
    <div class="now-header">
      <h2><span class="yc-badge" style="font-size:0.7rem;margin-right:6px;">YC</span> Young &amp; Catholic</h2>
      <span style="font-size:0.78rem;color:var(--text-light);" id="ycViewSubtitle"></span>
    </div>
    <div class="now-timeline" id="ycViewTimeline"></div>
  </div>
</div>

<!-- ══════ MAP VIEW ══════ -->
<div class="app-view" id="viewMap">
  <div class="map-view-wrapper">
    <div class="map-filter-bar" id="mapFilterBar">
      <button class="map-chip active" data-map-cat="" onclick="setMapFilter('')">All</button>
      <button class="map-chip" data-map-cat="mass" onclick="setMapFilter('mass')">Mass</button>
      <button class="map-chip" data-map-cat="confession" onclick="setMapFilter('confession')">Confession</button>
      <button class="map-chip" data-map-cat="devotion" onclick="setMapFilter('devotion')">Devotions</button>
    </div>
    <div id="mapContainer"></div>
  </div>
</div>

<script>
const PARISH_DATA_URL = './parish_data.json';
let PARISH_DATA; // set async on load

// Sub-type definitions per category
const SUBTYPES = {
  mass: [
    { key: 'weekend_mass',  label: 'Weekend Mass',    types: ['sunday_mass'],  days: ['saturday','sunday'] },
    { key: 'weekday_mass',  label: 'Weekday Mass',    types: ['daily_mass'],   days: ['monday','tuesday','wednesday','thursday','friday','weekday'] },
    { key: 'first_friday_mass', label: '1st Friday', types: ['daily_mass','sunday_mass'],  days: ['first_friday'] },
    { key: 'first_saturday_mass', label: '1st Saturday', types: ['daily_mass','sunday_mass'], days: ['first_saturday'] },
    { key: 'holyday_mass',  label: 'Holy Days',       types: ['daily_mass'],   days: ['holyday','holyday_eve'] },
    { key: 'latin_mass',    label: 'Latin Mass',      types: ['sunday_mass','daily_mass'], language: 'la' },
    { key: 'spanish_mass',  label: 'Spanish Mass',    types: ['sunday_mass','daily_mass'], language: 'es' },
    { key: 'polish_mass',   label: 'Polish Mass',     types: ['sunday_mass','daily_mass'], language: 'pl' },
  ],
  devotion: [
    { key: 'eucharistic',   label: 'Adoration',            types: ['adoration'] },
    { key: 'holy_hour',     label: 'Holy Hour',             types: ['holy_hour'] },
    { key: 'rosary',        label: 'Rosary',               types: ['rosary'] },
    { key: 'divine_mercy',  label: 'Divine Mercy',         types: ['divine_mercy'] },
    { key: 'miraculous',    label: 'Miraculous Medal',     types: ['miraculous_medal'] },
    { key: 'stations',      label: 'Stations of the Cross', types: ['stations_of_cross','stations_of_the_cross'] },
    { key: 'novena',        label: 'Novena',               types: ['novena'] },
    { key: 'anointing',     label: 'Anointing of the Sick', types: ['anointing_of_sick','anointing'] },
    { key: 'communion_svc', label: 'Communion Service',    types: ['communion_service'] },
  ],
};

function serviceMatchesSubtype(svc, subtype) {
  if (!subtype) return true;
  // Find the subtype def
  for (const cat of Object.values(SUBTYPES)) {
    const def = cat.find(s => s.key === subtype);
    if (!def) continue;
    // Must match type
    if (!def.types.includes(svc.type)) return false;
    // Language filter
    if (def.language && svc.language !== def.language) return false;
    // Season filter
    if (def.season && (!svc.seasonal || svc.seasonal.season !== def.season)) return false;
    // Day filter
    if (def.days) {
      const svcDays = svc.days || (svc.day ? [svc.day] : []);
      const overlap = def.days.some(d => svcDays.includes(d));
      if (!overlap) return false;
    }
    return true;
  }
  return false;
}

const SERVICE_LABELS = {
  sunday_mass:'Mass', daily_mass:'Mass', confession:'Confession',
  adoration:'Adoration', holy_hour:'Holy Hour', perpetual_adoration:'Perp. Adoration',
  benediction:'Benediction', rosary:'Rosary', divine_mercy:'Divine Mercy',
  miraculous_medal:'Miraculous Medal', novena:'Novena',
  stations_of_cross:'Stations of the Cross', stations_of_the_cross:'Stations of the Cross',
  anointing_of_sick:'Anointing of the Sick', communion_service:'Communion Service',
  devotion:'Devotion',
};

const DAY_LABELS = {
  monday:'Mon', tuesday:'Tue', wednesday:'Wed', thursday:'Thu',
  friday:'Fri', saturday:'Sat', sunday:'Sun',
  first_friday:'1st Fri', first_saturday:'1st Sat',
  holyday:'Holy Day', holyday_eve:'Holy Day Eve',
  weekday:'Weekday', daily:'Daily',
  '':'Varies',
};

const SEASON_LABELS = {
  lent:'Lent', advent:'Advent', school_year:'School Year', summer:'Summer',
};

const LANG_NAMES = {
  en:'English', es:'Spanish', pl:'Polish', pt:'Portuguese',
  vi:'Vietnamese', asl:'ASL', fr:'French', it:'Italian',
};
const LANG_LABELS = {
  en:'EN', es:'ES', pl:'PL', pt:'PT', vi:'VI', asl:'ASL', fr:'FR', it:'IT',
};

const SERVICE_TYPE_GROUPS = {
  mass:       ['sunday_mass','daily_mass','communion_service'],
  confession: ['confession'],
  devotion:   ['adoration','holy_hour','perpetual_adoration','benediction',
               'rosary','divine_mercy','miraculous_medal','novena',
               'stations_of_cross','stations_of_the_cross','anointing_of_sick',
               'anointing','devotion','vespers','prayer_group'],
};

function fmt12(t) {
  if (!t) return 'Varies';
  const [h, m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12  = h % 12 || 12;
  return m === 0 ? `${h12} ${ampm}` : `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
}

function fmtTimeRange(s) {
  if (s.times_vary && !s.time) return 'Varies';
  let t = fmt12(s.time);
  if (s.end_time) t += `–${fmt12(s.end_time)}`;
  return t;
}

function getDays(s) {
  if (s.days && s.days.length) return s.days;
  if (s.day) return [s.day];
  return [];
}

function fmtDays(days) {
  if (!days.length) return '';
  const labels = days.map(d => DAY_LABELS[d] || d);
  // Collapse Mon-Fri
  const wkdaySet = ['Mon','Tue','Wed','Thu','Fri'];
  const allWkday = wkdaySet.every(d => labels.includes(d)) && labels.length === 5;
  if (allWkday) return 'Mon–Fri';
  // Mon-Thu
  const monThu = ['Mon','Tue','Wed','Thu'];
  if (monThu.every(d => labels.includes(d)) && labels.length === 4 && !labels.includes('Fri')) return 'Mon–Thu';
  return labels.join(', ');
}

function serviceMatchesDay(svc, dayFilter) {
  if (!dayFilter) return true;
  const days = getDays(svc);
  if (days.includes(dayFilter)) return true;
  // 'weekday' services match Mon-Fri only
  const WEEKDAYS = ['monday','tuesday','wednesday','thursday','friday'];
  if (days.includes('weekday') && WEEKDAYS.includes(dayFilter)) return true;
  // 'daily' services match all 7 days (Mon-Sun)
  const ALL_DAYS = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
  if (days.includes('daily') && ALL_DAYS.includes(dayFilter)) return true;
  return false;
}

function serviceMatchesTime(svc, timeFilter) {
  if (!timeFilter) return true;
  if (!svc.time) return false; // no time = can't match a time filter
  const [h] = svc.time.split(':').map(Number);
  if (timeFilter === 'early')     return h < 8;
  if (timeFilter === 'morning')   return h >= 8 && h < 12;
  if (timeFilter === 'afternoon') return h >= 12 && h < 16;
  if (timeFilter === 'evening')   return h >= 16;
  return true;
}

function serviceMatchesType(svc, categoryFilter, subtypeFilter) {
  // If subtype active, use subtype matching (more specific)
  if (subtypeFilter) return serviceMatchesSubtype(svc, subtypeFilter);
  if (!categoryFilter) return true;
  const group = SERVICE_TYPE_GROUPS[categoryFilter];
  return group ? group.includes(svc.type) : true;
}

// Common abbreviations → expansions for search
const SEARCH_ABBREVIATIONS = {
  'olv': 'our lady valley',
  'olc': 'our lady czestochowa',
  'olbs': 'our lady blessed sacrament',
  'olsh': 'our lady sacred heart',
  'olmc': 'our lady mount carmel',
  'olp': 'our lady peace',
  'olf': 'our lady fatima',
  'mmh': 'mary mother hope',
  'bvm': 'blessed virgin mary',
  'smu': 'st mary assumption',
  'hf': 'holy family',
  'hc': 'holy cross',
  'hn': 'holy name',
  'ht': 'holy trinity',
  'bt': 'blessed trinity',
  'bs': 'blessed sacrament',
  'ck': 'christ king',
  'ic': 'immaculate conception',
  'dm': 'divine mercy',
  'sh': 'sacred heart',
  'stj': 'st joseph',
  'sta': 'st ann',
  'sm': 'st mary',
  'sp': 'st patrick',
  'sc': 'st cecilia',
  'se': 'st elizabeth',
  'sfa': 'st francis assisi',
  'stm': 'st michael',
  'cathedral': 'st michael cathedral',
};

function parishMatchesSearch(p, q) {
  if (!q) return true;
  const svcNotes = (p.services || []).map(s => s.notes || '').join(' ');
  const svcTypes = (p.services || []).map(s => {
    const label = SERVICE_LABELS[s.type] || s.type.replace(/_/g, ' ');
    return label;
  }).join(' ');
  // WP1: Include location/church names in search index
  const locNames = (p.locations || []).map(l => l.name || '').join(' ');
  const locAddresses = (p.locations || []).map(l => l.address || '').join(' ');
  const clergyStr = (p.clergy || []).map(cl => cl.name || '').join(' ');
  const haystack = `${p.name} ${locNames} ${locAddresses} ${p.town} ${p.county} ${svcNotes} ${svcTypes} ${clergyStr}`.toLowerCase();

  // Normalize query: expand abbreviations, handle "st"/"saint" equivalence
  const words = q.toLowerCase().split(/\s+/).filter(Boolean);
  const expanded = [];
  for (const w of words) {
    // Check if the whole query (joined) is an abbreviation
    if (words.length === 1 && SEARCH_ABBREVIATIONS[w]) {
      expanded.push(...SEARCH_ABBREVIATIONS[w].split(' '));
      continue;
    }
    // Normalize st/saint/st.
    if (w === 'saint') { expanded.push('st'); continue; }
    if (w === 'st.' || w === 'st') { expanded.push('st'); continue; }
    // Normalize fr/father/fr./rev
    if (w === 'father' || w === 'reverend' || w === 'rev' || w === 'rev.') { expanded.push('fr'); continue; }
    if (w === 'fr.' || w === 'fr') { expanded.push('fr'); continue; }
    expanded.push(w);
  }

  // Also check if multi-word query forms an abbreviation
  const initials = words.map(w => w[0]).join('');
  if (initials.length >= 2 && SEARCH_ABBREVIATIONS[initials]) {
    const abbrevWords = SEARCH_ABBREVIATIONS[initials].split(' ');
    if (abbrevWords.every(aw => haystack.includes(aw))) return true;
  }

  // Build a normalized haystack with st/saint and fr/father equivalence
  const normHaystack = haystack
    .replace(/\bsaint\b/g, 'st')
    .replace(/\bst\.\b/g, 'st')
    .replace(/\bfather\b/g, 'fr')
    .replace(/\bfr\.\b/g, 'fr')
    .replace(/\bfriar\b/g, 'fr')
    .replace(/\brev\.\b/g, 'fr')
    .replace(/\brevd?\b/g, 'fr');

  return expanded.every(w => normHaystack.includes(w));
}

// ─── WP2: SEASONAL DATE AWARENESS ──────────────────────────────────────────

// Compute Easter Sunday for a given year using the Anonymous Gregorian algorithm
function computeEaster(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31); // 3=March, 4=April
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(year, month - 1, day);
}

// Get Lent date range for a given year: Ash Wednesday through Holy Saturday
function getLentRange(year) {
  const easter = computeEaster(year);
  const ashWednesday = new Date(easter);
  ashWednesday.setDate(easter.getDate() - 46); // 46 days before Easter
  const holySaturday = new Date(easter);
  holySaturday.setDate(easter.getDate() - 1);  // day before Easter
  return { start: ashWednesday, end: holySaturday };
}

// Check if a seasonal service should be visible right now
function isCurrentSeason(svc) {
  if (!svc.seasonal || !svc.seasonal.is_seasonal) return true; // not seasonal = always show
  const season = svc.seasonal.season;
  if (!season) return true;

  const now = new Date();
  const year = now.getFullYear();

  if (season === 'lent') {
    const lent = getLentRange(year);
    const today = new Date(year, now.getMonth(), now.getDate());
    return today >= lent.start && today <= lent.end;
  }
  if (season === 'holy_week') {
    const easter = computeEaster(year);
    const palmSunday = new Date(easter);
    palmSunday.setDate(easter.getDate() - 7);
    const holySaturday = new Date(easter);
    holySaturday.setDate(easter.getDate() - 1);
    const today = new Date(year, now.getMonth(), now.getDate());
    return today >= palmSunday && today <= holySaturday;
  }
  if (season === 'advent') {
    // Advent: 4 Sundays before Christmas through Dec 24
    const christmas = new Date(year, 11, 25);
    const christmasDay = christmas.getDay();
    const fourthSunday = new Date(year, 11, 25 - christmasDay);
    const adventStart = new Date(fourthSunday);
    adventStart.setDate(fourthSunday.getDate() - 21);
    const adventEnd = new Date(year, 11, 24);
    const today = new Date(year, now.getMonth(), now.getDate());
    return today >= adventStart && today <= adventEnd;
  }
  if (season === 'school_year') {
    const month = now.getMonth(); // 0-indexed: 0=Jan, 8=Sep
    // Sep 1 through May 15
    return month >= 8 || month <= 3 || (month === 4 && now.getDate() <= 15);
  }
  if (season === 'summer') {
    const month = now.getMonth();
    // May 16 through Aug 31
    return (month === 4 && now.getDate() >= 16) || (month >= 5 && month <= 7);
  }
  return true; // unknown season = show
}

// ─── RENDERING ───────────────────────────────────────────────────────────────

// Canonical day sort order
const DAY_ORDER = [
  'sunday','saturday','monday','tuesday','wednesday','thursday','friday',
  'weekday','daily','first_friday','first_saturday',
  'holyday','holyday_eve',
];

function dayRank(day) {
  const i = DAY_ORDER.indexOf(day);
  return i === -1 ? 99 : i;
}

// Regular days eligible for collapsing (special/nth days stay separate)
const COLLAPSIBLE_DAYS = new Set([
  'monday','tuesday','wednesday','thursday','friday','saturday','sunday'
]);

// Collapse services that share the same time+type+language+notes into combined day rows.
// e.g. Mon 8AM + Tue 8AM + Thu 8AM → [Mon,Tue,Thu] 8AM as a single entry.
function collapseServiceDays(services) {
  const collapsible = services.filter(s => {
    const days = getDays(s);
    return days.length === 1 && COLLAPSIBLE_DAYS.has(days[0]);
  });
  const fixed = services.filter(s => {
    const days = getDays(s);
    return !(days.length === 1 && COLLAPSIBLE_DAYS.has(days[0]));
  });

  // Group collapsible by signature: type|time|end_time|language|notes|seasonal|location_id
  const buckets = new Map();
  for (const svc of collapsible) {
    const sig = `${svc.type}|${svc.time||''}|${svc.end_time||''}|${svc.language||'en'}|${svc.notes||''}|${(svc.seasonal&&svc.seasonal.season)||''}|${svc.location_id||''}`;
    if (!buckets.has(sig)) buckets.set(sig, { proto: svc, days: [] });
    buckets.get(sig).days.push(getDays(svc)[0]);
  }

  const collapsed = [...buckets.values()].map(({ proto, days }) => {
    if (days.length === 1) return proto; // no change needed
    // Return a synthetic entry with a `days` array (plural)
    return { ...proto, day: undefined, days: days.sort((a,b) => dayRank(a)-dayRank(b)) };
  });

  return [...fixed, ...collapsed];
}

// Card-level grouping: keeps adoration separate from devotion for display
const CARD_TYPE_GROUPS = {
  mass:       ['sunday_mass','daily_mass','communion_service'],
  confession: ['confession'],
  adoration:  ['adoration','holy_hour','perpetual_adoration','benediction'],
  devotion:   ['rosary','divine_mercy','miraculous_medal','novena',
               'stations_of_cross','stations_of_the_cross','anointing_of_sick',
               'anointing','devotion','vespers','prayer_group'],
};

function groupServices(services) {
  const groups = { mass:[], confession:[], adoration:[], devotion:[], other:[] };
  for (const svc of services) {
    let placed = false;
    for (const [key, types] of Object.entries(CARD_TYPE_GROUPS)) {
      if (types.includes(svc.type)) { groups[key].push(svc); placed = true; break; }
    }
    if (!placed) groups.other.push(svc);
  }
  return groups;
}

// ─── COLLAPSIBLE SECTION HELPERS ──────────────────────────────────────────────

function toggleSection(el) {
  const wrapper = el.closest('.svc-collapse');
  if (wrapper) wrapper.classList.toggle('open');
}

function buildSectionSummary(sectionKey, filteredServices) {
  if (!filteredServices.length) return '';
  const n = filteredServices.length;

  if (sectionKey === 'mass') {
    const daySet = new Set();
    filteredServices.forEach(s => getDays(s).forEach(d => daySet.add(d)));
    const dayStr = fmtDays([...daySet].sort((a,b) => dayRank(a) - dayRank(b)));
    return `${n} service${n!==1?'s':''} · ${dayStr}`;
  }

  if (sectionKey === 'confession') {
    // Show up to 3 actual day+time combos
    const combos = filteredServices
      .filter(s => s.time)
      .sort((a,b) => dayRank(getDays(a)[0]||'') - dayRank(getDays(b)[0]||''))
      .slice(0, 3)
      .map(s => {
        const d = fmtDays(getDays(s));
        return `${d} ${fmtTimeRange(s)}`;
      });
    if (combos.length) return combos.join(', ');
    return `${n} time${n!==1?'s':''}`;
  }

  if (sectionKey === 'adoration') {
    const daySet = new Set();
    filteredServices.forEach(s => getDays(s).forEach(d => daySet.add(d)));
    const dayStr = fmtDays([...daySet].sort((a,b) => dayRank(a) - dayRank(b)));
    return `${n} service${n!==1?'s':''}` + (dayStr ? ` · ${dayStr}` : '');
  }

  if (sectionKey === 'devotion') {
    // List distinct service type labels
    const typeSet = new Set();
    filteredServices.forEach(s => {
      const label = SERVICE_LABELS[s.type] || s.type.replace(/_/g,' ');
      typeSet.add(label);
    });
    const types = [...typeSet].slice(0, 4);
    return types.join(', ') + (typeSet.size > 4 ? ` +${typeSet.size - 4}` : '');
  }

  if (sectionKey === 'lent') {
    const typeSet = new Set();
    filteredServices.forEach(s => {
      const label = SERVICE_LABELS[s.type] || s.type.replace(/_/g,' ');
      typeSet.add(label);
    });
    const daySet = new Set();
    filteredServices.forEach(s => getDays(s).forEach(d => daySet.add(d)));
    const dayStr = fmtDays([...daySet].sort((a,b) => dayRank(a) - dayRank(b)));
    const types = [...typeSet].slice(0, 3).join(', ');
    return types + (dayStr ? ` · ${dayStr}` : '');
  }

  return `${n} service${n!==1?'s':''}`;
}

function wrapCollapsible(sectionKey, title, icon, innerHtml, filteredServices, collapsed) {
  if (!innerHtml) return '';
  const summary = buildSectionSummary(sectionKey, filteredServices);
  const openClass = collapsed ? '' : ' open';
  return `<div class="svc-collapse svc-collapse--${sectionKey}${openClass}">
    <div class="svc-collapse-header" onclick="toggleSection(this)">
      <span class="svc-collapse-chevron">▶</span>
      <span class="svc-collapse-label">${title}</span>
      <span class="svc-collapse-summary">${summary}</span>
    </div>
    <div class="svc-collapse-body">${innerHtml}</div>
  </div>`;
}


function renderServiceSection(title, icon, services, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite) {
  const filtered = services.filter(s =>
    isCurrentSeason(s) &&
    serviceMatchesDay(s, dayFilter) &&
    serviceMatchesTime(s, timeFilter) &&
    serviceMatchesType(s, categoryFilter, subtypeFilter) &&
    (!langFilter || s.language === langFilter)
  );
  if (!filtered.length) return '';

  // Collapse Mon/Tue/Wed etc. entries that share time+type into single multi-day rows
  const collapsed = collapseServiceDays(filtered);

  // Group by day key
  const byDay = new Map();
  for (const svc of collapsed) {
    const days = getDays(svc);
    const key  = days.sort((a,b) => dayRank(a)-dayRank(b)).join(',') || 'varies';
    if (!byDay.has(key)) byDay.set(key, { days, svcs: [] });
    byDay.get(key).svcs.push(svc);
  }

  // Sort day-groups by canonical day order
  const sorted = [...byDay.values()].sort((a, b) => {
    const ra = Math.min(...a.days.map(dayRank));
    const rb = Math.min(...b.days.map(dayRank));
    return ra - rb;
  });

  const rows = sorted.map(({ days, svcs }) => {
    const dayStr = fmtDays(days);

    // Sort services within day by time
    svcs.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

    // Decide layout: stack if any entry has a note; inline otherwise
    const anyNote = svcs.some(s => s.notes);

    const entryHtml = svc => {
      const timeStr = fmtTimeRange(svc);
      const lang    = svc.language && svc.language !== 'en'
        ? `<span class="lang-tag" title="${LANG_NAMES[svc.language]||svc.language}">${LANG_LABELS[svc.language]||svc.language}</span>` : '';
      const season  = svc.seasonal && svc.seasonal.is_seasonal && SEASON_LABELS[svc.seasonal.season]
        ? `<span class="seasonal-tag">${SEASON_LABELS[svc.seasonal.season]}</span>` : '';
      const label   = SERVICE_LABELS[svc.type] || svc.type.replace(/_/g,' ');
      const showLabel = label.toLowerCase() !== title.toLowerCase();
      const typeTag = showLabel ? `<span class="svc-type-tag">${label}</span>` : '';
      const note    = svc.notes;
      // WP1-1C: Location label for multi-site parishes
      const locLabel = (isMultiSite && svc.location_id && locMap && locMap[svc.location_id])
        ? `<span class="svc-location-label">&middot; ${locMap[svc.location_id].name}</span>` : '';
      // WP3: YC badge on linked services
      const ycTag = ycServiceIds.has(svc.id) ? '<span class="svc-yc-tag">YC</span>' : '';
      return { timeStr, lang, season, typeTag, note, locLabel, ycTag };
    };

    let timesHtml;
    if (!anyNote) {
      // Inline: "8 AM · 10:30 AM · Noon"
      timesHtml = `<span class="svc-inline">${
        svcs.map(svc => {
          const e = entryHtml(svc);
          return `<span class="svc-t">${e.timeStr}${e.locLabel}${e.typeTag}${e.lang}${e.season}${e.ycTag}</span>`;
        }).join('<span class="svc-sep">·</span>')
      }</span>`;
    } else {
      // Stacked: one entry per line, note beneath
      timesHtml = `<span class="svc-stack">${
        svcs.map(svc => {
          const e = entryHtml(svc);
          const noteHtml = e.note ? `<span class="svc-note-line">${e.note}</span>` : '';
          return `<span class="svc-stack-row"><span class="svc-t">${e.timeStr}</span>${e.locLabel}${e.typeTag}${e.lang}${e.season}${e.ycTag}${noteHtml}</span>`;
        }).join('')
      }</span>`;
    }

    return `<li class="service-row">
      <span class="svc-day">${dayStr || 'Varies'}</span>
      <span class="svc-times">${timesHtml}</span>
    </li>`;
  }).join('');

  return `<div class="service-section">
    <div class="service-section-title">${title}</div>
    <ul class="service-list">${rows}</ul>
  </div>`;
}

// Renders Mass section with holy day entries pinned at bottom behind a sub-divider
function renderMassSectionWithHolyDays(services, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite) {
  const HOLYDAY_DAYS = ['holyday', 'holyday_eve'];

  // Split into regular (excluding lenten) and holy day services
  const regular  = services.filter(s => !HOLYDAY_DAYS.includes(s.day) && !(s.seasonal && s.seasonal.season === 'lent'));
  const holydays = services.filter(s => HOLYDAY_DAYS.includes(s.day));

  const regularSect  = renderServiceSection('Mass', 'mass', regular,   dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  const holydaySect  = renderServiceSection('Mass', 'mass', holydays,  dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);

  if (!regularSect && !holydaySect) return '';

  if (regularSect && holydaySect) {
    // Inject holy days at the bottom of the same section with a sub-divider
    const holyRows = holydaySect.match(/<ul class="service-list">([\s\S]*?)<\/ul>/)?.[1] || '';
    return regularSect.replace(/<\/ul>\s*<\/div>$/,
      `<hr class="holyday-divider"><span class="holyday-sub-label">Holy Days of Obligation</span>${holyRows}</ul></div>`);
  }

  // Only one of the two has content — render whichever exists, adding holy day label if needed
  if (holydaySect && !regularSect) {
    return holydaySect.replace(/<ul class="service-list">/,
      `<ul class="service-list"><span class="holyday-sub-label">Holy Days of Obligation</span>`);
  }
  return regularSect;
}

// Renders a dedicated Lenten Services section aggregating all seasonal=lent services
function renderLentenSection(allServices, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite) {
  const lentSvcs = allServices.filter(s => s.seasonal && s.seasonal.season === 'lent' && isCurrentSeason(s));
  if (!lentSvcs.length) return '';

  // Apply active filters
  const filtered = lentSvcs.filter(s =>
    serviceMatchesDay(s, dayFilter) &&
    serviceMatchesTime(s, timeFilter) &&
    serviceMatchesType(s, categoryFilter, subtypeFilter) &&
    (!langFilter || s.language === langFilter)
  );
  if (!filtered.length) return '';

  // Group by day
  const byDay = new Map();
  for (const svc of filtered) {
    const days = getDays(svc);
    const key  = days.sort((a,b) => dayRank(a)-dayRank(b)).join(',') || 'varies';
    if (!byDay.has(key)) byDay.set(key, { days, svcs: [] });
    byDay.get(key).svcs.push(svc);
  }

  const sorted = [...byDay.values()].sort((a, b) =>
    Math.min(...a.days.map(dayRank)) - Math.min(...b.days.map(dayRank))
  );

  const rows = sorted.map(({ days, svcs }) => {
    const dayStr = fmtDays(days);
    svcs.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

    const entryHtml = svc => {
      const timeStr = fmtTimeRange(svc);
      const label   = SERVICE_LABELS[svc.type] || svc.type.replace(/_/g,' ');
      const typeTag = `<span class="svc-type-tag">${label}</span>`;
      const lang    = svc.language && svc.language !== 'en'
        ? `<span class="lang-tag">${LANG_LABELS[svc.language]||svc.language}</span>` : '';
      // WP1-1C: Location label for multi-site parishes
      const locLabel = (isMultiSite && svc.location_id && locMap && locMap[svc.location_id])
        ? `<span class="svc-location-label">&middot; ${locMap[svc.location_id].name}</span>` : '';
      const ycTag = ycServiceIds.has(svc.id) ? '<span class="svc-yc-tag">YC</span>' : '';
      return `<span class="svc-stack-row"><span class="svc-t">${timeStr}</span>${locLabel}${typeTag}${lang}${ycTag}${svc.notes ? `<span class="svc-note-line">${svc.notes}</span>` : ''}</span>`;
    };

    return `<li class="service-row">
      <span class="svc-day">${dayStr || 'Varies'}</span>
      <span class="svc-times"><span class="svc-stack">${svcs.map(entryHtml).join('')}</span></span>
    </li>`;
  }).join('');

  return `<div class="service-section lenten">
    <div class="service-section-title"><span class="icon-lent"></span>Lenten Services</div>
    <ul class="service-list">${rows}</ul>
  </div>`;
}

// WP2-2C: Render special_events (one-time events) on parish cards
function renderSpecialEvents(p) {
  if (!p.special_events || !p.special_events.length) return '';

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Show future/today events, OR recurring events whose season is still active
  const upcoming = p.special_events.filter(evt => {
    if (!evt.date) return false;
    // Recurring seasonal events: show if season is currently active
    if (evt.recurrence && evt.recurrence.type === 'seasonal' && evt.recurrence.season) {
      const fakeSvc = { seasonal: { is_seasonal: true, season: evt.recurrence.season } };
      return isCurrentSeason(fakeSvc);
    }
    const evtDate = new Date(evt.date + 'T00:00:00');
    return evtDate >= today;
  }).sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));

  if (!upcoming.length) return '';

  const rows = upcoming.map(evt => {
    const isRecurring = evt.recurrence && evt.recurrence.type === 'seasonal';

    let dateStr;
    if (isRecurring && evt.recurrence.days && evt.recurrence.days.length) {
      // Show recurring schedule: "Fri, Sat, Sun"
      const dayAbbrs = evt.recurrence.days.map(d => d.charAt(0).toUpperCase() + d.slice(1,3));
      dateStr = dayAbbrs.join(', ');
    } else {
      // Format date: "Mar 18"
      const d = new Date(evt.date + 'T12:00:00'); // noon to avoid timezone shift
      const month = d.toLocaleString('en-US', { month: 'short' });
      const day = d.getDate();
      dateStr = `${month} ${day}`;
    }

    const timeStr = evt.time ? fmt12(evt.time) : '';
    const endStr = evt.end_time ? ` – ${fmt12(evt.end_time)}` : '';
    const label = SERVICE_LABELS[evt.type] || evt.type.replace(/_/g, ' ');
    const note = evt.notes ? ` — ${evt.notes}` : ` — ${label}`;

    // Calendar button for non-recurring events with a time
    let calHtml = '';
    if (!isRecurring && evt.date && evt.time) {
      const loc0 = p.locations && p.locations[0];
      const evtLoc = (loc0 && loc0.name ? loc0.name : p.name) + ', ' + (p.town || '') + ', MA';
      const evtTitle = (evt.notes || label) + ' at ' + (loc0 ? loc0.name : p.name);
      const icsUrl = generateICS(evtTitle, evt.date, evt.time, evt.end_time, evtLoc, '');
      const gcalUrl = generateGCalURL(evtTitle, evt.date, evt.time, evt.end_time, evtLoc, '');
      calHtml = `<span class="cal-dropdown"><button class="special-event-cal" onclick="event.stopPropagation(); toggleCalDropdown(this);">📅</button><div class="cal-dropdown-menu"><a href="${gcalUrl}" target="_blank" rel="noopener">Google Calendar</a><a href="${icsUrl}" download="event.ics">Download .ics</a></div></span>`;
    }

    return `<li class="special-event-row">
      <span class="special-event-date">${dateStr}</span>
      <span class="special-event-detail">${timeStr}${endStr}${note}</span>
      ${calHtml}
    </li>`;
  }).join('');

  return `<div class="service-section special-events">
    <div class="service-section-title">Upcoming Events</div>
    <ul class="service-list special-events-list">${rows}</ul>
  </div>`;
}

// Render YC literal events (no service_id) on parish cards in an Events-style section
function renderYCLiteralEvents(p) {
  const evts = ycLiteralEventsByParish[p.id];
  if (!evts || !evts.length) return '';

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const upcoming = evts.filter(evt => {
    if (!evt.date) return false;
    const evtDate = new Date(evt.date + 'T00:00:00');
    return evtDate >= today;
  }).sort((a, b) => a.date.localeCompare(b.date));
  if (!upcoming.length) return '';

  // Group by title to consolidate recurring events
  const byTitle = new Map();
  for (const evt of upcoming) {
    const key = evt.title || evt.id;
    if (!byTitle.has(key)) byTitle.set(key, []);
    byTitle.get(key).push(evt);
  }

  const rows = [];
  for (const [title, group] of byTitle) {
    const next = group[0]; // soonest
    const d = new Date(next.date + 'T12:00:00');
    const dayName = d.toLocaleString('en-US', { weekday: 'short' });
    const month = d.toLocaleString('en-US', { month: 'short' });
    const dayNum = d.getDate();
    const dateStr = `${dayName}, ${month} ${dayNum}`;

    const timeStr = next.time ? fmt12(next.time) : '';
    const endStr = next.end_time ? ` – ${fmt12(next.end_time)}` : '';
    const socialTag = next.social ? '<span class="yc-event-social-tag">✦ Social after</span>' : '';
    const noteTag = next.notes ? ` <span style="opacity:0.65;font-size:0.62rem;">— ${next.notes}</span>` : '';

    // Recurrence note for series with 2+ dates
    let recurrenceNote = '';
    if (group.length > 1) {
      const futureDates = group.slice(1).map(e => {
        const fd = new Date(e.date + 'T12:00:00');
        return `${fd.toLocaleString('en-US', { month: 'short' })} ${fd.getDate()}`;
      }).join(', ');
      recurrenceNote = `<div class="yc-recurrence-note">Monthly · also ${futureDates}</div>`;
    }

    // Calendar button for the next occurrence
    let ycCalHtml = '';
    if (next.date && next.time) {
      const loc0 = p.locations && p.locations[0];
      const evtLoc = (loc0 ? loc0.name : p.name) + ', ' + (p.town || '') + ', MA';
      const icsUrl = generateICS(next.title, next.date, next.time, next.end_time, evtLoc, next.notes || '');
      const gcalUrl = generateGCalURL(next.title, next.date, next.time, next.end_time, evtLoc, next.notes || '');
      ycCalHtml = ` <span class="cal-dropdown"><button class="special-event-cal" onclick="event.stopPropagation(); toggleCalDropdown(this);">📅</button><div class="cal-dropdown-menu"><a href="${gcalUrl}" target="_blank" rel="noopener">Google Calendar</a><a href="${icsUrl}" download="${next.id || 'yc-event'}.ics">Download .ics</a></div></span>`;
    }

    rows.push(`<li class="yc-event-row">
      <span class="yc-event-date-col">${dateStr}</span>
      <span class="yc-event-detail-col">
        <span class="yc-event-title-tag">${next.title}</span>
        ${timeStr ? ` · ${timeStr}${endStr}` : ''}${socialTag}${ycCalHtml}${noteTag}
        ${recurrenceNote}
      </span>
    </li>`);
  }

  return `<div class="service-section special-events yc-events-section">
    <div class="service-section-title" style="color:#b8860b;"><span class="svc-yc-tag" style="margin-right:6px;font-size:0.55rem;">YC</span>Young &amp; Catholic Events</div>
    <ul class="service-list special-events-list">${rows.join('')}</ul>
  </div>`;
}


function getVerifiedBadge(p) {
  const val = p.validation;

  // No validation data at all
  if (!val) return buildVerifyBadge('red', '?', 'Not checked', {
    title: 'Not Yet Checked',
    rows: ['This parish has not been verified yet.'],
    action: 'Times may be outdated — confirm with the parish before visiting.',
  });

  // Parse source to determine how it was verified
  let sourceType = 'unknown';
  let sourceUrl = '';
  const rawSource = val.source || '';
  if (rawSource.startsWith('bulletin')) {
    sourceType = 'bulletin';
    const urlMatch = rawSource.match(/— (.+)$/);
    if (urlMatch) sourceUrl = urlMatch[1];
  } else if (rawSource.startsWith('website') || rawSource.startsWith('shrine website')) {
    sourceType = 'website';
    const urlMatch = rawSource.match(/— (.+)$/);
    if (urlMatch) sourceUrl = urlMatch[1];
  }

  // Calculate age
  let monthsOld = Infinity;
  if (val.last_checked) {
    const checked = new Date(val.last_checked);
    const now = new Date();
    monthsOld = (now.getFullYear() - checked.getFullYear()) * 12 + (now.getMonth() - checked.getMonth());
  }

  // Date label for display
  let dateLabel = '';
  if (val.bulletin_date) {
    const [yr, mo] = val.bulletin_date.split('-');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    dateLabel = months[parseInt(mo,10)-1] + ' ' + yr;
  } else if (val.last_checked) {
    const d = new Date(val.last_checked);
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    dateLabel = months[d.getMonth()] + ' ' + d.getFullYear();
  }

  const status = val.status;

  // Build based on status + age
  if (status === 'verified' || status === 'manually_verified') {
    const howChecked = status === 'manually_verified'
      ? 'Confirmed directly by a parishioner'
      : sourceType === 'bulletin' ? 'Checked against the parish bulletin'
      : sourceType === 'website' ? 'Checked against the parish website'
      : 'Verified by our team';

    // Fresh (< 3 months)
    if (monthsOld < 3) {
      const sourceLabel = sourceType === 'bulletin' ? 'Bulletin'
        : sourceType === 'website' ? 'Website' : 'Confirmed';
      return buildVerifyBadge('green', '✓', sourceLabel + (dateLabel ? ' · ' + dateLabel : ''), {
        title: '✓ Schedule Verified',
        rows: [
          `<strong>How:</strong> ${howChecked}`,
          dateLabel ? `<strong>When:</strong> ${dateLabel}` : '',
          sourceUrl ? `<strong>Source:</strong> <a href="${sourceUrl.startsWith('http') ? sourceUrl : 'https://' + sourceUrl}" target="_blank" rel="noopener" style="color:var(--navy);text-decoration:underline;">${sourceUrl.replace(/^https?:\/\//, '').split('/')[0]}</a>` : '',
        ].filter(Boolean),
        action: 'These times should be accurate. Still a good idea to check the bulletin before a first visit.',
      });
    }
    // Aging (3-6 months)
    else if (monthsOld < 6) {
      return buildVerifyBadge('yellow', '–', 'Checked ' + (dateLabel || 'a while ago'), {
        title: 'Schedule May Need a Refresh',
        rows: [
          `<strong>How:</strong> ${howChecked}`,
          dateLabel ? `<strong>Last checked:</strong> ${dateLabel} (${monthsOld} months ago)` : '',
        ].filter(Boolean),
        action: 'Times are probably still accurate, but check the bulletin to be safe.',
      });
    }
    // Stale (6+ months)
    else {
      return buildVerifyBadge('orange', '!', 'Last checked ' + (dateLabel || 'long ago'), {
        title: 'Schedule May Be Outdated',
        rows: [
          `<strong>How:</strong> ${howChecked}`,
          dateLabel ? `<strong>Last checked:</strong> ${dateLabel} (${monthsOld}+ months ago)` : '',
        ].filter(Boolean),
        action: 'Please confirm times with the parish before visiting — schedules may have changed.',
      });
    }
  }
  // Needs verification / deferred
  else if (status === 'needs_verification' || status === 'deferred') {
    return buildVerifyBadge('yellow', '–', 'Needs review', {
      title: 'Schedule Needs Review',
      rows: [
        'We have service times listed but haven\'t been able to confirm them recently.',
        dateLabel ? `<strong>Data from:</strong> ${dateLabel}` : '',
      ].filter(Boolean),
      action: 'Double-check times with the parish before visiting. Tap "Report" below to help us verify!',
    });
  }
  // Low confidence
  else if (status === 'low_confidence') {
    return buildVerifyBadge('orange', '!', 'Unverified', {
      title: 'Times May Not Be Accurate',
      rows: [
        'We pulled these times from an older source and haven\'t confirmed them.',
        dateLabel ? `<strong>Source date:</strong> ${dateLabel}` : '',
        val.recommended_action ? `<strong>Note:</strong> ${val.recommended_action}` : '',
      ].filter(Boolean),
      action: 'Please call the parish or check their bulletin before visiting. Help us by tapping "Report" below!',
    });
  }
  // Fallback
  else {
    return buildVerifyBadge('red', '?', 'Not checked', {
      title: 'Not Yet Checked',
      rows: ['This parish has not been verified yet.'],
      action: 'Confirm times directly with the parish. Help us by submitting a report!',
    });
  }
}

function buildVerifyBadge(tier, icon, label, detail) {
  const cls = 'verify-' + tier;
  const detailRows = detail.rows.map(r => `<div class="verify-detail-row">${r}</div>`).join('');
  return `<span class="verify-badge ${cls}" onclick="event.stopPropagation(); toggleVerifyDetail(this);">
    <span class="verify-icon">${icon}</span>${label}
    <div class="verify-detail">
      <div class="verify-detail-title">${detail.title}</div>
      ${detailRows}
      <div class="verify-detail-action">${detail.action}</div>
    </div>
  </span>`;
}

function toggleVerifyDetail(el) {
  // Close any other open badges
  document.querySelectorAll('.verify-badge.open').forEach(b => {
    if (b !== el) b.classList.remove('open');
  });
  el.classList.toggle('open');
}

// Close verify detail on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.verify-badge')) {
    document.querySelectorAll('.verify-badge.open').forEach(b => b.classList.remove('open'));
  }
});

var ycParishIds = new Set(); // populated by renderYCEvents(), used by card rendering
var ycServiceIds = new Set(); // service IDs linked to YC events
var ycNextEventByParish = {}; // parish_id → next upcoming YC event object
var ycActiveThisWeek = new Set(); // parish_ids with a YC event this week (Sun-Sat)
var ycLiteralEventsByParish = {}; // parish_id → array of upcoming YC events without service_id
var favorites = new Set(); // WP-Favorites: parish IDs the user has favorited
var favFilterActive = false;

function renderParishCard(p, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, distMiles) {
  const groups = groupServices(p.services || []);

  const hasAny = Object.values(groups).flat().some(s =>
    isCurrentSeason(s) &&
    serviceMatchesDay(s, dayFilter) &&
    serviceMatchesTime(s, timeFilter) &&
    serviceMatchesType(s, categoryFilter, subtypeFilter) &&
    (!langFilter || s.language === langFilter)
  );
  if (!hasAny && (dayFilter || timeFilter || categoryFilter || subtypeFilter || langFilter)) return '';

  const isLowConf = p.validation && (p.validation.status === 'low_confidence');

  const loc = p.locations && p.locations[0];

  // WP1-1A: Derive church display name from primary location
  let churchName = (loc && loc.name) ? loc.name : p.name;
  // Edge case: strip trailing "Church" if name already contains Cathedral/Basilica
  if (/Cathedral|Basilica/i.test(churchName)) {
    churchName = churchName.replace(/\s+Church$/i, '');
  }

  // WP1-1B: Multi-site detection & sibling churches
  const worshipSites = (p.locations || []).filter(l =>
    ['church', 'chapel', 'mission'].includes(l.type)
  );
  const isMultiSite = worshipSites.length > 1;
  let alsoAtHtml = '';
  if (isMultiSite) {
    const siblings = worshipSites.slice(1);
    const siblingLines = siblings.map(s => {
      const cityLabel = (s.city && s.city.toLowerCase() !== (p.town||'').toLowerCase())
        ? `, ${s.city}` : '';
      return `${s.name}${cityLabel}`;
    }).join('<br>');
    alsoAtHtml = `<div class="also-at">Also at:<br>${siblingLines}</div>`;
  }

  // WP1-1C: Build location lookup map for service-level labels
  const locMap = {};
  (p.locations || []).forEach(l => { locMap[l.id] = l; });

  const massSect  = renderMassSectionWithHolyDays(groups.mass, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  const confSect  = renderServiceSection('Confession', 'confession', groups.confession, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  const adorSect  = renderServiceSection('Adoration & Prayer', 'adoration', groups.adoration, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  const devotSect = renderServiceSection('Devotions', 'devotion', groups.devotion, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  const otherSect = renderServiceSection('Other Services', 'other', groups.other, dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);
  // Lenten section always renders if lent services exist (independent of any filter)
  const lentSect  = renderLentenSection(p.services || [], dayFilter, timeFilter, categoryFilter, subtypeFilter, langFilter, locMap, isMultiSite);

  // Pre-filter services for summaries (mirrors renderServiceSection's internal filter)
  const svcFilter = (s) =>
    isCurrentSeason(s) &&
    serviceMatchesDay(s, dayFilter) &&
    serviceMatchesTime(s, timeFilter) &&
    serviceMatchesType(s, categoryFilter, subtypeFilter) &&
    (!langFilter || s.language === langFilter);
  const massFiltered  = groups.mass.filter(svcFilter);
  const confFiltered  = groups.confession.filter(svcFilter);
  const adorFiltered  = groups.adoration.filter(svcFilter);
  const devotFiltered = groups.devotion.filter(svcFilter);
  const otherFiltered = groups.other.filter(svcFilter);
  const lentFiltered  = (p.services || []).filter(s => s.seasonal && s.seasonal.season === 'lent' && isCurrentSeason(s) && serviceMatchesDay(s, dayFilter) && serviceMatchesTime(s, timeFilter) && serviceMatchesType(s, categoryFilter, subtypeFilter) && (!langFilter || s.language === langFilter));

  // Determine collapse state: expanded (false) vs collapsed (true)
  // Defaults: Mass + Confession expanded; rest collapsed
  // Auto-expand: if a category filter targets this section, or search is active
  const hasSearch = !!(document.getElementById('searchInput') && document.getElementById('searchInput').value.trim());
  const massCollapsed  = false; // always open
  const confCollapsed  = false; // always open
  const adorCollapsed  = !(categoryFilter === 'devotion' || hasSearch);
  const devotCollapsed = !(categoryFilter === 'devotion' || hasSearch);
  const lentCollapsed  = false; // WP9: expanded by default when pinned to top
  const otherCollapsed = !hasSearch;

  // Wrap each in collapsible
  const massWrapped  = wrapCollapsible('mass',      'Mass',              'mass',       massSect,  massFiltered,  massCollapsed);
  const confWrapped  = wrapCollapsible('confession', 'Confession',       'confession', confSect,  confFiltered,  confCollapsed);
  const adorWrapped  = wrapCollapsible('adoration',  'Adoration & Prayer','adoration', adorSect,  adorFiltered,  adorCollapsed);
  const devotWrapped = wrapCollapsible('devotion',   'Devotions',        'devotion',   devotSect, devotFiltered, devotCollapsed);
  const lentWrapped  = wrapCollapsible('lent',       'Lenten Services',  'lent',       lentSect,  lentFiltered,  lentCollapsed);
  const otherWrapped = wrapCollapsible('other',      'Other Services',   'other',      otherSect, otherFiltered, otherCollapsed);

  const addr = loc && loc.address ? loc.address : `${churchName}, ${p.town}, MA`;
  const mapsUrl = /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent) && !window.MSStream
    ? `https://maps.apple.com/?q=${encodeURIComponent(addr)}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
  const appleMapsIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C7.58 2 4 5.58 4 10c0 5.25 8 12 8 12s8-6.75 8-12c0-4.42-3.58-8-8-8z" fill="#34A853"/><path d="M12 2C7.58 2 4 5.58 4 10c0 5.25 8 12 8 12s8-6.75 8-12c0-4.42-3.58-8-8-8zm0 2c3.31 0 6 2.69 6 6 0 1.01-.31 2.15-.82 3.32L12 17.5l-5.18-4.18C6.31 12.15 6 11.01 6 10c0-3.31 2.69-6 6-6z" fill="#2E7D32"/><circle cx="12" cy="10" r="2.5" fill="white"/></svg>`;
  const directionsBtn = `<a class="directions-btn" href="${mapsUrl}" target="_blank" rel="noopener">${appleMapsIcon} Directions</a>`;

  const distHtml = (distMiles !== undefined && distMiles !== null)
    ? `<span class="dist-badge${distMiles <= 5 ? ' near' : ''}">${distMiles.toFixed(1)} mi</span>`
    : '';

  const multiSite = ''; // WP1-1B: replaced by alsoAtHtml in card header

  const bulletinLink = p.bulletin_url
    ? `<a class="bulletin-link" href="${p.bulletin_url}" target="_blank" rel="noopener">Bulletin</a>` : '';

  // Build contact drawer rows
  const c = p.contact || {};
  const clergy = p.clergy || [];
  const contactRows = [];
  if (c.phone) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Phone</span><span class="contact-row-val"><a href="tel:${c.phone.replace(/\D/g,'')}" class="phone-link">${c.phone}</a></span></div>`);
  if (c.fax)   contactRows.push(`<div class="contact-row"><span class="contact-row-label">Fax</span><span class="contact-row-val">${c.fax}</span></div>`);
  if (c.emails && c.emails.length) {
    const emailList = c.emails.map(e => `<a href="mailto:${e}">${e}</a>`).join(', ');
    contactRows.push(`<div class="contact-row"><span class="contact-row-label">Email</span><span class="contact-row-val">${emailList}</span></div>`);
  }
  if (c.website) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Website</span><span class="contact-row-val"><a href="${c.website}" target="_blank" rel="noopener">${c.website.replace(/^https?:\/\//,'')}</a></span></div>`);
  if (c.office_hours) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Office hrs</span><span class="contact-row-val">${c.office_hours}</span></div>`);
  if (loc && loc.address) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Address</span><span class="contact-row-val">${loc.address}</span></div>`);
  if (c.office_address) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Mailing</span><span class="contact-row-val">${c.office_address}</span></div>`);
  // Clergy from data
  for (const cl of clergy) {
    if (cl.name) contactRows.push(`<div class="contact-row"><span class="contact-row-label">${cl.title || 'Clergy'}</span><span class="contact-row-val">${cl.name}</span></div>`);
  }
  if (c.notes) contactRows.push(`<div class="contact-row"><span class="contact-row-label">Notes</span><span class="contact-row-val">${c.notes}</span></div>`);

  const contactDrawer = contactRows.length
    ? `<button class="contact-toggle-btn" onclick="toggleContact(this)">Contact</button>
       <div class="contact-drawer">${contactRows.join('')}</div>` : '';

  // Pastor name for card footer — find first clergy with "Pastor" or "Rector" title
  const pastorClergy = clergy.find(cl => cl.name && /pastor|rector/i.test(cl.title || ''));
  const pastorFooter = pastorClergy
    ? `<span class="pastor-name">${pastorClergy.name}</span>` : `<span></span>`;

  // Accessibility badge
  const accessBadge = (loc && loc.is_accessible)
    ? '<span class="access-badge" title="Wheelchair accessible">♿ Accessible</span>' : '';

  const confBadge = getVerifiedBadge(p);

  const confWarn = isLowConf
    ? `<div class="confidence-warn">⚠ Times may not be accurate — please check with the parish before visiting</div>` : '';

  let ycBannerHtml = '';
  if (ycParishIds.has(p.id)) {
    const nextEvt = ycNextEventByParish[p.id];
    let bannerText = '';
    if (nextEvt) {
      const d = new Date(nextEvt.date + 'T12:00:00');
      const dayName = d.toLocaleString('en-US', { weekday: 'short' });
      const month = d.toLocaleString('en-US', { month: 'short' });
      const dayNum = d.getDate();
      const timeStr = nextEvt.time ? fmt12(nextEvt.time) : '';
      bannerText = `${nextEvt.title} · ${dayName} ${month} ${dayNum}${timeStr ? ' · ' + timeStr : ''}${nextEvt.social ? ' · Social after' : ''}`;
    }
    ycBannerHtml = `<div class="parish-yc-banner"><span class="yc-banner-label">YC</span>${bannerText ? `<span class="yc-banner-text">${bannerText}</span>` : '<span class="yc-banner-text">Young &amp; Catholic</span>'}</div>`;
  }

  const isFav = favorites.has(p.id);

  return `<article class="parish-card${isLowConf ? ' low-confidence' : ''}${ycActiveThisWeek.has(p.id) ? ' yc-active-week' : ''}" data-parish-id="${p.id}">
    ${ycBannerHtml}
    <div class="card-header">
      <h2>${churchName}</h2>
      ${alsoAtHtml}
      <div class="card-location">${p.town}, MA &middot; ${p.county} County</div>
      <span class="county-badge"><button class="fav-btn${isFav ? ' favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${p.id}', this);" title="${isFav ? 'Remove from favorites' : 'Add to favorites'}">${isFav ? '❤️' : '🤍'}</button> ${confBadge}</span>
      ${confWarn}
    </div>
    <div class="card-meta">${accessBadge}${contactDrawer}${bulletinLink}${distHtml}${directionsBtn}<button class="share-btn" onclick="event.stopPropagation(); shareParish('${p.id}', this);" title="Share this church">📋 Share</button>${multiSite}</div>
    <div class="card-body">
      ${renderYCLiteralEvents(p)}
      ${lentWrapped}${massWrapped}${confWrapped}${adorWrapped}${devotWrapped}${otherWrapped}
      ${renderSpecialEvents(p)}
    </div>
    <div class="card-footer">
      ${pastorFooter}
      <button class="reconcile-btn" onclick="openReconcile('${p.id}')" title="Report an update or correction">Report</button>
    </div>
  </article>`;
}

// ═══════════════════════════════════════════════════
// CALENDAR INTEGRATION
// ═══════════════════════════════════════════════════

function formatICSDate(dateStr, timeStr) {
  if (!dateStr) return '';
  const d = dateStr.replace(/-/g, '');
  const t = timeStr ? timeStr.replace(/:/g, '') + '00' : '000000';
  return d + 'T' + t;
}

function generateICS(title, dateStr, timeStr, endTimeStr, location, description) {
  const dtStart = formatICSDate(dateStr, timeStr);
  const dtEnd = endTimeStr ? formatICSDate(dateStr, endTimeStr)
    : formatICSDate(dateStr, timeStr ? (() => {
        const [h, m] = timeStr.split(':').map(Number);
        const endH = h + 1;
        return `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      })() : null);

  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//WMass Parish Finder//EN',
    'BEGIN:VEVENT',
    `DTSTART:${dtStart}`,
    dtEnd ? `DTEND:${dtEnd}` : '',
    `SUMMARY:${(title || '').replace(/[,;\\]/g, ' ')}`,
    location ? `LOCATION:${location.replace(/[,;\\]/g, ' ')}` : '',
    description ? `DESCRIPTION:${description.replace(/[,;\\]/g, ' ').replace(/\n/g, '\\n')}` : '',
    `UID:${Date.now()}-${Math.random().toString(36).slice(2)}@parishfinder`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');

  return 'data:text/calendar;charset=utf-8,' + encodeURIComponent(lines);
}

function generateGCalURL(title, dateStr, timeStr, endTimeStr, location, description) {
  const dtStart = formatICSDate(dateStr, timeStr);
  const dtEnd = endTimeStr ? formatICSDate(dateStr, endTimeStr)
    : formatICSDate(dateStr, timeStr ? (() => {
        const [h, m] = timeStr.split(':').map(Number);
        return `${String(h + 1).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      })() : null);

  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: title || '',
    dates: dtStart + '/' + (dtEnd || dtStart),
  });
  if (location) params.set('location', location);
  if (description) params.set('details', description);

  return 'https://calendar.google.com/calendar/render?' + params.toString();
}

function toggleCalDropdown(el) {
  // Close any already-open dropdown
  const existing = document.getElementById('calDropdownPortal');
  if (existing) {
    existing.remove();
    // If clicking same button that opened it, just close
    if (existing._srcBtn === el) return;
  }

  const menu = el.parentElement.querySelector('.cal-dropdown-menu');
  if (!menu) return;

  // Clone the menu and portal it to body
  const portal = menu.cloneNode(true);
  portal.id = 'calDropdownPortal';
  portal._srcBtn = el;
  portal.classList.add('open');

  // Position below the button
  const rect = el.getBoundingClientRect();
  portal.style.position = 'fixed';
  portal.style.top = (rect.bottom + 4) + 'px';
  portal.style.left = Math.max(4, Math.min(rect.left, window.innerWidth - 170)) + 'px';
  portal.style.zIndex = '9999';

  document.body.appendChild(portal);
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.cal-dropdown') && !e.target.closest('#calDropdownPortal')) {
    const portal = document.getElementById('calDropdownPortal');
    if (portal) portal.remove();
  }
});

window.addEventListener('scroll', function() {
  const portal = document.getElementById('calDropdownPortal');
  if (portal) portal.remove();
}, true);

(async function() {
  try {
    const resp = await fetch(PARISH_DATA_URL);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    PARISH_DATA = await resp.json();
  } catch(e) {
    document.body.innerHTML = '<div style="padding:2rem;text-align:center;color:red;font-size:1.2rem;">Error loading data. Please refresh the page.<br><small>' + e.message + '</small></div>';
    return;
  }

const parishes      = PARISH_DATA.parishes;
const grid          = document.getElementById('parishGrid');
const searchInput   = document.getElementById('searchInput');
const countyFilter  = document.getElementById('countyFilter');
const dayFilterEl   = document.getElementById('dayFilter');
const timeFilterEl  = document.getElementById('timeFilter');
const langFilterEl  = document.getElementById('langFilter');
const categoryChips = document.getElementById('categoryChips');
const subfilterBar  = document.getElementById('subfilterBar');
const subtypeChips  = document.getElementById('subtypeChips');
const subfilterLabel= document.getElementById('subfilterLabel');
const resultsCount  = document.getElementById('resultsCount');

let activeCategory = '';
let activeSubtype  = '';

// Stats
const totalSvc = parishes.reduce((n,p) => n + (p.services||[]).length, 0);
document.getElementById('headerBadge').textContent   = `${parishes.length} Churches · ${totalSvc} Services`;

const CAT_LABELS = { mass: 'Mass type', confession: 'When', adoration: 'Type', devotion: 'Devotion' };

function buildSubChips(category) {
  const defs = SUBTYPES[category] || [];
  subtypeChips.innerHTML =
    `<button class="subchip active" data-sub="">All ${CAT_LABELS[category] || ''}</button>` +
    defs.map(d => `<button class="subchip" data-sub="${d.key}">${d.label}</button>`).join('');
  subfilterLabel.textContent = CAT_LABELS[category] || '';
}

function isAnyFilterActive() {
  return !!(searchInput.value.trim() || countyFilter.value || dayFilterEl.value ||
            timeFilterEl.value || langFilterEl.value || activeCategory);
}

function updateClearFiltersBtn() {
  const btn = document.getElementById('clearFiltersBtn');
  if (btn) btn.style.display = isAnyFilterActive() ? '' : 'none';
}

var _deepLinkParishId = null; // captured before render can strip it

function syncUrlParams() {
  const params = new URLSearchParams();
  if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
  if (countyFilter.value)       params.set('county', countyFilter.value);
  if (dayFilterEl.value)        params.set('day', dayFilterEl.value);
  if (timeFilterEl.value)       params.set('time', timeFilterEl.value);
  if (langFilterEl.value)       params.set('lang', langFilterEl.value);
  if (activeCategory)           params.set('cat', activeCategory);
  if (activeSubtype)            params.set('sub', activeSubtype);
  // Preserve deep link parish param during initial load
  if (_deepLinkParishId) params.set('parish', _deepLinkParishId);
  const str = params.toString();
  history.replaceState(null, '', str ? '?' + str : location.pathname);
}

function render() {
  const q        = searchInput.value.trim();
  const county   = countyFilter.value;
  const day      = dayFilterEl.value;
  const time     = timeFilterEl.value;
  const lang     = langFilterEl.value;
  const cat      = activeCategory;
  const subtype  = activeSubtype;

  const filtered = parishes.filter(p => {
    if (favFilterActive && !favorites.has(p.id)) return false;
    if (!parishMatchesSearch(p, q)) return false;
    if (county && p.county !== county) return false;
    if (day || time || cat || subtype || lang) {
      const hasMatch = (p.services||[]).some(s =>
        isCurrentSeason(s) &&
        serviceMatchesDay(s, day) &&
        serviceMatchesTime(s, time) &&
        serviceMatchesType(s, cat, subtype) &&
        (!lang || s.language === lang)
      );
      if (!hasMatch) return false;
    }
    return true;
  });

  // Sort based on sortMode
  if (sortMode === 'proximity' && userLat !== null) {
    filtered.sort((a, b) => {
      const da = getDistMiles(a);
      const db = getDistMiles(b);
      if (da === null && db === null) return 0;
      if (da === null) return 1;
      if (db === null) return -1;
      return da - db;
    });
  } else {
    // Alphabetical (default)
    filtered.sort((a, b) => a.name.localeCompare(b.name));
  }

  // Pin YC active-this-week parishes to top (regardless of filters)
  if (ycActiveThisWeek.size > 0) {
    const filteredIds = new Set(filtered.map(p => p.id));
    const missingYC = parishes.filter(p => ycActiveThisWeek.has(p.id) && !filteredIds.has(p.id));
    if (missingYC.length) filtered.unshift(...missingYC);
    filtered.sort((a, b) => {
      const aYC = ycActiveThisWeek.has(a.id) ? 0 : 1;
      const bYC = ycActiveThisWeek.has(b.id) ? 0 : 1;
      return aYC - bYC;
    });
  }

  // WP-Favorites: Pin favorites to top when not in favorites-only mode
  if (favorites.size > 0 && !favFilterActive) {
    filtered.sort((a, b) => {
      const aF = favorites.has(a.id) ? 0 : 1;
      const bF = favorites.has(b.id) ? 0 : 1;
      return aF - bF;
    });
  }

  var html = filtered.map(function(p) {
    return renderParishCard(p, day, time, cat, subtype, lang, getDistMiles(p));
  }).join('');
  grid.innerHTML = html || '<div class="no-results"><div class="cross">✝</div><p>No churches found matching your filters.</p></div>';

  const shown = filtered.length;
  resultsCount.textContent = shown + ' of ' + parishes.length + ' shown';

  updateClearFiltersBtn();
  syncUrlParams();
}

// Category chips
categoryChips.addEventListener('click', e => {
  const chip = e.target.closest('[data-cat]');
  if (!chip) return;
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  activeCategory = chip.dataset.cat;
  activeSubtype  = '';

  if (activeCategory && SUBTYPES[activeCategory]) {
    buildSubChips(activeCategory);
    subfilterBar.style.display = '';
  } else {
    subfilterBar.style.display = 'none';
    subtypeChips.innerHTML = '';
  }
  render();
});

// Subtype chips (event delegation)
subtypeChips.addEventListener('click', e => {
  const chip = e.target.closest('[data-sub]');
  if (!chip) return;
  subtypeChips.querySelectorAll('[data-sub]').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  activeSubtype = chip.dataset.sub;
  render();
});

// Other controls
searchInput.addEventListener('input', render);
countyFilter.addEventListener('change', render);
dayFilterEl.addEventListener('change', render);
timeFilterEl.addEventListener('change', render);
langFilterEl.addEventListener('change', render);
document.getElementById('clearFiltersBtn').addEventListener('click', function(e) {
  e.stopPropagation();
  clearAllFilters();
});

// Tap-to-expand/collapse special event detail text
grid.addEventListener('click', function(e) {
  if (e.target.closest('.cal-dropdown')) return;
  const detail = e.target.closest('.special-event-detail');
  if (detail) {
    detail.classList.toggle('expanded');
    return;
  }
});

// Proximity stubs — real implementation in location block below
var userLat = null;
var userLng = null;
function getDistMiles(p) {
  if (userLat === null) return null;
  var loc = p.locations && p.locations[0];
  if (!loc || !loc.lat || !loc.lng) return null;
  return haversine(userLat, userLng, loc.lat, loc.lng);
}
function haversine(lat1, lng1, lat2, lng2) {
  var R = 3958.8;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.pow(Math.sin(dLat/2),2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.pow(Math.sin(dLng/2),2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// Apply URL params if present (before initial render)
(function applyUrlParams() {
  const p = new URLSearchParams(location.search);
  // Capture deep link parish before render/syncUrlParams can strip it
  if (p.get('parish')) _deepLinkParishId = p.get('parish');
  if (p.get('q'))      searchInput.value = p.get('q');
  if (p.get('county')) countyFilter.value = p.get('county');
  if (p.get('day'))    dayFilterEl.value = p.get('day');
  if (p.get('time'))   timeFilterEl.value = p.get('time');
  if (p.get('lang'))   langFilterEl.value = p.get('lang');
  if (p.get('cat')) {
    activeCategory = p.get('cat');
    categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === activeCategory));
    if (SUBTYPES[activeCategory]) { buildSubChips(activeCategory); subfilterBar.style.display = ''; }
    if (p.get('sub')) {
      activeSubtype = p.get('sub');
      subtypeChips.querySelectorAll('[data-sub]').forEach(c => c.classList.toggle('active', c.dataset.sub === activeSubtype));
    }
  }
})();

// Initial render
renderYCEvents();
render();
applyDeepLinkParams();
updateCalExportBtn();

// ═══════════════════════════════════════════════════
// LOCATION & PROXIMITY
// ═══════════════════════════════════════════════════

// userLat, userLng, haversine, getDistMiles declared in main block above
var locationStatus = 'unknown';
var soonRadiusMiles = 10;
var soonMode = 'mass'; // 'mass' | 'confession' | 'adoration' | 'lent'
var sortMode = 'alpha'; // 'proximity' | 'alpha'  — proximity only when location known

function requestLocation() {
  if (!navigator.geolocation) {
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      locationStatus = 'granted';
      sortMode = 'proximity';
      document.getElementById('sortToggle').classList.add('location-ready');
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === 'proximity'));
      renderYCEvents();
      render();
      if (currentView === 'now') {
        if (nowViewMode === 'week') renderWeekCalendar();
        else renderNowView();
      }
      if (currentView === 'yc') renderYCView();
      if (mapInitialized && appMap) {
        L.circleMarker([userLat, userLng], {
          radius: 8, fillColor: '#4285F4', fillOpacity: 0.9, color: '#fff', weight: 2
        }).addTo(appMap).bindPopup('You are here');
      }
    },
    () => {
      locationStatus = 'denied';
    },
    { timeout: 8000 }
  );
}

// Passive location attempt on load (no prompt shown if permission not already granted)
function initLocationBanner() {
  // Happening Soon section removed from visible UI — just attempt passive location
}
try {
  if (navigator.permissions) {
    navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
      if (result.state === 'granted') {
        requestLocation();
      } else {
        initLocationBanner();
      }
    }).catch(function() { initLocationBanner(); });
  } else {
    initLocationBanner();
  }
} catch(e) {
  initLocationBanner();
}

// ═══════════════════════════════════════════════════
// HAPPENING SOON
// ═══════════════════════════════════════════════════

const DAY_NAMES = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

function timeToMinutes(t) {
  if (!t) return null;
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function refreshSoon() {
  if (userLat === null) return;
  document.getElementById('happeningSoon').style.display = '';

  const now = new Date();
  const todayIdx = now.getDay(); // 0=Sun
  const todayName = DAY_NAMES[todayIdx];
  const nowMin = now.getHours() * 60 + now.getMinutes();
  var windowMin = 90;

  // Determine which services qualify for this mode
  function svcMatchesMode(svc) {
    if (soonMode === 'mass') {
      return svc.type === 'sunday_mass' || svc.type === 'daily_mass' || svc.type === 'mass';
    }
    if (soonMode === 'confession') {
      return svc.type === 'confession';
    }
    if (soonMode === 'adoration') {
      return svc.type === 'adoration' || svc.type === 'holy_hour';
    }
    if (soonMode === 'lent') {
      // Show all Lenten-season services happening now/soon
      return svc.seasonal && svc.seasonal.season === 'lent';
    }
    return false;
  }

  const results = [];

  for (const p of parishes) {
    const primaryLoc = p.locations && p.locations[0];
    if (!primaryLoc || !primaryLoc.lat) continue;

    for (const svc of (p.services || [])) {
      if (!svcMatchesMode(svc)) continue;
      // WP2-2B: Skip out-of-season services
      if (!isCurrentSeason(svc)) continue;
      const svcMin = timeToMinutes(svc.time);
      if (svcMin === null) continue;

      // WP1-1E: Use specific building coords for multi-site distance calc
      let svcLat = primaryLoc.lat, svcLng = primaryLoc.lng;
      if (svc.location_id) {
        const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
        if (svcLoc && svcLoc.lat) { svcLat = svcLoc.lat; svcLng = svcLoc.lng; }
      }
      const dist = haversine(userLat, userLng, svcLat, svcLng);
      if (dist > soonRadiusMiles) continue;

      const svcDay = svc.day;
      const isWeekday = todayIdx >= 1 && todayIdx <= 5; // Mon-Fri
      const matchesToday = svcDay === todayName
        || (svcDay === 'daily')  // daily = all 7 days
        || (svcDay === 'weekday' && isWeekday);

      if (!matchesToday) continue;

      // WP2-2A: Use real end times instead of hardcoded 90-min window
      let endMin;
      if (svc.end_time) {
        endMin = timeToMinutes(svc.end_time);
      } else {
        // Fallback: estimated duration by type
        const isMass = svc.type === 'sunday_mass' || svc.type === 'daily_mass' || svc.type === 'mass';
        endMin = svcMin + (isMass ? 90 : 60);
      }

      const minsAway = svcMin - nowMin;
      let status = null;
      if (nowMin >= svcMin && nowMin <= endMin) {
        status = 'now';       // Service in progress
      } else if (minsAway > 0 && minsAway <= windowMin) {
        status = 'soon';      // Starting within lookahead window
      }

      if (status) {
        results.push({ p, svc, dist, minsAway, svcMin, status });
      }
    }
  }

  // WP2-2D: Also check special_events for today
  for (const p of parishes) {
    if (!p.special_events || !p.special_events.length) continue;
    const primaryLoc = p.locations && p.locations[0];
    if (!primaryLoc || !primaryLoc.lat) continue;

    for (const evt of p.special_events) {
      if (!evt.time) continue;

      // Check if this event applies today
      let appliesToday = false;
      const todayStr = now.getFullYear() + '-' +
        String(now.getMonth()+1).padStart(2,'0') + '-' +
        String(now.getDate()).padStart(2,'0');

      if (evt.recurrence && evt.recurrence.type === 'seasonal' && evt.recurrence.season) {
        // Recurring seasonal: check if season is active AND today's day matches
        const fakeSvc = { seasonal: { is_seasonal: true, season: evt.recurrence.season } };
        if (isCurrentSeason(fakeSvc) && evt.recurrence.days && evt.recurrence.days.length) {
          const todayDayName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][now.getDay()];
          appliesToday = evt.recurrence.days.includes(todayDayName);
        }
      } else if (evt.date) {
        appliesToday = (evt.date === todayStr);
      }
      if (!appliesToday) continue;
      if (!svcMatchesMode(evt)) continue;

      const svcMin = timeToMinutes(evt.time);
      if (svcMin === null) continue;

      let svcLat = primaryLoc.lat, svcLng = primaryLoc.lng;
      if (evt.location_id) {
        const evtLoc = (p.locations || []).find(l => l.id === evt.location_id);
        if (evtLoc && evtLoc.lat) { svcLat = evtLoc.lat; svcLng = evtLoc.lng; }
      }
      const dist = haversine(userLat, userLng, svcLat, svcLng);
      if (dist > soonRadiusMiles) continue;

      let endMin;
      if (evt.end_time) {
        endMin = timeToMinutes(evt.end_time);
      } else {
        endMin = svcMin + 60;
      }

      const minsAway = svcMin - nowMin;
      let status = null;
      if (nowMin >= svcMin && nowMin <= endMin) {
        status = 'now';
      } else if (minsAway > 0 && minsAway <= windowMin) {
        status = 'soon';
      }

      if (status) {
        results.push({ p, svc: evt, dist, minsAway, svcMin, status, isSpecialEvent: true });
      }
    }
  }

  // Sort: "happening now" first (by how far into the service), then "starting soon" (by minsAway)
  results.sort((a, b) => {
    if (a.status === 'now' && b.status !== 'now') return -1;
    if (a.status !== 'now' && b.status === 'now') return 1;
    if (a.status === 'now' && b.status === 'now') return a.dist - b.dist;
    return a.minsAway - b.minsAway || a.dist - b.dist;
  });

  const container = document.getElementById('soonCards');
  if (results.length === 0) {
    const modeLabels = { mass: 'Masses', confession: 'confessions', adoration: 'adoration services', lent: 'Lenten services' };
    const modeLabel = modeLabels[soonMode] || 'services';
    container.innerHTML = `<span class="soon-none">No ${modeLabel} happening now or starting soon within 10 miles.</span>`;
    return;
  }

    const SVCTYPE_SHORT = { confession:'Confession', mass:'Mass', sunday_mass:'Mass', daily_mass:'Mass',
    stations_of_cross:'Stations', adoration:'Adoration', holy_hour:'Holy Hour', rosary:'Rosary', divine_mercy:'Divine Mercy', devotion:'Devotion',
    communion_service:'Communion Svc', novena:'Novena', anointing:'Anointing', miraculous_medal:'Miraculous Medal' };

  container.innerHTML = results.slice(0, 10).map(({ p, svc, dist, minsAway, status }) => {
    // WP2-2A: Distinguish "happening now" from "starting soon"
    let minsLabel;
    if (status === 'now') {
      minsLabel = 'Happening now';
    } else if (minsAway === 0) {
      minsLabel = 'Starting now';
    } else if (minsAway <= 5) {
      minsLabel = 'In a few minutes';
    } else {
      minsLabel = `In ${minsAway} min`;
    }

    // WP1-1E: Use correct building name/address for multi-site parishes
    let displayName, displayTown, directionsAddr;
    if (svc.location_id) {
      const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
      if (svcLoc) {
        displayName = svcLoc.name;
        displayTown = svcLoc.city || p.town;
        directionsAddr = svcLoc.address || (p.locations[0] && p.locations[0].address) || `${displayName}, ${displayTown}, MA`;
      }
    }
    if (!displayName) {
      const primaryLoc = p.locations && p.locations[0];
      displayName = (primaryLoc && primaryLoc.name) ? primaryLoc.name : p.name;
      // Strip trailing "Church" if name contains Cathedral/Basilica
      if (/Cathedral|Basilica/i.test(displayName)) {
        displayName = displayName.replace(/\s+Church$/i, '');
      }
      displayTown = p.town;
      directionsAddr = (primaryLoc && primaryLoc.address) || `${displayName}, ${p.town}, MA`;
    }

    const mapsUrl = /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent) && !window.MSStream
      ? `https://maps.apple.com/?q=${encodeURIComponent(directionsAddr)}`
      : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(directionsAddr)}`;
    const typeLabel = (soonMode !== 'mass')
      ? `<div class="soon-card-type">${SVCTYPE_SHORT[svc.type] || svc.type.replace(/_/g,' ')}</div>` : '';
    const isLenten = svc.seasonal && svc.seasonal.is_seasonal && svc.seasonal.season === 'lent';
    const nowClass = status === 'now' ? ' happening-now' : '';
    return `<a class="soon-card${isLenten ? ' lenten' : ''}${nowClass}" href="${mapsUrl}" target="_blank" rel="noopener">
      <div class="soon-card-time">${svc.time ? fmt12(svc.time) : 'Soon'}</div>
      <div class="soon-card-starts">${minsLabel}</div>
      ${typeLabel}
      <div class="soon-card-parish">${displayName}</div>
      <div class="soon-card-town">${displayTown}</div>
      <div class="soon-card-dist">${dist.toFixed(1)} mi</div>
    </a>`;
  }).join('');
}

// Refresh soon every minute
setInterval(() => { if (currentView === 'now') { if (nowViewMode === 'week') renderWeekCalendar(); else renderNowView(); } }, 60000);

// ═══════════════════════════════════════════════════
// YOUNG & CATHOLIC EVENTS
// ═══════════════════════════════════════════════════

function renderYCEvents() {
  const ycEvents = (PARISH_DATA.yc_events || []);
  if (!ycEvents.length) return;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const upcoming = ycEvents.filter(evt => {
    if (!evt.date) return false;
    const evtDate = new Date(evt.date + 'T00:00:00');
    return evtDate >= today;
  }).sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));

  if (!upcoming.length) return;

  // Build parish ID → name lookup for card labels
  ycParishIds.clear();
  ycServiceIds.clear();
  ycNextEventByParish = {};
  ycActiveThisWeek.clear();
  ycLiteralEventsByParish = {};

  // Compute current week window (Sunday through Saturday)
  const nowForWeek = new Date();
  const dayOfWeek = nowForWeek.getDay(); // 0=Sun
  const weekStart = new Date(nowForWeek);
  weekStart.setDate(nowForWeek.getDate() - dayOfWeek);
  weekStart.setHours(0, 0, 0, 0);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999);

  upcoming.forEach(evt => {
    if (evt.parish_id) ycParishIds.add(evt.parish_id);
    if (evt.service_id) ycServiceIds.add(evt.service_id);
    // Track the next (soonest) event per parish
    if (evt.parish_id && !ycNextEventByParish[evt.parish_id]) {
      ycNextEventByParish[evt.parish_id] = evt;
    }
    // Check if event falls within this week
    if (evt.parish_id && evt.date) {
      const evtDate = new Date(evt.date + 'T12:00:00');
      if (evtDate >= weekStart && evtDate <= weekEnd) {
        ycActiveThisWeek.add(evt.parish_id);
      }
    }
    // Build literal events map (no service_id = standalone event)
    if (evt.parish_id && !evt.service_id) {
      if (!ycLiteralEventsByParish[evt.parish_id]) {
        ycLiteralEventsByParish[evt.parish_id] = [];
      }
      ycLiteralEventsByParish[evt.parish_id].push(evt);
    }
  });

  const section = document.getElementById('ycEventsSection');
  const container = document.getElementById('ycCards');
  const subtitle = document.getElementById('ycSubtitle');

  subtitle.textContent = upcoming.length + ' upcoming';

  container.innerHTML = upcoming.map(evt => {
    // Date formatting: "Fri Mar 12"
    const d = new Date(evt.date + 'T12:00:00');
    const dayName = d.toLocaleString('en-US', { weekday: 'short' });
    const month = d.toLocaleString('en-US', { month: 'short' });
    const dayNum = d.getDate();
    const dateStr = `${dayName}, ${month} ${dayNum}`;

    const timeStr = evt.time ? fmt12(evt.time) : '';
    const endStr = evt.end_time ? ` – ${fmt12(evt.end_time)}` : '';

    // Resolve location name
    let placeName = '';
    if (evt.parish_id) {
      const p = parishes.find(x => x.id === evt.parish_id);
      if (p) {
        if (evt.location_id) {
          const loc = (p.locations || []).find(l => l.id === evt.location_id);
          if (loc) placeName = loc.name;
        }
        if (!placeName) {
          const primary = p.locations && p.locations[0];
          if (primary) {
            placeName = primary.name;
            if (/Cathedral|Basilica/i.test(placeName)) placeName = placeName.replace(/\s+Church$/i, '');
          } else {
            placeName = p.name;
          }
        }
      }
    }
    if (evt.venue_name) placeName = evt.venue_name;

    const socialTag = evt.social ? '<div class="yc-card-social">✦ Social after</div>' : '';
    const noteTag = evt.notes ? `<div style="font-size:0.6rem;color:rgba(255,255,255,0.4);margin-top:2px;">${evt.notes}</div>` : '';

    // Distance calculation
    let distTag = '';
    if (userLat !== null) {
      let evtLat = evt.venue_lat, evtLng = evt.venue_lng;
      if (!evtLat && evt.parish_id) {
        const ep = parishes.find(x => x.id === evt.parish_id);
        if (ep) {
          const eLoc = evt.location_id
            ? (ep.locations || []).find(l => l.id === evt.location_id)
            : (ep.locations && ep.locations[0]);
          if (eLoc && eLoc.lat) { evtLat = eLoc.lat; evtLng = eLoc.lng; }
        }
      }
      if (evtLat && evtLng) {
        const evtDist = haversine(userLat, userLng, evtLat, evtLng);
        distTag = `<div class="yc-card-dist">${evtDist.toFixed(1)} mi</div>`;
      }
    }

    // Calendar button
    const evtLocation = evt.venue_address || (placeName ? placeName + ', MA' : '');
    const evtDesc = evt.title + (evt.social ? ' (Social after)' : '') + (evt.notes ? ' — ' + evt.notes : '');
    const icsUrl = generateICS(evt.title, evt.date, evt.time, evt.end_time, evtLocation, evtDesc);
    const gcalUrl = generateGCalURL(evt.title, evt.date, evt.time, evt.end_time, evtLocation, evtDesc);
    const calBtnHtml = evt.date && evt.time
      ? `<div class="cal-dropdown" onclick="event.stopPropagation();">
           <button class="cal-btn" onclick="event.stopPropagation(); toggleCalDropdown(this);">📅 Add</button>
           <div class="cal-dropdown-menu">
             <a href="${gcalUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation();">Google Calendar</a>
             <a href="${icsUrl}" download="${evt.id || 'event'}.ics" onclick="event.stopPropagation();">Download .ics</a>
           </div>
         </div>` : '';

    return `<div class="yc-card" data-parish-id="${evt.parish_id || ''}" onclick="scrollToParish('${evt.parish_id || ''}')">
      <div class="yc-card-date">${dateStr}</div>
      <div class="yc-card-title">${evt.title}</div>
      <div class="yc-card-time">${timeStr}${endStr}</div>
      <div class="yc-card-place">${placeName}</div>
      ${distTag}${socialTag}${calBtnHtml}${noteTag}
    </div>`;
  }).join('');

  // Strip moved to dedicated YC Events tab — keep container hidden
  // section.style.display = '';
}

function scrollToParish(parishId) {
  if (!parishId) return;
  // Find the card in the grid by searching for the reconcile button with this ID
  const cards = document.querySelectorAll('.parish-card');
  for (const card of cards) {
    const reconcileBtn = card.querySelector('.reconcile-btn');
    if (reconcileBtn) {
      const onclickStr = reconcileBtn.getAttribute('onclick') || '';
      if (onclickStr.includes(parishId)) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.style.transition = 'box-shadow 0.3s';
        card.style.boxShadow = '0 0 0 2px #e8a838, 0 0 16px rgba(232,168,56,0.3)';
        setTimeout(() => { card.style.boxShadow = ''; }, 2500);
        return;
      }
    }
  }
}

// ═══════════════════════════════════════════════════
// LANGUAGE BAR
// ═══════════════════════════════════════════════════

// langBar removed from DOM — language filtering via langFilterEl select only

// Add parish now handled via header button → openNewParish()

// ═══════════════════════════════════════════════════
// QUICK ACTIONS
// ═══════════════════════════════════════════════════

let quickActive = null;

function setQuickActive(id) {
  ['btnThisWeekend','btnLentNearMe','btnConfession','btnNearMe'].forEach(b => {
    const el = document.getElementById(b);
    if (el) el.classList.toggle('active', b === id);
  });
  const clearBtn = document.getElementById('btnClearQuick');
  if (clearBtn) clearBtn.style.display = id ? '' : 'none';
  quickActive = id;
}

function clearQuick() {
  // Reset all filters
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  if (timeFilterEl) timeFilterEl.value = '';
  langFilterEl.value = '';
  // langBar removed
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  subfilterBar.style.display = 'none';
  setQuickActive(null);
  render();
}

function quickThisWeekend() {
  if (quickActive === 'btnThisWeekend') { clearQuick(); return; }
  searchInput.value = '';
  countyFilter.value = '';
  // Saturday + Sunday = set day to sunday and also let saturday vigils show
  // Best approach: set category to mass, clear day (both days show)
  dayFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === 'mass'));
  activeCategory = 'mass';
  activeSubtype = '';
  // Build subchips for mass
  if (SUBTYPES['mass']) {
    buildSubChips('mass');
    // Auto-select weekend subtype if available
    const wkndChip = [...subtypeChips.querySelectorAll('[data-sub]')].find(c => c.dataset.sub === 'weekend_mass');
    if (wkndChip) {
      subtypeChips.querySelectorAll('[data-sub]').forEach(c => c.classList.remove('active'));
      wkndChip.classList.add('active');
      activeSubtype = 'weekend_mass';
    }
    subfilterBar.style.display = '';
  }
  setQuickActive('btnThisWeekend');
  render();
}

function quickConfession() {
  if (quickActive === 'btnConfession') { clearQuick(); return; }
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === 'confession'));
  activeCategory = 'confession';
  activeSubtype = '';
  if (SUBTYPES['confession']) {
    buildSubChips('confession');
    subfilterBar.style.display = '';
  }
  setQuickActive('btnConfession');
  render();
}

function quickNearMe() {
  if (quickActive === 'btnNearMe') { clearQuick(); return; }
  if (userLat === null) {
    requestLocation();
    // Will re-render after location granted
  }
  setQuickActive('btnNearMe');
  render();
}

function quickLentNearMe() {
  if (quickActive === 'btnLentNearMe') { clearQuick(); return; }
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  langFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  subfilterBar.style.display = 'none';
  if (userLat === null) requestLocation();
  setQuickActive('btnLentNearMe');
  render();
}

function clearAllFilters() {
  searchInput.value = '';
  countyFilter.value = '';
  dayFilterEl.value = '';
  langFilterEl.value = '';
  if (timeFilterEl) timeFilterEl.value = '';
  categoryChips.querySelectorAll('[data-cat]').forEach(c => c.classList.toggle('active', c.dataset.cat === ''));
  activeCategory = '';
  activeSubtype = '';
  subfilterBar.style.display = 'none';
  subtypeChips.innerHTML = '';
  setQuickActive(null);
  render();
}

function setSortMode(mode) {
  sortMode = mode;
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === mode));
  // If switching to proximity and no location yet, request it
  if (mode === 'proximity' && userLat === null) requestLocation();
  render();
}

function toggleContact(btn) {
  btn.classList.toggle('open');
  const drawer = btn.nextElementSibling;
  if (drawer) drawer.classList.toggle('open');
}

function clearLocationSort() {
  userLat = null;
  userLng = null;
  locationStatus = 'unknown';
  sortMode = 'alpha';
  const st = document.getElementById('sortToggle');
  if (st) { st.classList.remove('location-ready'); }
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === 'alpha'));
  render();
}

// ═══════════════════════════════════════════════════
// SHARE PARISH DEEP LINK
// ═══════════════════════════════════════════════════

function shareParish(parishId, btnEl) {
  const base = window.location.origin + window.location.pathname;
  const shareUrl = base + '?parish=' + encodeURIComponent(parishId);

  // Find parish name for share sheet
  const parish = parishes.find(p => p.id === parishId);
  const loc = parish && parish.locations && parish.locations[0];
  const churchName = (loc && loc.name) ? loc.name : (parish ? parish.name : 'Church');

  function showCopied() {
    if (btnEl) {
      btnEl.classList.add('copied');
      btnEl.textContent = '✓ Shared!';
      setTimeout(() => { btnEl.classList.remove('copied'); btnEl.textContent = '📋 Share'; }, 1800);
    }
  }

  function fallbackCopy() {
    if (navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext) {
      navigator.clipboard.writeText(shareUrl).then(showCopied).catch(() => {
        prompt('Copy this link:', shareUrl);
      });
    } else {
      const ta = document.createElement('textarea');
      ta.value = shareUrl;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); showCopied(); }
      catch(e) { prompt('Copy this link:', shareUrl); }
      document.body.removeChild(ta);
    }
  }

  // Use native share sheet on mobile if available
  // Include URL in text field — many platforms (iOS Messages, WhatsApp) only use text, not url
  if (navigator.share) {
    navigator.share({
      text: churchName + ' — Mass Finder\n' + shareUrl,
    }).then(showCopied).catch(() => { /* user cancelled share */ });
  } else {
    fallbackCopy();
  }
}

// Handle ?parish=xxx deep link on load
(function handleParishDeepLink() {
  if (!_deepLinkParishId) return;
  const pid = _deepLinkParishId;
  // Wait for DOM to settle after render
  setTimeout(() => {
    const card = document.querySelector(`[data-parish-id="${pid}"]`);
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.style.transition = 'box-shadow 0.3s';
      card.style.boxShadow = '0 0 0 3px var(--gold), 0 0 20px rgba(201,168,76,0.3)';
      setTimeout(() => {
        card.style.boxShadow = '';
        // Clear deep link param from URL after highlight fades
        _deepLinkParishId = null;
        syncUrlParams();
      }, 3500);
    }
  }, 400);
})();

// ═══════════════════════════════════════════════════
// FAVORITES (WP-Favorites)
// ═══════════════════════════════════════════════════

function loadFavorites() {
  try {
    const raw = document.cookie.split('; ').find(c => c.startsWith('pf_favs='));
    if (raw) {
      const ids = JSON.parse(decodeURIComponent(raw.split('=')[1]));
      ids.forEach(id => favorites.add(id));
    }
  } catch(e) {}
  updateFavChip();
}

function saveFavorites() {
  const val = JSON.stringify([...favorites]);
  const d = new Date(); d.setFullYear(d.getFullYear() + 2);
  document.cookie = 'pf_favs=' + encodeURIComponent(val) + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
  updateFavChip();
}

function toggleFavorite(parishId, btnEl) {
  if (favorites.has(parishId)) {
    favorites.delete(parishId);
    if (btnEl) { btnEl.classList.remove('favorited'); btnEl.textContent = '🤍'; btnEl.title = 'Add to favorites'; }
  } else {
    favorites.add(parishId);
    if (btnEl) { btnEl.classList.add('favorited'); btnEl.textContent = '❤️'; btnEl.title = 'Remove from favorites'; }
  }
  saveFavorites();
  if (favFilterActive) render();
}

function toggleFavFilter() {
  favFilterActive = !favFilterActive;
  const chip = document.getElementById('favFilterChip');
  if (chip) chip.classList.toggle('active', favFilterActive);
  render();
}

function updateFavChip() {
  const chip = document.getElementById('favFilterChip');
  if (chip) {
    chip.classList.toggle('visible', favorites.size > 0);
    chip.classList.toggle('active', favFilterActive);
  }
}

loadFavorites();

// ═══════════════════════════════════════════════════
// TAB NAVIGATION (WP8)
// ═══════════════════════════════════════════════════

var currentView = 'churches';
var mapInitialized = false;

function switchAppView(view) {
  currentView = view;
  document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.app-tab').forEach(t => t.classList.remove('active'));
  const viewEl = document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1));
  if (viewEl) viewEl.classList.add('active');
  const tabEl = document.querySelector(`.app-tab[data-view="${view}"]`);
  if (tabEl) tabEl.classList.add('active');
  // Show/hide controls bar based on view
  document.querySelector('.controls-bar').style.display = (view === 'churches') ? '' : 'none';

  if (view === 'now') {
    if (nowViewMode === 'week') renderWeekCalendar();
    else renderNowView();
    updateCalExportBtn();
  }
  if (view === 'yc') renderYCView();
  if (view === 'map' && !mapInitialized) initMap();

  // Update URL: use hash for backward compat, also sync params
  const hash = view === 'churches' ? '' : '#' + view;
  history.replaceState(null, '', (location.search || location.pathname) + hash);
}

// Handle hash on load
(function checkHash() {
  const h = location.hash.replace('#', '');
  if (h === 'now' || h === 'map' || h === 'yc') {
    setTimeout(() => switchAppView(h), 100);
  }
})();

// ═══════════════════════════════════════════════════
// WHAT'S NOW VIEW (WP8)
// ═══════════════════════════════════════════════════

var nowMode = 'all';

function setNowMode(mode) {
  nowMode = mode;
  document.querySelectorAll('[data-now-mode]').forEach(p => p.classList.toggle('active', p.dataset.nowMode === mode));
  if (nowViewMode === 'week') renderWeekCalendar();
  else renderNowView();
}

function renderNowView() {
  const now = new Date();
  const todayIdx = now.getDay();
  const todayName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][todayIdx];
  const nowMin = now.getHours() * 60 + now.getMinutes();

  // Update location button state
  const locBtn = document.getElementById('nowLocationBtn');
  if (locBtn) {
    if (userLat !== null) {
      locBtn.textContent = '📍 Location Active';
      locBtn.classList.add('active');
    } else {
      locBtn.textContent = '📍 Enable Location';
      locBtn.classList.remove('active');
    }
  }

  // Hide/show Lent pill
  const lentPill = document.getElementById('nowLentPill');
  if (lentPill) {
    const lentRange = getLentRange(now.getFullYear());
    const todayCheck = new Date(); todayCheck.setHours(0,0,0,0);
    lentPill.style.display = (todayCheck >= lentRange.start && todayCheck <= lentRange.end) ? '' : 'none';
  }

  function svcMatchesNowMode(svc) {
    if (nowMode === 'all') return true;
    if (nowMode === 'mass') return svc.type === 'sunday_mass' || svc.type === 'daily_mass';
    if (nowMode === 'confession') return svc.type === 'confession';
    if (nowMode === 'adoration') return svc.type === 'adoration' || svc.type === 'holy_hour';
    if (nowMode === 'lent') return svc.seasonal && svc.seasonal.season === 'lent';
    return false;
  }

  const results = [];

  for (const p of parishes) {
    const primaryLoc = p.locations && p.locations[0];
    for (const svc of (p.services || [])) {
      if (!svcMatchesNowMode(svc)) continue;
      if (!isCurrentSeason(svc)) continue;
      const svcMin = timeToMinutes(svc.time);
      if (svcMin === null) continue;

      const svcDay = svc.day;
      const isWeekday = todayIdx >= 1 && todayIdx <= 5;
      const matchesToday = svcDay === todayName || svcDay === 'daily' || (svcDay === 'weekday' && isWeekday);
      if (!matchesToday) continue;

      let endMin = svc.end_time ? timeToMinutes(svc.end_time) : svcMin + (svc.type.includes('mass') ? 90 : 60);
      const minsAway = svcMin - nowMin;

      let status = null;
      if (nowMin >= svcMin && nowMin <= endMin) status = 'now';
      else if (minsAway > 0 && minsAway <= 60) status = 'soon';

      if (!status) continue;

      let dist = null;
      if (userLat !== null && primaryLoc && primaryLoc.lat) {
        let svcLat = primaryLoc.lat, svcLng = primaryLoc.lng;
        if (svc.location_id) {
          const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
          if (svcLoc && svcLoc.lat) { svcLat = svcLoc.lat; svcLng = svcLoc.lng; }
        }
        dist = haversine(userLat, userLng, svcLat, svcLng);
        // With location active: only show within 10 miles
        if (dist > 10) continue;
      }

      let displayName = (primaryLoc && primaryLoc.name) || p.name;
      if (/Cathedral|Basilica/i.test(displayName)) displayName = displayName.replace(/\s+Church$/i, '');
      if (svc.location_id) {
        const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
        if (svcLoc) displayName = svcLoc.name;
      }

      results.push({ p, svc, dist, minsAway, svcMin, status, displayName });
    }
  }

  // Sort: now first, then soon (by minsAway). Within each: by distance if available
  results.sort((a, b) => {
    const statusRank = { now: 0, soon: 1 };
    if (statusRank[a.status] !== statusRank[b.status]) return statusRank[a.status] - statusRank[b.status];
    if (a.status === 'now' && b.status === 'now') return (a.dist || 999) - (b.dist || 999);
    return a.minsAway - b.minsAway || (a.dist || 999) - (b.dist || 999);
  });

  // Without location: limit to 3 per service type category to keep it tight
  let displayResults = results;
  if (userLat === null) {
    const catCounts = {};
    displayResults = results.filter(r => {
      let cat = 'other';
      if (r.svc.type === 'sunday_mass' || r.svc.type === 'daily_mass') cat = 'mass';
      else if (r.svc.type === 'confession') cat = 'confession';
      else if (r.svc.type === 'adoration' || r.svc.type === 'holy_hour') cat = 'adoration';
      catCounts[cat] = (catCounts[cat] || 0) + 1;
      return catCounts[cat] <= 3;
    });
  }

  const container = document.getElementById('nowTimeline');

  if (!displayResults.length) {
    const noLocNote = userLat === null ? '<br><small style="color:#999;">Enable location for nearby results.</small>' : '';
    container.innerHTML = `<div class="now-empty"><div class="cross">✝</div><p>No services happening or starting within 60 minutes.${noLocNote}</p></div>`;
  } else {
    // Group results by status
    const grouped = { now: [], soon: [] };
    for (const r of displayResults) {
      if (grouped[r.status]) grouped[r.status].push(r);
    }

    const SVCTYPE_SHORT = { confession:'Confession', mass:'Mass', sunday_mass:'Mass', daily_mass:'Mass',
      stations_of_cross:'Stations', adoration:'Adoration', holy_hour:'Holy Hour', rosary:'Rosary',
      divine_mercy:'Divine Mercy', devotion:'Devotion', communion_service:'Communion', novena:'Novena' };
    const SECTION_LIMIT = 3;

    function renderItem(r) {
      let minsLabel = '';
      if (r.status === 'now') minsLabel = '<span class="time-status">Happening now</span>';
      else if (r.minsAway <= 5) minsLabel = '<span class="time-away">In a few min</span>';
      else minsLabel = `<span class="time-away">In ${r.minsAway} min</span>`;

      const isLenten = r.svc.seasonal && r.svc.seasonal.season === 'lent';
      const itemClass = r.status === 'now' ? ' happening' : (isLenten ? ' lent-item' : '');
      const typeLabel = SVCTYPE_SHORT[r.svc.type] || r.svc.type.replace(/_/g, ' ');
      const distHtml = r.dist !== null
        ? `<span class="now-item-dist${r.dist <= 5 ? ' near' : ''}">${r.dist.toFixed(1)} mi</span>` : '';

      return `<div class="now-item${itemClass}" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${r.p.id}'), 200);">
        <div class="now-item-time"><div class="time-big">${fmt12(r.svc.time)}</div>${minsLabel}</div>
        <div class="now-item-info"><div class="item-type">${typeLabel}</div><div class="item-name">${r.displayName}</div><div class="item-location">${r.p.town}, MA</div></div>
        ${distHtml}
      </div>`;
    }

    let html = '';
    const sectionLabels = { now: 'Happening Now', soon: 'Starting Soon' };

    for (const status of ['now', 'soon']) {
      const items = grouped[status];
      if (!items.length) continue;
      html += `<div class="now-section-label">${sectionLabels[status]}</div>`;
      // Show first 3
      for (let i = 0; i < Math.min(items.length, SECTION_LIMIT); i++) {
        html += renderItem(items[i]);
      }
      // Overflow items collapsed
      if (items.length > SECTION_LIMIT) {
        const overflowCount = items.length - SECTION_LIMIT;
        html += `<div class="now-overflow-wrapper" id="nowOverflow_${status}">`;
        for (let i = SECTION_LIMIT; i < items.length; i++) {
          html += renderItem(items[i]);
        }
        html += `</div>`;
        html += `<button class="now-expand-btn" id="nowExpandBtn_${status}" onclick="toggleNowOverflow('${status}')">Show ${overflowCount} more ▾</button>`;
      }
    }
    container.innerHTML = html;
  }
}

function toggleNowOverflow(status) {
  const wrapper = document.getElementById('nowOverflow_' + status);
  const btn = document.getElementById('nowExpandBtn_' + status);
  if (!wrapper || !btn) return;
  const isOpen = wrapper.classList.toggle('open');
  if (isOpen) {
    btn.textContent = 'Show less ▴';
  } else {
    const count = wrapper.children.length;
    btn.textContent = `Show ${count} more ▾`;
  }
}

// ═══════════════════════════════════════════════════
// WEEKLY CALENDAR VIEW (WP-WeekCal)
// ═══════════════════════════════════════════════════

var nowViewMode = 'timeline'; // 'timeline' | 'week'

function setNowViewMode(mode) {
  nowViewMode = mode;
  document.querySelectorAll('#nowViewToggle button').forEach(b =>
    b.classList.toggle('active', b.dataset.nowView === mode)
  );
  document.getElementById('nowTimeline').style.display = (mode === 'timeline') ? '' : 'none';
  document.getElementById('weekCalendar').style.display = (mode === 'week') ? '' : 'none';
  // Show/hide export button (always visible in week mode, or when favorites exist)
  updateCalExportBtn();
  if (mode === 'timeline') renderNowView();
  else renderWeekCalendar();
}

function updateCalExportBtn() {
  const btn = document.getElementById('calExportBtn');
  if (btn) {
    btn.style.display = (nowViewMode === 'week' || favorites.size > 0) ? '' : 'none';
  }
}

function renderWeekCalendar() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayIdx = today.getDay(); // 0=Sun

  // Build array of 7 days starting from today
  const days = [];
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const dayKeys = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  for (let i = 0; i < 7; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    days.push({
      date: d,
      dayName: dayNames[d.getDay()],
      dayKey: dayKeys[d.getDay()],
      dateLabel: monthNames[d.getMonth()] + ' ' + d.getDate(),
      isToday: i === 0,
      isWeekday: d.getDay() >= 1 && d.getDay() <= 5,
    });
  }

  const SVCTYPE_SHORT = {
    confession: 'Confession', sunday_mass: 'Mass', daily_mass: 'Mass',
    stations_of_cross: 'Stations', adoration: 'Adoration', holy_hour: 'Holy Hour',
    rosary: 'Rosary', divine_mercy: 'Divine Mercy', communion_service: 'Communion', novena: 'Novena'
  };

  function svcMatchesNowMode(svc) {
    if (nowMode === 'all') return true;
    if (nowMode === 'mass') return svc.type === 'sunday_mass' || svc.type === 'daily_mass';
    if (nowMode === 'confession') return svc.type === 'confession';
    if (nowMode === 'adoration') return svc.type === 'adoration' || svc.type === 'holy_hour';
    if (nowMode === 'lent') return svc.seasonal && svc.seasonal.season === 'lent';
    return false;
  }

  function getSvcTypeClass(svc) {
    if (svc.type === 'sunday_mass' || svc.type === 'daily_mass') return 'type-mass';
    if (svc.type === 'confession') return 'type-confession';
    if (svc.type === 'adoration' || svc.type === 'holy_hour') return 'type-adoration';
    if (svc.seasonal && svc.seasonal.season === 'lent') return 'type-lent';
    return 'type-other';
  }

  let html = '<div class="week-cal-grid">';

  for (const day of days) {
    const svcs = [];
    for (const p of parishes) {
      const primaryLoc = p.locations && p.locations[0];
      for (const svc of (p.services || [])) {
        if (!svcMatchesNowMode(svc)) continue;
        if (!isCurrentSeason(svc)) continue;
        const svcMin = timeToMinutes(svc.time);
        if (svcMin === null) continue;

        const svcDay = svc.day;
        const matchesDay = svcDay === day.dayKey || svcDay === 'daily' || (svcDay === 'weekday' && day.isWeekday);
        if (!matchesDay) continue;

        // Check location radius if user has location
        let dist = null;
        if (userLat !== null && primaryLoc && primaryLoc.lat) {
          let svcLat = primaryLoc.lat, svcLng = primaryLoc.lng;
          if (svc.location_id) {
            const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
            if (svcLoc && svcLoc.lat) { svcLat = svcLoc.lat; svcLng = svcLoc.lng; }
          }
          dist = haversine(userLat, userLng, svcLat, svcLng);
          if (dist > 25) continue; // 25mi radius for week view
        }

        let displayName = (primaryLoc && primaryLoc.name) || p.name;
        if (/Cathedral|Basilica/i.test(displayName)) displayName = displayName.replace(/\s+Church$/i, '');
        if (svc.location_id) {
          const svcLoc = (p.locations || []).find(l => l.id === svc.location_id);
          if (svcLoc) displayName = svcLoc.name;
        }

        svcs.push({ p, svc, dist, svcMin, displayName });
      }
    }

    // Sort by time
    svcs.sort((a, b) => a.svcMin - b.svcMin);

    html += `<div class="week-col${day.isToday ? ' today' : ''}">`;
    html += `<div class="week-col-head">${day.dayName}<span class="week-date">${day.date.getDate()}</span></div>`;
    html += `<div class="week-col-body">`;

    if (!svcs.length) {
      html += `<div class="week-empty">No services</div>`;
    } else {
      for (const s of svcs) {
        const typeLabel = SVCTYPE_SHORT[s.svc.type] || s.svc.type.replace(/_/g, ' ');
        const distHtml = s.dist !== null ? `<div class="week-svc-dist">${s.dist.toFixed(1)} mi</div>` : '';
        html += `<div class="week-svc ${getSvcTypeClass(s.svc)}" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${s.p.id}'), 200);" title="${s.displayName} — ${typeLabel} at ${fmt12(s.svc.time)}">
          <div class="week-svc-time">${fmt12(s.svc.time)}</div>
          <div class="week-svc-type">${typeLabel}</div>
          <div class="week-svc-name">${s.displayName}</div>
          ${distHtml}
        </div>`;
      }
    }

    html += `</div></div>`;
  }

  html += '</div>';
  document.getElementById('weekCalendar').innerHTML = html;

  // Scroll today's column into view on mobile
  setTimeout(() => {
    const todayCol = document.querySelector('.week-col.today');
    if (todayCol) todayCol.scrollIntoView({ inline: 'start', behavior: 'smooth' });
  }, 50);
}

// ═══════════════════════════════════════════════════
// CALENDAR EXPORT (WP-CalExport)
// ═══════════════════════════════════════════════════

function toggleCalExportMenu() {
  const menu = document.getElementById('calExportMenu');
  if (menu) menu.classList.toggle('open');
}

// Close export menu on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('#calExportDropdown')) {
    const menu = document.getElementById('calExportMenu');
    if (menu) menu.classList.remove('open');
  }
});

function buildMultiEventICS(events) {
  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//WMass Parish Finder//EN',
    'X-WR-CALNAME:Mass Finder Services',
  ];

  for (const evt of events) {
    lines.push('BEGIN:VEVENT');
    lines.push(`DTSTART:${evt.dtStart}`);
    if (evt.dtEnd) lines.push(`DTEND:${evt.dtEnd}`);
    lines.push(`SUMMARY:${(evt.title || '').replace(/[,;\\]/g, ' ')}`);
    if (evt.location) lines.push(`LOCATION:${evt.location.replace(/[,;\\]/g, ' ')}`);
    if (evt.description) lines.push(`DESCRIPTION:${evt.description.replace(/[,;\\]/g, ' ').replace(/\n/g, '\\n')}`);
    // RRULE for recurring services
    if (evt.rrule) lines.push(evt.rrule);
    lines.push(`UID:${evt.uid || (Date.now() + '-' + Math.random().toString(36).slice(2))}@parishfinder`);
    lines.push('END:VEVENT');
  }

  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

function dayKeyToRRuleDay(dayKey) {
  const map = { sunday: 'SU', monday: 'MO', tuesday: 'TU', wednesday: 'WE',
    thursday: 'TH', friday: 'FR', saturday: 'SA' };
  return map[dayKey] || null;
}

function getNextOccurrence(dayKey, timeStr) {
  const now = new Date();
  const targetDayIdx = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'].indexOf(dayKey);
  const todayIdx = now.getDay();
  let daysAhead = targetDayIdx - todayIdx;
  if (daysAhead < 0) daysAhead += 7;
  if (daysAhead === 0) {
    // If today, check if time hasn't passed
    const [h, m] = (timeStr || '00:00').split(':').map(Number);
    if (now.getHours() * 60 + now.getMinutes() > h * 60 + m) daysAhead = 7;
  }
  const d = new Date(now);
  d.setDate(d.getDate() + daysAhead);
  return d;
}

function buildICSDateTime(date, timeStr) {
  const y = date.getFullYear();
  const mo = String(date.getMonth() + 1).padStart(2, '0');
  const dy = String(date.getDate()).padStart(2, '0');
  if (!timeStr) return `${y}${mo}${dy}`;
  const [h, m] = timeStr.split(':').map(Number);
  return `${y}${mo}${dy}T${String(h).padStart(2,'0')}${String(m).padStart(2,'0')}00`;
}

function exportFavoritesICS() {
  if (favorites.size === 0) {
    alert('Add some favorites first! Tap the heart on any church card.');
    return;
  }

  const events = [];
  for (const p of parishes) {
    if (!favorites.has(p.id)) continue;
    const primaryLoc = p.locations && p.locations[0];
    const locName = (primaryLoc && primaryLoc.name) || p.name;
    const address = primaryLoc ? [primaryLoc.address, primaryLoc.city, primaryLoc.state].filter(Boolean).join(', ') : '';

    for (const svc of (p.services || [])) {
      if (!isCurrentSeason(svc)) continue;
      const svcMin = timeToMinutes(svc.time);
      if (svcMin === null) continue;

      const svcDay = svc.day;
      const typeLabel = svc.type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      let rrule = null;

      if (['sunday','monday','tuesday','wednesday','thursday','friday','saturday'].includes(svcDay)) {
        const rrDay = dayKeyToRRuleDay(svcDay);
        if (rrDay) rrule = `RRULE:FREQ=WEEKLY;BYDAY=${rrDay};COUNT=13`; // ~3 months
        const nextDate = getNextOccurrence(svcDay, svc.time);
        const dtStart = buildICSDateTime(nextDate, svc.time);
        const endH = Math.floor(svcMin / 60) + 1;
        const endM = svcMin % 60;
        const dtEnd = svc.end_time ? buildICSDateTime(nextDate, svc.end_time)
          : buildICSDateTime(nextDate, `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`);

        events.push({
          title: `${typeLabel} — ${locName}`,
          dtStart, dtEnd,
          location: address || locName,
          description: svc.notes || '',
          rrule,
          uid: `${p.id}-${svc.id}@parishfinder`,
        });
      } else if (svcDay === 'daily' || svcDay === 'weekday') {
        const days = svcDay === 'daily' ? 'MO,TU,WE,TH,FR,SA,SU' : 'MO,TU,WE,TH,FR';
        rrule = `RRULE:FREQ=WEEKLY;BYDAY=${days};COUNT=13`;
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + 1);
        const dtStart = buildICSDateTime(nextDate, svc.time);
        const endH = Math.floor(svcMin / 60) + 1;
        const endM = svcMin % 60;
        const dtEnd = svc.end_time ? buildICSDateTime(nextDate, svc.end_time)
          : buildICSDateTime(nextDate, `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`);

        events.push({
          title: `${typeLabel} — ${locName}`,
          dtStart, dtEnd,
          location: address || locName,
          description: svc.notes || '',
          rrule,
          uid: `${p.id}-${svc.id}@parishfinder`,
        });
      }
    }
  }

  if (!events.length) {
    alert('No services found for your favorited churches.');
    return;
  }

  downloadICSFile(buildMultiEventICS(events), 'mass-finder-favorites.ics');
  document.getElementById('calExportMenu').classList.remove('open');
}

function exportWeekICS() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dayKeys = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const events = [];

  for (let i = 0; i < 7; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    const dayKey = dayKeys[d.getDay()];
    const isWeekday = d.getDay() >= 1 && d.getDay() <= 5;

    for (const p of parishes) {
      const primaryLoc = p.locations && p.locations[0];
      const locName = (primaryLoc && primaryLoc.name) || p.name;
      const address = primaryLoc ? [primaryLoc.address, primaryLoc.city, primaryLoc.state].filter(Boolean).join(', ') : '';

      // If user has location, only include nearby
      if (userLat !== null && primaryLoc && primaryLoc.lat) {
        const dist = haversine(userLat, userLng, primaryLoc.lat, primaryLoc.lng);
        if (dist > 25) continue;
      }

      for (const svc of (p.services || [])) {
        if (!isCurrentSeason(svc)) continue;
        const svcMin = timeToMinutes(svc.time);
        if (svcMin === null) continue;
        // Filter by now mode
        if (nowMode !== 'all') {
          if (nowMode === 'mass' && svc.type !== 'sunday_mass' && svc.type !== 'daily_mass') continue;
          if (nowMode === 'confession' && svc.type !== 'confession') continue;
          if (nowMode === 'adoration' && svc.type !== 'adoration' && svc.type !== 'holy_hour') continue;
          if (nowMode === 'lent' && !(svc.seasonal && svc.seasonal.season === 'lent')) continue;
        }

        const svcDay = svc.day;
        const matchesDay = svcDay === dayKey || svcDay === 'daily' || (svcDay === 'weekday' && isWeekday);
        if (!matchesDay) continue;

        const typeLabel = svc.type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        const dtStart = buildICSDateTime(d, svc.time);
        const endH = Math.floor(svcMin / 60) + 1;
        const endM = svcMin % 60;
        const dtEnd = svc.end_time ? buildICSDateTime(d, svc.end_time)
          : buildICSDateTime(d, `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`);

        events.push({
          title: `${typeLabel} — ${locName}`,
          dtStart, dtEnd,
          location: address || locName,
          description: svc.notes || '',
          uid: `${p.id}-${svc.id}-${i}@parishfinder`,
        });
      }
    }
  }

  if (!events.length) {
    alert('No services found for this week with current filters.');
    return;
  }

  downloadICSFile(buildMultiEventICS(events), 'mass-finder-this-week.ics');
  document.getElementById('calExportMenu').classList.remove('open');
}

function downloadICSFile(icsContent, filename) {
  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ═══════════════════════════════════════════════════
// DEEP LINKS — SHAREABLE FILTER URLS (WP-DeepLinks)
// ═══════════════════════════════════════════════════

function shareCurrentView(btnEl) {
  const base = window.location.origin + window.location.pathname;
  const params = new URLSearchParams();

  // Capture all active filters
  if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
  if (countyFilter.value)       params.set('county', countyFilter.value);
  if (dayFilterEl.value)        params.set('day', dayFilterEl.value);
  if (timeFilterEl.value)       params.set('time', timeFilterEl.value);
  if (langFilterEl.value)       params.set('lang', langFilterEl.value);
  if (activeCategory)           params.set('cat', activeCategory);
  if (activeSubtype)            params.set('sub', activeSubtype);
  if (sortMode === 'proximity') params.set('sort', 'proximity');

  // Capture tab state
  if (currentView !== 'churches') params.set('view', currentView);

  // If in now view, capture now mode and view mode
  if (currentView === 'now') {
    if (nowMode !== 'all') params.set('nowMode', nowMode);
    if (nowViewMode !== 'timeline') params.set('nowView', nowViewMode);
  }

  const shareUrl = base + (params.toString() ? '?' + params.toString() : '');

  // Build share description
  const filterParts = [];
  if (activeCategory) filterParts.push(activeCategory);
  if (dayFilterEl.value) filterParts.push(dayFilterEl.value);
  if (searchInput.value.trim()) filterParts.push('"' + searchInput.value.trim() + '"');
  const desc = filterParts.length ? filterParts.join(', ') : 'all churches';

  function showCopied() {
    if (btnEl) {
      btnEl.classList.add('copied');
      const orig = btnEl.innerHTML;
      btnEl.innerHTML = '✓ Copied!';
      setTimeout(() => { btnEl.classList.remove('copied'); btnEl.innerHTML = orig; }, 2000);
    }
  }

  if (navigator.share) {
    navigator.share({
      text: `Mass Finder — ${desc}\n${shareUrl}`,
    }).then(showCopied).catch(() => {});
  } else if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl).then(showCopied).catch(() => {
      prompt('Copy this link:', shareUrl);
    });
  } else {
    prompt('Copy this link:', shareUrl);
  }
}

// Enhanced URL parameter application (supports new deep link params)
function applyDeepLinkParams() {
  const p = new URLSearchParams(location.search);

  // Tab view
  if (p.get('view')) {
    const v = p.get('view');
    if (['now', 'yc', 'map'].includes(v)) {
      setTimeout(() => switchAppView(v), 150);
    }
  }

  // Now view mode
  if (p.get('nowMode')) {
    const nm = p.get('nowMode');
    if (['mass', 'confession', 'adoration', 'lent'].includes(nm)) {
      nowMode = nm;
      document.querySelectorAll('[data-now-mode]').forEach(pill =>
        pill.classList.toggle('active', pill.dataset.nowMode === nm)
      );
    }
  }

  // Now view style (timeline vs week)
  if (p.get('nowView') === 'week') {
    setTimeout(() => setNowViewMode('week'), 200);
  }

  // Sort mode
  if (p.get('sort') === 'proximity' && userLat !== null) {
    sortMode = 'proximity';
    document.querySelectorAll('.sort-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.sort === 'proximity')
    );
  }
}

// Override syncUrlParams to include new deep link params
const _origSyncUrlParams = syncUrlParams;
syncUrlParams = function() {
  const params = new URLSearchParams();
  if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
  if (countyFilter.value)       params.set('county', countyFilter.value);
  if (dayFilterEl.value)        params.set('day', dayFilterEl.value);
  if (timeFilterEl.value)       params.set('time', timeFilterEl.value);
  if (langFilterEl.value)       params.set('lang', langFilterEl.value);
  if (activeCategory)           params.set('cat', activeCategory);
  if (activeSubtype)            params.set('sub', activeSubtype);
  if (_deepLinkParishId) params.set('parish', _deepLinkParishId);
  // Include tab state in URL
  if (currentView && currentView !== 'churches') params.set('view', currentView);
  const str = params.toString();
  history.replaceState(null, '', str ? '?' + str : location.pathname);
};

// Update isAnyFilterActive and share button visibility
const _origUpdateClear = updateClearFiltersBtn;
updateClearFiltersBtn = function() {
  _origUpdateClear();
  const shareBtn = document.getElementById('shareViewBtn');
  if (shareBtn) shareBtn.style.display = isAnyFilterActive() ? '' : 'none';
};

// ═══════════════════════════════════════════════════
// YC EVENTS VIEW
// ═══════════════════════════════════════════════════

function renderYCView() {
  const ycEvents = (PARISH_DATA.yc_events || []);
  const today = new Date(); today.setHours(0,0,0,0);

  const upcoming = ycEvents.filter(evt => {
    if (!evt.date) return false;
    const evtDate = new Date(evt.date + 'T00:00:00');
    return evtDate >= today;
  }).sort((a,b) => a.date.localeCompare(b.date) || (a.time||'').localeCompare(b.time||''));

  const subtitle = document.getElementById('ycViewSubtitle');
  if (subtitle) subtitle.textContent = upcoming.length + ' upcoming event' + (upcoming.length !== 1 ? 's' : '');

  const container = document.getElementById('ycViewTimeline');
  if (!upcoming.length) {
    container.innerHTML = '<div class="now-empty"><div class="cross">✝</div><p>No upcoming YC events.</p></div>';
    return;
  }

  // Group by date
  let html = '';
  let lastDateStr = '';

  for (const evt of upcoming) {
    const d = new Date(evt.date + 'T12:00:00');
    const dayName = d.toLocaleString('en-US', { weekday: 'long' });
    const month = d.toLocaleString('en-US', { month: 'short' });
    const dayNum = d.getDate();
    const dateStr = `${dayName}, ${month} ${dayNum}`;

    if (dateStr !== lastDateStr) {
      html += `<div class="now-section-label" style="color:#b8860b;border-bottom-color:rgba(232,168,56,0.3);">${dateStr}</div>`;
      lastDateStr = dateStr;
    }

    let placeName = '';
    if (evt.venue_name) placeName = evt.venue_name;
    else if (evt.parish_id) {
      const ep = parishes.find(x => x.id === evt.parish_id);
      if (ep && ep.locations && ep.locations[0]) placeName = ep.locations[0].name;
    }

    let distHtml = '';
    if (userLat !== null && evt.parish_id) {
      const ep = parishes.find(x => x.id === evt.parish_id);
      if (ep) {
        const eLoc = evt.location_id
          ? (ep.locations || []).find(l => l.id === evt.location_id)
          : (ep.locations && ep.locations[0]);
        if (eLoc && eLoc.lat) {
          const evtDist = haversine(userLat, userLng, eLoc.lat, eLoc.lng);
          distHtml = `<span class="now-item-dist${evtDist <= 5 ? ' near' : ''}">${evtDist.toFixed(1)} mi</span>`;
        }
      }
    }

    const socialNote = evt.social ? ' · Social after' : '';
    const noteText = evt.notes ? `<div style="font-size:0.72rem;color:var(--mid-gray);font-style:italic;margin-top:2px;">${evt.notes}</div>` : '';

    html += `<div class="now-item yc-event" style="flex-wrap:wrap;">
      <div class="now-item-time"><div class="time-big">${evt.time ? fmt12(evt.time) : ''}</div><span class="time-away">${evt.end_time ? '– ' + fmt12(evt.end_time) : ''}</span></div>
      <div class="now-item-info"><div class="item-type" style="color:#e8a838;">${evt.type || 'Event'}${socialNote}</div><div class="item-name">${evt.title}</div><div class="item-location">${placeName}</div>${noteText}</div>
      ${distHtml}
      <div class="yc-item-actions">
        ${evt.date && evt.time ? `<a class="yc-action-btn" href="${generateICS(evt.title, evt.date, evt.time, evt.end_time || null, placeName, evt.notes || '')}" download="${(evt.title||'event').replace(/[^a-zA-Z0-9]/g,'_')}.ics" onclick="event.stopPropagation();">📅 Add to Calendar</a>` : ''}
        ${evt.parish_id ? `<button class="yc-action-btn" onclick="event.stopPropagation(); switchAppView('churches'); setTimeout(() => scrollToParish('${evt.parish_id}'), 200);">⛪ View Church</button>` : ''}
      </div>
    </div>`;
  }

  container.innerHTML = html;
}

// ═══════════════════════════════════════════════════
// MAP VIEW (WP-Map)
// ═══════════════════════════════════════════════════

var appMap = null;
var mapMarkers = [];
var mapFilter = '';

function initMap() {
  if (mapInitialized) return;
  mapInitialized = true;

  // Center on western MA
  appMap = L.map('mapContainer', { zoomControl: true, tap: true, tapTolerance: 20 }).setView([42.18, -72.60], 10);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18,
  }).addTo(appMap);

  // Invalidate size after view becomes visible
  setTimeout(() => { appMap.invalidateSize(); }, 200);

  renderMapMarkers();

  // Show user location if available
  if (userLat !== null) {
    L.circleMarker([userLat, userLng], {
      radius: 8, fillColor: '#4285F4', fillOpacity: 0.9, color: '#fff', weight: 2
    }).addTo(appMap).bindPopup('You are here');
  }
}

function renderMapMarkers() {
  if (!appMap) return;

  // Clear existing
  mapMarkers.forEach(m => appMap.removeLayer(m));
  mapMarkers = [];

  const markerColors = {
    mass: '#1a2744',
    confession: '#7c4fa0',
    devotion: '#c9a84c',
    default: '#1a2744'
  };

  for (const p of parishes) {
    if (!p.locations || !p.locations[0] || !p.locations[0].lat) continue;

    // Filter check
    if (mapFilter) {
      const group = SERVICE_TYPE_GROUPS[mapFilter];
      if (group) {
        const hasType = (p.services || []).some(s => group.includes(s.type) && isCurrentSeason(s));
        if (!hasType) continue;
      }
    }

    const loc = p.locations[0];
    let churchName = loc.name || p.name;
    if (/Cathedral|Basilica/i.test(churchName)) churchName = churchName.replace(/\s+Church$/i, '');

    // Count services by type
    const svcs = (p.services || []).filter(s => isCurrentSeason(s));
    const massSvcs = svcs.filter(s => s.type === 'sunday_mass' || s.type === 'daily_mass').length;
    const confSvcs = svcs.filter(s => s.type === 'confession').length;
    const otherSvcs = svcs.length - massSvcs - confSvcs;

    const svcSummary = [];
    if (massSvcs) svcSummary.push(`${massSvcs} Mass`);
    if (confSvcs) svcSummary.push(`${confSvcs} Confession`);
    if (otherSvcs) svcSummary.push(`${otherSvcs} other`);

    const color = mapFilter ? (markerColors[mapFilter] || markerColors.default) : markerColors.default;

    const marker = L.circleMarker([loc.lat, loc.lng], {
      radius: 12,
      fillColor: color,
      fillOpacity: 0.85,
      color: '#fff',
      weight: 2,
    }).addTo(appMap);

    marker.bindPopup(`
      <h3>${churchName}</h3>
      <div class="popup-town">${p.town}, MA · ${p.county} County</div>
      <div class="popup-services">${svcSummary.join(' · ')}</div>
      <span class="popup-link" onclick="switchAppView('churches'); setTimeout(() => scrollToParish('${p.id}'), 200);">View Details →</span>
    `, { closeButton: true, minWidth: 180 });

    // Enlarge on hover for desktop discoverability
    marker.on('mouseover', function() { this.setRadius(16); this.setStyle({ weight: 3 }); });
    marker.on('mouseout', function() { if (!this.isPopupOpen()) { this.setRadius(12); this.setStyle({ weight: 2 }); } });

    mapMarkers.push(marker);
  }
}

function setMapFilter(cat) {
  mapFilter = cat;
  document.querySelectorAll('[data-map-cat]').forEach(c => c.classList.toggle('active', c.dataset.mapCat === cat));
  renderMapMarkers();
}

// Expose all interactive functions to global scope
// (they're defined inside an async IIFE — inline onclick attributes require global scope)
window.requestLocation  = requestLocation;
window.clearAllFilters  = clearAllFilters;
window.clearLocationSort = clearLocationSort;
window.setSortMode       = setSortMode;
window.toggleContact     = toggleContact;
window.shareParish       = shareParish;
window.scrollToParish   = scrollToParish;
window.switchAppView    = switchAppView;
window.setNowMode       = setNowMode;
window.toggleNowOverflow = toggleNowOverflow;
window.renderYCView     = renderYCView;
window.setMapFilter     = setMapFilter;
window.toggleFavorite   = toggleFavorite;
window.toggleFavFilter  = toggleFavFilter;
window.setNowViewMode   = setNowViewMode;
window.renderWeekCalendar = renderWeekCalendar;
window.toggleCalExportMenu = toggleCalExportMenu;
window.exportFavoritesICS = exportFavoritesICS;
window.exportWeekICS     = exportWeekICS;
window.shareCurrentView  = shareCurrentView;
window.toggleVerifyDetail = toggleVerifyDetail;

})();
</script>

<!-- ══════════════════════════════════════════════════
     RECONCILIATION MODAL
══════════════════════════════════════════════════ -->
<div class="modal-backdrop" id="reconcileBackdrop">
<div class="modal-box">

  <!-- HEADER -->
  <div class="mhdr">
    <div class="mhdr-left">
      <h2>Report an Update</h2>
      <div class="mhdr-parish" id="mParishName"></div>
    </div>
    <button class="mhdr-close" onclick="closeReconcile()">×</button>
  </div>

  <!-- MODE TABS -->
  <div class="mode-tabs">
    <button class="mode-tab active" id="tab-flag"    onclick="switchTab('flag')">Correct Existing Service</button>
    <button class="mode-tab"        id="tab-add"     onclick="switchTab('add')">+ Report Missing Service</button>
    <button class="mode-tab"        id="tab-general" onclick="switchTab('general')">General Note</button>
  </div>

  <!-- ── TAB: FLAG EXISTING ── -->
  <div class="tab-panel active mbody" id="panel-flag">

    <div class="fsection">
      <div class="fsection-title">① Select the service that needs updating</div>
      <div class="fsection-body">
        <div class="svc-list" id="svcList">
          <div style="padding:14px;color:#aaa;font-size:0.85rem">Loading…</div>
        </div>
        <div class="selected-svc-detail" id="svcDetail">
          <div class="detail-label">Current recorded data (prefilled below — edit what's wrong)</div>
          <div class="fgrid cols3" style="margin-top:10px">
            <div class="fg">
              <label>Type</label>
              <select id="fd_type"></select>
            </div>
            <div class="fg">
              <label>Day(s)</label>
              <div class="day-chips" id="fd_days"></div>
            </div>
            <div class="fg">
              <label>Special recurrence</label>
              <select id="fd_special">
                <option value="">None (regular weekly)</option>
                <option value="first_friday">First Friday</option>
                <option value="first_saturday">First Saturday</option>
                <option value="first_sunday">First Sunday</option>
                <option value="first_tuesday">First Tuesday</option>
                <option value="second_sunday">2nd Sunday</option>
                <option value="third_sunday">3rd Sunday</option>
                <option value="fourth_friday">4th Friday</option>
                <option value="fourth_sunday">4th Sunday</option>
                <option value="last_sunday">Last Sunday</option>
                <option value="holyday">Holy Day of Obligation</option>
                <option value="holyday_eve">Holy Day Eve</option>
                <option value="daily">Every day</option>
                <option value="weekday">Any weekday</option>
              </select>
            </div>
            <div class="fg">
              <label>Start time</label>
              <input type="time" id="fd_time">
            </div>
            <div class="fg">
              <label>End time</label>
              <input type="time" id="fd_endtime">
            </div>
            <div class="fg">
              <label>Language</label>
              <select id="fd_language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="pl">Polish</option>
                <option value="pt">Portuguese</option>
                <option value="vi">Vietnamese</option>
                <option value="la">Latin (Traditional)</option>
                <option value="asl">ASL</option>
              </select>
            </div>
            <div class="fg check-row">
              <input type="checkbox" id="fd_times_vary">
              <label for="fd_times_vary">Times vary / by appointment</label>
            </div>
            <div class="fg check-row">
              <input type="checkbox" id="fd_seasonal" onchange="document.getElementById('fd_season_row').style.display=this.checked?'':'none'">
              <label for="fd_seasonal">Seasonal service</label>
            </div>
            <div class="fg" id="fd_season_row" style="display:none">
              <label>Season</label>
              <select id="fd_season">
                <option value="lent">Lent</option>
                <option value="advent">Advent</option>
                <option value="summer">Summer</option>
                <option value="school_year">School Year</option>
                <option value="academic_year">Academic Year</option>
              </select>
            </div>
            <div class="fg span2">
              <label>Location / church building</label>
              <select id="fd_location"></select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fsection">
      <div class="fsection-title">② Describe what's wrong and what it should say</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>What is incorrect or outdated? <span class="req">*</span></label>
          <textarea id="fd_wrong" rows="3"
            ></textarea>
        </div>
        <div class="fg">
          <label>What should it say? (corrected version)</label>
          <textarea id="fd_correct" rows="2"
            ></textarea>
        </div>
      </div>
    </div>

    <div class="fsection">
      <div class="fsection-title">③ How do you know this?</div>
      <div class="fsection-body fgrid cols3">
        <div class="fg">
          <label>Source <span class="req">*</span></label>
          <select id="fd_source">
            <option value="bulletin">Bulletin</option>
            <option value="website">Church website</option>
            <option value="attended">I attended this service</option>
            <option value="phone">Called the church office</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="fg">
          <label>Date / bulletin month</label>
          <input type="month" id="fd_source_date">
        </div>
        <div class="fg">
          <label>Confidence</label>
          <select id="fd_confidence">
            <option value="certain">Certain — confirmed from primary source</option>
            <option value="likely">Likely — strong indication</option>
            <option value="uncertain">Uncertain — needs verification</option>
          </select>
        </div>
        <div class="fg span2">
          <label>Source URL (bulletin link, website page, etc.)</label>
          <input type="url" id="fd_source_url" placeholder="https://www.parishname.org/bulletin">
        </div>
        <div class="fg">
          <label>Your name (optional)</label>
          <input type="text" id="fd_name" >
        </div>
      </div>
    </div>

  </div><!-- /panel-flag -->


  <!-- ── TAB: ADD MISSING SERVICE ── -->
  <div class="tab-panel mbody" id="panel-add">

    <div class="fsection">
      <div class="fsection-title">① Describe the missing service</div>
      <div class="fsection-body fgrid">
        <div class="fg">
          <label>Service type <span class="req">*</span></label>
          <select id="fa_type">
            <optgroup label="Mass">
              <option value="sunday_mass">Sunday / Vigil Mass</option>
              <option value="daily_mass">Daily Mass</option>
            </optgroup>
            <optgroup label="Sacraments">
              <option value="confession">Confession / Reconciliation</option>
              <option value="anointing">Anointing of the Sick</option>
              <option value="communion_service">Communion Service (no priest)</option>
            </optgroup>
            <optgroup label="Adoration">
              <option value="adoration">Eucharistic Adoration</option>
              <option value="holy_hour">Holy Hour</option>
            </optgroup>
            <optgroup label="Devotions">
              <option value="rosary">Rosary</option>
              <option value="divine_mercy">Divine Mercy Chaplet</option>
              <option value="miraculous_medal">Miraculous Medal Novena</option>
              <option value="stations_of_cross">Stations of the Cross</option>
              <option value="novena">Novena (other)</option>
              <option value="devotion">Other Devotion</option>
            </optgroup>
          </select>
        </div>
        <div class="fg">
          <label>Language</label>
          <select id="fa_language">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="pl">Polish</option>
            <option value="pt">Portuguese</option>
            <option value="vi">Vietnamese</option>
            <option value="la">Latin (Traditional)</option>
            <option value="asl">ASL</option>
          </select>
        </div>

        <div class="fg span2">
          <label>Day(s) of the week</label>
          <div class="day-chips" id="fa_days"></div>
          <div class="hint">Click to toggle. Select all that apply.</div>
        </div>

        <div class="fg">
          <label>Special recurrence</label>
          <select id="fa_special">
            <option value="">None (regular weekly)</option>
            <option value="first_friday">First Friday</option>
            <option value="first_saturday">First Saturday</option>
            <option value="first_sunday">First Sunday</option>
            <option value="first_tuesday">First Tuesday</option>
            <option value="second_sunday">2nd Sunday</option>
            <option value="third_sunday">3rd Sunday</option>
            <option value="fourth_friday">4th Friday</option>
            <option value="fourth_sunday">4th Sunday</option>
            <option value="last_sunday">Last Sunday</option>
            <option value="holyday">Holy Day of Obligation</option>
            <option value="holyday_eve">Holy Day Eve</option>
            <option value="daily">Every day</option>
            <option value="weekday">Any weekday</option>
          </select>
        </div>
        <div class="fg">
          <label>Start time</label>
          <input type="time" id="fa_time">
        </div>
        <div class="fg">
          <label>End time (if known)</label>
          <input type="time" id="fa_endtime">
        </div>
        <div class="fg check-row">
          <input type="checkbox" id="fa_times_vary">
          <label for="fa_times_vary">Times vary / by appointment</label>
        </div>
        <div class="fg check-row">
          <input type="checkbox" id="fa_seasonal" onchange="document.getElementById('fa_season_row').style.display=this.checked?'':'none'">
          <label for="fa_seasonal">This is a seasonal service</label>
        </div>
        <div class="fg" id="fa_season_row" style="display:none">
          <label>Season</label>
          <select id="fa_season">
            <option value="lent">Lent</option>
            <option value="advent">Advent</option>
            <option value="summer">Summer</option>
            <option value="school_year">School Year</option>
            <option value="academic_year">Academic Year</option>
          </select>
        </div>
        <div class="fg span2">
          <label>Location / church building (if multiple sites)</label>
          <select id="fa_location"></select>
        </div>
        <div class="fg span2">
          <label>Additional notes</label>
          <textarea id="fa_notes" rows="2"
            ></textarea>
        </div>
      </div>
    </div>

    <div class="fsection">
      <div class="fsection-title">② How do you know this service exists?</div>
      <div class="fsection-body fgrid cols3">
        <div class="fg">
          <label>Source <span class="req">*</span></label>
          <select id="fa_source">
            <option value="bulletin">Bulletin</option>
            <option value="website">Church website</option>
            <option value="attended">I attended this service</option>
            <option value="phone">Called the church office</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="fg">
          <label>Date / bulletin month</label>
          <input type="month" id="fa_source_date">
        </div>
        <div class="fg">
          <label>Confidence</label>
          <select id="fa_confidence">
            <option value="certain">Certain</option>
            <option value="likely">Likely</option>
            <option value="uncertain">Uncertain</option>
          </select>
        </div>
        <div class="fg span2">
          <label>Source URL</label>
          <input type="url" id="fa_source_url" placeholder="https://www.parishname.org/bulletin">
        </div>
        <div class="fg">
          <label>Your name (optional)</label>
          <input type="text" id="fa_name" >
        </div>
      </div>
    </div>

  </div><!-- /panel-add -->


  <!-- ── TAB: GENERAL NOTE ── -->
  <div class="tab-panel mbody" id="panel-general">

    <div class="fsection">
      <div class="fsection-title">General feedback or note about this parish</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>What would you like to report? <span class="req">*</span></label>
          <textarea id="fg_notes" rows="5"
            ></textarea>
        </div>
        <div class="fg">
          <label>Source / how you know</label>
          <input type="text" id="fg_source" >
        </div>
        <div class="fg">
          <label>Source URL (if applicable)</label>
          <input type="url" id="fg_url" placeholder="https://">
        </div>
        <div class="fg">
          <label>Your name (optional)</label>
          <input type="text" id="fg_name" >
        </div>
      </div>
    </div>

  </div><!-- /panel-general -->


  <!-- SUCCESS SCREEN (hidden until submit) -->
  <div class="msuccess" id="mSuccess">
    <div class="sicon">✓</div>
    <h3>Submission received — thank you!</h3>
    <p>Your report has been logged for review by the diocese data team.<br>
       No change is made to the directory until the update is verified.</p>
    <div class="ref-id" id="mRefId"></div>
    <br>
    <button class="mbtn-submit" onclick="closeReconcile()">Close</button>
  </div>


  <!-- MODAL FOOTER -->
  <div class="mftr" id="mFtr">
    <div class="mftr-note">Submissions are reviewed before any data is updated. Thank you for helping keep this directory accurate.</div>
    <button class="mbtn-cancel" onclick="closeReconcile()">Cancel</button>
    <button class="mbtn-submit" onclick="submitReconcile()">Submit Report →</button>
  </div>

</div><!-- /modal-box -->
</div><!-- /modal-backdrop -->


<script>
// ════════════════════════════════════════════════════════════
//  RECONCILIATION MODAL  — full logic
// ════════════════════════════════════════════════════════════

const SVC_TYPE_LABELS = {
  sunday_mass:'Sunday / Vigil Mass', daily_mass:'Daily Mass',
  confession:'Confession', anointing_of_sick:'Anointing of the Sick',
  communion_service:'Communion Service',
  adoration:'Eucharistic Adoration', holy_hour:'Holy Hour',
  perpetual_adoration:'Perpetual Adoration', benediction:'Benediction',
  rosary:'Rosary', divine_mercy:'Divine Mercy Chaplet',
  miraculous_medal:'Miraculous Medal Novena',
  stations_of_cross:'Stations of the Cross',
  stations_of_the_cross:'Stations of the Cross',
  novena:'Novena', devotion:'Devotion',
};
const SVC_TYPE_OPTIONS = Object.entries(SVC_TYPE_LABELS);

const DAY_FULL = {
  monday:'Monday', tuesday:'Tuesday', wednesday:'Wednesday',
  thursday:'Thursday', friday:'Friday', saturday:'Saturday', sunday:'Sunday',
  first_friday:'1st Fri', first_saturday:'1st Sat', first_sunday:'1st Sun',
  first_tuesday:'1st Tue', first_monday:'1st Mon',
  second_sunday:'2nd Sun', second_tuesday:'2nd Tue',
  third_friday:'3rd Fri',
  fourth_friday:'4th Fri', fourth_sunday:'4th Sun', fourth_tuesday:'4th Tue',
  holyday:'Holy Day', holyday_eve:'Holy Day Eve',
  daily:'Daily', weekday:'Weekday', last_sunday:'Last Sun', '':'Varies',
};

const WEEKDAYS = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];

let _currentParish = null;
let _activeTab     = 'flag';
let _selectedSvcId = null;
let _flagDays      = new Set();
let _addDays       = new Set();

// ── helpers ─────────────────────────────────────────────────

function fmtT(t) {
  if (!t) return '';
  const [h,m] = t.split(':');
  const hr = parseInt(h);
  return `${hr > 12 ? hr-12 : hr||12}:${m} ${hr>=12?'PM':'AM'}`;
}

function svcMeta(s) {
  const days = (s.days||[s.day]).filter(Boolean);
  const dayStr = days.map(d=>DAY_FULL[d]||d).join('/');
  const timeStr = s.time ? fmtT(s.time) : (s.times_vary ? 'time varies' : '');
  const endStr = s.end_time ? `–${fmtT(s.end_time)}` : '';
  const langStr = s.language && s.language!=='en' ? s.language.toUpperCase() : '';
  return [dayStr, timeStr+endStr, langStr].filter(Boolean).join(' · ');
}

// ── day chip builders ────────────────────────────────────────

function buildDayChips(containerId, stateSet) {
  const el = document.getElementById(containerId);
  el.innerHTML = WEEKDAYS.map(d =>
    `<span class="dc${stateSet.has(d)?' on':''}" onclick="toggleDayChip('${containerId}','${d}')">${DAY_FULL[d].slice(0,3)}</span>`
  ).join('');
}

function toggleDayChip(containerId, day) {
  const stateSet = containerId.startsWith('fd_') ? _flagDays : _addDays;
  stateSet.has(day) ? stateSet.delete(day) : stateSet.add(day);
  buildDayChips(containerId, stateSet);
}

// ── populate type select (shared) ───────────────────────────

function populateTypeSelect(elId) {
  const el = document.getElementById(elId);
  el.innerHTML = SVC_TYPE_OPTIONS.map(([v,l])=>`<option value="${v}">${l}</option>`).join('');
}

// ── open / close ─────────────────────────────────────────────

function openReconcile(parishId) {
  _currentParish  = PARISH_DATA.parishes.find(p=>p.id===parishId);
  if (!_currentParish) return;
  _selectedSvcId  = null;
  _flagDays       = new Set();
  _addDays        = new Set();

  // WP1: Display church name in reconcile header
  const recLoc = _currentParish.locations && _currentParish.locations[0];
  let recChurchName = (recLoc && recLoc.name) ? recLoc.name : _currentParish.name;
  if (/Cathedral|Basilica/i.test(recChurchName)) {
    recChurchName = recChurchName.replace(/\s+Church$/i, '');
  }
  document.getElementById('mParishName').textContent =
    recChurchName + ' — ' + _currentParish.town + ', MA';

  // reset tabs
  switchTab('flag');

  // populate type selects
  populateTypeSelect('fd_type');
  populateTypeSelect('fa_type');

  // build day chips
  buildDayChips('fd_days', _flagDays);
  buildDayChips('fa_days', _addDays);

  // service list
  buildSvcList();

  // location selects
  const locs = (_currentParish.locations||[]);
  const locOpts = '<option value="">— Main church —</option>' +
    locs.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
  document.getElementById('fd_location').innerHTML = locOpts;
  document.getElementById('fa_location').innerHTML = locOpts;

  // hide selected detail
  document.getElementById('svcDetail').classList.remove('visible');

  // clear description fields
  ['fd_wrong','fd_correct','fa_notes','fg_notes','fg_source','fg_url'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });

  // default source dates
  const ym = new Date().toISOString().slice(0,7);
  ['fd_source_date','fa_source_date'].forEach(id=>{
    document.getElementById(id).value = ym;
  });

  // hide success, show footer
  document.getElementById('mSuccess').style.display = 'none';
  document.getElementById('mFtr').style.display = 'flex';
  document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='');
  document.querySelectorAll('.mode-tab').forEach(t=>t.style.display='');

  document.getElementById('reconcileBackdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeReconcile() {
  document.getElementById('reconcileBackdrop').classList.remove('open');
  document.body.style.overflow = '';
}

// close on backdrop click
document.getElementById('reconcileBackdrop').addEventListener('click', function(e) {
  if (e.target === this) closeReconcile();
});

// ── tab switching ────────────────────────────────────────────

function switchTab(tab) {
  _activeTab = tab;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('panel-'+tab).classList.add('active');
}

// ── service list ─────────────────────────────────────────────

function buildSvcList() {
  const el = document.getElementById('svcList');
  const svcs = _currentParish.services || [];
  if (!svcs.length) {
    el.innerHTML = '<div style="padding:14px;color:#aaa;font-size:0.85rem">No services recorded yet — use "Report Missing Service" to add one.</div>';
    return;
  }
  el.innerHTML = svcs.map((s,i) => {
    const typeLbl = SVC_TYPE_LABELS[s.type] || s.type;
    const meta    = svcMeta(s);
    const note    = s.notes ? `<div class="svc-item-note">${s.notes}</div>` : '';
    return `<label class="svc-item">
      <input type="radio" name="svcRadio" value="${s.id}" onchange="selectService('${s.id}')">
      <div class="svc-item-main">
        <div class="svc-item-type">${typeLbl}</div>
        <div class="svc-item-meta">${meta}</div>
        ${note}
      </div>
    </label>`;
  }).join('');
}

// ── prefill fields when a service is selected ─────────────────

function selectService(svcId) {
  _selectedSvcId = svcId;
  const s = (_currentParish.services||[]).find(x=>x.id===svcId);
  if (!s) return;

  // show detail panel
  document.getElementById('svcDetail').classList.add('visible');

  // prefill type
  document.getElementById('fd_type').value = s.type || '';

  // prefill days
  _flagDays = new Set();
  const SPECIAL = ['first_friday','first_saturday','first_sunday','first_tuesday',
    'second_sunday','third_sunday','fourth_friday','fourth_sunday','last_sunday',
    'holyday','holyday_eve','daily','weekday'];
  const isSpecialDay = SPECIAL.includes(s.day);
  const dayList = s.days ? [...s.days] : (!isSpecialDay && s.day ? [s.day] : []);
  dayList.forEach(d => _flagDays.add(d));
  buildDayChips('fd_days', _flagDays);

  // prefill special recurrence
  document.getElementById('fd_special').value = (isSpecialDay ? s.day : '') || '';

  // prefill time
  document.getElementById('fd_time').value    = s.time     || '';
  document.getElementById('fd_endtime').value = s.end_time || '';

  // prefill times_vary
  document.getElementById('fd_times_vary').checked = !!s.times_vary;

  // prefill language
  document.getElementById('fd_language').value = s.language || 'en';

  // prefill location
  document.getElementById('fd_location').value = s.location_id || '';

  // prefill seasonal
  const isSeasonal = s.seasonal?.is_seasonal;
  document.getElementById('fd_seasonal').checked = !!isSeasonal;
  document.getElementById('fd_season_row').style.display = isSeasonal ? '' : 'none';
  if (isSeasonal) document.getElementById('fd_season').value = s.seasonal.season || 'lent';

  // helpful placeholder for the "what's wrong" field
  document.getElementById('fd_wrong').placeholder =
    `Currently listed as: ${SVC_TYPE_LABELS[s.type]||s.type}, ${svcMeta(s)} — describe what's incorrect.`;
}

// ── email via Web3Forms ──────────────────────────────────────
// Get your access key at https://web3forms.com (free, 250/mo)
const W3F_KEY = 'bf7958f8-3eda-4ed3-8b61-9843af03fd5a';
const W3F_URL = 'https://api.web3forms.com/submit';

async function sendFormEmail(subject, htmlBody, refId) {
  try {
    const resp = await fetch(W3F_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        access_key: W3F_KEY,
        subject: subject,
        from_name: 'Mass Finder',
        to: 'mvadamski@gmail.com',
        message: htmlBody,
        replyto: 'noreply@parishfinder.vercel.app',
      })
    });
    const data = await resp.json();
    if (!data.success) console.warn('Web3Forms error:', data.message);
    return data.success;
  } catch(e) {
    console.warn('Email send failed:', e);
    return false;
  }
}

function formatReconcileEmail(payload) {
  const lines = [];
  lines.push(`Parish: ${payload.parish_name} (${payload.parish_id})`);
  lines.push(`Tab: ${payload.mode}`);
  lines.push(`Ref: ${payload.ref_id}`);
  lines.push(`Submitted: ${payload.submitted_at}`);
  lines.push('');

  if (payload.mode === 'flag') {
    if (payload.service_id) lines.push(`Service ID: ${payload.service_id}`);
    if (payload.report) {
      lines.push(`What's wrong: ${payload.report.what_is_wrong}`);
      if (payload.report.what_it_should_say) lines.push(`Should say: ${payload.report.what_it_should_say}`);
    }
    if (payload.proposed_fields) {
      const pf = payload.proposed_fields;
      lines.push('');
      lines.push('Proposed fields:');
      if (pf.type) lines.push(`  Type: ${pf.type}`);
      if (pf.days && pf.days.length) lines.push(`  Days: ${pf.days.join(', ')}`);
      if (pf.special_day) lines.push(`  Special day: ${pf.special_day}`);
      if (pf.time) lines.push(`  Time: ${pf.time}${pf.end_time ? ' – ' + pf.end_time : ''}`);
      if (pf.language) lines.push(`  Language: ${pf.language}`);
      if (pf.is_seasonal) lines.push(`  Season: ${pf.season}`);
    }
    if (payload.source) {
      lines.push('');
      lines.push(`Source: ${payload.source.type}${payload.source.date ? ' (' + payload.source.date + ')' : ''}`);
      if (payload.source.url) lines.push(`Source URL: ${payload.source.url}`);
      lines.push(`Confidence: ${payload.source.confidence}`);
    }
  } else if (payload.mode === 'add') {
    if (payload.new_service) {
      const ns = payload.new_service;
      lines.push('New service:');
      lines.push(`  Type: ${ns.type}`);
      if (ns.language && ns.language !== 'en') lines.push(`  Language: ${ns.language}`);
      if (ns.days && ns.days.length) lines.push(`  Days: ${ns.days.join(', ')}`);
      if (ns.special_day) lines.push(`  Special day: ${ns.special_day}`);
      if (ns.time) lines.push(`  Time: ${ns.time}${ns.end_time ? ' – ' + ns.end_time : ''}`);
      if (ns.is_seasonal) lines.push(`  Season: ${ns.season}`);
      if (ns.notes) lines.push(`  Notes: ${ns.notes}`);
    }
    if (payload.source) {
      lines.push('');
      lines.push(`Source: ${payload.source.type}${payload.source.date ? ' (' + payload.source.date + ')' : ''}`);
      if (payload.source.url) lines.push(`Source URL: ${payload.source.url}`);
      lines.push(`Confidence: ${payload.source.confidence}`);
    }
  } else {
    if (payload.notes) lines.push(`Notes: ${payload.notes}`);
    if (payload.source) lines.push(`Source: ${payload.source}`);
    if (payload.source_url) lines.push(`URL: ${payload.source_url}`);
  }

  if (payload.submitter && payload.submitter.name) {
    lines.push('');
    lines.push(`Submitter: ${payload.submitter.name}`);
  }

  return lines.join('\n');
}

function formatNewParishEmail(payload) {
  const lines = [];
  lines.push(`New church request: ${payload.name}`);
  lines.push(`Ref: ${payload.ref_id}`);
  lines.push(`Submitted: ${payload.submitted_at}`);
  lines.push('');
  if (payload.website) lines.push(`Website: ${payload.website}`);
  if (payload.bulletin_url) lines.push(`Bulletin: ${payload.bulletin_url}`);
  if (payload.notes) lines.push(`Notes: ${payload.notes}`);
  if (payload.submitter) {
    if (payload.submitter.name) lines.push(`Submitter: ${payload.submitter.name}`);
    if (payload.submitter.email) lines.push(`Email: ${payload.submitter.email}`);
  }
  return lines.join('\n');
}

// ── submit ───────────────────────────────────────────────────

function submitReconcile() {
  // Validate required field per tab
  let valid = true;
  if (_activeTab === 'flag') {
    const wrongEl = document.getElementById('fd_wrong');
    if (!wrongEl.value.trim()) {
      wrongEl.style.borderColor = '#c0392b';
      wrongEl.focus();
      wrongEl.placeholder = 'Please describe what is incorrect before submitting.';
      valid = false;
    } else wrongEl.style.borderColor = '';
  } else if (_activeTab === 'add') {
    // nothing mandatory beyond type (already defaulted)
  } else if (_activeTab === 'general') {
    const notesEl = document.getElementById('fg_notes');
    if (!notesEl.value.trim()) {
      notesEl.style.borderColor = '#c0392b';
      notesEl.focus();
      valid = false;
    } else notesEl.style.borderColor = '';
  }
  if (!valid) return;

  // Collect payload
  const now  = new Date();
  const refId = 'REC-' + now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') +
                String(now.getDate()).padStart(2,'0') + '-' +
                Math.random().toString(36).slice(2,7).toUpperCase();

  const payload = {
    ref_id:       refId,
    submitted_at: now.toISOString(),
    parish_id:    _currentParish.id,
    parish_name:  _currentParish.name,
    mode:         _activeTab,
  };

  if (_activeTab === 'flag') {
    payload.service_id     = _selectedSvcId;
    payload.proposed_fields = {
      type:        document.getElementById('fd_type').value,
      days:        [..._flagDays],
      special_day: document.getElementById('fd_special').value,
      time:        document.getElementById('fd_time').value,
      end_time:    document.getElementById('fd_endtime').value,
      times_vary:  document.getElementById('fd_times_vary').checked,
      language:    document.getElementById('fd_language').value,
      location_id: document.getElementById('fd_location').value,
      is_seasonal: document.getElementById('fd_seasonal').checked,
      season:      document.getElementById('fd_season').value,
    };
    payload.report = {
      what_is_wrong:  document.getElementById('fd_wrong').value,
      what_it_should_say: document.getElementById('fd_correct').value,
    };
    payload.source = {
      type:       document.getElementById('fd_source').value,
      date:       document.getElementById('fd_source_date').value,
      confidence: document.getElementById('fd_confidence').value,
      url:        document.getElementById('fd_source_url').value,
    };
    payload.submitter = { name: document.getElementById('fd_name').value };

  } else if (_activeTab === 'add') {
    payload.new_service = {
      type:        document.getElementById('fa_type').value,
      language:    document.getElementById('fa_language').value,
      days:        [..._addDays],
      special_day: document.getElementById('fa_special').value,
      time:        document.getElementById('fa_time').value,
      end_time:    document.getElementById('fa_endtime').value,
      times_vary:  document.getElementById('fa_times_vary').checked,
      is_seasonal: document.getElementById('fa_seasonal').checked,
      season:      document.getElementById('fa_season').value,
      location_id: document.getElementById('fa_location').value,
      notes:       document.getElementById('fa_notes').value,
    };
    payload.source = {
      type:       document.getElementById('fa_source').value,
      date:       document.getElementById('fa_source_date').value,
      confidence: document.getElementById('fa_confidence').value,
      url:        document.getElementById('fa_source_url').value,
    };
    payload.submitter = { name: document.getElementById('fa_name').value };

  } else {
    payload.notes  = document.getElementById('fg_notes').value;
    payload.source = document.getElementById('fg_source').value;
    payload.source_url = document.getElementById('fg_url').value;
    payload.submitter  = { name: document.getElementById('fg_name').value };
  }

  // Send email
  const modeLabels = { flag: 'Flag Incorrect Data', add: 'Add Missing Service', general: 'General Note' };
  const subject = `[Parish Finder] ${modeLabels[_activeTab] || _activeTab} — ${_currentParish.name} (${refId})`;
  const body = formatReconcileEmail(payload);
  sendFormEmail(subject, body, refId);

  // Show success screen
  document.querySelectorAll('.tab-panel').forEach(p => p.style.display='none');
  document.querySelectorAll('.mode-tab').forEach(t => t.style.display='none');
  document.getElementById('mFtr').style.display = 'none';
  document.getElementById('mSuccess').style.display = 'block';
  document.getElementById('mRefId').textContent = 'Reference ID: ' + refId;
}
</script>


<!-- ══════════════════════════════════════════════════
     NEW PARISH REQUEST MODAL  (simplified)
══════════════════════════════════════════════════ -->
<div class="np-backdrop" id="npBackdrop">
<div class="np-box" style="max-width:560px">

  <div class="mhdr">
    <div class="mhdr-left">
      <h2>Request a Church Listing</h2>
      <div class="mhdr-parish">Diocese of Springfield, Massachusetts</div>
    </div>
    <button class="mhdr-close" onclick="closeNewParish()">×</button>
  </div>

  <div class="np-intro">
    Know of a church that's missing? Share what you have — even just a name and a bulletin link is enough. The data team handles the rest.
  </div>

  <div class="mbody" id="npFormBody">

    <div class="fsection">
      <div class="fsection-title">Parish info</div>
      <div class="fsection-body fgrid cols1">
        <div class="fg">
          <label>Church name <span class="req">*</span></label>
          <input type="text" id="np_name" >
        </div>
        <div class="fg">
          <label>Church website</label>
          <input type="url" id="np_website" placeholder="https://www.churchname.org">
        </div>
        <div class="fg">
          <label>Bulletin link <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(parishesonline.com, church-bulletin.org, or church site — most helpful)</span></label>
          <input type="url" id="np_bulletin_url" placeholder="https://church-bulletin.org/?id=XXXX">
        </div>
        <div class="fg">
          <label>Anything else you know <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.78rem;color:#888">(services, schedule notes, location — whatever you have)</span></label>
          <textarea id="np_notes" rows="4"
            ></textarea>
        </div>
      </div>
    </div>

    <div class="fsection">
      <div class="fsection-title">Your info (optional)</div>
      <div class="fsection-body fgrid">
        <div class="fg">
          <label>Your name</label>
          <input type="text" id="np_sub_name" >
        </div>
        <div class="fg">
          <label>Email (for follow-up)</label>
          <input type="email" id="np_sub_email" >
        </div>
      </div>
    </div>

  </div>

  <!-- SUCCESS -->
  <div class="msuccess" id="npSuccess" style="display:none">
    <div class="sicon">+</div>
    <h3>Got it — thank you!</h3>
    <p>The data team will look this up, verify it against the bulletin, and add it to the directory if confirmed.</p>
    <div class="ref-id" id="npRefId"></div>
    <br>
    <button class="mbtn-submit" onclick="closeNewParish()">Close</button>
  </div>

  <div class="mftr" id="npFtr">
    <div class="mftr-note">Reviewed before anything goes live.</div>
    <button class="mbtn-cancel" onclick="closeNewParish()">Cancel</button>
    <button class="mbtn-submit" onclick="submitNewParish()">Submit →</button>
  </div>

</div>
</div>

<script>
function openNewParish() {
  ['np_name','np_website','np_bulletin_url','np_notes','np_sub_name','np_sub_email']
    .forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('npFormBody').style.display = 'block';
  document.getElementById('npSuccess').style.display  = 'none';
  document.getElementById('npFtr').style.display      = 'flex';
  document.getElementById('npBackdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeNewParish() {
  document.getElementById('npBackdrop').classList.remove('open');
  document.body.style.overflow = '';
}
// close on backdrop click
document.getElementById('npBackdrop').addEventListener('click', function(e) {
  if (e.target === this) closeNewParish();
});


function submitNewParish() {
  const nameEl = document.getElementById('np_name');
  if (!nameEl.value.trim()) {
    nameEl.style.borderColor = '#c0392b';
    nameEl.focus();
    return;
  }
  nameEl.style.borderColor = '';

  const now = new Date();
  const refId = 'NP-' + now.getFullYear() +
    String(now.getMonth()+1).padStart(2,'0') +
    String(now.getDate()).padStart(2,'0') + '-' +
    Math.random().toString(36).slice(2,7).toUpperCase();

  const payload = {
    ref_id:       refId,
    submitted_at: now.toISOString(),
    type:         'new_parish_request',
    name:         document.getElementById('np_name').value,
    website:      document.getElementById('np_website').value,
    bulletin_url: document.getElementById('np_bulletin_url').value,
    notes:        document.getElementById('np_notes').value,
    submitter: {
      name:  document.getElementById('np_sub_name').value,
      email: document.getElementById('np_sub_email').value,
    },
  };

  // Send email
  const subject = `[Parish Finder] New Parish Request — ${payload.name} (${refId})`;
  const body = formatNewParishEmail(payload);
  sendFormEmail(subject, body, refId);

  document.getElementById('npFormBody').style.display = 'none';
  document.getElementById('npFtr').style.display      = 'none';
  document.getElementById('npSuccess').style.display  = 'block';
  document.getElementById('npRefId').textContent      = 'Reference ID: ' + refId;
}
</script>

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}

// PWA Install Banner — platform-aware, slim, dismissible
(function initInstallBanner() {
  // Don't show if already running as installed PWA
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (window.navigator.standalone === true) return; // iOS standalone

  // Don't show if user dismissed recently (30-day cookie)
  if (document.cookie.split('; ').some(c => c.startsWith('pf_install_dismissed='))) return;

  const slot = document.getElementById('installBannerSlot');
  if (!slot) return;

  const ua = navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isSafari = isIOS && /Safari/i.test(ua) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(ua);
  const isAndroid = /Android/i.test(ua);
  const isChrome = /Chrome/i.test(ua) && !/Edge|OPR|Brave/i.test(ua);

  // iOS: manual "Add to Home Screen" instructions (works in Safari, Chrome, etc.)
  if (isIOS) {
    const isIOSChrome = /CriOS/.test(ua);
    const isIOSFirefox = /FxiOS/.test(ua);
    let hint;
    if (isIOSChrome) {
      // Chrome on iOS: tap ••• menu then "Add to Home Screen"
      hint = `— tap <strong>⋯</strong> (menu) then "Add to Home Screen"`;
    } else if (isIOSFirefox) {
      hint = `— tap the menu then "Share" then "Add to Home Screen"`;
    } else {
      // Safari: tap share icon then Add to Home Screen
      const shareIcon = `<svg class="ios-share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12M5 10l7-7 7 7"/><path d="M5 17h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2a1 1 0 011-1z"/></svg>`;
      hint = `— tap ${shareIcon} then "Add to Home Screen"`;
    }
    slot.innerHTML = `<div class="install-banner" id="installBanner">
      <span class="ib-icon">✝</span>
      <span class="ib-text"><strong>Add to Home Screen</strong><span class="ib-hint">${hint}</span></span>
      <button class="ib-close" onclick="dismissInstall()" aria-label="Dismiss">✕</button>
    </div>`;
    return;
  }

  // Android Chrome: use beforeinstallprompt when available
  if (isAndroid && isChrome) {
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      slot.innerHTML = `<div class="install-banner" id="installBanner">
        <span class="ib-icon">✝</span>
        <span class="ib-text"><strong>Install Mass Finder</strong><span class="ib-hint">— quick access from your home screen</span></span>
        <button class="ib-action" id="ibInstallBtn">Install</button>
        <button class="ib-close" onclick="dismissInstall()" aria-label="Dismiss">✕</button>
      </div>`;

      document.getElementById('ibInstallBtn').addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(() => { deferredPrompt = null; dismissInstall(); });
        }
      });
    });

    window.addEventListener('appinstalled', () => { dismissInstall(); });
    return;
  }

  // Desktop: show subtle install hint only if beforeinstallprompt fires
  let deferredPromptDesktop = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPromptDesktop = e;
    slot.innerHTML = `<div class="install-banner" id="installBanner">
      <span class="ib-icon">✝</span>
      <span class="ib-text"><strong>Install Mass Finder</strong><span class="ib-hint">— as a desktop app for quick access</span></span>
      <button class="ib-action" id="ibInstallBtnD">Install</button>
      <button class="ib-close" onclick="dismissInstall()" aria-label="Dismiss">✕</button>
    </div>`;

    document.getElementById('ibInstallBtnD').addEventListener('click', () => {
      if (deferredPromptDesktop) {
        deferredPromptDesktop.prompt();
        deferredPromptDesktop.userChoice.then(() => { deferredPromptDesktop = null; dismissInstall(); });
      }
    });
  });

  window.addEventListener('appinstalled', () => { dismissInstall(); });
})();

function dismissInstall() {
  const b = document.getElementById('installBanner');
  if (b) b.parentElement.innerHTML = '';
  // Set 30-day dismissal cookie
  const d = new Date(); d.setDate(d.getDate() + 30);
  document.cookie = 'pf_install_dismissed=1;expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
}
window.dismissInstall = dismissInstall;
</script>

</body>
</html>
